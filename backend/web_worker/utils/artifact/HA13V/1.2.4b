var exports={COPYRIGHT:"Copyright (C) 2014-2018 Stewart Allen <sa@grid.space> - All Rights Reserved",LICENSE:"See the license.md file included with the source distribution",VERSION:"1.2.4a"};if(!module)var module={};module.exports=exports;!function(){"use strict";var t,e={},i=!1;if(self.ClipperLib=e,i){n="chrome";t="Netscape"}else{var n=navigator.userAgent.toString().toLowerCase();t=navigator.appName}var r,o={};-1!=n.indexOf("chrome")&&-1==n.indexOf("chromium")?o.chrome=1:o.chrome=0,-1!=n.indexOf("chromium")?o.chromium=1:o.chromium=0,-1!=n.indexOf("safari")&&-1==n.indexOf("chrome")&&-1==n.indexOf("chromium")?o.safari=1:o.safari=0,-1!=n.indexOf("firefox")?o.firefox=1:o.firefox=0,-1!=n.indexOf("firefox/17")?o.firefox17=1:o.firefox17=0,-1!=n.indexOf("firefox/15")?o.firefox15=1:o.firefox15=0,-1!=n.indexOf("firefox/3")?o.firefox3=1:o.firefox3=0,-1!=n.indexOf("opera")?o.opera=1:o.opera=0,-1!=n.indexOf("msie 10")?o.msie10=1:o.msie10=0,-1!=n.indexOf("msie 9")?o.msie9=1:o.msie9=0,-1!=n.indexOf("msie 8")?o.msie8=1:o.msie8=0,-1!=n.indexOf("msie 7")?o.msie7=1:o.msie7=0,-1!=n.indexOf("msie ")?o.msie=1:o.msie=0,e.biginteger_used=null;function s(t,i,n){e.biginteger_used=1,null!=t&&("number"==typeof t&&void 0===i?this.fromInt(t):"number"==typeof t?this.fromNumber(t,i,n):null==i&&"string"!=typeof t?this.fromString(t,256):this.fromString(t,i))}function l(){return new s(null)}"Microsoft Internet Explorer"==t?(s.prototype.am=function(t,e,i,n,r,o){for(var s=32767&e,l=e>>15;--o>=0;){var p=32767&this[t],h=this[t++]>>15,u=l*p+h*s;r=((p=s*p+((32767&u)<<15)+i[n]+(1073741823&r))>>>30)+(u>>>15)+l*h+(r>>>30),i[n++]=1073741823&p}return r},r=30):"Netscape"!=t?(s.prototype.am=function(t,e,i,n,r,o){for(;--o>=0;){var s=e*this[t++]+i[n]+r;r=Math.floor(s/67108864),i[n++]=67108863&s}return r},r=26):(s.prototype.am=function(t,e,i,n,r,o){for(var s=16383&e,l=e>>14;--o>=0;){var p=16383&this[t],h=this[t++]>>14,u=l*p+h*s;r=((p=s*p+((16383&u)<<14)+i[n]+r)>>28)+(u>>14)+l*h,i[n++]=268435455&p}return r},r=28),s.prototype.DB=r,s.prototype.DM=(1<<r)-1,s.prototype.DV=1<<r;s.prototype.FV=Math.pow(2,52),s.prototype.F1=52-r,s.prototype.F2=2*r-52;var p,h,u="0123456789abcdefghijklmnopqrstuvwxyz",a=new Array;for(p="0".charCodeAt(0),h=0;h<=9;++h)a[p++]=h;for(p="a".charCodeAt(0),h=10;h<36;++h)a[p++]=h;for(p="A".charCodeAt(0),h=10;h<36;++h)a[p++]=h;function f(t){return u.charAt(t)}function d(t,e){var i=a[t.charCodeAt(e)];return null==i?-1:i}function P(t){var e=l();return e.fromInt(t),e}function m(t){var e,i=1;return 0!=(e=t>>>16)&&(t=e,i+=16),0!=(e=t>>8)&&(t=e,i+=8),0!=(e=t>>4)&&(t=e,i+=4),0!=(e=t>>2)&&(t=e,i+=2),0!=(e=t>>1)&&(t=e,i+=1),i}function y(t){this.m=t}function c(t){this.m=t,this.mp=t.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<t.DB-15)-1,this.mt2=2*t.t}function v(t,e){return t&e}function C(t,e){return t|e}function I(t,e){return t^e}function _(t,e){return t&~e}function x(t){if(0==t)return-1;var e=0;return 0==(65535&t)&&(t>>=16,e+=16),0==(255&t)&&(t>>=8,e+=8),0==(15&t)&&(t>>=4,e+=4),0==(3&t)&&(t>>=2,e+=2),0==(1&t)&&++e,e}function E(t){for(var e=0;0!=t;)t&=t-1,++e;return e}function L(){}function g(t){return t}function T(t){this.r2=l(),this.q3=l(),s.ONE.dlShiftTo(2*t.t,this.r2),this.mu=this.r2.divide(t),this.m=t}y.prototype.convert=function(t){return t.s<0||t.compareTo(this.m)>=0?t.mod(this.m):t},y.prototype.revert=function(t){return t},y.prototype.reduce=function(t){t.divRemTo(this.m,null,t)},y.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i),this.reduce(i)},y.prototype.sqrTo=function(t,e){t.squareTo(e),this.reduce(e)},c.prototype.convert=function(t){var e=l();return t.abs().dlShiftTo(this.m.t,e),e.divRemTo(this.m,null,e),t.s<0&&e.compareTo(s.ZERO)>0&&this.m.subTo(e,e),e},c.prototype.revert=function(t){var e=l();return t.copyTo(e),this.reduce(e),e},c.prototype.reduce=function(t){for(;t.t<=this.mt2;)t[t.t++]=0;for(var e=0;e<this.m.t;++e){var i=32767&t[e],n=i*this.mpl+((i*this.mph+(t[e]>>15)*this.mpl&this.um)<<15)&t.DM;for(t[i=e+this.m.t]+=this.m.am(0,n,t,e,0,this.m.t);t[i]>=t.DV;)t[i]-=t.DV,t[++i]++}t.clamp(),t.drShiftTo(this.m.t,t),t.compareTo(this.m)>=0&&t.subTo(this.m,t)},c.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i),this.reduce(i)},c.prototype.sqrTo=function(t,e){t.squareTo(e),this.reduce(e)},s.prototype.copyTo=function(t){for(var e=this.t-1;e>=0;--e)t[e]=this[e];t.t=this.t,t.s=this.s},s.prototype.fromInt=function(t){this.t=1,this.s=t<0?-1:0,t>0?this[0]=t:t<-1?this[0]=t+this.DV:this.t=0},s.prototype.fromString=function(t,e){var i;if(16==e)i=4;else if(8==e)i=3;else if(256==e)i=8;else if(2==e)i=1;else if(32==e)i=5;else{if(4!=e)return void this.fromRadix(t,e);i=2}this.t=0,this.s=0;for(var n=t.length,r=!1,o=0;--n>=0;){var l=8==i?255&t[n]:d(t,n);l<0?"-"==t.charAt(n)&&(r=!0):(r=!1,0==o?this[this.t++]=l:o+i>this.DB?(this[this.t-1]|=(l&(1<<this.DB-o)-1)<<o,this[this.t++]=l>>this.DB-o):this[this.t-1]|=l<<o,(o+=i)>=this.DB&&(o-=this.DB))}8==i&&0!=(128&t[0])&&(this.s=-1,o>0&&(this[this.t-1]|=(1<<this.DB-o)-1<<o)),this.clamp(),r&&s.ZERO.subTo(this,this)},s.prototype.clamp=function(){for(var t=this.s&this.DM;this.t>0&&this[this.t-1]==t;)--this.t},s.prototype.dlShiftTo=function(t,e){var i;for(i=this.t-1;i>=0;--i)e[i+t]=this[i];for(i=t-1;i>=0;--i)e[i]=0;e.t=this.t+t,e.s=this.s},s.prototype.drShiftTo=function(t,e){for(var i=t;i<this.t;++i)e[i-t]=this[i];e.t=Math.max(this.t-t,0),e.s=this.s},s.prototype.lShiftTo=function(t,e){var i,n=t%this.DB,r=this.DB-n,o=(1<<r)-1,s=Math.floor(t/this.DB),l=this.s<<n&this.DM;for(i=this.t-1;i>=0;--i)e[i+s+1]=this[i]>>r|l,l=(this[i]&o)<<n;for(i=s-1;i>=0;--i)e[i]=0;e[s]=l,e.t=this.t+s+1,e.s=this.s,e.clamp()},s.prototype.rShiftTo=function(t,e){e.s=this.s;var i=Math.floor(t/this.DB);if(i>=this.t)e.t=0;else{var n=t%this.DB,r=this.DB-n,o=(1<<n)-1;e[0]=this[i]>>n;for(var s=i+1;s<this.t;++s)e[s-i-1]|=(this[s]&o)<<r,e[s-i]=this[s]>>n;n>0&&(e[this.t-i-1]|=(this.s&o)<<r),e.t=this.t-i,e.clamp()}},s.prototype.subTo=function(t,e){for(var i=0,n=0,r=Math.min(t.t,this.t);i<r;)n+=this[i]-t[i],e[i++]=n&this.DM,n>>=this.DB;if(t.t<this.t){for(n-=t.s;i<this.t;)n+=this[i],e[i++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;i<t.t;)n-=t[i],e[i++]=n&this.DM,n>>=this.DB;n-=t.s}e.s=n<0?-1:0,n<-1?e[i++]=this.DV+n:n>0&&(e[i++]=n),e.t=i,e.clamp()},s.prototype.multiplyTo=function(t,e){var i=this.abs(),n=t.abs(),r=i.t;for(e.t=r+n.t;--r>=0;)e[r]=0;for(r=0;r<n.t;++r)e[r+i.t]=i.am(0,n[r],e,r,0,i.t);e.s=0,e.clamp(),this.s!=t.s&&s.ZERO.subTo(e,e)},s.prototype.squareTo=function(t){for(var e=this.abs(),i=t.t=2*e.t;--i>=0;)t[i]=0;for(i=0;i<e.t-1;++i){var n=e.am(i,e[i],t,2*i,0,1);(t[i+e.t]+=e.am(i+1,2*e[i],t,2*i+1,n,e.t-i-1))>=e.DV&&(t[i+e.t]-=e.DV,t[i+e.t+1]=1)}t.t>0&&(t[t.t-1]+=e.am(i,e[i],t,2*i,0,1)),t.s=0,t.clamp()},s.prototype.divRemTo=function(t,e,i){var n=t.abs();if(!(n.t<=0)){var r=this.abs();if(r.t<n.t)return null!=e&&e.fromInt(0),void(null!=i&&this.copyTo(i));null==i&&(i=l());var o=l(),p=this.s,h=t.s,u=this.DB-m(n[n.t-1]);u>0?(n.lShiftTo(u,o),r.lShiftTo(u,i)):(n.copyTo(o),r.copyTo(i));var a=o.t,f=o[a-1];if(0!=f){var d=f*(1<<this.F1)+(a>1?o[a-2]>>this.F2:0),P=this.FV/d,y=(1<<this.F1)/d,c=1<<this.F2,v=i.t,C=v-a,I=null==e?l():e;for(o.dlShiftTo(C,I),i.compareTo(I)>=0&&(i[i.t++]=1,i.subTo(I,i)),s.ONE.dlShiftTo(a,I),I.subTo(o,o);o.t<a;)o[o.t++]=0;for(;--C>=0;){var _=i[--v]==f?this.DM:Math.floor(i[v]*P+(i[v-1]+c)*y);if((i[v]+=o.am(0,_,i,C,0,a))<_)for(o.dlShiftTo(C,I),i.subTo(I,i);i[v]<--_;)i.subTo(I,i)}null!=e&&(i.drShiftTo(a,e),p!=h&&s.ZERO.subTo(e,e)),i.t=a,i.clamp(),u>0&&i.rShiftTo(u,i),p<0&&s.ZERO.subTo(i,i)}}},s.prototype.invDigit=function(){if(this.t<1)return 0;var t=this[0];if(0==(1&t))return 0;var e=3&t;return(e=(e=(e=(e=e*(2-(15&t)*e)&15)*(2-(255&t)*e)&255)*(2-((65535&t)*e&65535))&65535)*(2-t*e%this.DV)%this.DV)>0?this.DV-e:-e},s.prototype.isEven=function(){return 0==(this.t>0?1&this[0]:this.s)},s.prototype.exp=function(t,e){if(t>4294967295||t<1)return s.ONE;var i=l(),n=l(),r=e.convert(this),o=m(t)-1;for(r.copyTo(i);--o>=0;)if(e.sqrTo(i,n),(t&1<<o)>0)e.mulTo(n,r,i);else{var p=i;i=n,n=p}return e.revert(i)},s.prototype.toString=function(t){if(this.s<0)return"-"+this.negate().toString(t);var e;if(16==t)e=4;else if(8==t)e=3;else if(2==t)e=1;else if(32==t)e=5;else{if(4!=t)return this.toRadix(t);e=2}var i,n=(1<<e)-1,r=!1,o="",s=this.t,l=this.DB-s*this.DB%e;if(s-- >0)for(l<this.DB&&(i=this[s]>>l)>0&&(r=!0,o=f(i));s>=0;)l<e?(i=(this[s]&(1<<l)-1)<<e-l,i|=this[--s]>>(l+=this.DB-e)):(i=this[s]>>(l-=e)&n,l<=0&&(l+=this.DB,--s)),i>0&&(r=!0),r&&(o+=f(i));return r?o:"0"},s.prototype.negate=function(){var t=l();return s.ZERO.subTo(this,t),t},s.prototype.abs=function(){return this.s<0?this.negate():this},s.prototype.compareTo=function(t){var e=this.s-t.s;if(0!=e)return e;var i=this.t;if(0!=(e=i-t.t))return this.s<0?-e:e;for(;--i>=0;)if(0!=(e=this[i]-t[i]))return e;return 0},s.prototype.bitLength=function(){return this.t<=0?0:this.DB*(this.t-1)+m(this[this.t-1]^this.s&this.DM)},s.prototype.mod=function(t){var e=l();return this.abs().divRemTo(t,null,e),this.s<0&&e.compareTo(s.ZERO)>0&&t.subTo(e,e),e},s.prototype.modPowInt=function(t,e){var i;return i=t<256||e.isEven()?new y(e):new c(e),this.exp(t,i)},s.ZERO=P(0),s.ONE=P(1),L.prototype.convert=g,L.prototype.revert=g,L.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i)},L.prototype.sqrTo=function(t,e){t.squareTo(e)},T.prototype.convert=function(t){if(t.s<0||t.t>2*this.m.t)return t.mod(this.m);if(t.compareTo(this.m)<0)return t;var e=l();return t.copyTo(e),this.reduce(e),e},T.prototype.revert=function(t){return t},T.prototype.reduce=function(t){for(t.drShiftTo(this.m.t-1,this.r2),t.t>this.m.t+1&&(t.t=this.m.t+1,t.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);t.compareTo(this.r2)<0;)t.dAddOffset(1,this.m.t+1);for(t.subTo(this.r2,t);t.compareTo(this.m)>=0;)t.subTo(this.m,t)},T.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i),this.reduce(i)},T.prototype.sqrTo=function(t,e){t.squareTo(e),this.reduce(e)};var X=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],N=(1<<26)/X[X.length-1];s.prototype.chunkSize=function(t){return Math.floor(Math.LN2*this.DB/Math.log(t))},s.prototype.toRadix=function(t){if(null==t&&(t=10),0==this.signum()||t<2||t>36)return"0";var e=this.chunkSize(t),i=Math.pow(t,e),n=P(i),r=l(),o=l(),s="";for(this.divRemTo(n,r,o);r.signum()>0;)s=(i+o.intValue()).toString(t).substr(1)+s,r.divRemTo(n,r,o);return o.intValue().toString(t)+s},s.prototype.fromRadix=function(t,e){this.fromInt(0),null==e&&(e=10);for(var i=this.chunkSize(e),n=Math.pow(e,i),r=!1,o=0,l=0,p=0;p<t.length;++p){var h=d(t,p);h<0?"-"==t.charAt(p)&&0==this.signum()&&(r=!0):(l=e*l+h,++o>=i&&(this.dMultiply(n),this.dAddOffset(l,0),o=0,l=0))}o>0&&(this.dMultiply(Math.pow(e,o)),this.dAddOffset(l,0)),r&&s.ZERO.subTo(this,this)},s.prototype.fromNumber=function(t,e,i){if("number"==typeof e)if(t<2)this.fromInt(1);else for(this.fromNumber(t,i),this.testBit(t-1)||this.bitwiseTo(s.ONE.shiftLeft(t-1),C,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(e);)this.dAddOffset(2,0),this.bitLength()>t&&this.subTo(s.ONE.shiftLeft(t-1),this);else{var n=new Array,r=7&t;n.length=1+(t>>3),e.nextBytes(n),r>0?n[0]&=(1<<r)-1:n[0]=0,this.fromString(n,256)}},s.prototype.bitwiseTo=function(t,e,i){var n,r,o=Math.min(t.t,this.t);for(n=0;n<o;++n)i[n]=e(this[n],t[n]);if(t.t<this.t){for(r=t.s&this.DM,n=o;n<this.t;++n)i[n]=e(this[n],r);i.t=this.t}else{for(r=this.s&this.DM,n=o;n<t.t;++n)i[n]=e(r,t[n]);i.t=t.t}i.s=e(this.s,t.s),i.clamp()},s.prototype.changeBit=function(t,e){var i=s.ONE.shiftLeft(t);return this.bitwiseTo(i,e,i),i},s.prototype.addTo=function(t,e){for(var i=0,n=0,r=Math.min(t.t,this.t);i<r;)n+=this[i]+t[i],e[i++]=n&this.DM,n>>=this.DB;if(t.t<this.t){for(n+=t.s;i<this.t;)n+=this[i],e[i++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;i<t.t;)n+=t[i],e[i++]=n&this.DM,n>>=this.DB;n+=t.s}e.s=n<0?-1:0,n>0?e[i++]=n:n<-1&&(e[i++]=this.DV+n),e.t=i,e.clamp()},s.prototype.dMultiply=function(t){this[this.t]=this.am(0,t-1,this,0,0,this.t),++this.t,this.clamp()},s.prototype.dAddOffset=function(t,e){if(0!=t){for(;this.t<=e;)this[this.t++]=0;for(this[e]+=t;this[e]>=this.DV;)this[e]-=this.DV,++e>=this.t&&(this[this.t++]=0),++this[e]}},s.prototype.multiplyLowerTo=function(t,e,i){var n,r=Math.min(this.t+t.t,e);for(i.s=0,i.t=r;r>0;)i[--r]=0;for(n=i.t-this.t;r<n;++r)i[r+this.t]=this.am(0,t[r],i,r,0,this.t);for(n=Math.min(t.t,e);r<n;++r)this.am(0,t[r],i,r,0,e-r);i.clamp()},s.prototype.multiplyUpperTo=function(t,e,i){--e;var n=i.t=this.t+t.t-e;for(i.s=0;--n>=0;)i[n]=0;for(n=Math.max(e-this.t,0);n<t.t;++n)i[this.t+n-e]=this.am(e-n,t[n],i,0,0,this.t+n-e);i.clamp(),i.drShiftTo(1,i)},s.prototype.modInt=function(t){if(t<=0)return 0;var e=this.DV%t,i=this.s<0?t-1:0;if(this.t>0)if(0==e)i=this[0]%t;else for(var n=this.t-1;n>=0;--n)i=(e*i+this[n])%t;return i},s.prototype.millerRabin=function(t){var e=this.subtract(s.ONE),i=e.getLowestSetBit();if(i<=0)return!1;var n=e.shiftRight(i);(t=t+1>>1)>X.length&&(t=X.length);for(var r=l(),o=0;o<t;++o){r.fromInt(X[Math.floor(Math.random()*X.length)]);var p=r.modPow(n,this);if(0!=p.compareTo(s.ONE)&&0!=p.compareTo(e)){for(var h=1;h++<i&&0!=p.compareTo(e);)if(0==(p=p.modPowInt(2,this)).compareTo(s.ONE))return!1;if(0!=p.compareTo(e))return!1}}return!0},s.prototype.clone=function(){var t=l();return this.copyTo(t),t},s.prototype.intValue=function(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]},s.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24},s.prototype.shortValue=function(){return 0==this.t?this.s:this[0]<<16>>16},s.prototype.signum=function(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1},s.prototype.toByteArray=function(){var t=this.t,e=new Array;e[0]=this.s;var i,n=this.DB-t*this.DB%8,r=0;if(t-- >0)for(n<this.DB&&(i=this[t]>>n)!=(this.s&this.DM)>>n&&(e[r++]=i|this.s<<this.DB-n);t>=0;)n<8?(i=(this[t]&(1<<n)-1)<<8-n,i|=this[--t]>>(n+=this.DB-8)):(i=this[t]>>(n-=8)&255,n<=0&&(n+=this.DB,--t)),0!=(128&i)&&(i|=-256),0==r&&(128&this.s)!=(128&i)&&++r,(r>0||i!=this.s)&&(e[r++]=i);return e},s.prototype.equals=function(t){return 0==this.compareTo(t)},s.prototype.min=function(t){return this.compareTo(t)<0?this:t},s.prototype.max=function(t){return this.compareTo(t)>0?this:t},s.prototype.and=function(t){var e=l();return this.bitwiseTo(t,v,e),e},s.prototype.or=function(t){var e=l();return this.bitwiseTo(t,C,e),e},s.prototype.xor=function(t){var e=l();return this.bitwiseTo(t,I,e),e},s.prototype.andNot=function(t){var e=l();return this.bitwiseTo(t,_,e),e},s.prototype.not=function(){for(var t=l(),e=0;e<this.t;++e)t[e]=this.DM&~this[e];return t.t=this.t,t.s=~this.s,t},s.prototype.shiftLeft=function(t){var e=l();return t<0?this.rShiftTo(-t,e):this.lShiftTo(t,e),e},s.prototype.shiftRight=function(t){var e=l();return t<0?this.lShiftTo(-t,e):this.rShiftTo(t,e),e},s.prototype.getLowestSetBit=function(){for(var t=0;t<this.t;++t)if(0!=this[t])return t*this.DB+x(this[t]);return this.s<0?this.t*this.DB:-1},s.prototype.bitCount=function(){for(var t=0,e=this.s&this.DM,i=0;i<this.t;++i)t+=E(this[i]^e);return t},s.prototype.testBit=function(t){var e=Math.floor(t/this.DB);return e>=this.t?0!=this.s:0!=(this[e]&1<<t%this.DB)},s.prototype.setBit=function(t){return this.changeBit(t,C)},s.prototype.clearBit=function(t){return this.changeBit(t,_)},s.prototype.flipBit=function(t){return this.changeBit(t,I)},s.prototype.add=function(t){var e=l();return this.addTo(t,e),e},s.prototype.subtract=function(t){var e=l();return this.subTo(t,e),e},s.prototype.multiply=function(t){var e=l();return this.multiplyTo(t,e),e},s.prototype.divide=function(t){var e=l();return this.divRemTo(t,e,null),e},s.prototype.remainder=function(t){var e=l();return this.divRemTo(t,null,e),e},s.prototype.divideAndRemainder=function(t){var e=l(),i=l();return this.divRemTo(t,e,i),new Array(e,i)},s.prototype.modPow=function(t,e){var i,n,r=t.bitLength(),o=P(1);if(r<=0)return o;i=r<18?1:r<48?3:r<144?4:r<768?5:6,n=r<8?new y(e):e.isEven()?new T(e):new c(e);var s=new Array,p=3,h=i-1,u=(1<<i)-1;if(s[1]=n.convert(this),i>1){var a=l();for(n.sqrTo(s[1],a);p<=u;)s[p]=l(),n.mulTo(a,s[p-2],s[p]),p+=2}var f,d,v=t.t-1,C=!0,I=l();for(r=m(t[v])-1;v>=0;){for(r>=h?f=t[v]>>r-h&u:(f=(t[v]&(1<<r+1)-1)<<h-r,v>0&&(f|=t[v-1]>>this.DB+r-h)),p=i;0==(1&f);)f>>=1,--p;if((r-=p)<0&&(r+=this.DB,--v),C)s[f].copyTo(o),C=!1;else{for(;p>1;)n.sqrTo(o,I),n.sqrTo(I,o),p-=2;p>0?n.sqrTo(o,I):(d=o,o=I,I=d),n.mulTo(I,s[f],o)}for(;v>=0&&0==(t[v]&1<<r);)n.sqrTo(o,I),d=o,o=I,I=d,--r<0&&(r=this.DB-1,--v)}return n.revert(o)},s.prototype.modInverse=function(t){var e=t.isEven();if(this.isEven()&&e||0==t.signum())return s.ZERO;for(var i=t.clone(),n=this.clone(),r=P(1),o=P(0),l=P(0),p=P(1);0!=i.signum();){for(;i.isEven();)i.rShiftTo(1,i),e?(r.isEven()&&o.isEven()||(r.addTo(this,r),o.subTo(t,o)),r.rShiftTo(1,r)):o.isEven()||o.subTo(t,o),o.rShiftTo(1,o);for(;n.isEven();)n.rShiftTo(1,n),e?(l.isEven()&&p.isEven()||(l.addTo(this,l),p.subTo(t,p)),l.rShiftTo(1,l)):p.isEven()||p.subTo(t,p),p.rShiftTo(1,p);i.compareTo(n)>=0?(i.subTo(n,i),e&&r.subTo(l,r),o.subTo(p,o)):(n.subTo(i,n),e&&l.subTo(r,l),p.subTo(o,p))}return 0!=n.compareTo(s.ONE)?s.ZERO:p.compareTo(t)>=0?p.subtract(t):p.signum()<0?(p.addTo(t,p),p.signum()<0?p.add(t):p):p},s.prototype.pow=function(t){return this.exp(t,new L)},s.prototype.gcd=function(t){var e=this.s<0?this.negate():this.clone(),i=t.s<0?t.negate():t.clone();if(e.compareTo(i)<0){var n=e;e=i,i=n}var r=e.getLowestSetBit(),o=i.getLowestSetBit();if(o<0)return e;for(r<o&&(o=r),o>0&&(e.rShiftTo(o,e),i.rShiftTo(o,i));e.signum()>0;)(r=e.getLowestSetBit())>0&&e.rShiftTo(r,e),(r=i.getLowestSetBit())>0&&i.rShiftTo(r,i),e.compareTo(i)>=0?(e.subTo(i,e),e.rShiftTo(1,e)):(i.subTo(e,i),i.rShiftTo(1,i));return o>0&&i.lShiftTo(o,i),i},s.prototype.isProbablePrime=function(t){var e,i=this.abs();if(1==i.t&&i[0]<=X[X.length-1]){for(e=0;e<X.length;++e)if(i[0]==X[e])return!0;return!1}if(i.isEven())return!1;for(e=1;e<X.length;){for(var n=X[e],r=e+1;r<X.length&&n<N;)n*=X[r++];for(n=i.modInt(n);e<r;)if(n%X[e++]==0)return!1}return i.millerRabin(t)},s.prototype.square=function(){var t=l();return this.squareTo(t),t};var O=s;if(O.prototype.IsNegative=function(){return-1==this.compareTo(O.ZERO)},O.op_Equality=function(t,e){return 0==t.compareTo(e)},O.op_Inequality=function(t,e){return 0!=t.compareTo(e)},O.op_GreaterThan=function(t,e){return t.compareTo(e)>0},O.op_LessThan=function(t,e){return t.compareTo(e)<0},O.op_Addition=function(t,e){return new O(t).add(new O(e))},O.op_Subtraction=function(t,e){return new O(t).subtract(new O(e))},O.Int128Mul=function(t,e){return new O(t).multiply(new O(e))},O.op_Division=function(t,e){return t.divide(e)},O.prototype.ToDouble=function(){return parseFloat(this.toString())},void 0===Y)var Y=function(t,e){var i;if(void 0===Object.getOwnPropertyNames){for(i in e.prototype)void 0!==t.prototype[i]&&t.prototype[i]!=Object.prototype[i]||(t.prototype[i]=e.prototype[i]);for(i in e)void 0===t[i]&&(t[i]=e[i]);t.$baseCtor=e}else{for(var n=Object.getOwnPropertyNames(e.prototype),r=0;r<n.length;r++)void 0===Object.getOwnPropertyDescriptor(t.prototype,n[r])&&Object.defineProperty(t.prototype,n[r],Object.getOwnPropertyDescriptor(e.prototype,n[r]));for(i in e)void 0===t[i]&&(t[i]=e[i]);t.$baseCtor=e}};e.Path=function(){return[]},e.Paths=function(){return[]},e.DoublePoint=function(){var t=arguments;this.X=0,this.Y=0,1==t.length?(this.X=t[0].X,this.Y=t[0].Y):2==t.length&&(this.X=t[0],this.Y=t[1])},e.DoublePoint0=function(){this.X=0,this.Y=0},e.DoublePoint1=function(t){this.X=t.X,this.Y=t.Y},e.DoublePoint2=function(t,e){this.X=t,this.Y=e},e.PolyNode=function(){this.m_Parent=null,this.m_polygon=new e.Path,this.m_Index=0,this.m_jointype=0,this.m_endtype=0,this.m_Childs=[],this.IsOpen=!1},e.PolyNode.prototype.IsHoleNode=function(){for(var t=!0,e=this.m_Parent;null!==e;)t=!t,e=e.m_Parent;return t},e.PolyNode.prototype.ChildCount=function(){return this.m_Childs.length},e.PolyNode.prototype.Contour=function(){return this.m_polygon},e.PolyNode.prototype.AddChild=function(t){var e=this.m_Childs.length;this.m_Childs.push(t),t.m_Parent=this,t.m_Index=e},e.PolyNode.prototype.GetNext=function(){return this.m_Childs.length>0?this.m_Childs[0]:this.GetNextSiblingUp()},e.PolyNode.prototype.GetNextSiblingUp=function(){return null===this.m_Parent?null:this.m_Index==this.m_Parent.m_Childs.length-1?this.m_Parent.GetNextSiblingUp():this.m_Parent.m_Childs[this.m_Index+1]},e.PolyNode.prototype.Childs=function(){return this.m_Childs},e.PolyNode.prototype.Parent=function(){return this.m_Parent},e.PolyNode.prototype.IsHole=function(){return this.IsHoleNode()},e.PolyTree=function(){this.m_AllPolys=[],e.PolyNode.call(this)},e.PolyTree.prototype.Clear=function(){for(var t=0,e=this.m_AllPolys.length;t<e;t++)this.m_AllPolys[t]=null;this.m_AllPolys.length=0,this.m_Childs.length=0},e.PolyTree.prototype.GetFirst=function(){return this.m_Childs.length>0?this.m_Childs[0]:null},e.PolyTree.prototype.Total=function(){return this.m_AllPolys.length},Y(e.PolyTree,e.PolyNode),e.Math_Abs_Int64=e.Math_Abs_Int32=e.Math_Abs_Double=function(t){return Math.abs(t)},e.Math_Max_Int32_Int32=function(t,e){return Math.max(t,e)},o.msie||o.opera||o.safari?e.Cast_Int32=function(t){return 0|t}:e.Cast_Int32=function(t){return~~t},o.chrome?e.Cast_Int64=function(t){return t<-2147483648||t>2147483647?t<0?Math.ceil(t):Math.floor(t):~~t}:o.firefox&&"function"==typeof Number.toInteger?e.Cast_Int64=function(t){return Number.toInteger(t)}:o.msie7||o.msie8?e.Cast_Int64=function(t){return parseInt(t,10)}:o.msie?e.Cast_Int64=function(t){return t<-2147483648||t>2147483647?t<0?Math.ceil(t):Math.floor(t):0|t}:e.Cast_Int64=function(t){return t<0?Math.ceil(t):Math.floor(t)},e.Clear=function(t){t.length=0},e.PI=3.141592653589793,e.PI2=6.283185307179586,e.IntPoint=function(){var t=arguments,i=t.length;if(this.X=0,this.Y=0,2==i)this.X=t[0],this.Y=t[1];else if(1==i)if(t[0]instanceof e.DoublePoint){var n=t[0];this.X=e.Clipper.Round(n.X),this.Y=e.Clipper.Round(n.Y)}else{var r=t[0];this.X=r.X,this.Y=r.Y}else this.X=0,this.Y=0},e.IntPoint.op_Equality=function(t,e){return t.X==e.X&&t.Y==e.Y},e.IntPoint.op_Inequality=function(t,e){return t.X!=e.X||t.Y!=e.Y},e.IntPoint0=function(){this.X=0,this.Y=0},e.IntPoint1=function(t){this.X=t.X,this.Y=t.Y},e.IntPoint1dp=function(t){this.X=e.Clipper.Round(t.X),this.Y=e.Clipper.Round(t.Y)},e.IntPoint2=function(t,e){this.X=t,this.Y=e},e.IntRect=function(){var t=arguments,e=t.length;4==e?(this.left=t[0],this.top=t[1],this.right=t[2],this.bottom=t[3]):1==e?(this.left=ir.left,this.top=ir.top,this.right=ir.right,this.bottom=ir.bottom):(this.left=0,this.top=0,this.right=0,this.bottom=0)},e.IntRect0=function(){this.left=0,this.top=0,this.right=0,this.bottom=0},e.IntRect1=function(t){this.left=t.left,this.top=t.top,this.right=t.right,this.bottom=t.bottom},e.IntRect4=function(t,e,i,n){this.left=t,this.top=e,this.right=i,this.bottom=n},e.ClipType={ctIntersection:0,ctUnion:1,ctDifference:2,ctXor:3},e.PolyType={ptSubject:0,ptClip:1},e.PolyFillType={pftEvenOdd:0,pftNonZero:1,pftPositive:2,pftNegative:3},e.JoinType={jtSquare:0,jtRound:1,jtMiter:2},e.EndType={etOpenSquare:0,etOpenRound:1,etOpenButt:2,etClosedLine:3,etClosedPolygon:4},e.EdgeSide={esLeft:0,esRight:1},e.Direction={dRightToLeft:0,dLeftToRight:1},e.TEdge=function(){this.Bot=new e.IntPoint,this.Curr=new e.IntPoint,this.Top=new e.IntPoint,this.Delta=new e.IntPoint,this.Dx=0,this.PolyTyp=e.PolyType.ptSubject,this.Side=e.EdgeSide.esLeft,this.WindDelta=0,this.WindCnt=0,this.WindCnt2=0,this.OutIdx=0,this.Next=null,this.Prev=null,this.NextInLML=null,this.NextInAEL=null,this.PrevInAEL=null,this.NextInSEL=null,this.PrevInSEL=null},e.IntersectNode=function(){this.Edge1=null,this.Edge2=null,this.Pt=new e.IntPoint},e.MyIntersectNodeSort=function(){},e.MyIntersectNodeSort.Compare=function(t,e){return e.Pt.Y-t.Pt.Y},e.LocalMinima=function(){this.Y=0,this.LeftBound=null,this.RightBound=null,this.Next=null},e.Scanbeam=function(){this.Y=0,this.Next=null},e.OutRec=function(){this.Idx=0,this.IsHole=!1,this.IsOpen=!1,this.FirstLeft=null,this.Pts=null,this.BottomPt=null,this.PolyNode=null},e.OutPt=function(){this.Idx=0,this.Pt=new e.IntPoint,this.Next=null,this.Prev=null},e.Join=function(){this.OutPt1=null,this.OutPt2=null,this.OffPt=new e.IntPoint},e.ClipperBase=function(){this.m_MinimaList=null,this.m_CurrentLM=null,this.m_edges=new Array,this.m_UseFullRange=!1,this.m_HasOpenPaths=!1,this.PreserveCollinear=!1,this.m_MinimaList=null,this.m_CurrentLM=null,this.m_UseFullRange=!1,this.m_HasOpenPaths=!1},e.ClipperBase.horizontal=-9007199254740992,e.ClipperBase.Skip=-2,e.ClipperBase.Unassigned=-1,e.ClipperBase.tolerance=1e-20,e.ClipperBase.loRange=47453132,e.ClipperBase.hiRange=0xfffffffffffff,e.ClipperBase.near_zero=function(t){return t>-e.ClipperBase.tolerance&&t<e.ClipperBase.tolerance},e.ClipperBase.IsHorizontal=function(t){return 0===t.Delta.Y},e.ClipperBase.prototype.PointIsVertex=function(t,i){var n=i;do{if(e.IntPoint.op_Equality(n.Pt,t))return!0;n=n.Next}while(n!=i);return!1},e.ClipperBase.prototype.PointOnLineSegment=function(t,e,i,n){return n?t.X==e.X&&t.Y==e.Y||t.X==i.X&&t.Y==i.Y||t.X>e.X==t.X<i.X&&t.Y>e.Y==t.Y<i.Y&&O.op_Equality(O.Int128Mul(t.X-e.X,i.Y-e.Y),O.Int128Mul(i.X-e.X,t.Y-e.Y)):t.X==e.X&&t.Y==e.Y||t.X==i.X&&t.Y==i.Y||t.X>e.X==t.X<i.X&&t.Y>e.Y==t.Y<i.Y&&(t.X-e.X)*(i.Y-e.Y)==(i.X-e.X)*(t.Y-e.Y)},e.ClipperBase.prototype.PointOnPolygon=function(t,e,i){for(var n=e;;){if(this.PointOnLineSegment(t,n.Pt,n.Next.Pt,i))return!0;if((n=n.Next)==e)break}return!1},e.ClipperBase.prototype.SlopesEqual=e.ClipperBase.SlopesEqual=function(){var t,i,n,r,o,s,l=arguments,p=l.length;return 3==p?(t=l[0],i=l[1],l[2]?O.op_Equality(O.Int128Mul(t.Delta.Y,i.Delta.X),O.Int128Mul(t.Delta.X,i.Delta.Y)):e.Cast_Int64(t.Delta.Y*i.Delta.X)==e.Cast_Int64(t.Delta.X*i.Delta.Y)):4==p?(n=l[0],r=l[1],o=l[2],l[3]?O.op_Equality(O.Int128Mul(n.Y-r.Y,r.X-o.X),O.Int128Mul(n.X-r.X,r.Y-o.Y)):e.Cast_Int64((n.Y-r.Y)*(r.X-o.X))-e.Cast_Int64((n.X-r.X)*(r.Y-o.Y))==0):(n=l[0],r=l[1],o=l[2],s=l[3],l[4]?O.op_Equality(O.Int128Mul(n.Y-r.Y,o.X-s.X),O.Int128Mul(n.X-r.X,o.Y-s.Y)):e.Cast_Int64((n.Y-r.Y)*(o.X-s.X))-e.Cast_Int64((n.X-r.X)*(o.Y-s.Y))==0)},e.ClipperBase.SlopesEqual3=function(t,i,n){return n?O.op_Equality(O.Int128Mul(t.Delta.Y,i.Delta.X),O.Int128Mul(t.Delta.X,i.Delta.Y)):e.Cast_Int64(t.Delta.Y*i.Delta.X)==e.Cast_Int64(t.Delta.X*i.Delta.Y)},e.ClipperBase.SlopesEqual4=function(t,i,n,r){return r?O.op_Equality(O.Int128Mul(t.Y-i.Y,i.X-n.X),O.Int128Mul(t.X-i.X,i.Y-n.Y)):e.Cast_Int64((t.Y-i.Y)*(i.X-n.X))-e.Cast_Int64((t.X-i.X)*(i.Y-n.Y))==0},e.ClipperBase.SlopesEqual5=function(t,i,n,r,o){return o?O.op_Equality(O.Int128Mul(t.Y-i.Y,n.X-r.X),O.Int128Mul(t.X-i.X,n.Y-r.Y)):e.Cast_Int64((t.Y-i.Y)*(n.X-r.X))-e.Cast_Int64((t.X-i.X)*(n.Y-r.Y))==0},e.ClipperBase.prototype.Clear=function(){this.DisposeLocalMinimaList();for(var t=0,i=this.m_edges.length;t<i;++t){for(var n=0,r=this.m_edges[t].length;n<r;++n)this.m_edges[t][n]=null;e.Clear(this.m_edges[t])}e.Clear(this.m_edges),this.m_UseFullRange=!1,this.m_HasOpenPaths=!1},e.ClipperBase.prototype.DisposeLocalMinimaList=function(){for(;null!==this.m_MinimaList;){var t=this.m_MinimaList.Next;this.m_MinimaList=null,this.m_MinimaList=t}this.m_CurrentLM=null},e.ClipperBase.prototype.RangeTest=function(t,i){i.Value?(t.X>e.ClipperBase.hiRange||t.Y>e.ClipperBase.hiRange||-t.X>e.ClipperBase.hiRange||-t.Y>e.ClipperBase.hiRange)&&e.Error("Coordinate outside allowed range in RangeTest()."):(t.X>e.ClipperBase.loRange||t.Y>e.ClipperBase.loRange||-t.X>e.ClipperBase.loRange||-t.Y>e.ClipperBase.loRange)&&(i.Value=!0,this.RangeTest(t,i))},e.ClipperBase.prototype.InitEdge=function(t,e,i,n){t.Next=e,t.Prev=i,t.Curr.X=n.X,t.Curr.Y=n.Y,t.OutIdx=-1},e.ClipperBase.prototype.InitEdge2=function(t,e){t.Curr.Y>=t.Next.Curr.Y?(t.Bot.X=t.Curr.X,t.Bot.Y=t.Curr.Y,t.Top.X=t.Next.Curr.X,t.Top.Y=t.Next.Curr.Y):(t.Top.X=t.Curr.X,t.Top.Y=t.Curr.Y,t.Bot.X=t.Next.Curr.X,t.Bot.Y=t.Next.Curr.Y),this.SetDx(t),t.PolyTyp=e},e.ClipperBase.prototype.FindNextLocMin=function(t){for(var i;;){for(;e.IntPoint.op_Inequality(t.Bot,t.Prev.Bot)||e.IntPoint.op_Equality(t.Curr,t.Top);)t=t.Next;if(t.Dx!=e.ClipperBase.horizontal&&t.Prev.Dx!=e.ClipperBase.horizontal)break;for(;t.Prev.Dx==e.ClipperBase.horizontal;)t=t.Prev;for(i=t;t.Dx==e.ClipperBase.horizontal;)t=t.Next;if(t.Top.Y!=t.Prev.Bot.Y){i.Prev.Bot.X<t.Bot.X&&(t=i);break}}return t},e.ClipperBase.prototype.ProcessBound=function(t,i){var n,r,o=t,s=t;if(t.Dx==e.ClipperBase.horizontal&&(r=i?t.Prev.Bot.X:t.Next.Bot.X,t.Bot.X!=r&&this.ReverseHorizontal(t)),s.OutIdx!=e.ClipperBase.Skip)if(i){for(;s.Top.Y==s.Next.Bot.Y&&s.Next.OutIdx!=e.ClipperBase.Skip;)s=s.Next;if(s.Dx==e.ClipperBase.horizontal&&s.Next.OutIdx!=e.ClipperBase.Skip){for(n=s;n.Prev.Dx==e.ClipperBase.horizontal;)n=n.Prev;n.Prev.Top.X==s.Next.Top.X?i||(s=n.Prev):n.Prev.Top.X>s.Next.Top.X&&(s=n.Prev)}for(;t!=s;)t.NextInLML=t.Next,t.Dx==e.ClipperBase.horizontal&&t!=o&&t.Bot.X!=t.Prev.Top.X&&this.ReverseHorizontal(t),t=t.Next;t.Dx==e.ClipperBase.horizontal&&t!=o&&t.Bot.X!=t.Prev.Top.X&&this.ReverseHorizontal(t),s=s.Next}else{for(;s.Top.Y==s.Prev.Bot.Y&&s.Prev.OutIdx!=e.ClipperBase.Skip;)s=s.Prev;if(s.Dx==e.ClipperBase.horizontal&&s.Prev.OutIdx!=e.ClipperBase.Skip){for(n=s;n.Next.Dx==e.ClipperBase.horizontal;)n=n.Next;n.Next.Top.X==s.Prev.Top.X?i||(s=n.Next):n.Next.Top.X>s.Prev.Top.X&&(s=n.Next)}for(;t!=s;)t.NextInLML=t.Prev,t.Dx==e.ClipperBase.horizontal&&t!=o&&t.Bot.X!=t.Next.Top.X&&this.ReverseHorizontal(t),t=t.Prev;t.Dx==e.ClipperBase.horizontal&&t!=o&&t.Bot.X!=t.Next.Top.X&&this.ReverseHorizontal(t),s=s.Prev}if(s.OutIdx==e.ClipperBase.Skip){if(t=s,i){for(;t.Top.Y==t.Next.Bot.Y;)t=t.Next;for(;t!=s&&t.Dx==e.ClipperBase.horizontal;)t=t.Prev}else{for(;t.Top.Y==t.Prev.Bot.Y;)t=t.Prev;for(;t!=s&&t.Dx==e.ClipperBase.horizontal;)t=t.Next}if(t==s)s=i?t.Next:t.Prev;else{t=i?s.Next:s.Prev;var l=new e.LocalMinima;l.Next=null,l.Y=t.Bot.Y,l.LeftBound=null,l.RightBound=t,l.RightBound.WindDelta=0,s=this.ProcessBound(l.RightBound,i),this.InsertLocalMinima(l)}}return s},e.ClipperBase.prototype.AddPath=function(t,i,n){n||i!=e.PolyType.ptClip||e.Error("AddPath: Open paths must be subject.");var r=t.length-1;if(n)for(;r>0&&e.IntPoint.op_Equality(t[r],t[0]);)--r;for(;r>0&&e.IntPoint.op_Equality(t[r],t[r-1]);)--r;if(n&&r<2||!n&&r<1)return!1;for(var o=new Array,s=0;s<=r;s++)o.push(new e.TEdge);var l=!0;o[1].Curr.X=t[1].X,o[1].Curr.Y=t[1].Y;var p={Value:this.m_UseFullRange};this.RangeTest(t[0],p),this.m_UseFullRange=p.Value,p.Value=this.m_UseFullRange,this.RangeTest(t[r],p),this.m_UseFullRange=p.Value,this.InitEdge(o[0],o[1],o[r],t[0]),this.InitEdge(o[r],o[0],o[r-1],t[r]);for(s=r-1;s>=1;--s)p.Value=this.m_UseFullRange,this.RangeTest(t[s],p),this.m_UseFullRange=p.Value,this.InitEdge(o[s],o[s+1],o[s-1],t[s]);for(var h=o[0],u=h,a=h;;)if(!e.IntPoint.op_Equality(u.Curr,u.Next.Curr)||!n&&u.Next==h){if(u.Prev==u.Next)break;if(!n||!e.ClipperBase.SlopesEqual(u.Prev.Curr,u.Curr,u.Next.Curr,this.m_UseFullRange)||this.PreserveCollinear&&this.Pt2IsBetweenPt1AndPt3(u.Prev.Curr,u.Curr,u.Next.Curr)){if((u=u.Next)==a)break}else u==h&&(h=u.Next),a=u=(u=this.RemoveEdge(u)).Prev}else{if(u==u.Next)break;u!=h||n||(h=u.Next),a=u=this.RemoveEdge(u)}if(!n&&u==u.Next||n&&u.Prev==u.Next)return!1;n||(this.m_HasOpenPaths=!0,h.Prev.OutIdx=e.ClipperBase.Skip);var f;u=h;do{this.InitEdge2(u,i),u=u.Next,l&&u.Curr.Y!=h.Curr.Y&&(l=!1)}while(u!=h);if(l){if(n)return!1;for(u.Prev.OutIdx=e.ClipperBase.Skip,u.Prev.Bot.X<u.Prev.Top.X&&this.ReverseHorizontal(u.Prev),(P=new e.LocalMinima).Next=null,P.Y=u.Bot.Y,P.LeftBound=null,P.RightBound=u,P.RightBound.Side=e.EdgeSide.esRight,P.RightBound.WindDelta=0;u.Next.OutIdx!=e.ClipperBase.Skip;)u.NextInLML=u.Next,u.Bot.X!=u.Prev.Top.X&&this.ReverseHorizontal(u),u=u.Next;return this.InsertLocalMinima(P),this.m_edges.push(o),!0}this.m_edges.push(o);for(var d=null;(u=this.FindNextLocMin(u))!=d;){var P;null==d&&(d=u),(P=new e.LocalMinima).Next=null,P.Y=u.Bot.Y,u.Dx<u.Prev.Dx?(P.LeftBound=u.Prev,P.RightBound=u,f=!1):(P.LeftBound=u,P.RightBound=u.Prev,f=!0),P.LeftBound.Side=e.EdgeSide.esLeft,P.RightBound.Side=e.EdgeSide.esRight,n?P.LeftBound.Next==P.RightBound?P.LeftBound.WindDelta=-1:P.LeftBound.WindDelta=1:P.LeftBound.WindDelta=0,P.RightBound.WindDelta=-P.LeftBound.WindDelta,u=this.ProcessBound(P.LeftBound,f);var m=this.ProcessBound(P.RightBound,!f);P.LeftBound.OutIdx==e.ClipperBase.Skip?P.LeftBound=null:P.RightBound.OutIdx==e.ClipperBase.Skip&&(P.RightBound=null),this.InsertLocalMinima(P),f||(u=m)}return!0},e.ClipperBase.prototype.AddPaths=function(t,e,i){for(var n=!1,r=0,o=t.length;r<o;++r)this.AddPath(t[r],e,i)&&(n=!0);return n},e.ClipperBase.prototype.Pt2IsBetweenPt1AndPt3=function(t,i,n){return!(e.IntPoint.op_Equality(t,n)||e.IntPoint.op_Equality(t,i)||e.IntPoint.op_Equality(n,i))&&(t.X!=n.X?i.X>t.X==i.X<n.X:i.Y>t.Y==i.Y<n.Y)},e.ClipperBase.prototype.RemoveEdge=function(t){t.Prev.Next=t.Next,t.Next.Prev=t.Prev;var e=t.Next;return t.Prev=null,e},e.ClipperBase.prototype.SetDx=function(t){t.Delta.X=t.Top.X-t.Bot.X,t.Delta.Y=t.Top.Y-t.Bot.Y,0===t.Delta.Y?t.Dx=e.ClipperBase.horizontal:t.Dx=t.Delta.X/t.Delta.Y},e.ClipperBase.prototype.InsertLocalMinima=function(t){if(null===this.m_MinimaList)this.m_MinimaList=t;else if(t.Y>=this.m_MinimaList.Y)t.Next=this.m_MinimaList,this.m_MinimaList=t;else{for(var e=this.m_MinimaList;null!==e.Next&&t.Y<e.Next.Y;)e=e.Next;t.Next=e.Next,e.Next=t}},e.ClipperBase.prototype.PopLocalMinima=function(){null!==this.m_CurrentLM&&(this.m_CurrentLM=this.m_CurrentLM.Next)},e.ClipperBase.prototype.ReverseHorizontal=function(t){var e=t.Top.X;t.Top.X=t.Bot.X,t.Bot.X=e},e.ClipperBase.prototype.Reset=function(){if(this.m_CurrentLM=this.m_MinimaList,null!=this.m_CurrentLM)for(var t=this.m_MinimaList;null!=t;){var i=t.LeftBound;null!=i&&(i.Curr.X=i.Bot.X,i.Curr.Y=i.Bot.Y,i.Side=e.EdgeSide.esLeft,i.OutIdx=e.ClipperBase.Unassigned),null!=(i=t.RightBound)&&(i.Curr.X=i.Bot.X,i.Curr.Y=i.Bot.Y,i.Side=e.EdgeSide.esRight,i.OutIdx=e.ClipperBase.Unassigned),t=t.Next}},e.Clipper=function(t){void 0===t&&(t=0),this.m_PolyOuts=null,this.m_ClipType=e.ClipType.ctIntersection,this.m_Scanbeam=null,this.m_ActiveEdges=null,this.m_SortedEdges=null,this.m_IntersectList=null,this.m_IntersectNodeComparer=null,this.m_ExecuteLocked=!1,this.m_ClipFillType=e.PolyFillType.pftEvenOdd,this.m_SubjFillType=e.PolyFillType.pftEvenOdd,this.m_Joins=null,this.m_GhostJoins=null,this.m_UsingPolyTree=!1,this.ReverseSolution=!1,this.StrictlySimple=!1,e.ClipperBase.call(this),this.m_Scanbeam=null,this.m_ActiveEdges=null,this.m_SortedEdges=null,this.m_IntersectList=new Array,this.m_IntersectNodeComparer=e.MyIntersectNodeSort.Compare,this.m_ExecuteLocked=!1,this.m_UsingPolyTree=!1,this.m_PolyOuts=new Array,this.m_Joins=new Array,this.m_GhostJoins=new Array,this.ReverseSolution=0!=(1&t),this.StrictlySimple=0!=(2&t),this.PreserveCollinear=0!=(4&t)},e.Clipper.ioReverseSolution=1,e.Clipper.ioStrictlySimple=2,e.Clipper.ioPreserveCollinear=4,e.Clipper.prototype.Clear=function(){0!==this.m_edges.length&&(this.DisposeAllPolyPts(),e.ClipperBase.prototype.Clear.call(this))},e.Clipper.prototype.DisposeScanbeamList=function(){for(;null!==this.m_Scanbeam;){var t=this.m_Scanbeam.Next;this.m_Scanbeam=null,this.m_Scanbeam=t}},e.Clipper.prototype.Reset=function(){e.ClipperBase.prototype.Reset.call(this),this.m_Scanbeam=null,this.m_ActiveEdges=null,this.m_SortedEdges=null;for(var t=this.m_MinimaList;null!==t;)this.InsertScanbeam(t.Y),t=t.Next},e.Clipper.prototype.InsertScanbeam=function(t){if(null===this.m_Scanbeam)this.m_Scanbeam=new e.Scanbeam,this.m_Scanbeam.Next=null,this.m_Scanbeam.Y=t;else if(t>this.m_Scanbeam.Y){(n=new e.Scanbeam).Y=t,n.Next=this.m_Scanbeam,this.m_Scanbeam=n}else{for(var i=this.m_Scanbeam;null!==i.Next&&t<=i.Next.Y;)i=i.Next;if(t==i.Y)return;var n;(n=new e.Scanbeam).Y=t,n.Next=i.Next,i.Next=n}},e.Clipper.prototype.Execute=function(){var t=arguments,i=t.length,n=t[1]instanceof e.PolyTree;if(4==i&&!n){var r=t[0],o=t[1],s=t[2],l=t[3];if(this.m_ExecuteLocked)return!1;this.m_HasOpenPaths&&e.Error("Error: PolyTree struct is need for open path clipping."),this.m_ExecuteLocked=!0,e.Clear(o),this.m_SubjFillType=s,this.m_ClipFillType=l,this.m_ClipType=r,this.m_UsingPolyTree=!1;try{(h=this.ExecuteInternal())&&this.BuildResult(o)}finally{this.DisposeAllPolyPts(),this.m_ExecuteLocked=!1}return h}if(4==i&&n){r=t[0];var p=t[1];s=t[2],l=t[3];if(this.m_ExecuteLocked)return!1;this.m_ExecuteLocked=!0,this.m_SubjFillType=s,this.m_ClipFillType=l,this.m_ClipType=r,this.m_UsingPolyTree=!0;try{var h;(h=this.ExecuteInternal())&&this.BuildResult2(p)}finally{this.DisposeAllPolyPts(),this.m_ExecuteLocked=!1}return h}if(2==i&&!n){r=t[0],o=t[1];return this.Execute(r,o,e.PolyFillType.pftEvenOdd,e.PolyFillType.pftEvenOdd)}if(2==i&&n){r=t[0],p=t[1];return this.Execute(r,p,e.PolyFillType.pftEvenOdd,e.PolyFillType.pftEvenOdd)}},e.Clipper.prototype.FixHoleLinkage=function(t){if(null!==t.FirstLeft&&(t.IsHole==t.FirstLeft.IsHole||null===t.FirstLeft.Pts)){for(var e=t.FirstLeft;null!==e&&(e.IsHole==t.IsHole||null===e.Pts);)e=e.FirstLeft;t.FirstLeft=e}},e.Clipper.prototype.ExecuteInternal=function(){try{if(this.Reset(),null===this.m_CurrentLM)return!1;var t=this.PopScanbeam();do{if(this.InsertLocalMinimaIntoAEL(t),e.Clear(this.m_GhostJoins),this.ProcessHorizontals(!1),null===this.m_Scanbeam)break;var i=this.PopScanbeam();if(!this.ProcessIntersections(t,i))return!1;this.ProcessEdgesAtTopOfScanbeam(i),t=i}while(null!==this.m_Scanbeam||null!==this.m_CurrentLM);for(var n=0,r=this.m_PolyOuts.length;n<r;n++){null===(o=this.m_PolyOuts[n]).Pts||o.IsOpen||(o.IsHole^this.ReverseSolution)==this.Area(o)>0&&this.ReversePolyPtLinks(o.Pts)}this.JoinCommonEdges();for(n=0,r=this.m_PolyOuts.length;n<r;n++){var o;null===(o=this.m_PolyOuts[n]).Pts||o.IsOpen||this.FixupOutPolygon(o)}return this.StrictlySimple&&this.DoSimplePolygons(),!0}finally{e.Clear(this.m_Joins),e.Clear(this.m_GhostJoins)}},e.Clipper.prototype.PopScanbeam=function(){var t=this.m_Scanbeam.Y;this.m_Scanbeam;return this.m_Scanbeam=this.m_Scanbeam.Next,null,t},e.Clipper.prototype.DisposeAllPolyPts=function(){for(var t=0,i=this.m_PolyOuts.length;t<i;++t)this.DisposeOutRec(t);e.Clear(this.m_PolyOuts)},e.Clipper.prototype.DisposeOutRec=function(t){var e=this.m_PolyOuts[t];null!==e.Pts&&this.DisposeOutPts(e.Pts),e=null,this.m_PolyOuts[t]=null},e.Clipper.prototype.DisposeOutPts=function(t){if(null!==t){for(t.Prev.Next=null;null!==t;)t,t=t.Next,null}},e.Clipper.prototype.AddJoin=function(t,i,n){var r=new e.Join;r.OutPt1=t,r.OutPt2=i,r.OffPt.X=n.X,r.OffPt.Y=n.Y,this.m_Joins.push(r)},e.Clipper.prototype.AddGhostJoin=function(t,i){var n=new e.Join;n.OutPt1=t,n.OffPt.X=i.X,n.OffPt.Y=i.Y,this.m_GhostJoins.push(n)},e.Clipper.prototype.InsertLocalMinimaIntoAEL=function(t){for(;null!==this.m_CurrentLM&&this.m_CurrentLM.Y==t;){var i=this.m_CurrentLM.LeftBound,n=this.m_CurrentLM.RightBound;this.PopLocalMinima();var r=null;if(null===i?(this.InsertEdgeIntoAEL(n,null),this.SetWindingCount(n),this.IsContributing(n)&&(r=this.AddOutPt(n,n.Bot))):null==n?(this.InsertEdgeIntoAEL(i,null),this.SetWindingCount(i),this.IsContributing(i)&&(r=this.AddOutPt(i,i.Bot)),this.InsertScanbeam(i.Top.Y)):(this.InsertEdgeIntoAEL(i,null),this.InsertEdgeIntoAEL(n,i),this.SetWindingCount(i),n.WindCnt=i.WindCnt,n.WindCnt2=i.WindCnt2,this.IsContributing(i)&&(r=this.AddLocalMinPoly(i,n,i.Bot)),this.InsertScanbeam(i.Top.Y)),null!=n&&(e.ClipperBase.IsHorizontal(n)?this.AddEdgeToSEL(n):this.InsertScanbeam(n.Top.Y)),null!=i&&null!=n){if(null!==r&&e.ClipperBase.IsHorizontal(n)&&this.m_GhostJoins.length>0&&0!==n.WindDelta)for(var o=0,s=this.m_GhostJoins.length;o<s;o++){var l=this.m_GhostJoins[o];this.HorzSegmentsOverlap(l.OutPt1.Pt,l.OffPt,n.Bot,n.Top)&&this.AddJoin(l.OutPt1,r,l.OffPt)}if(i.OutIdx>=0&&null!==i.PrevInAEL&&i.PrevInAEL.Curr.X==i.Bot.X&&i.PrevInAEL.OutIdx>=0&&e.ClipperBase.SlopesEqual(i.PrevInAEL,i,this.m_UseFullRange)&&0!==i.WindDelta&&0!==i.PrevInAEL.WindDelta){var p=this.AddOutPt(i.PrevInAEL,i.Bot);this.AddJoin(r,p,i.Top)}if(i.NextInAEL!=n){if(n.OutIdx>=0&&n.PrevInAEL.OutIdx>=0&&e.ClipperBase.SlopesEqual(n.PrevInAEL,n,this.m_UseFullRange)&&0!==n.WindDelta&&0!==n.PrevInAEL.WindDelta){p=this.AddOutPt(n.PrevInAEL,n.Bot);this.AddJoin(r,p,n.Top)}var h=i.NextInAEL;if(null!==h)for(;h!=n;)this.IntersectEdges(n,h,i.Curr,!1),h=h.NextInAEL}}}},e.Clipper.prototype.InsertEdgeIntoAEL=function(t,e){if(null===this.m_ActiveEdges)t.PrevInAEL=null,t.NextInAEL=null,this.m_ActiveEdges=t;else if(null===e&&this.E2InsertsBeforeE1(this.m_ActiveEdges,t))t.PrevInAEL=null,t.NextInAEL=this.m_ActiveEdges,this.m_ActiveEdges.PrevInAEL=t,this.m_ActiveEdges=t;else{for(null===e&&(e=this.m_ActiveEdges);null!==e.NextInAEL&&!this.E2InsertsBeforeE1(e.NextInAEL,t);)e=e.NextInAEL;t.NextInAEL=e.NextInAEL,null!==e.NextInAEL&&(e.NextInAEL.PrevInAEL=t),t.PrevInAEL=e,e.NextInAEL=t}},e.Clipper.prototype.E2InsertsBeforeE1=function(t,i){return i.Curr.X==t.Curr.X?i.Top.Y>t.Top.Y?i.Top.X<e.Clipper.TopX(t,i.Top.Y):t.Top.X>e.Clipper.TopX(i,t.Top.Y):i.Curr.X<t.Curr.X},e.Clipper.prototype.IsEvenOddFillType=function(t){return t.PolyTyp==e.PolyType.ptSubject?this.m_SubjFillType==e.PolyFillType.pftEvenOdd:this.m_ClipFillType==e.PolyFillType.pftEvenOdd},e.Clipper.prototype.IsEvenOddAltFillType=function(t){return t.PolyTyp==e.PolyType.ptSubject?this.m_ClipFillType==e.PolyFillType.pftEvenOdd:this.m_SubjFillType==e.PolyFillType.pftEvenOdd},e.Clipper.prototype.IsContributing=function(t){var i,n;switch(t.PolyTyp==e.PolyType.ptSubject?(i=this.m_SubjFillType,n=this.m_ClipFillType):(i=this.m_ClipFillType,n=this.m_SubjFillType),i){case e.PolyFillType.pftEvenOdd:if(0===t.WindDelta&&1!=t.WindCnt)return!1;break;case e.PolyFillType.pftNonZero:if(1!=Math.abs(t.WindCnt))return!1;break;case e.PolyFillType.pftPositive:if(1!=t.WindCnt)return!1;break;default:if(-1!=t.WindCnt)return!1}switch(this.m_ClipType){case e.ClipType.ctIntersection:switch(n){case e.PolyFillType.pftEvenOdd:case e.PolyFillType.pftNonZero:return 0!==t.WindCnt2;case e.PolyFillType.pftPositive:return t.WindCnt2>0;default:return t.WindCnt2<0}case e.ClipType.ctUnion:switch(n){case e.PolyFillType.pftEvenOdd:case e.PolyFillType.pftNonZero:return 0===t.WindCnt2;case e.PolyFillType.pftPositive:return t.WindCnt2<=0;default:return t.WindCnt2>=0}case e.ClipType.ctDifference:if(t.PolyTyp==e.PolyType.ptSubject)switch(n){case e.PolyFillType.pftEvenOdd:case e.PolyFillType.pftNonZero:return 0===t.WindCnt2;case e.PolyFillType.pftPositive:return t.WindCnt2<=0;default:return t.WindCnt2>=0}else switch(n){case e.PolyFillType.pftEvenOdd:case e.PolyFillType.pftNonZero:return 0!==t.WindCnt2;case e.PolyFillType.pftPositive:return t.WindCnt2>0;default:return t.WindCnt2<0}case e.ClipType.ctXor:if(0!==t.WindDelta)return!0;switch(n){case e.PolyFillType.pftEvenOdd:case e.PolyFillType.pftNonZero:return 0===t.WindCnt2;case e.PolyFillType.pftPositive:return t.WindCnt2<=0;default:return t.WindCnt2>=0}}return!0},e.Clipper.prototype.SetWindingCount=function(t){for(var i=t.PrevInAEL;null!==i&&(i.PolyTyp!=t.PolyTyp||0===i.WindDelta);)i=i.PrevInAEL;if(null===i)t.WindCnt=0===t.WindDelta?1:t.WindDelta,t.WindCnt2=0,i=this.m_ActiveEdges;else if(0===t.WindDelta&&this.m_ClipType!=e.ClipType.ctUnion)t.WindCnt=1,t.WindCnt2=i.WindCnt2,i=i.NextInAEL;else if(this.IsEvenOddFillType(t)){if(0===t.WindDelta){for(var n=!0,r=i.PrevInAEL;null!==r;)r.PolyTyp==i.PolyTyp&&0!==r.WindDelta&&(n=!n),r=r.PrevInAEL;t.WindCnt=n?0:1}else t.WindCnt=t.WindDelta;t.WindCnt2=i.WindCnt2,i=i.NextInAEL}else i.WindCnt*i.WindDelta<0?Math.abs(i.WindCnt)>1?i.WindDelta*t.WindDelta<0?t.WindCnt=i.WindCnt:t.WindCnt=i.WindCnt+t.WindDelta:t.WindCnt=0===t.WindDelta?1:t.WindDelta:0===t.WindDelta?t.WindCnt=i.WindCnt<0?i.WindCnt-1:i.WindCnt+1:i.WindDelta*t.WindDelta<0?t.WindCnt=i.WindCnt:t.WindCnt=i.WindCnt+t.WindDelta,t.WindCnt2=i.WindCnt2,i=i.NextInAEL;if(this.IsEvenOddAltFillType(t))for(;i!=t;)0!==i.WindDelta&&(t.WindCnt2=0===t.WindCnt2?1:0),i=i.NextInAEL;else for(;i!=t;)t.WindCnt2+=i.WindDelta,i=i.NextInAEL},e.Clipper.prototype.AddEdgeToSEL=function(t){null===this.m_SortedEdges?(this.m_SortedEdges=t,t.PrevInSEL=null,t.NextInSEL=null):(t.NextInSEL=this.m_SortedEdges,t.PrevInSEL=null,this.m_SortedEdges.PrevInSEL=t,this.m_SortedEdges=t)},e.Clipper.prototype.CopyAELToSEL=function(){var t=this.m_ActiveEdges;for(this.m_SortedEdges=t;null!==t;)t.PrevInSEL=t.PrevInAEL,t.NextInSEL=t.NextInAEL,t=t.NextInAEL},e.Clipper.prototype.SwapPositionsInAEL=function(t,e){if(t.NextInAEL!=t.PrevInAEL&&e.NextInAEL!=e.PrevInAEL){if(t.NextInAEL==e)null!==(i=e.NextInAEL)&&(i.PrevInAEL=t),null!==(n=t.PrevInAEL)&&(n.NextInAEL=e),e.PrevInAEL=n,e.NextInAEL=t,t.PrevInAEL=e,t.NextInAEL=i;else if(e.NextInAEL==t){null!==(i=t.NextInAEL)&&(i.PrevInAEL=e),null!==(n=e.PrevInAEL)&&(n.NextInAEL=t),t.PrevInAEL=n,t.NextInAEL=e,e.PrevInAEL=t,e.NextInAEL=i}else{var i=t.NextInAEL,n=t.PrevInAEL;t.NextInAEL=e.NextInAEL,null!==t.NextInAEL&&(t.NextInAEL.PrevInAEL=t),t.PrevInAEL=e.PrevInAEL,null!==t.PrevInAEL&&(t.PrevInAEL.NextInAEL=t),e.NextInAEL=i,null!==e.NextInAEL&&(e.NextInAEL.PrevInAEL=e),e.PrevInAEL=n,null!==e.PrevInAEL&&(e.PrevInAEL.NextInAEL=e)}null===t.PrevInAEL?this.m_ActiveEdges=t:null===e.PrevInAEL&&(this.m_ActiveEdges=e)}},e.Clipper.prototype.SwapPositionsInSEL=function(t,e){if(!(null===t.NextInSEL&&null===t.PrevInSEL||null===e.NextInSEL&&null===e.PrevInSEL)){if(t.NextInSEL==e)null!==(i=e.NextInSEL)&&(i.PrevInSEL=t),null!==(n=t.PrevInSEL)&&(n.NextInSEL=e),e.PrevInSEL=n,e.NextInSEL=t,t.PrevInSEL=e,t.NextInSEL=i;else if(e.NextInSEL==t){null!==(i=t.NextInSEL)&&(i.PrevInSEL=e),null!==(n=e.PrevInSEL)&&(n.NextInSEL=t),t.PrevInSEL=n,t.NextInSEL=e,e.PrevInSEL=t,e.NextInSEL=i}else{var i=t.NextInSEL,n=t.PrevInSEL;t.NextInSEL=e.NextInSEL,null!==t.NextInSEL&&(t.NextInSEL.PrevInSEL=t),t.PrevInSEL=e.PrevInSEL,null!==t.PrevInSEL&&(t.PrevInSEL.NextInSEL=t),e.NextInSEL=i,null!==e.NextInSEL&&(e.NextInSEL.PrevInSEL=e),e.PrevInSEL=n,null!==e.PrevInSEL&&(e.PrevInSEL.NextInSEL=e)}null===t.PrevInSEL?this.m_SortedEdges=t:null===e.PrevInSEL&&(this.m_SortedEdges=e)}},e.Clipper.prototype.AddLocalMaxPoly=function(t,e,i){this.AddOutPt(t,i),0==e.WindDelta&&this.AddOutPt(e,i),t.OutIdx==e.OutIdx?(t.OutIdx=-1,e.OutIdx=-1):t.OutIdx<e.OutIdx?this.AppendPolygon(t,e):this.AppendPolygon(e,t)},e.Clipper.prototype.AddLocalMinPoly=function(t,i,n){var r,o,s;if(e.ClipperBase.IsHorizontal(i)||t.Dx>i.Dx?(r=this.AddOutPt(t,n),i.OutIdx=t.OutIdx,t.Side=e.EdgeSide.esLeft,i.Side=e.EdgeSide.esRight,s=(o=t).PrevInAEL==i?i.PrevInAEL:o.PrevInAEL):(r=this.AddOutPt(i,n),t.OutIdx=i.OutIdx,t.Side=e.EdgeSide.esRight,i.Side=e.EdgeSide.esLeft,s=(o=i).PrevInAEL==t?t.PrevInAEL:o.PrevInAEL),null!==s&&s.OutIdx>=0&&e.Clipper.TopX(s,n.Y)==e.Clipper.TopX(o,n.Y)&&e.ClipperBase.SlopesEqual(o,s,this.m_UseFullRange)&&0!==o.WindDelta&&0!==s.WindDelta){var l=this.AddOutPt(s,n);this.AddJoin(r,l,o.Top)}return r},e.Clipper.prototype.CreateOutRec=function(){var t=new e.OutRec;return t.Idx=-1,t.IsHole=!1,t.IsOpen=!1,t.FirstLeft=null,t.Pts=null,t.BottomPt=null,t.PolyNode=null,this.m_PolyOuts.push(t),t.Idx=this.m_PolyOuts.length-1,t},e.Clipper.prototype.AddOutPt=function(t,i){var n=t.Side==e.EdgeSide.esLeft;if(t.OutIdx<0){(o=this.CreateOutRec()).IsOpen=0===t.WindDelta;var r=new e.OutPt;return o.Pts=r,r.Idx=o.Idx,r.Pt.X=i.X,r.Pt.Y=i.Y,r.Next=r,r.Prev=r,o.IsOpen||this.SetHoleState(t,o),t.OutIdx=o.Idx,r}var o,s=(o=this.m_PolyOuts[t.OutIdx]).Pts;return n&&e.IntPoint.op_Equality(i,s.Pt)?s:!n&&e.IntPoint.op_Equality(i,s.Prev.Pt)?s.Prev:((r=new e.OutPt).Idx=o.Idx,r.Pt.X=i.X,r.Pt.Y=i.Y,r.Next=s,r.Prev=s.Prev,r.Prev.Next=r,s.Prev=r,n&&(o.Pts=r),r)},e.Clipper.prototype.SwapPoints=function(t,i){var n=new e.IntPoint(t.Value);t.Value.X=i.Value.X,t.Value.Y=i.Value.Y,i.Value.X=n.X,i.Value.Y=n.Y},e.Clipper.prototype.HorzSegmentsOverlap=function(t,e,i,n){return t.X>i.X==t.X<n.X||(e.X>i.X==e.X<n.X||(i.X>t.X==i.X<e.X||(n.X>t.X==n.X<e.X||(t.X==i.X&&e.X==n.X||t.X==n.X&&e.X==i.X))))},e.Clipper.prototype.InsertPolyPtBetween=function(t,i,n){var r=new e.OutPt;return r.Pt.X=n.X,r.Pt.Y=n.Y,i==t.Next?(t.Next=r,i.Prev=r,r.Next=i,r.Prev=t):(i.Next=r,t.Prev=r,r.Next=t,r.Prev=i),r},e.Clipper.prototype.SetHoleState=function(t,e){for(var i=!1,n=t.PrevInAEL;null!==n;)n.OutIdx>=0&&0!=n.WindDelta&&(i=!i,null===e.FirstLeft&&(e.FirstLeft=this.m_PolyOuts[n.OutIdx])),n=n.PrevInAEL;i&&(e.IsHole=!0)},e.Clipper.prototype.GetDx=function(t,i){return t.Y==i.Y?e.ClipperBase.horizontal:(i.X-t.X)/(i.Y-t.Y)},e.Clipper.prototype.FirstIsBottomPt=function(t,i){for(var n=t.Prev;e.IntPoint.op_Equality(n.Pt,t.Pt)&&n!=t;)n=n.Prev;var r=Math.abs(this.GetDx(t.Pt,n.Pt));for(n=t.Next;e.IntPoint.op_Equality(n.Pt,t.Pt)&&n!=t;)n=n.Next;var o=Math.abs(this.GetDx(t.Pt,n.Pt));for(n=i.Prev;e.IntPoint.op_Equality(n.Pt,i.Pt)&&n!=i;)n=n.Prev;var s=Math.abs(this.GetDx(i.Pt,n.Pt));for(n=i.Next;e.IntPoint.op_Equality(n.Pt,i.Pt)&&n!=i;)n=n.Next;var l=Math.abs(this.GetDx(i.Pt,n.Pt));return r>=s&&r>=l||o>=s&&o>=l},e.Clipper.prototype.GetBottomPt=function(t){for(var i=null,n=t.Next;n!=t;)n.Pt.Y>t.Pt.Y?(t=n,i=null):n.Pt.Y==t.Pt.Y&&n.Pt.X<=t.Pt.X&&(n.Pt.X<t.Pt.X?(i=null,t=n):n.Next!=t&&n.Prev!=t&&(i=n)),n=n.Next;if(null!==i)for(;i!=n;)for(this.FirstIsBottomPt(n,i)||(t=i),i=i.Next;e.IntPoint.op_Inequality(i.Pt,t.Pt);)i=i.Next;return t},e.Clipper.prototype.GetLowermostRec=function(t,e){null===t.BottomPt&&(t.BottomPt=this.GetBottomPt(t.Pts)),null===e.BottomPt&&(e.BottomPt=this.GetBottomPt(e.Pts));var i=t.BottomPt,n=e.BottomPt;return i.Pt.Y>n.Pt.Y?t:i.Pt.Y<n.Pt.Y?e:i.Pt.X<n.Pt.X?t:i.Pt.X>n.Pt.X?e:i.Next==i?e:n.Next==n?t:this.FirstIsBottomPt(i,n)?t:e},e.Clipper.prototype.Param1RightOfParam2=function(t,e){do{if((t=t.FirstLeft)==e)return!0}while(null!==t);return!1},e.Clipper.prototype.GetOutRec=function(t){for(var e=this.m_PolyOuts[t];e!=this.m_PolyOuts[e.Idx];)e=this.m_PolyOuts[e.Idx];return e},e.Clipper.prototype.AppendPolygon=function(t,i){var n,r=this.m_PolyOuts[t.OutIdx],o=this.m_PolyOuts[i.OutIdx];n=this.Param1RightOfParam2(r,o)?o:this.Param1RightOfParam2(o,r)?r:this.GetLowermostRec(r,o);var s,l=r.Pts,p=l.Prev,h=o.Pts,u=h.Prev;t.Side==e.EdgeSide.esLeft?(i.Side==e.EdgeSide.esLeft?(this.ReversePolyPtLinks(h),h.Next=l,l.Prev=h,p.Next=u,u.Prev=p,r.Pts=u):(u.Next=l,l.Prev=u,h.Prev=p,p.Next=h,r.Pts=h),s=e.EdgeSide.esLeft):(i.Side==e.EdgeSide.esRight?(this.ReversePolyPtLinks(h),p.Next=u,u.Prev=p,h.Next=l,l.Prev=h):(p.Next=h,h.Prev=p,l.Prev=u,u.Next=l),s=e.EdgeSide.esRight),r.BottomPt=null,n==o&&(o.FirstLeft!=r&&(r.FirstLeft=o.FirstLeft),r.IsHole=o.IsHole),o.Pts=null,o.BottomPt=null,o.FirstLeft=r;var a=t.OutIdx,f=i.OutIdx;t.OutIdx=-1,i.OutIdx=-1;for(var d=this.m_ActiveEdges;null!==d;){if(d.OutIdx==f){d.OutIdx=a,d.Side=s;break}d=d.NextInAEL}o.Idx=r.Idx},e.Clipper.prototype.ReversePolyPtLinks=function(t){if(null!==t){var e,i;e=t;do{i=e.Next,e.Next=e.Prev,e.Prev=i,e=i}while(e!=t)}},e.Clipper.SwapSides=function(t,e){var i=t.Side;t.Side=e.Side,e.Side=i},e.Clipper.SwapPolyIndexes=function(t,e){var i=t.OutIdx;t.OutIdx=e.OutIdx,e.OutIdx=i},e.Clipper.prototype.IntersectEdges=function(t,i,n,r){var o,s,l,p,h,u,a=!r&&null===t.NextInLML&&t.Top.X==n.X&&t.Top.Y==n.Y,f=!r&&null===i.NextInLML&&i.Top.X==n.X&&i.Top.Y==n.Y,d=t.OutIdx>=0,P=i.OutIdx>=0;if(0===t.WindDelta||0===i.WindDelta)return 0===t.WindDelta&&0===i.WindDelta?(a||f)&&d&&P&&this.AddLocalMaxPoly(t,i,n):t.PolyTyp==i.PolyTyp&&t.WindDelta!=i.WindDelta&&this.m_ClipType==e.ClipType.ctUnion?0===t.WindDelta?P&&(this.AddOutPt(t,n),d&&(t.OutIdx=-1)):d&&(this.AddOutPt(i,n),P&&(i.OutIdx=-1)):t.PolyTyp!=i.PolyTyp&&(0!==t.WindDelta||1!=Math.abs(i.WindCnt)||this.m_ClipType==e.ClipType.ctUnion&&0!==i.WindCnt2?0!==i.WindDelta||1!=Math.abs(t.WindCnt)||this.m_ClipType==e.ClipType.ctUnion&&0!==t.WindCnt2||(this.AddOutPt(i,n),P&&(i.OutIdx=-1)):(this.AddOutPt(t,n),d&&(t.OutIdx=-1))),a&&(t.OutIdx<0?this.DeleteFromAEL(t):e.Error("Error intersecting polylines")),void(f&&(i.OutIdx<0?this.DeleteFromAEL(i):e.Error("Error intersecting polylines")));if(t.PolyTyp==i.PolyTyp)if(this.IsEvenOddFillType(t)){var m=t.WindCnt;t.WindCnt=i.WindCnt,i.WindCnt=m}else t.WindCnt+i.WindDelta===0?t.WindCnt=-t.WindCnt:t.WindCnt+=i.WindDelta,i.WindCnt-t.WindDelta==0?i.WindCnt=-i.WindCnt:i.WindCnt-=t.WindDelta;else this.IsEvenOddFillType(i)?t.WindCnt2=0===t.WindCnt2?1:0:t.WindCnt2+=i.WindDelta,this.IsEvenOddFillType(t)?i.WindCnt2=0===i.WindCnt2?1:0:i.WindCnt2-=t.WindDelta;switch(t.PolyTyp==e.PolyType.ptSubject?(o=this.m_SubjFillType,l=this.m_ClipFillType):(o=this.m_ClipFillType,l=this.m_SubjFillType),i.PolyTyp==e.PolyType.ptSubject?(s=this.m_SubjFillType,p=this.m_ClipFillType):(s=this.m_ClipFillType,p=this.m_SubjFillType),o){case e.PolyFillType.pftPositive:h=t.WindCnt;break;case e.PolyFillType.pftNegative:h=-t.WindCnt;break;default:h=Math.abs(t.WindCnt)}switch(s){case e.PolyFillType.pftPositive:u=i.WindCnt;break;case e.PolyFillType.pftNegative:u=-i.WindCnt;break;default:u=Math.abs(i.WindCnt)}if(d&&P)a||f||0!==h&&1!=h||0!==u&&1!=u||t.PolyTyp!=i.PolyTyp&&this.m_ClipType!=e.ClipType.ctXor?this.AddLocalMaxPoly(t,i,n):(this.AddOutPt(t,n),this.AddOutPt(i,n),e.Clipper.SwapSides(t,i),e.Clipper.SwapPolyIndexes(t,i));else if(d)0!==u&&1!=u||(this.AddOutPt(t,n),e.Clipper.SwapSides(t,i),e.Clipper.SwapPolyIndexes(t,i));else if(P)0!==h&&1!=h||(this.AddOutPt(i,n),e.Clipper.SwapSides(t,i),e.Clipper.SwapPolyIndexes(t,i));else if(!(0!==h&&1!=h||0!==u&&1!=u||a||f)){var y,c;switch(l){case e.PolyFillType.pftPositive:y=t.WindCnt2;break;case e.PolyFillType.pftNegative:y=-t.WindCnt2;break;default:y=Math.abs(t.WindCnt2)}switch(p){case e.PolyFillType.pftPositive:c=i.WindCnt2;break;case e.PolyFillType.pftNegative:c=-i.WindCnt2;break;default:c=Math.abs(i.WindCnt2)}if(t.PolyTyp!=i.PolyTyp)this.AddLocalMinPoly(t,i,n);else if(1==h&&1==u)switch(this.m_ClipType){case e.ClipType.ctIntersection:y>0&&c>0&&this.AddLocalMinPoly(t,i,n);break;case e.ClipType.ctUnion:y<=0&&c<=0&&this.AddLocalMinPoly(t,i,n);break;case e.ClipType.ctDifference:(t.PolyTyp==e.PolyType.ptClip&&y>0&&c>0||t.PolyTyp==e.PolyType.ptSubject&&y<=0&&c<=0)&&this.AddLocalMinPoly(t,i,n);break;case e.ClipType.ctXor:this.AddLocalMinPoly(t,i,n)}else e.Clipper.SwapSides(t,i)}a!=f&&(a&&t.OutIdx>=0||f&&i.OutIdx>=0)&&(e.Clipper.SwapSides(t,i),e.Clipper.SwapPolyIndexes(t,i)),a&&this.DeleteFromAEL(t),f&&this.DeleteFromAEL(i)},e.Clipper.prototype.DeleteFromAEL=function(t){var e=t.PrevInAEL,i=t.NextInAEL;null===e&&null===i&&t!=this.m_ActiveEdges||(null!==e?e.NextInAEL=i:this.m_ActiveEdges=i,null!==i&&(i.PrevInAEL=e),t.NextInAEL=null,t.PrevInAEL=null)},e.Clipper.prototype.DeleteFromSEL=function(t){var e=t.PrevInSEL,i=t.NextInSEL;null===e&&null===i&&t!=this.m_SortedEdges||(null!==e?e.NextInSEL=i:this.m_SortedEdges=i,null!==i&&(i.PrevInSEL=e),t.NextInSEL=null,t.PrevInSEL=null)},e.Clipper.prototype.UpdateEdgeIntoAEL=function(t){null===t.NextInLML&&e.Error("UpdateEdgeIntoAEL: invalid call");var i=t.PrevInAEL,n=t.NextInAEL;return t.NextInLML.OutIdx=t.OutIdx,null!==i?i.NextInAEL=t.NextInLML:this.m_ActiveEdges=t.NextInLML,null!==n&&(n.PrevInAEL=t.NextInLML),t.NextInLML.Side=t.Side,t.NextInLML.WindDelta=t.WindDelta,t.NextInLML.WindCnt=t.WindCnt,t.NextInLML.WindCnt2=t.WindCnt2,(t=t.NextInLML).Curr.X=t.Bot.X,t.Curr.Y=t.Bot.Y,t.PrevInAEL=i,t.NextInAEL=n,e.ClipperBase.IsHorizontal(t)||this.InsertScanbeam(t.Top.Y),t},e.Clipper.prototype.ProcessHorizontals=function(t){for(var e=this.m_SortedEdges;null!==e;)this.DeleteFromSEL(e),this.ProcessHorizontal(e,t),e=this.m_SortedEdges},e.Clipper.prototype.GetHorzDirection=function(t,i){t.Bot.X<t.Top.X?(i.Left=t.Bot.X,i.Right=t.Top.X,i.Dir=e.Direction.dLeftToRight):(i.Left=t.Top.X,i.Right=t.Bot.X,i.Dir=e.Direction.dRightToLeft)},e.Clipper.prototype.PrepareHorzJoins=function(t,i){var n=this.m_PolyOuts[t.OutIdx].Pts;t.Side!=e.EdgeSide.esLeft&&(n=n.Prev),i&&(e.IntPoint.op_Equality(n.Pt,t.Top)?this.AddGhostJoin(n,t.Bot):this.AddGhostJoin(n,t.Top))},e.Clipper.prototype.ProcessHorizontal=function(t,i){var n={Dir:null,Left:null,Right:null};this.GetHorzDirection(t,n);for(var r=n.Dir,o=n.Left,s=n.Right,l=t,p=null;null!==l.NextInLML&&e.ClipperBase.IsHorizontal(l.NextInLML);)l=l.NextInLML;for(null===l.NextInLML&&(p=this.GetMaximaPair(l));;){for(var h=t==l,u=this.GetNextInAEL(t,r);null!==u&&!(u.Curr.X==t.Top.X&&null!==t.NextInLML&&u.Dx<t.NextInLML.Dx);){var a=this.GetNextInAEL(u,r);if(r==e.Direction.dLeftToRight&&u.Curr.X<=s||r==e.Direction.dRightToLeft&&u.Curr.X>=o){if(t.OutIdx>=0&&0!=t.WindDelta&&this.PrepareHorzJoins(t,i),u==p&&h)return r==e.Direction.dLeftToRight?this.IntersectEdges(t,u,u.Top,!1):this.IntersectEdges(u,t,u.Top,!1),void(p.OutIdx>=0&&e.Error("ProcessHorizontal error"));if(r==e.Direction.dLeftToRight){var f=new e.IntPoint(u.Curr.X,t.Curr.Y);this.IntersectEdges(t,u,f,!0)}else{f=new e.IntPoint(u.Curr.X,t.Curr.Y);this.IntersectEdges(u,t,f,!0)}this.SwapPositionsInAEL(t,u)}else if(r==e.Direction.dLeftToRight&&u.Curr.X>=s||r==e.Direction.dRightToLeft&&u.Curr.X<=o)break;u=a}if(t.OutIdx>=0&&0!==t.WindDelta&&this.PrepareHorzJoins(t,i),null===t.NextInLML||!e.ClipperBase.IsHorizontal(t.NextInLML))break;(t=this.UpdateEdgeIntoAEL(t)).OutIdx>=0&&this.AddOutPt(t,t.Bot);n={Dir:r,Left:o,Right:s};this.GetHorzDirection(t,n),r=n.Dir,o=n.Left,s=n.Right}if(null!==t.NextInLML)if(t.OutIdx>=0){var d=this.AddOutPt(t,t.Top);if(0===(t=this.UpdateEdgeIntoAEL(t)).WindDelta)return;var P=t.PrevInAEL;a=t.NextInAEL;if(null!==P&&P.Curr.X==t.Bot.X&&P.Curr.Y==t.Bot.Y&&0!==P.WindDelta&&P.OutIdx>=0&&P.Curr.Y>P.Top.Y&&e.ClipperBase.SlopesEqual(t,P,this.m_UseFullRange)){var m=this.AddOutPt(P,t.Bot);this.AddJoin(d,m,t.Top)}else if(null!==a&&a.Curr.X==t.Bot.X&&a.Curr.Y==t.Bot.Y&&0!==a.WindDelta&&a.OutIdx>=0&&a.Curr.Y>a.Top.Y&&e.ClipperBase.SlopesEqual(t,a,this.m_UseFullRange)){m=this.AddOutPt(a,t.Bot);this.AddJoin(d,m,t.Top)}}else t=this.UpdateEdgeIntoAEL(t);else null!==p?p.OutIdx>=0?(r==e.Direction.dLeftToRight?this.IntersectEdges(t,p,t.Top,!1):this.IntersectEdges(p,t,t.Top,!1),p.OutIdx>=0&&e.Error("ProcessHorizontal error")):(this.DeleteFromAEL(t),this.DeleteFromAEL(p)):(t.OutIdx>=0&&this.AddOutPt(t,t.Top),this.DeleteFromAEL(t))},e.Clipper.prototype.GetNextInAEL=function(t,i){return i==e.Direction.dLeftToRight?t.NextInAEL:t.PrevInAEL},e.Clipper.prototype.IsMinima=function(t){return null!==t&&t.Prev.NextInLML!=t&&t.Next.NextInLML!=t},e.Clipper.prototype.IsMaxima=function(t,e){return null!==t&&t.Top.Y==e&&null===t.NextInLML},e.Clipper.prototype.IsIntermediate=function(t,e){return t.Top.Y==e&&null!==t.NextInLML},e.Clipper.prototype.GetMaximaPair=function(t){var i=null;return e.IntPoint.op_Equality(t.Next.Top,t.Top)&&null===t.Next.NextInLML?i=t.Next:e.IntPoint.op_Equality(t.Prev.Top,t.Top)&&null===t.Prev.NextInLML&&(i=t.Prev),null===i||-2!=i.OutIdx&&(i.NextInAEL!=i.PrevInAEL||e.ClipperBase.IsHorizontal(i))?i:null},e.Clipper.prototype.ProcessIntersections=function(t,i){if(null==this.m_ActiveEdges)return!0;try{if(this.BuildIntersectList(t,i),0==this.m_IntersectList.length)return!0;if(1!=this.m_IntersectList.length&&!this.FixupIntersectionOrder())return!1;this.ProcessIntersectList()}catch(t){this.m_SortedEdges=null,this.m_IntersectList.length=0,e.Error("ProcessIntersections error")}return this.m_SortedEdges=null,!0},e.Clipper.prototype.BuildIntersectList=function(t,i){if(null!==this.m_ActiveEdges){var n=this.m_ActiveEdges;for(this.m_SortedEdges=n;null!==n;)n.PrevInSEL=n.PrevInAEL,n.NextInSEL=n.NextInAEL,n.Curr.X=e.Clipper.TopX(n,i),n=n.NextInAEL;for(var r=!0;r&&null!==this.m_SortedEdges;){for(r=!1,n=this.m_SortedEdges;null!==n.NextInSEL;){var o=n.NextInSEL,s=new e.IntPoint;if(n.Curr.X>o.Curr.X){!this.IntersectPoint(n,o,s)&&n.Curr.X>o.Curr.X+1&&e.Error("Intersection error"),s.Y>t&&(s.Y=t,Math.abs(n.Dx)>Math.abs(o.Dx)?s.X=e.Clipper.TopX(o,t):s.X=e.Clipper.TopX(n,t));var l=new e.IntersectNode;l.Edge1=n,l.Edge2=o,l.Pt.X=s.X,l.Pt.Y=s.Y,this.m_IntersectList.push(l),this.SwapPositionsInSEL(n,o),r=!0}else n=o}if(null===n.PrevInSEL)break;n.PrevInSEL.NextInSEL=null}this.m_SortedEdges=null}},e.Clipper.prototype.EdgesAdjacent=function(t){return t.Edge1.NextInSEL==t.Edge2||t.Edge1.PrevInSEL==t.Edge2},e.Clipper.IntersectNodeSort=function(t,e){return e.Pt.Y-t.Pt.Y},e.Clipper.prototype.FixupIntersectionOrder=function(){this.m_IntersectList.sort(this.m_IntersectNodeComparer),this.CopyAELToSEL();for(var t=this.m_IntersectList.length,e=0;e<t;e++){if(!this.EdgesAdjacent(this.m_IntersectList[e])){for(var i=e+1;i<t&&!this.EdgesAdjacent(this.m_IntersectList[i]);)i++;if(i==t)return!1;var n=this.m_IntersectList[e];this.m_IntersectList[e]=this.m_IntersectList[i],this.m_IntersectList[i]=n}this.SwapPositionsInSEL(this.m_IntersectList[e].Edge1,this.m_IntersectList[e].Edge2)}return!0},e.Clipper.prototype.ProcessIntersectList=function(){for(var t=0,e=this.m_IntersectList.length;t<e;t++){var i=this.m_IntersectList[t];this.IntersectEdges(i.Edge1,i.Edge2,i.Pt,!0),this.SwapPositionsInAEL(i.Edge1,i.Edge2)}this.m_IntersectList.length=0};o.msie?e.Clipper.Round=function(t){return t<0?Math.ceil(t-.5):Math.round(t)}:o.chromium?e.Clipper.Round=function(t){return t<0?-Math.round(Math.abs(t)):Math.round(t)}:o.safari?e.Clipper.Round=function(t){return t<0?(t-=.5)<-2147483648?Math.ceil(t):0|t:(t+=.5)>2147483647?Math.floor(t):0|t}:e.Clipper.Round=function(t){return t<0?Math.ceil(t-.5):Math.floor(t+.5)},e.Clipper.TopX=function(t,i){return i==t.Top.Y?t.Top.X:t.Bot.X+e.Clipper.Round(t.Dx*(i-t.Bot.Y))},e.Clipper.prototype.IntersectPoint=function(t,i,n){var r,o;if(n.X=0,n.Y=0,e.ClipperBase.SlopesEqual(t,i,this.m_UseFullRange)||t.Dx==i.Dx)return i.Bot.Y>t.Bot.Y?(n.X=i.Bot.X,n.Y=i.Bot.Y):(n.X=t.Bot.X,n.Y=t.Bot.Y),!1;if(0===t.Delta.X)n.X=t.Bot.X,e.ClipperBase.IsHorizontal(i)?n.Y=i.Bot.Y:(o=i.Bot.Y-i.Bot.X/i.Dx,n.Y=e.Clipper.Round(n.X/i.Dx+o));else if(0===i.Delta.X)n.X=i.Bot.X,e.ClipperBase.IsHorizontal(t)?n.Y=t.Bot.Y:(r=t.Bot.Y-t.Bot.X/t.Dx,n.Y=e.Clipper.Round(n.X/t.Dx+r));else{r=t.Bot.X-t.Bot.Y*t.Dx;var s=((o=i.Bot.X-i.Bot.Y*i.Dx)-r)/(t.Dx-i.Dx);n.Y=e.Clipper.Round(s),Math.abs(t.Dx)<Math.abs(i.Dx)?n.X=e.Clipper.Round(t.Dx*s+r):n.X=e.Clipper.Round(i.Dx*s+o)}if(n.Y<t.Top.Y||n.Y<i.Top.Y){if(t.Top.Y>i.Top.Y)return n.Y=t.Top.Y,n.X=e.Clipper.TopX(i,t.Top.Y),n.X<t.Top.X;n.Y=i.Top.Y,Math.abs(t.Dx)<Math.abs(i.Dx)?n.X=e.Clipper.TopX(t,n.Y):n.X=e.Clipper.TopX(i,n.Y)}return!0},e.Clipper.prototype.ProcessEdgesAtTopOfScanbeam=function(t){for(var i=this.m_ActiveEdges;null!==i;){var n=this.IsMaxima(i,t);if(n){var r=this.GetMaximaPair(i);n=null===r||!e.ClipperBase.IsHorizontal(r)}if(n){var o=i.PrevInAEL;this.DoMaxima(i),i=null===o?this.m_ActiveEdges:o.NextInAEL}else{if(this.IsIntermediate(i,t)&&e.ClipperBase.IsHorizontal(i.NextInLML)?((i=this.UpdateEdgeIntoAEL(i)).OutIdx>=0&&this.AddOutPt(i,i.Bot),this.AddEdgeToSEL(i)):(i.Curr.X=e.Clipper.TopX(i,t),i.Curr.Y=t),this.StrictlySimple){o=i.PrevInAEL;if(i.OutIdx>=0&&0!==i.WindDelta&&null!==o&&o.OutIdx>=0&&o.Curr.X==i.Curr.X&&0!==o.WindDelta){var s=this.AddOutPt(o,i.Curr),l=this.AddOutPt(i,i.Curr);this.AddJoin(s,l,i.Curr)}}i=i.NextInAEL}}for(this.ProcessHorizontals(!0),i=this.m_ActiveEdges;null!==i;){if(this.IsIntermediate(i,t)){s=null;i.OutIdx>=0&&(s=this.AddOutPt(i,i.Top));o=(i=this.UpdateEdgeIntoAEL(i)).PrevInAEL;var p=i.NextInAEL;if(null!==o&&o.Curr.X==i.Bot.X&&o.Curr.Y==i.Bot.Y&&null!==s&&o.OutIdx>=0&&o.Curr.Y>o.Top.Y&&e.ClipperBase.SlopesEqual(i,o,this.m_UseFullRange)&&0!==i.WindDelta&&0!==o.WindDelta){l=this.AddOutPt(o,i.Bot);this.AddJoin(s,l,i.Top)}else if(null!==p&&p.Curr.X==i.Bot.X&&p.Curr.Y==i.Bot.Y&&null!==s&&p.OutIdx>=0&&p.Curr.Y>p.Top.Y&&e.ClipperBase.SlopesEqual(i,p,this.m_UseFullRange)&&0!==i.WindDelta&&0!==p.WindDelta){l=this.AddOutPt(p,i.Bot);this.AddJoin(s,l,i.Top)}}i=i.NextInAEL}},e.Clipper.prototype.DoMaxima=function(t){var i=this.GetMaximaPair(t);if(null===i)return t.OutIdx>=0&&this.AddOutPt(t,t.Top),void this.DeleteFromAEL(t);for(var n=t.NextInAEL;null!==n&&n!=i;)this.IntersectEdges(t,n,t.Top,!0),this.SwapPositionsInAEL(t,n),n=t.NextInAEL;-1==t.OutIdx&&-1==i.OutIdx?(this.DeleteFromAEL(t),this.DeleteFromAEL(i)):t.OutIdx>=0&&i.OutIdx>=0?this.IntersectEdges(t,i,t.Top,!1):0===t.WindDelta?(t.OutIdx>=0&&(this.AddOutPt(t,t.Top),t.OutIdx=-1),this.DeleteFromAEL(t),i.OutIdx>=0&&(this.AddOutPt(i,t.Top),i.OutIdx=-1),this.DeleteFromAEL(i)):e.Error("DoMaxima error")},e.Clipper.ReversePaths=function(t){for(var e=0,i=t.length;e<i;e++)t[e].reverse()},e.Clipper.Orientation=function(t){return e.Clipper.Area(t)>=0},e.Clipper.prototype.PointCount=function(t){if(null===t)return 0;var e=0,i=t;do{e++,i=i.Next}while(i!=t);return e},e.Clipper.prototype.BuildResult=function(t){e.Clear(t);for(var i=0,n=this.m_PolyOuts.length;i<n;i++){var r=this.m_PolyOuts[i];if(null!==r.Pts){var o=r.Pts.Prev,s=this.PointCount(o);if(!(s<2)){for(var l=new Array(s),p=0;p<s;p++)l[p]=o.Pt,o=o.Prev;t.push(l)}}}},e.Clipper.prototype.BuildResult2=function(t){t.Clear();for(var i=0,n=this.m_PolyOuts.length;i<n;i++){var r=this.m_PolyOuts[i],o=this.PointCount(r.Pts);if(!(r.IsOpen&&o<2||!r.IsOpen&&o<3)){this.FixHoleLinkage(r);var s=new e.PolyNode;t.m_AllPolys.push(s),r.PolyNode=s,s.m_polygon.length=o;for(var l=r.Pts.Prev,p=0;p<o;p++)s.m_polygon[p]=l.Pt,l=l.Prev}}for(i=0,n=this.m_PolyOuts.length;i<n;i++){null!==(r=this.m_PolyOuts[i]).PolyNode&&(r.IsOpen?(r.PolyNode.IsOpen=!0,t.AddChild(r.PolyNode)):null!==r.FirstLeft&&null!=r.FirstLeft.PolyNode?r.FirstLeft.PolyNode.AddChild(r.PolyNode):t.AddChild(r.PolyNode))}},e.Clipper.prototype.FixupOutPolygon=function(t){var i=null;t.BottomPt=null;for(var n=t.Pts;;){if(n.Prev==n||n.Prev==n.Next)return this.DisposeOutPts(n),void(t.Pts=null);if(e.IntPoint.op_Equality(n.Pt,n.Next.Pt)||e.IntPoint.op_Equality(n.Pt,n.Prev.Pt)||e.ClipperBase.SlopesEqual(n.Prev.Pt,n.Pt,n.Next.Pt,this.m_UseFullRange)&&(!this.PreserveCollinear||!this.Pt2IsBetweenPt1AndPt3(n.Prev.Pt,n.Pt,n.Next.Pt))){i=null;n.Prev.Next=n.Next,n.Next.Prev=n.Prev,n=n.Prev,null}else{if(n==i)break;null===i&&(i=n),n=n.Next}}t.Pts=n},e.Clipper.prototype.DupOutPt=function(t,i){var n=new e.OutPt;return n.Pt.X=t.Pt.X,n.Pt.Y=t.Pt.Y,n.Idx=t.Idx,i?(n.Next=t.Next,n.Prev=t,t.Next.Prev=n,t.Next=n):(n.Prev=t.Prev,n.Next=t,t.Prev.Next=n,t.Prev=n),n},e.Clipper.prototype.GetOverlap=function(t,e,i,n,r){return t<e?i<n?(r.Left=Math.max(t,i),r.Right=Math.min(e,n)):(r.Left=Math.max(t,n),r.Right=Math.min(e,i)):i<n?(r.Left=Math.max(e,i),r.Right=Math.min(t,n)):(r.Left=Math.max(e,n),r.Right=Math.min(t,i)),r.Left<r.Right},e.Clipper.prototype.JoinHorz=function(t,i,n,r,o,s){var l=t.Pt.X>i.Pt.X?e.Direction.dRightToLeft:e.Direction.dLeftToRight,p=n.Pt.X>r.Pt.X?e.Direction.dRightToLeft:e.Direction.dLeftToRight;if(l==p)return!1;if(l==e.Direction.dLeftToRight){for(;t.Next.Pt.X<=o.X&&t.Next.Pt.X>=t.Pt.X&&t.Next.Pt.Y==o.Y;)t=t.Next;s&&t.Pt.X!=o.X&&(t=t.Next),i=this.DupOutPt(t,!s),e.IntPoint.op_Inequality(i.Pt,o)&&((t=i).Pt.X=o.X,t.Pt.Y=o.Y,i=this.DupOutPt(t,!s))}else{for(;t.Next.Pt.X>=o.X&&t.Next.Pt.X<=t.Pt.X&&t.Next.Pt.Y==o.Y;)t=t.Next;s||t.Pt.X==o.X||(t=t.Next),i=this.DupOutPt(t,s),e.IntPoint.op_Inequality(i.Pt,o)&&((t=i).Pt.X=o.X,t.Pt.Y=o.Y,i=this.DupOutPt(t,s))}if(p==e.Direction.dLeftToRight){for(;n.Next.Pt.X<=o.X&&n.Next.Pt.X>=n.Pt.X&&n.Next.Pt.Y==o.Y;)n=n.Next;s&&n.Pt.X!=o.X&&(n=n.Next),r=this.DupOutPt(n,!s),e.IntPoint.op_Inequality(r.Pt,o)&&((n=r).Pt.X=o.X,n.Pt.Y=o.Y,r=this.DupOutPt(n,!s))}else{for(;n.Next.Pt.X>=o.X&&n.Next.Pt.X<=n.Pt.X&&n.Next.Pt.Y==o.Y;)n=n.Next;s||n.Pt.X==o.X||(n=n.Next),r=this.DupOutPt(n,s),e.IntPoint.op_Inequality(r.Pt,o)&&((n=r).Pt.X=o.X,n.Pt.Y=o.Y,r=this.DupOutPt(n,s))}return l==e.Direction.dLeftToRight==s?(t.Prev=n,n.Next=t,i.Next=r,r.Prev=i):(t.Next=n,n.Prev=t,i.Prev=r,r.Next=i),!0},e.Clipper.prototype.JoinPoints=function(t,i,n){var r=t.OutPt1,o=new e.OutPt,s=t.OutPt2,l=new e.OutPt,p=t.OutPt1.Pt.Y==t.OffPt.Y;if(p&&e.IntPoint.op_Equality(t.OffPt,t.OutPt1.Pt)&&e.IntPoint.op_Equality(t.OffPt,t.OutPt2.Pt)){for(o=t.OutPt1.Next;o!=r&&e.IntPoint.op_Equality(o.Pt,t.OffPt);)o=o.Next;var h=o.Pt.Y>t.OffPt.Y;for(l=t.OutPt2.Next;l!=s&&e.IntPoint.op_Equality(l.Pt,t.OffPt);)l=l.Next;return h!=l.Pt.Y>t.OffPt.Y&&(h?(o=this.DupOutPt(r,!1),l=this.DupOutPt(s,!0),r.Prev=s,s.Next=r,o.Next=l,l.Prev=o,t.OutPt1=r,t.OutPt2=o,!0):(o=this.DupOutPt(r,!0),l=this.DupOutPt(s,!1),r.Next=s,s.Prev=r,o.Prev=l,l.Next=o,t.OutPt1=r,t.OutPt2=o,!0))}if(p){for(o=r;r.Prev.Pt.Y==r.Pt.Y&&r.Prev!=o&&r.Prev!=s;)r=r.Prev;for(;o.Next.Pt.Y==o.Pt.Y&&o.Next!=r&&o.Next!=s;)o=o.Next;if(o.Next==r||o.Next==s)return!1;for(l=s;s.Prev.Pt.Y==s.Pt.Y&&s.Prev!=l&&s.Prev!=o;)s=s.Prev;for(;l.Next.Pt.Y==l.Pt.Y&&l.Next!=s&&l.Next!=r;)l=l.Next;if(l.Next==s||l.Next==r)return!1;var u={Left:null,Right:null};if(!this.GetOverlap(r.Pt.X,o.Pt.X,s.Pt.X,l.Pt.X,u))return!1;var a,f=u.Left,d=u.Right,P=new e.IntPoint;return r.Pt.X>=f&&r.Pt.X<=d?(P.X=r.Pt.X,P.Y=r.Pt.Y,a=r.Pt.X>o.Pt.X):s.Pt.X>=f&&s.Pt.X<=d?(P.X=s.Pt.X,P.Y=s.Pt.Y,a=s.Pt.X>l.Pt.X):o.Pt.X>=f&&o.Pt.X<=d?(P.X=o.Pt.X,P.Y=o.Pt.Y,a=o.Pt.X>r.Pt.X):(P.X=l.Pt.X,P.Y=l.Pt.Y,a=l.Pt.X>s.Pt.X),t.OutPt1=r,t.OutPt2=s,this.JoinHorz(r,o,s,l,P,a)}for(o=r.Next;e.IntPoint.op_Equality(o.Pt,r.Pt)&&o!=r;)o=o.Next;var m=o.Pt.Y>r.Pt.Y||!e.ClipperBase.SlopesEqual(r.Pt,o.Pt,t.OffPt,this.m_UseFullRange);if(m){for(o=r.Prev;e.IntPoint.op_Equality(o.Pt,r.Pt)&&o!=r;)o=o.Prev;if(o.Pt.Y>r.Pt.Y||!e.ClipperBase.SlopesEqual(r.Pt,o.Pt,t.OffPt,this.m_UseFullRange))return!1}for(l=s.Next;e.IntPoint.op_Equality(l.Pt,s.Pt)&&l!=s;)l=l.Next;var y=l.Pt.Y>s.Pt.Y||!e.ClipperBase.SlopesEqual(s.Pt,l.Pt,t.OffPt,this.m_UseFullRange);if(y){for(l=s.Prev;e.IntPoint.op_Equality(l.Pt,s.Pt)&&l!=s;)l=l.Prev;if(l.Pt.Y>s.Pt.Y||!e.ClipperBase.SlopesEqual(s.Pt,l.Pt,t.OffPt,this.m_UseFullRange))return!1}return o!=r&&l!=s&&o!=l&&(i!=n||m!=y)&&(m?(o=this.DupOutPt(r,!1),l=this.DupOutPt(s,!0),r.Prev=s,s.Next=r,o.Next=l,l.Prev=o,t.OutPt1=r,t.OutPt2=o,!0):(o=this.DupOutPt(r,!0),l=this.DupOutPt(s,!1),r.Next=s,s.Prev=r,o.Prev=l,l.Next=o,t.OutPt1=r,t.OutPt2=o,!0))},e.Clipper.GetBounds=function(t){for(var i=0,n=t.length;i<n&&0==t[i].length;)i++;if(i==n)return new e.IntRect(0,0,0,0);var r=new e.IntRect;for(r.left=t[i][0].X,r.right=r.left,r.top=t[i][0].Y,r.bottom=r.top;i<n;i++)for(var o=0,s=t[i].length;o<s;o++)t[i][o].X<r.left?r.left=t[i][o].X:t[i][o].X>r.right&&(r.right=t[i][o].X),t[i][o].Y<r.top?r.top=t[i][o].Y:t[i][o].Y>r.bottom&&(r.bottom=t[i][o].Y);return r},e.Clipper.prototype.GetBounds2=function(t){var i=t,n=new e.IntRect;for(n.left=t.Pt.X,n.right=t.Pt.X,n.top=t.Pt.Y,n.bottom=t.Pt.Y,t=t.Next;t!=i;)t.Pt.X<n.left&&(n.left=t.Pt.X),t.Pt.X>n.right&&(n.right=t.Pt.X),t.Pt.Y<n.top&&(n.top=t.Pt.Y),t.Pt.Y>n.bottom&&(n.bottom=t.Pt.Y),t=t.Next;return n},e.Clipper.PointInPolygon=function(t,e){var i=0,n=e.length;if(n<3)return 0;for(var r=e[0],o=1;o<=n;++o){var s=o==n?e[0]:e[o];if(s.Y==t.Y&&(s.X==t.X||r.Y==t.Y&&s.X>t.X==r.X<t.X))return-1;if(r.Y<t.Y!=s.Y<t.Y)if(r.X>=t.X)if(s.X>t.X)i=1-i;else{if(0==(l=(r.X-t.X)*(s.Y-t.Y)-(s.X-t.X)*(r.Y-t.Y)))return-1;l>0==s.Y>r.Y&&(i=1-i)}else if(s.X>t.X){var l;if(0==(l=(r.X-t.X)*(s.Y-t.Y)-(s.X-t.X)*(r.Y-t.Y)))return-1;l>0==s.Y>r.Y&&(i=1-i)}r=s}return i},e.Clipper.prototype.PointInPolygon=function(t,e){for(var i=0,n=e;;){var r=e.Pt.X,o=e.Pt.Y,s=e.Next.Pt.X,l=e.Next.Pt.Y;if(l==t.Y&&(s==t.X||o==t.Y&&s>t.X==r<t.X))return-1;if(o<t.Y!=l<t.Y)if(r>=t.X)if(s>t.X)i=1-i;else{if(0==(p=(r-t.X)*(l-t.Y)-(s-t.X)*(o-t.Y)))return-1;p>0==l>o&&(i=1-i)}else if(s>t.X){var p;if(0==(p=(r-t.X)*(l-t.Y)-(s-t.X)*(o-t.Y)))return-1;p>0==l>o&&(i=1-i)}if(n==(e=e.Next))break}return i},e.Clipper.prototype.Poly2ContainsPoly1=function(t,e){var i=t;do{var n=this.PointInPolygon(i.Pt,e);if(n>=0)return 0!=n;i=i.Next}while(i!=t);return!0},e.Clipper.prototype.FixupFirstLefts1=function(t,e){for(var i=0,n=this.m_PolyOuts.length;i<n;i++){var r=this.m_PolyOuts[i];null!==r.Pts&&r.FirstLeft==t&&this.Poly2ContainsPoly1(r.Pts,e.Pts)&&(r.FirstLeft=e)}},e.Clipper.prototype.FixupFirstLefts2=function(t,e){for(var i=0,n=this.m_PolyOuts,r=n.length,o=n[i];i<r;o=n[++i])o.FirstLeft==t&&(o.FirstLeft=e)},e.Clipper.ParseFirstLeft=function(t){for(;null!=t&&null==t.Pts;)t=t.FirstLeft;return t},e.Clipper.prototype.JoinCommonEdges=function(){for(var t=0,i=this.m_Joins.length;t<i;t++){var n,r=this.m_Joins[t],o=this.GetOutRec(r.OutPt1.Idx),s=this.GetOutRec(r.OutPt2.Idx);if(null!=o.Pts&&null!=s.Pts)if(n=o==s?o:this.Param1RightOfParam2(o,s)?s:this.Param1RightOfParam2(s,o)?o:this.GetLowermostRec(o,s),this.JoinPoints(r,o,s))if(o==s){if(o.Pts=r.OutPt1,o.BottomPt=null,(s=this.CreateOutRec()).Pts=r.OutPt2,this.UpdateOutPtIdxs(s),this.m_UsingPolyTree)for(var l=0,p=this.m_PolyOuts.length;l<p-1;l++){var h=this.m_PolyOuts[l];null!=h.Pts&&e.Clipper.ParseFirstLeft(h.FirstLeft)==o&&h.IsHole!=o.IsHole&&(this.Poly2ContainsPoly1(h.Pts,r.OutPt2)&&(h.FirstLeft=s))}this.Poly2ContainsPoly1(s.Pts,o.Pts)?(s.IsHole=!o.IsHole,s.FirstLeft=o,this.m_UsingPolyTree&&this.FixupFirstLefts2(s,o),(s.IsHole^this.ReverseSolution)==this.Area(s)>0&&this.ReversePolyPtLinks(s.Pts)):this.Poly2ContainsPoly1(o.Pts,s.Pts)?(s.IsHole=o.IsHole,o.IsHole=!s.IsHole,s.FirstLeft=o.FirstLeft,o.FirstLeft=s,this.m_UsingPolyTree&&this.FixupFirstLefts2(o,s),(o.IsHole^this.ReverseSolution)==this.Area(o)>0&&this.ReversePolyPtLinks(o.Pts)):(s.IsHole=o.IsHole,s.FirstLeft=o.FirstLeft,this.m_UsingPolyTree&&this.FixupFirstLefts1(o,s))}else s.Pts=null,s.BottomPt=null,s.Idx=o.Idx,o.IsHole=n.IsHole,n==s&&(o.FirstLeft=s.FirstLeft),s.FirstLeft=o,this.m_UsingPolyTree&&this.FixupFirstLefts2(s,o)}},e.Clipper.prototype.UpdateOutPtIdxs=function(t){var e=t.Pts;do{e.Idx=t.Idx,e=e.Prev}while(e!=t.Pts)},e.Clipper.prototype.DoSimplePolygons=function(){for(var t=0;t<this.m_PolyOuts.length;){var i=this.m_PolyOuts[t++],n=i.Pts;if(null!==n)do{for(var r=n.Next;r!=i.Pts;){if(e.IntPoint.op_Equality(n.Pt,r.Pt)&&r.Next!=n&&r.Prev!=n){var o=n.Prev,s=r.Prev;n.Prev=s,s.Next=n,r.Prev=o,o.Next=r,i.Pts=n;var l=this.CreateOutRec();l.Pts=r,this.UpdateOutPtIdxs(l),this.Poly2ContainsPoly1(l.Pts,i.Pts)?(l.IsHole=!i.IsHole,l.FirstLeft=i):this.Poly2ContainsPoly1(i.Pts,l.Pts)?(l.IsHole=i.IsHole,i.IsHole=!l.IsHole,l.FirstLeft=i.FirstLeft,i.FirstLeft=l):(l.IsHole=i.IsHole,l.FirstLeft=i.FirstLeft),r=n}r=r.Next}n=n.Next}while(n!=i.Pts)}},e.Clipper.Area=function(t){var e=t.length;if(e<3)return 0;for(var i=0,n=0,r=e-1;n<e;++n)i+=(t[r].X+t[n].X)*(t[r].Y-t[n].Y),r=n;return.5*-i},e.Clipper.prototype.Area=function(t){var e=t.Pts;if(null==e)return 0;var i=0;do{i+=(e.Prev.Pt.X+e.Pt.X)*(e.Prev.Pt.Y-e.Pt.Y),e=e.Next}while(e!=t.Pts);return.5*i},e.Clipper.SimplifyPolygon=function(t,i){var n=new Array,r=new e.Clipper(0);return r.StrictlySimple=!0,r.AddPath(t,e.PolyType.ptSubject,!0),r.Execute(e.ClipType.ctUnion,n,i,i),n},e.Clipper.SimplifyPolygons=function(t,i){void 0===i&&(i=e.PolyFillType.pftEvenOdd);var n=new Array,r=new e.Clipper(0);return r.StrictlySimple=!0,r.AddPaths(t,e.PolyType.ptSubject,!0),r.Execute(e.ClipType.ctUnion,n,i,i),n},e.Clipper.DistanceSqrd=function(t,e){var i=t.X-e.X,n=t.Y-e.Y;return i*i+n*n},e.Clipper.DistanceFromLineSqrd=function(t,e,i){var n=e.Y-i.Y,r=i.X-e.X,o=n*e.X+r*e.Y;return(o=n*t.X+r*t.Y-o)*o/(n*n+r*r)},e.Clipper.SlopesNearCollinear=function(t,i,n,r){return e.Clipper.DistanceFromLineSqrd(i,t,n)<r},e.Clipper.PointsAreClose=function(t,e,i){var n=t.X-e.X,r=t.Y-e.Y;return n*n+r*r<=i},e.Clipper.ExcludeOp=function(t){var e=t.Prev;return e.Next=t.Next,t.Next.Prev=e,e.Idx=0,e},e.Clipper.CleanPolygon=function(t,i){void 0===i&&(i=1.415);var n=t.length;if(0==n)return new Array;for(var r=new Array(n),o=0;o<n;++o)r[o]=new e.OutPt;for(o=0;o<n;++o)r[o].Pt=t[o],r[o].Next=r[(o+1)%n],r[o].Next.Prev=r[o],r[o].Idx=0;for(var s=i*i,l=r[0];0==l.Idx&&l.Next!=l.Prev;)e.Clipper.PointsAreClose(l.Pt,l.Prev.Pt,s)?(l=e.Clipper.ExcludeOp(l),n--):e.Clipper.PointsAreClose(l.Prev.Pt,l.Next.Pt,s)?(e.Clipper.ExcludeOp(l.Next),l=e.Clipper.ExcludeOp(l),n-=2):e.Clipper.SlopesNearCollinear(l.Prev.Pt,l.Pt,l.Next.Pt,s)?(l=e.Clipper.ExcludeOp(l),n--):(l.Idx=1,l=l.Next);n<3&&(n=0);var p=new Array(n);for(o=0;o<n;++o)p[o]=new e.IntPoint(l.Pt),l=l.Next;return r=null,p},e.Clipper.CleanPolygons=function(t,i){for(var n=new Array(t.length),r=0,o=t.length;r<o;r++)n[r]=e.Clipper.CleanPolygon(t[r],i);return n},e.Clipper.Minkowski=function(t,i,n,r){var o=r?1:0,s=t.length,l=i.length,p=new Array;if(n)for(var h=0;h<l;h++){for(var u=new Array(s),a=0,f=t.length,d=t[a];a<f;d=t[++a])u[a]=new e.IntPoint(i[h].X+d.X,i[h].Y+d.Y);p.push(u)}else for(h=0;h<l;h++){for(u=new Array(s),a=0,f=t.length,d=t[a];a<f;d=t[++a])u[a]=new e.IntPoint(i[h].X-d.X,i[h].Y-d.Y);p.push(u)}var P=new Array;for(h=0;h<l-1+o;h++)for(a=0;a<s;a++){var m=new Array;m.push(p[h%l][a%s]),m.push(p[(h+1)%l][a%s]),m.push(p[(h+1)%l][(a+1)%s]),m.push(p[h%l][(a+1)%s]),e.Clipper.Orientation(m)||m.reverse(),P.push(m)}var y=new e.Clipper(0);return y.AddPaths(P,e.PolyType.ptSubject,!0),y.Execute(e.ClipType.ctUnion,p,e.PolyFillType.pftNonZero,e.PolyFillType.pftNonZero),p},e.Clipper.MinkowskiSum=function(){var t=arguments,i=t.length;if(3==i){var n=t[0],r=t[1],o=t[2];return e.Clipper.Minkowski(n,r,!0,o)}if(4==i){n=t[0];for(var s=t[1],l=t[2],p=(o=t[3],new e.Clipper),h=0,u=s.length;h<u;++h){var a=e.Clipper.Minkowski(n,s[h],!0,o);p.AddPaths(a,e.PolyType.ptSubject,!0)}o&&p.AddPaths(s,e.PolyType.ptClip,!0);var f=new e.Paths;return p.Execute(e.ClipType.ctUnion,f,l,l),f}},e.Clipper.MinkowskiDiff=function(t,i,n){return e.Clipper.Minkowski(t,i,!1,n)},e.Clipper.PolyTreeToPaths=function(t){var i=new Array;return e.Clipper.AddPolyNodeToPaths(t,e.Clipper.NodeType.ntAny,i),i},e.Clipper.AddPolyNodeToPaths=function(t,i,n){var r=!0;switch(i){case e.Clipper.NodeType.ntOpen:return;case e.Clipper.NodeType.ntClosed:r=!t.IsOpen}t.m_polygon.length>0&&r&&n.push(t.m_polygon);for(var o=0,s=t.Childs(),l=s.length,p=s[o];o<l;p=s[++o])e.Clipper.AddPolyNodeToPaths(p,i,n)},e.Clipper.OpenPathsFromPolyTree=function(t){for(var i=new e.Paths,n=0,r=t.ChildCount();n<r;n++)t.Childs()[n].IsOpen&&i.push(t.Childs()[n].m_polygon);return i},e.Clipper.ClosedPathsFromPolyTree=function(t){var i=new e.Paths;return e.Clipper.AddPolyNodeToPaths(t,e.Clipper.NodeType.ntClosed,i),i},Y(e.Clipper,e.ClipperBase),e.Clipper.NodeType={ntAny:0,ntOpen:1,ntClosed:2},e.ClipperOffset=function(t,i){void 0===t&&(t=2),void 0===i&&(i=e.ClipperOffset.def_arc_tolerance),this.m_destPolys=new e.Paths,this.m_srcPoly=new e.Path,this.m_destPoly=new e.Path,this.m_normals=new Array,this.m_delta=0,this.m_sinA=0,this.m_sin=0,this.m_cos=0,this.m_miterLim=0,this.m_StepsPerRad=0,this.m_lowest=new e.IntPoint,this.m_polyNodes=new e.PolyNode,this.MiterLimit=t,this.ArcTolerance=i,this.m_lowest.X=-1},e.ClipperOffset.two_pi=6.28318530717959,e.ClipperOffset.def_arc_tolerance=.25,e.ClipperOffset.prototype.Clear=function(){e.Clear(this.m_polyNodes.Childs()),this.m_lowest.X=-1},e.ClipperOffset.Round=e.Clipper.Round,e.ClipperOffset.prototype.AddPath=function(t,i,n){var r=t.length-1;if(!(r<0)){var o=new e.PolyNode;if(o.m_jointype=i,o.m_endtype=n,n==e.EndType.etClosedLine||n==e.EndType.etClosedPolygon)for(;r>0&&e.IntPoint.op_Equality(t[0],t[r]);)r--;o.m_polygon.push(t[0]);for(var s=0,l=0,p=1;p<=r;p++)e.IntPoint.op_Inequality(o.m_polygon[s],t[p])&&(s++,o.m_polygon.push(t[p]),(t[p].Y>o.m_polygon[l].Y||t[p].Y==o.m_polygon[l].Y&&t[p].X<o.m_polygon[l].X)&&(l=s));if(!(n==e.EndType.etClosedPolygon&&s<2||n!=e.EndType.etClosedPolygon&&s<0)&&(this.m_polyNodes.AddChild(o),n==e.EndType.etClosedPolygon))if(this.m_lowest.X<0)this.m_lowest=new e.IntPoint(0,l);else{var h=this.m_polyNodes.Childs()[this.m_lowest.X].m_polygon[this.m_lowest.Y];(o.m_polygon[l].Y>h.Y||o.m_polygon[l].Y==h.Y&&o.m_polygon[l].X<h.X)&&(this.m_lowest=new e.IntPoint(this.m_polyNodes.ChildCount()-1,l))}}},e.ClipperOffset.prototype.AddPaths=function(t,e,i){for(var n=0,r=t.length;n<r;n++)this.AddPath(t[n],e,i)},e.ClipperOffset.prototype.FixOrientations=function(){if(this.m_lowest.X>=0&&!e.Clipper.Orientation(this.m_polyNodes.Childs()[this.m_lowest.X].m_polygon))for(var t=0;t<this.m_polyNodes.ChildCount();t++){((i=this.m_polyNodes.Childs()[t]).m_endtype==e.EndType.etClosedPolygon||i.m_endtype==e.EndType.etClosedLine&&e.Clipper.Orientation(i.m_polygon))&&i.m_polygon.reverse()}else for(t=0;t<this.m_polyNodes.ChildCount();t++){var i;(i=this.m_polyNodes.Childs()[t]).m_endtype!=e.EndType.etClosedLine||e.Clipper.Orientation(i.m_polygon)||i.m_polygon.reverse()}},e.ClipperOffset.GetUnitNormal=function(t,i){var n=i.X-t.X,r=i.Y-t.Y;if(0==n&&0==r)return new e.DoublePoint(0,0);var o=1/Math.sqrt(n*n+r*r);return n*=o,r*=o,new e.DoublePoint(r,-n)},e.ClipperOffset.prototype.DoOffset=function(t){if(this.m_destPolys=new Array,this.m_delta=t,e.ClipperBase.near_zero(t))for(var i=0;i<this.m_polyNodes.ChildCount();i++){(o=this.m_polyNodes.Childs()[i]).m_endtype==e.EndType.etClosedPolygon&&this.m_destPolys.push(o.m_polygon)}else{var n;this.MiterLimit>2?this.m_miterLim=2/(this.MiterLimit*this.MiterLimit):this.m_miterLim=.5,n=this.ArcTolerance<=0?e.ClipperOffset.def_arc_tolerance:this.ArcTolerance>Math.abs(t)*e.ClipperOffset.def_arc_tolerance?Math.abs(t)*e.ClipperOffset.def_arc_tolerance:this.ArcTolerance;var r=3.14159265358979/Math.acos(1-n/Math.abs(t));this.m_sin=Math.sin(e.ClipperOffset.two_pi/r),this.m_cos=Math.cos(e.ClipperOffset.two_pi/r),this.m_StepsPerRad=r/e.ClipperOffset.two_pi,t<0&&(this.m_sin=-this.m_sin);for(i=0;i<this.m_polyNodes.ChildCount();i++){var o=this.m_polyNodes.Childs()[i];this.m_srcPoly=o.m_polygon;var s=this.m_srcPoly.length;if(!(0==s||t<=0&&(s<3||o.m_endtype!=e.EndType.etClosedPolygon)))if(this.m_destPoly=new Array,1!=s){this.m_normals.length=0;for(f=0;f<s-1;f++)this.m_normals.push(e.ClipperOffset.GetUnitNormal(this.m_srcPoly[f],this.m_srcPoly[f+1]));if(o.m_endtype==e.EndType.etClosedLine||o.m_endtype==e.EndType.etClosedPolygon?this.m_normals.push(e.ClipperOffset.GetUnitNormal(this.m_srcPoly[s-1],this.m_srcPoly[0])):this.m_normals.push(new e.DoublePoint(this.m_normals[s-2])),o.m_endtype==e.EndType.etClosedPolygon){var l=s-1;for(f=0;f<s;f++)l=this.OffsetPoint(f,l,o.m_jointype);this.m_destPolys.push(this.m_destPoly)}else if(o.m_endtype==e.EndType.etClosedLine){for(l=s-1,f=0;f<s;f++)l=this.OffsetPoint(f,l,o.m_jointype);this.m_destPolys.push(this.m_destPoly),this.m_destPoly=new Array;var p=this.m_normals[s-1];for(f=s-1;f>0;f--)this.m_normals[f]=new e.DoublePoint(-this.m_normals[f-1].X,-this.m_normals[f-1].Y);this.m_normals[0]=new e.DoublePoint(-p.X,-p.Y),l=0;for(f=s-1;f>=0;f--)l=this.OffsetPoint(f,l,o.m_jointype);this.m_destPolys.push(this.m_destPoly)}else{var h;for(l=0,f=1;f<s-1;++f)l=this.OffsetPoint(f,l,o.m_jointype);if(o.m_endtype==e.EndType.etOpenButt){f=s-1;h=new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[f].X+this.m_normals[f].X*t),e.ClipperOffset.Round(this.m_srcPoly[f].Y+this.m_normals[f].Y*t)),this.m_destPoly.push(h),h=new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[f].X-this.m_normals[f].X*t),e.ClipperOffset.Round(this.m_srcPoly[f].Y-this.m_normals[f].Y*t)),this.m_destPoly.push(h)}else{f=s-1;l=s-2,this.m_sinA=0,this.m_normals[f]=new e.DoublePoint(-this.m_normals[f].X,-this.m_normals[f].Y),o.m_endtype==e.EndType.etOpenSquare?this.DoSquare(f,l):this.DoRound(f,l)}for(f=s-1;f>0;f--)this.m_normals[f]=new e.DoublePoint(-this.m_normals[f-1].X,-this.m_normals[f-1].Y);this.m_normals[0]=new e.DoublePoint(-this.m_normals[1].X,-this.m_normals[1].Y);for(f=(l=s-1)-1;f>0;--f)l=this.OffsetPoint(f,l,o.m_jointype);o.m_endtype==e.EndType.etOpenButt?(h=new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[0].X-this.m_normals[0].X*t),e.ClipperOffset.Round(this.m_srcPoly[0].Y-this.m_normals[0].Y*t)),this.m_destPoly.push(h),h=new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[0].X+this.m_normals[0].X*t),e.ClipperOffset.Round(this.m_srcPoly[0].Y+this.m_normals[0].Y*t)),this.m_destPoly.push(h)):(l=1,this.m_sinA=0,o.m_endtype==e.EndType.etOpenSquare?this.DoSquare(0,1):this.DoRound(0,1)),this.m_destPolys.push(this.m_destPoly)}}else{if(o.m_jointype==e.JoinType.jtRound)for(var u=1,a=0,f=1;f<=r;f++){this.m_destPoly.push(new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[0].X+u*t),e.ClipperOffset.Round(this.m_srcPoly[0].Y+a*t)));var d=u;u=u*this.m_cos-this.m_sin*a,a=d*this.m_sin+a*this.m_cos}else{u=-1,a=-1;for(var f=0;f<4;++f)this.m_destPoly.push(new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[0].X+u*t),e.ClipperOffset.Round(this.m_srcPoly[0].Y+a*t))),u<0?u=1:a<0?a=1:u=-1}this.m_destPolys.push(this.m_destPoly)}}}},e.ClipperOffset.prototype.Execute=function(){var t=arguments;if(t[0]instanceof e.PolyTree){o=t[0],s=t[1];if(o.Clear(),this.FixOrientations(),this.DoOffset(s),(r=new e.Clipper(0)).AddPaths(this.m_destPolys,e.PolyType.ptSubject,!0),s>0)r.Execute(e.ClipType.ctUnion,o,e.PolyFillType.pftPositive,e.PolyFillType.pftPositive);else{p=e.Clipper.GetBounds(this.m_destPolys);if((l=new e.Path).push(new e.IntPoint(p.left-10,p.bottom+10)),l.push(new e.IntPoint(p.right+10,p.bottom+10)),l.push(new e.IntPoint(p.right+10,p.top-10)),l.push(new e.IntPoint(p.left-10,p.top-10)),r.AddPath(l,e.PolyType.ptSubject,!0),r.ReverseSolution=!0,r.Execute(e.ClipType.ctUnion,o,e.PolyFillType.pftNegative,e.PolyFillType.pftNegative),1==o.ChildCount()&&o.Childs()[0].ChildCount()>0){var i=o.Childs()[0];o.Childs()[0]=i.Childs()[0];for(var n=1;n<i.ChildCount();n++)o.AddChild(i.Childs()[n])}else o.Clear()}}else{var r,o=t[0],s=t[1];if(e.Clear(o),this.FixOrientations(),this.DoOffset(s),(r=new e.Clipper(0)).AddPaths(this.m_destPolys,e.PolyType.ptSubject,!0),s>0)r.Execute(e.ClipType.ctUnion,o,e.PolyFillType.pftPositive,e.PolyFillType.pftPositive);else{var l,p=e.Clipper.GetBounds(this.m_destPolys);(l=new e.Path).push(new e.IntPoint(p.left-10,p.bottom+10)),l.push(new e.IntPoint(p.right+10,p.bottom+10)),l.push(new e.IntPoint(p.right+10,p.top-10)),l.push(new e.IntPoint(p.left-10,p.top-10)),r.AddPath(l,e.PolyType.ptSubject,!0),r.ReverseSolution=!0,r.Execute(e.ClipType.ctUnion,o,e.PolyFillType.pftNegative,e.PolyFillType.pftNegative),o.length>0&&o.splice(0,1)}}},e.ClipperOffset.prototype.OffsetPoint=function(t,i,n){if(this.m_sinA=this.m_normals[i].X*this.m_normals[t].Y-this.m_normals[t].X*this.m_normals[i].Y,this.m_sinA<5e-5&&this.m_sinA>-5e-5)return i;if(this.m_sinA>1?this.m_sinA=1:this.m_sinA<-1&&(this.m_sinA=-1),this.m_sinA*this.m_delta<0)this.m_destPoly.push(new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[t].X+this.m_normals[i].X*this.m_delta),e.ClipperOffset.Round(this.m_srcPoly[t].Y+this.m_normals[i].Y*this.m_delta))),this.m_destPoly.push(new e.IntPoint(this.m_srcPoly[t])),this.m_destPoly.push(new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[t].X+this.m_normals[t].X*this.m_delta),e.ClipperOffset.Round(this.m_srcPoly[t].Y+this.m_normals[t].Y*this.m_delta)));else switch(n){case e.JoinType.jtMiter:var r=this.m_normals[t].X*this.m_normals[i].X+this.m_normals[t].Y*this.m_normals[i].Y+1;r>=this.m_miterLim?this.DoMiter(t,i,r):this.DoSquare(t,i);break;case e.JoinType.jtSquare:this.DoSquare(t,i);break;case e.JoinType.jtRound:this.DoRound(t,i)}return i=t},e.ClipperOffset.prototype.DoSquare=function(t,i){var n=Math.tan(Math.atan2(this.m_sinA,this.m_normals[i].X*this.m_normals[t].X+this.m_normals[i].Y*this.m_normals[t].Y)/4);this.m_destPoly.push(new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[t].X+this.m_delta*(this.m_normals[i].X-this.m_normals[i].Y*n)),e.ClipperOffset.Round(this.m_srcPoly[t].Y+this.m_delta*(this.m_normals[i].Y+this.m_normals[i].X*n)))),this.m_destPoly.push(new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[t].X+this.m_delta*(this.m_normals[t].X+this.m_normals[t].Y*n)),e.ClipperOffset.Round(this.m_srcPoly[t].Y+this.m_delta*(this.m_normals[t].Y-this.m_normals[t].X*n))))},e.ClipperOffset.prototype.DoMiter=function(t,i,n){var r=this.m_delta/n;this.m_destPoly.push(new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[t].X+(this.m_normals[i].X+this.m_normals[t].X)*r),e.ClipperOffset.Round(this.m_srcPoly[t].Y+(this.m_normals[i].Y+this.m_normals[t].Y)*r)))},e.ClipperOffset.prototype.DoRound=function(t,i){for(var n,r=Math.atan2(this.m_sinA,this.m_normals[i].X*this.m_normals[t].X+this.m_normals[i].Y*this.m_normals[t].Y),o=e.Cast_Int32(e.ClipperOffset.Round(this.m_StepsPerRad*Math.abs(r))),s=this.m_normals[i].X,l=this.m_normals[i].Y,p=0;p<o;++p)this.m_destPoly.push(new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[t].X+s*this.m_delta),e.ClipperOffset.Round(this.m_srcPoly[t].Y+l*this.m_delta))),n=s,s=s*this.m_cos-this.m_sin*l,l=n*this.m_sin+l*this.m_cos;this.m_destPoly.push(new e.IntPoint(e.ClipperOffset.Round(this.m_srcPoly[t].X+this.m_normals[t].X*this.m_delta),e.ClipperOffset.Round(this.m_srcPoly[t].Y+this.m_normals[t].Y*this.m_delta)))},e.Error=function(t){try{throw new Error(t)}catch(t){alert(t.message)}},e.JS={},e.JS.AreaOfPolygon=function(t,i){return i||(i=1),e.Clipper.Area(t)/(i*i)},e.JS.AreaOfPolygons=function(t,i){i||(i=1);for(var n=0,r=0;r<t.length;r++)n+=e.Clipper.Area(t[r]);return n/(i*i)},e.JS.BoundsOfPath=function(t,i){return e.JS.BoundsOfPaths([t],i)},e.JS.BoundsOfPaths=function(t,i){i||(i=1);var n=e.Clipper.GetBounds(t);return n.left/=i,n.bottom/=i,n.right/=i,n.top/=i,n},e.JS.Clean=function(t,i){if(!(t instanceof Array))return[];var n=t[0]instanceof Array;t=e.JS.Clone(t);if("number"!=typeof i||null===i)return e.Error("Delta is not a number in Clean()."),t;if(0===t.length||1==t.length&&0===t[0].length||i<0)return t;n||(t=[t]);for(var r,o,s,l,p,h,u,a=t.length,f=[],d=0;d<a;d++)if(0!==(r=(o=t[d]).length))if(r<3)s=o,f.push(s);else{for(s=o,l=i*i,p=o[0],h=1,u=1;u<r;u++)(o[u].X-p.X)*(o[u].X-p.X)+(o[u].Y-p.Y)*(o[u].Y-p.Y)<=l||(s[h]=o[u],p=o[u],h++);p=o[h-1],(o[0].X-p.X)*(o[0].X-p.X)+(o[0].Y-p.Y)*(o[0].Y-p.Y)<=l&&h--,h<r&&s.splice(h,r-h),s.length&&f.push(s)}return!n&&f.length?f=f[0]:n||0!==f.length?n&&0===f.length&&(f=[[]]):f=[],f},e.JS.Clone=function(t){if(!(t instanceof Array))return[];if(0===t.length)return[];if(1==t.length&&0===t[0].length)return[[]];var e=t[0]instanceof Array;e||(t=[t]);var i,n,r,o,s=t.length,l=new Array(s);for(n=0;n<s;n++){for(i=t[n].length,o=new Array(i),r=0;r<i;r++)o[r]={X:t[n][r].X,Y:t[n][r].Y};l[n]=o}return e||(l=l[0]),l},e.JS.Lighten=function(t,i){if(!(t instanceof Array))return[];if("number"!=typeof i||null===i)return e.Error("Tolerance is not a number in Lighten()."),e.JS.Clone(t);if(0===t.length||1==t.length&&0===t[0].length||i<0)return e.JS.Clone(t);var n,r,o,s,l,p,h,u,a,f,d,P,m,y,c,v;t[0]instanceof Array||(t=[t]);var C=t.length,I=i*i,_=[];for(n=0;n<C;n++)if(0!=(p=(o=t[n]).length)){for(s=0;s<1e6;s++){for(l=[],o[(p=o.length)-1].X!=o[0].X||o[p-1].Y!=o[0].Y?(d=1,o.push({X:o[0].X,Y:o[0].Y}),p=o.length):d=0,f=[],r=0;r<p-2;r++)h=o[r],a=o[r+1],u=o[r+2],c=h.X,v=h.Y,P=u.X-c,m=u.Y-v,0===P&&0===m||((y=((a.X-c)*P+(a.Y-v)*m)/(P*P+m*m))>1?(c=u.X,v=u.Y):y>0&&(c+=P*y,v+=m*y)),(P=a.X-c)*P+(m=a.Y-v)*m<=I&&(f[r+1]=1,r++);for(l.push({X:o[0].X,Y:o[0].Y}),r=1;r<p-1;r++)f[r]||l.push({X:o[r].X,Y:o[r].Y});if(l.push({X:o[p-1].X,Y:o[p-1].Y}),d&&o.pop(),!f.length)break;o=l}l[(p=l.length)-1].X==l[0].X&&l[p-1].Y==l[0].Y&&l.pop(),l.length>2&&_.push(l)}return t[0]instanceof Array||(_=_[0]),void 0===_&&(_=[[]]),_},e.JS.PerimeterOfPath=function(t,e,i){if(void 0===t)return 0;var n,r,o=Math.sqrt,s=0,l=0,p=0,h=0,u=0,a=t.length;if(a<2)return 0;for(e&&(t[a]=t[0],a++);--a;)l=(n=t[a]).X,p=n.Y,s+=o((l-(h=(r=t[a-1]).X))*(l-h)+(p-(u=r.Y))*(p-u));return e&&t.pop(),s/i},e.JS.PerimeterOfPaths=function(t,i,n){n||(n=1);for(var r=0,o=0;o<t.length;o++)r+=e.JS.PerimeterOfPath(t[o],i,n);return r},e.JS.ScaleDownPath=function(t,e){var i,n;for(e||(e=1),i=t.length;i--;)(n=t[i]).X=n.X/e,n.Y=n.Y/e},e.JS.ScaleDownPaths=function(t,e){var i,n,r;Math.round;for(e||(e=1),i=t.length;i--;)for(n=t[i].length;n--;)(r=t[i][n]).X=r.X/e,r.Y=r.Y/e},e.JS.ScaleUpPath=function(t,e){var i,n,r=Math.round;for(e||(e=1),i=t.length;i--;)(n=t[i]).X=r(n.X*e),n.Y=r(n.Y*e)},e.JS.ScaleUpPaths=function(t,e){var i,n,r,o=Math.round;for(e||(e=1),i=t.length;i--;)for(n=t[i].length;n--;)(r=t[i][n]).X=o(r.X*e),r.Y=o(r.Y*e)},e.ExPolygons=function(){return[]},e.ExPolygon=function(){this.outer=null,this.holes=null},e.JS.AddOuterPolyNodeToExPolygons=function(t,i){var n=new e.ExPolygon;n.outer=t.Contour();var r,o,s,l,p,h,u=t.Childs(),a=u.length;for(n.holes=new Array(a),s=0;s<a;s++)for(r=u[s],n.holes[s]=r.Contour(),l=0,h=(p=r.Childs()).length;l<h;l++)o=p[l],e.JS.AddOuterPolyNodeToExPolygons(o,i);i.push(n)},e.JS.ExPolygonsToPaths=function(t){var i,n,r,o,s=new e.Paths;for(i=0,r=t.length;i<r;i++)for(s.push(t[i].outer),n=0,o=t[i].holes.length;n<o;n++)s.push(t[i].holes[n]);return s},e.JS.PolyTreeToExPolygons=function(t){var i,n,r,o,s=new e.ExPolygons;for(n=0,o=(r=t.Childs()).length;n<o;n++)i=r[n],e.JS.AddOuterPolyNodeToExPolygons(i,s);return s}}();void 0===Date.now&&(Date.now=function(){return(new Date).valueOf()});var TWEEN=TWEEN||function(){var n=[];return{REVISION:"14",getAll:function(){return n},removeAll:function(){n=[]},add:function(t){n.push(t)},remove:function(t){var r=n.indexOf(t);-1!==r&&n.splice(r,1)},update:function(t){if(0===n.length)return!1;var r=0;for(t=void 0!==t?t:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();r<n.length;)n[r].update(t)?r++:n.splice(r,1);return!0}}}();TWEEN.Tween=function(n){var t=n,r={},i={},u={},o=1e3,e=0,a=!1,f=!1,c=!1,s=0,h=null,l=TWEEN.Easing.Linear.None,p=TWEEN.Interpolation.Linear,E=[],I=null,v=!1,w=null,M=null,d=null;for(var O in n)r[O]=parseFloat(n[O],10);this.to=function(n,t){return void 0!==t&&(o=t),i=n,this},this.start=function(n){for(var o in TWEEN.add(this),f=!0,v=!1,h=void 0!==n?n:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now(),h+=s,i){if(i[o]instanceof Array){if(0===i[o].length)continue;i[o]=[t[o]].concat(i[o])}r[o]=t[o],r[o]instanceof Array==!1&&(r[o]*=1),u[o]=r[o]||0}return this},this.stop=function(){return f?(TWEEN.remove(this),f=!1,null!==d&&d.call(t),this.stopChainedTweens(),this):this},this.stopChainedTweens=function(){for(var n=0,t=E.length;n<t;n++)E[n].stop()},this.delay=function(n){return s=n,this},this.repeat=function(n){return e=n,this},this.yoyo=function(n){return a=n,this},this.easing=function(n){return l=n,this},this.interpolation=function(n){return p=n,this},this.chain=function(){return E=arguments,this},this.onStart=function(n){return I=n,this},this.onUpdate=function(n){return w=n,this},this.onComplete=function(n){return M=n,this},this.onStop=function(n){return d=n,this},this.update=function(n){var f;if(n<h)return!0;!1===v&&(null!==I&&I.call(t),v=!0);var d=(n-h)/o,O=l(d=d>1?1:d);for(f in i){var N=r[f]||0,T=i[f];T instanceof Array?t[f]=p(T,O):("string"==typeof T&&(T=N+parseFloat(T,10)),"number"==typeof T&&(t[f]=N+(T-N)*O))}if(null!==w&&w.call(t,O),1==d){if(e>0){for(f in isFinite(e)&&e--,u){if("string"==typeof i[f]&&(u[f]=u[f]+parseFloat(i[f],10)),a){var m=u[f];u[f]=i[f],i[f]=m}r[f]=u[f]}return a&&(c=!c),h=n+s,!0}null!==M&&M.call(t);for(var g=0,W=E.length;g<W;g++)E[g].start(n);return!1}return!0}},TWEEN.Easing={Linear:{None:function(n){return n}},Quadratic:{In:function(n){return n*n},Out:function(n){return n*(2-n)},InOut:function(n){return(n*=2)<1?.5*n*n:-.5*(--n*(n-2)-1)}},Cubic:{In:function(n){return n*n*n},Out:function(n){return--n*n*n+1},InOut:function(n){return(n*=2)<1?.5*n*n*n:.5*((n-=2)*n*n+2)}},Quartic:{In:function(n){return n*n*n*n},Out:function(n){return 1- --n*n*n*n},InOut:function(n){return(n*=2)<1?.5*n*n*n*n:-.5*((n-=2)*n*n*n-2)}},Quintic:{In:function(n){return n*n*n*n*n},Out:function(n){return--n*n*n*n*n+1},InOut:function(n){return(n*=2)<1?.5*n*n*n*n*n:.5*((n-=2)*n*n*n*n+2)}},Sinusoidal:{In:function(n){return 1-Math.cos(n*Math.PI/2)},Out:function(n){return Math.sin(n*Math.PI/2)},InOut:function(n){return.5*(1-Math.cos(Math.PI*n))}},Exponential:{In:function(n){return 0===n?0:Math.pow(1024,n-1)},Out:function(n){return 1===n?1:1-Math.pow(2,-10*n)},InOut:function(n){return 0===n?0:1===n?1:(n*=2)<1?.5*Math.pow(1024,n-1):.5*(2-Math.pow(2,-10*(n-1)))}},Circular:{In:function(n){return 1-Math.sqrt(1-n*n)},Out:function(n){return Math.sqrt(1- --n*n)},InOut:function(n){return(n*=2)<1?-.5*(Math.sqrt(1-n*n)-1):.5*(Math.sqrt(1-(n-=2)*n)+1)}},Elastic:{In:function(n){var t,r=.1;return 0===n?0:1===n?1:(!r||r<1?(r=1,t=.1):t=.4*Math.asin(1/r)/(2*Math.PI),-r*Math.pow(2,10*(n-=1))*Math.sin((n-t)*(2*Math.PI)/.4))},Out:function(n){var t,r=.1;return 0===n?0:1===n?1:(!r||r<1?(r=1,t=.1):t=.4*Math.asin(1/r)/(2*Math.PI),r*Math.pow(2,-10*n)*Math.sin((n-t)*(2*Math.PI)/.4)+1)},InOut:function(n){var t,r=.1;return 0===n?0:1===n?1:(!r||r<1?(r=1,t=.1):t=.4*Math.asin(1/r)/(2*Math.PI),(n*=2)<1?r*Math.pow(2,10*(n-=1))*Math.sin((n-t)*(2*Math.PI)/.4)*-.5:r*Math.pow(2,-10*(n-=1))*Math.sin((n-t)*(2*Math.PI)/.4)*.5+1)}},Back:{In:function(n){var t=1.70158;return n*n*((t+1)*n-t)},Out:function(n){var t=1.70158;return--n*n*((t+1)*n+t)+1},InOut:function(n){var t=2.5949095;return(n*=2)<1?n*n*((t+1)*n-t)*.5:.5*((n-=2)*n*((t+1)*n+t)+2)}},Bounce:{In:function(n){return 1-TWEEN.Easing.Bounce.Out(1-n)},Out:function(n){return n<1/2.75?7.5625*n*n:n<2/2.75?7.5625*(n-=1.5/2.75)*n+.75:n<2.5/2.75?7.5625*(n-=2.25/2.75)*n+.9375:7.5625*(n-=2.625/2.75)*n+.984375},InOut:function(n){return n<.5?.5*TWEEN.Easing.Bounce.In(2*n):.5*TWEEN.Easing.Bounce.Out(2*n-1)+.5}}},TWEEN.Interpolation={Linear:function(n,t){var r=n.length-1,i=r*t,u=Math.floor(i),o=TWEEN.Interpolation.Utils.Linear;return t<0?o(n[0],n[1],i):t>1?o(n[r],n[r-1],r-i):o(n[u],n[u+1>r?r:u+1],i-u)},Bezier:function(n,t){var r,i=0,u=n.length-1,o=Math.pow,e=TWEEN.Interpolation.Utils.Bernstein;for(r=0;r<=u;r++)i+=o(1-t,u-r)*o(t,r)*n[r]*e(u,r);return i},CatmullRom:function(n,t){var r=n.length-1,i=r*t,u=Math.floor(i),o=TWEEN.Interpolation.Utils.CatmullRom;return n[0]===n[r]?(t<0&&(u=Math.floor(i=r*(1+t))),o(n[(u-1+r)%r],n[u],n[(u+1)%r],n[(u+2)%r],i-u)):t<0?n[0]-(o(n[0],n[0],n[1],n[1],-i)-n[0]):t>1?n[r]-(o(n[r],n[r],n[r-1],n[r-1],i-r)-n[r]):o(n[u?u-1:0],n[u],n[r<u+1?r:u+1],n[r<u+2?r:u+2],i-u)},Utils:{Linear:function(n,t,r){return(t-n)*r+n},Bernstein:function(n,t){var r=TWEEN.Interpolation.Utils.Factorial;return r(n)/r(t)/r(n-t)},Factorial:function(){var n=[1];return function(t){var r,i=1;if(n[t])return n[t];for(r=t;r>1;r--)i*=r;return n[t]=i}}(),CatmullRom:function(n,t,r,i,u){var o=.5*(r-n),e=.5*(i-t),a=u*u;return(2*t-2*r+o+e)*(u*a)+(-3*t+3*r-2*o-e)*a+o*u+t}}},module.exports=TWEEN;var saveAs=saveAs||function(e){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=function(){return e.URL||e.webkitURL||e},n=e.document.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in n,r=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),i=e.webkitRequestFileSystem,a=e.requestFileSystem||i||e.mozRequestFileSystem,c=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},f=0,s=function(n){var o=function(){"string"==typeof n?t().revokeObjectURL(n):n.remove()};e.chrome?o():setTimeout(o,500)},u=function(e,t,n){for(var o=(t=[].concat(t)).length;o--;){var r=e["on"+t[o]];if("function"==typeof r)try{r.call(e,n||e)}catch(e){c(e)}}},d=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e},l=function(c,l,p){p||(c=d(c));var v,w,y,m=this,h=c.type,S=!1,R=function(){u(m,"writestart progress write writeend".split(" "))},O=function(){if(w&&r&&"undefined"!=typeof FileReader){var n=new FileReader;return n.onloadend=function(){var e=n.result;w.location.href="data:attachment/file"+e.slice(e.search(/[,;]/)),m.readyState=m.DONE,R()},n.readAsDataURL(c),void(m.readyState=m.INIT)}(!S&&v||(v=t().createObjectURL(c)),w)?w.location.href=v:void 0==e.open(v,"_blank")&&r&&(e.location.href=v);m.readyState=m.DONE,R(),s(v)},g=function(e){return function(){if(m.readyState!==m.DONE)return e.apply(this,arguments)}},b={create:!0,exclusive:!1};if(m.readyState=m.INIT,l||(l="download"),o)return v=t().createObjectURL(c),void setTimeout(function(){var e,t;n.href=v,n.download=l,e=n,t=new MouseEvent("click"),e.dispatchEvent(t),R(),s(v),m.readyState=m.DONE});e.chrome&&h&&"application/octet-stream"!==h&&(y=c.slice||c.webkitSlice,c=y.call(c,0,c.size,"application/octet-stream"),S=!0),i&&"download"!==l&&(l+=".download"),("application/octet-stream"===h||i)&&(w=e),a?(f+=c.size,a(e.TEMPORARY,f,g(function(e){e.root.getDirectory("saved",b,g(function(e){var t=function(){e.getFile(l,b,g(function(e){e.createWriter(g(function(t){t.onwriteend=function(t){w.location.href=e.toURL(),m.readyState=m.DONE,u(m,"writeend",t),s(e)},t.onerror=function(){var e=t.error;e.code!==e.ABORT_ERR&&O()},"writestart progress write abort".split(" ").forEach(function(e){t["on"+e]=m["on"+e]}),t.write(c),m.abort=function(){t.abort(),m.readyState=m.DONE},m.readyState=m.WRITING}),O)}),O)};e.getFile(l,{create:!1},g(function(e){e.remove(),t()}),g(function(e){e.code===e.NOT_FOUND_ERR?t():O()}))}),O)}),O)):O()},p=l.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return n||(e=d(e)),navigator.msSaveOrOpenBlob(e,t||"download")}:(p.abort=function(){this.readyState=this.DONE,u(this,"abort")},p.readyState=p.INIT=0,p.WRITING=1,p.DONE=2,p.error=p.onwritestart=p.onprogress=p.onwrite=p.onabort=p.onerror=p.onwriteend=null,function(e,t,n){return new l(e,t,n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs});"use strict";!function(){var t=Array.prototype;t.peek=function(){return this[this.length-1]},t.append=function(t){return this.push(t),this},t.appendAll=function(t){return t&&t.length>0&&this.push.apply(this,t),this},t.clone=function(t){for(var n=this.slice(),i=n.length,r=0;r<i;)n[r]=n[r++].clone(t);return n},t.remove=function(t){var n=this.indexOf(t);return n>=0?this.splice(n,1):null},t.last=function(){return 0===this.length?null:this[this.length-1]},t.contains=function(t){return this.indexOf(t)>=0},t.toFloat32=function(){for(var t=0,n=new Float32Array(this.length);t<this.length;)n[t]=this[t++];return n},t.forEachPair=function(t,n){for(var i=0,r=n||2,e=this.length;i<e;)t(this[i],this[(i+1)%e],i),i+=r},t.show=function(t,n){n=n||function(t){console.log(t)},this.forEach(function(i){n(i[t]())})},String.prototype.reverse=function(){return this.split("").reverse().join("")}}();"use strict";!function(){var t=THREE.Mesh.prototype,n=THREE.Geometry.prototype,r=THREE.BufferGeometry.prototype;t.getBoundingBox=function(t){return this.geometry.getBoundingBox(t)},t.center=function(){return this.geometry.center(),this},t.mirrorX=function(){return this.mirror(0)},t.mirrorY=function(){return this.mirror(1)},t.mirrorZ=function(){return this.mirror(2)},t.mirror=function(t){var n,r=this.geometry,i=r.attributes,e=i.position.array,o=i.normal.array;for(n=t||0;n<e.length;n+=3)e[n]=-e[n],o[n]=-o[n];return r.computeVertexNormals(),this},n.center=function(t,n,r){var i=this.getBoundingBox(),e=i.dim.clone().multiplyScalar(.5),o=e.clone().add(i.min),u=this.attributes.position,a=u.array,s=Math.max(e.x,e.y,e.z),c=0;for(t&&(o.x-=(s-e.x)*t),n&&(o.y-=(s-e.y)*n),r&&(o.z-=(s-e.z)*r);c<a.length;)a[c++]-=o.x,a[c++]-=o.y,a[c++]-=o.z;return u.needsUpdate=!0,this.getBoundingBox(!0),this},n.getBoundingBox=function(t){return!t&&this.boundingBox||this.computeBoundingBox(),this.boundingBox.dim=this.boundingBox.max.clone().sub(this.boundingBox.min),this.boundingBox},n.unitScale=function(t){var n=this.getBoundingBox(),r=t||1;return this.applyMatrix((new THREE.Matrix3).identity().multiplyScalar(r/Math.max(n.max.x-n.min.x,n.max.y-n.min.y,n.max.z-n.min.z))),this.getBoundingBox(!0),this},r.center=n.center,r.getBoundingBox=n.getBoundingBox,r.unitScale=n.unitScale,r.fixNormals=function(){return this.computeVertexNormals(),this},THREE.Geometry.fromVertices=function(t){var n=new THREE.BufferGeometry;return n.addAttribute("position",new THREE.BufferAttribute(t,3)),n},THREE.Object3D.prototype.newGroup=function(){var t=new THREE.Group;return this.add(t),t},THREE.Object3D.prototype.removeAll=function(){this.children.slice().forEach(function(t){t.parent=void 0,t.dispatchEvent({type:"removed"})}),this.children=[]}}();"use strict";var gs_base=exports;!function(){if(self.base||(self.base={}),!self.base.util){var e=self.base,n=8;e.key={NONE:"",PROJECT:"project",SEGINT:"segint",RAYINT:"rayint",PARALLEL:"parallel"},e.config={bridgeLineGapDistance:0,precision_offset:.05,precision_poly_area:.05,precision_poly_bounds:.01,precision_poly_merge:.05,precision_merge:1e-4,precision_slice_z:1e-4,precision_merge_sq:s(1e-4),precision_bounds:1e-4,precision_slope:.02,precision_slope_merge:.25,precision_fill_merge:.001,precision_decimate:.05,decimate_threshold:1e5,precision_point_on_line:.01,precision_circularity:.001,hint_len_min:s(3),hint_len_max:s(20),hint_min_circ:.15,precision_mask_tolerance:.001,precision_close_to_poly_sq:s(.001),precision_midpoint_check_dist:1,precision_nested_sq:s(.01),clipper:1e5,clipperClean:1e3},e.util={sqr:s,time:function(){return(new Date).getTime()},round:function(e,i){var r=Math.pow(10,i||n);return Math.round(e*r)/r},area2:r,distSq:function(e,n){return s(n.x-e.x)+s(n.y-e.y)},distSqv2:function(e,n,i,r){return s(i-e)+s(r-n)},inRange:function(e,n,i){var r=parseFloat(e);return r>=n&&r<=i},isCloseTo:t,inCloseRange:o,isCollinear:function(e,n,i){return o(r(e,n,i),-1e-5,1e-5)},isClockwise:function(e,n,i){return r(e,n,i)>0},isCounterClockwise:function(e,n,i){return r(e,n,i)<0},doCombinations:function(e,n,i,r){var t,o;for(t=0;t<e.length;t++)for(o=e===n?t+1:0;o<n.length;o++)r(e[t],n[o],i);return i},offsetPrecision:function(e,n){return Math.abs(e)-n},intersectRayLine:function(n,i,r,t,s){var c=e.key,u=n.x,a=n.y,l=i.dx,_=i.dy,p=r.x,f=r.y,y=t.x-p,d=t.y-f,x=d*l-y*_,m=a-f,g=u-p,h=y*m-d*g,b=l*m-_*g;if(Math.abs(x)<1e-12)return null;if(m=h/x,g=b/x,s||o(g,0,1)&&m>=0){var v=e.newPoint(u+m*l,a+m*_,t.z||n.z,c.NONE);return v.dist=m,v.p1=r,v.p2=t,v}return null},intersect:function(n,i,r,t,o,s){var c=e.key,u=n.x,a=n.y,l=i.x,_=i.y,p=r.x,f=r.y,y=l-u,d=_-a,x=t.x-p,m=t.y-f,g=m*y-x*d;if(Math.abs(g)<1e-4)return o&&!s?null:c.PARALLEL;var h=a-f,b=u-p,v=x*h-m*b;b=(y*h-d*b)/g;var C=(h=v/g)>=-1e-4&&h<=1.0001&&b>=-1e-4&&b<=1.0001,N=h>=0&&b>=0;if(o===c.SEGINT&&!C)return null;if(o===c.RAYINT&&!N)return null;var R=e.newPoint(u+h*y,a+h*d,r.z||t.z,C?c.SEGINT:N?c.RAYINT:c.PROJECT);return R.dist=h,R.p1=r,R.p2=t,R},determinant:function(e,n,i,r){var t=n.x-e.x,o=n.y-e.y,s=r.x-i.x;return(r.y-i.y)*t-s*o}}}function i(e,n){return(n.x-e.x)*(n.y+e.y)}function r(e,n,r){return i(e,n)+i(n,r)+i(r,e)}function t(n,i,r){return Math.abs(n-i)<=(r||e.config.precision_merge)}function o(e,n,i){return(t(e,n)||e>=n)&&(t(e,i)||e<=i)}function s(e){return e*e}}();"use strict";var gs_base_debug=exports;!function(){if(self.base||(self.base={}),!self.base.debug){var n=self.base,e=!1,r={},t=[],i=20,o=0,f=[16711680,65280,255,65535,16711935,16776960];n.debug={on:function(){return e},enable:function(n){e=!0,n&&(i=Math.abs(n))},disable:function(){e=!1},history:function(){return t},last:function(){return t[t.length-1]},get:function(n){return r[n]},set:function(n,e){if(Array.isArray(n))for(var t=0;t<n.length;t++)r[n[t]]=e||1;else r[n]=e||1},clear:function(n){if(Array.isArray(n))for(var e=0;e<n.length;e++)delete r[n[e]];else delete r[n]},log:l,trace:function(n){n&&"string"!=typeof n&&(n=JSON.stringify(n)),l(new Error(n).stack)},test:function(n,e){var t;if(e)if(Array.isArray(e)){for(t=0;t<e.length;t++)if(r[e[t]])return null}else if(r[e])return null;if(n)if(Array.isArray(n)){for(t=0;t<n.length;t++)if(!r[n[t]])return null}else if(!r[n])return null;return s()||!0},view:null,setView:function(e){n.debug.view=e},color:function(){return f[o++%f.length]},xray:function n(e,r,t,i,o){var f,l=[11141120,0,11184640,4473924,65280,8947848,43690,0,170,4473924,11141290,8947848],u=0,c=t||s();"number"==typeof r&&e.setZ(r),e.forEachPoint(function(n){if(!f)return f;o&&(n.z=r+=.1),c.lines([f.clone(),n.clone()],l[u++%l.length]),f=n}),c.lines([e.last().clone(),e.first().clone()],16777215),c.points(e.points,0,.1),c.points([e.first()],16777215,.4),c.points([e.last()],5592405,.45),i&&e.inner&&e.inner.forEach(function(e){n(e,r,t,!1,o)})},points:function(n,e,r,t){s().points(n,e,t)},lines:function(n,e){s().lines(n,e)},polygon:function(n,e,r){return n.render(s(),e,r)},slice:null}}function l(n){if(console.log(n),e)for(t.push(n);t.length>i;)t.shift()}function s(){return n.debug.view}}();"use strict";var gs_base_render=exports;!function(){if(self.base||(self.base={}),!self.base.render){var e=self.base,r=1,n={};e.render={wireframe:function(e,s,i){if(s.length%3!=0)throw"invalid line : "+s.length;for(var c=new THREE.Geometry,a={},E=0,o=0;o<s.length;o+=3){var y=s[o],u=s[o+1],v=s[o+2],w=t(y,u),f=t(u,v),l=t(v,y);a[w.key]||(c.vertices.push(new THREE.Vector3(y.x,y.y,y.z)),c.vertices.push(new THREE.Vector3(u.x,u.y,u.z)),a[w.key]=++E),a[f.key]||(c.vertices.push(new THREE.Vector3(u.x,u.y,u.z)),c.vertices.push(new THREE.Vector3(v.x,v.y,v.z)),a[f.key]=++E),a[l.key]||(c.vertices.push(new THREE.Vector3(v.x,v.y,v.z)),c.vertices.push(new THREE.Vector3(y.x,y.y,y.z)),a[l.key]=++E)}c.verticesNeedUpdate=!0;var h=new THREE.LineSegments(c,function(e){var t=n[e];t||(t=new THREE.LineBasicMaterial({fog:!1,color:e,linewidth:r}),n[e]=t);return t}(i));return e.add(h),h}}}function t(r,n){return r.key<n.key?e.newLine(r,n):e.newLine(n,r)}}();"use strict";var gs_base_point=exports;!function(){if(self.base||(self.base={}),!self.base.Point){var t=self.base,i=t.util,n=t.config,s=t.key,r=i.round,o=e.prototype;t.Point=e,t.newPoint=u,o.setZ=function(t){return this.z=t,this},o.swapXZ=function(){var t=this,i=t.x;t.x=t.z,t.z=i},o.swapYZ=function(){var t=this,i=t.y;t.y=t.z,t.z=i},o.round=function(t){return u(r(this.x,t),r(this.y,t),r(this.z,t))},o.addFacet=function(t){return this.group||(this.group=[]),this.group.push(t),this},o.rekey=function(){this.key=[this.x,this.y,this.z].join(",")},o.toString=function(){return this.key},o.clone=function(){return u(this.x,this.y,this.z,this.key)},o.slopeTo=function(i){return t.newSlope(this,i)},o.lineTo=function(i,n){return t.newLine(this,i,n)},o.isNear=function(t,n){return i.isCloseTo(this.x,t.x,n)&&i.isCloseTo(this.y,t.y,n)},o.distToLine=function(t,i){return Math.sqrt(this.distToLineSq(t,i))},o.distToLineNew=function(t,i){return n=this,s=t,o={x:(r=i).x-s.x,y:r.y-s.y},e=h({x:n.x-s.x,y:n.y-s.y},o),u=h(o,o),y=e/u,f={x:s.x+y*o.x,y:s.y+y*o.y},function(t,i){return function(t){return Math.sqrt(h(t,t))}({x:t.x-i.x,y:t.y-i.y})}(n,f);var n,s,r,o,e,u,y,f},o.distToLineSq=function(t,n){var s=this,r=i.distSq(t,n),o=((s.x-t.x)*(n.x-t.x)+(s.y-t.y)*(n.y-t.y))/r;return o<0?i.distSq(s,t):o>1?i.distSq(s,n):i.distSqv2(s.x,s.y,t.x+o*(n.x-t.x),t.y+o*(n.y-t.y))},o.withinDist2=function(t,i,n){var s=t.distToSq2D(i),r=this.distToSq2D(t),o=this.distToSq2D(i);return!(s<n&&r>(s+=n)&&o>s)&&(!(r>s&&o>s)&&this.distToLineSq(t,i)<n)},o.midPointTo=function(t){return u((this.x+t.x)/2,(this.y+t.y)/2,this.z)},o.midPointTo3D=function(t){return u((this.x+t.x)/2,(this.y+t.y)/2,(this.z+t.z)/2)},o.projectOnSlope=function(t,i){return u(this.x+t.dx*i,this.y+t.dy*i,this.z)},o.followTo=function(t,i){return this.follow(this.slopeTo(t),i)},o.offsetPointFrom=function(t,i){var n=t.x-this.x,r=t.y-this.y,o=i/Math.sqrt(n*n+r*r),e=n*o,h=r*o;return u(t.x-e,t.y-h,t.z,s.NONE)},o.offsetPointTo=function(t,i){var n=t.x-this.x,r=t.y-this.y,o=i/Math.sqrt(n*n+r*r),e=n*o,h=r*o;return u(this.x+e,this.y+h,t.z,s.NONE)},o.offsetLineTo=function(i,n){var r=this,o=i.x-r.x,e=i.y-r.y,h=n/Math.sqrt(o*o+e*e),y=o*h,f=e*h,x=u(r.x-f,r.y+y,r.z,s.NONE),a=u(i.x-f,i.y+y,i.z,s.NONE);return x.op=r,a.op=i,t.newLine(x,a,s.NONE)},o.inPolygon=function(t){if(!t.bounds.containsXY(this.x,this.y))return!1;var i,n,s,r=t.points,o=r.length,e=!1;for(s=0;s<o;s++)i=r[s],n=r[(s+1)%o],i.y>=this.y!=n.y>=this.y&&this.x<=(n.x-i.x)*(this.y-i.y)/(n.y-i.y)+i.x&&(e=!e);return e},o.isInPolygon=function(t){var i;if(Array.isArray(t)){for(i=0;i<t.length;i++)if(this.isInPolygon(t[i]))return!0;return!1}var s=t.inner;if(this.inPolygon(t)||this.nearPolygon(t,n.precision_merge_sq)){for(i=0;s&&i<s.length;i++)if(this.inPolygon(s[i])&&!this.nearPolygon(s[i],n.precision_merge_sq))return!1;return!0}return!1},o.isInPolygonOnly=function(t){var i;if(Array.isArray(t)){for(i=0;i<t.length;i++)if(this.isInPolygonOnly(t[i]))return!0;return!1}var n=t.inner;if(this.inPolygon(t)){for(i=0;n&&i<n.length;i++)if(this.inPolygon(n[i]))return!1;return!0}return!1},o.nearPolygon=function(t,i,n){for(var s=0,r=t.points,o=r.length;s<o;s++)if(this.withinDist2(r[s],r[(s+1)%o],i))return!0;if(n&&t.inner)for(s=0;s<t.inner.length;s++)if(this.nearPolygon(t.inner[s],i))return!0;return!1},o.insideOffset=function(t,i,n){return this.inPolygon(t)===i>0&&!this.nearPolygon(t,n)},o.follow=function(t,i){var n=i/Math.sqrt(t.dx*t.dx+t.dy*t.dy);return u(this.x+t.dx*n,this.y+t.dy*n,this.z)},o.intersectZ=function(t,i){var n=t.x-this.x,s=t.y-this.y,r=t.z-this.z,o=1-(t.z-i)/r;return u(this.x+n*o,this.y+s*o,this.z+r*o)},o.isEqual2D=function(t){return this===t||this.x===t.x&&this.y===t.y},o.isMergable2D=function(t){return this.isEqual2D(t)||this.distToSq2D(t)<n.precision_merge_sq},o.isEqual=function(t){return this===t||this.x===t.x&&this.y===t.y&&this.z===t.z},o.isMergable3D=function(t){return this.isEqual(t)||this.distToSq3D(t)<n.precision_merge_sq},o.isInBox=function(t,i){return Math.abs(this.x-t.x)<i&&Math.abs(this.y-t.y)<i},o.distToPolySegments=function(t,i){var n=this,s=1/0;return t.forEachSegment(function(t,r){const o=Math.min(s,n.distToLine(t,r));if((s=Math.min(o,s))<=i)return!0}),s},o.distToPolyPoints=function(t,i){var n=this,s=1/0;return t.forEachPoint(function(t){if((s=Math.min(s,n.distTo2D(t)))<i)return!0}),s},o.nearestTo=function(t,i){if(!i)throw"missing max";var n,s,r,o=1/0,e=null;for(n=0;n<t.length;n++)(s=t[n])===this||s.del||(r=this.distToSq2D(s))<i&&r<o&&(o=r,e=s);return e},o.averageDistTo=function(t){var i,n=0,s=0;for(i=0;i<t.length;i++)t[i]!=this&&(n+=this.distToSq2D(t[i]),s++);return n/s},o.distTo2D=function(t){var i=this.x-t.x,n=this.y-t.y;return Math.sqrt(i*i+n*n)},o.distToSq2D=function(t){var i=this.x-t.x,n=this.y-t.y;return i*i+n*n},o.distTo3D=function(t){var i=this.x-t.x,n=this.y-t.y,s=this.z-t.z;return Math.sqrt(i*i+n*n+s*s)},o.distToSq3D=function(t){var i=this.x-t.x,n=this.y-t.y,s=this.z-t.z;return i*i+n*n+s*s},o.inTriangle=function(t,i,n){var s=this.x-t.x,r=this.y-t.y,o=(i.x-t.x)*r-(i.y-t.y)*s>0;return(n.x-t.x)*r-(n.y-t.y)*s>0!=o&&(n.x-i.x)*(this.y-i.y)-(n.y-i.y)*(this.x-i.x)>0==o},o.onLine=function(t,i){return this.distToLine(t,i)<n.precision_point_on_line},o.add=function(t){return u(this.x+t.x,this.y+t.y,this.z+t.z)},o.sub=function(t){return u(this.x-t.x,this.y-t.y,this.z-t.z)},o.move=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.X+=t.x*n.clipper,this.Y+=t.y*n.clipper,this}}function e(t,i,s,r,o){o?(this.x=t||o.X/n.clipper||0,this.y=i||o.Y/n.clipper||0,this.z=s||0,this.X=o.X,this.Y=o.Y,this.key=null):(this.x=t,this.y=i,this.z=s||0,this.X=t*n.clipper,this.Y=i*n.clipper,this.key=r||[t,i,s].toString()),this.poly=null,this.dist=0,this.p1=null,this.p2=null,this.pos=0,this.mod=0,this.del=!1,this.group=null}function h(t,i){return t.x*i.x+t.y*i.y}function u(t,i,n,s,r){return new e(t,i,n,s,r)}}();"use strict";var gs_base_slope=exports;!function(){if(self.base||(self.base={}),!self.base.Slope){var t=self.base,i=t.config,s=Math.abs,e=r.prototype,n=Math.PI/180,h=180/Math.PI;t.Slope=r,t.newSlope=a,t.newSlopeFromAngle=function(t){return a(0,0,Math.cos(t*n),Math.sin(t*n))},e.toString=function(){return[this.dx,this.dy,this.angle].join(",")},e.isSame=function(t){if(s(this.dx)<=i.precision_merge&&s(t.dx)<=i.precision_merge)return!0;if(s(this.dy)<=i.precision_merge&&s(t.dy)<=i.precision_merge)return!0;var e,n,h,r=Math.min(1/Math.sqrt(this.dx*this.dx+this.dy*this.dy),i.precision_slope_merge);return e=this.angle,n=t.angle,h=r||i.precision_slope,s(e-n)<=h||360-s(e-n)<=h},e.normal=function(){var t=this.dx;return this.dx=-this.dy,this.dy=t,this.angle=Math.atan2(this.dy,this.dx)*h,this},e.toUnit=function(){var t=Math.max(s(this.dx),s(this.dy));return this.dx=this.dx/t,this.dy=this.dy/t,this},e.factor=function(t){return this.dx*=t,this.dy*=t,this},e.invert=function(){return this.dx=-this.dx,this.dy=-this.dy,this.angle=360-this.angle,this}}function r(t,i,s,e){this.dx=t&&i?i.x-t.x:s,this.dy=t&&i?i.y-t.y:e,this.angle=Math.atan2(this.dy,this.dx)*h}function a(t,i,s,e){return new r(t,i,s,e)}}();"use strict";var gs_base_line=exports;!function(){if(self.base||(self.base={}),!self.base.Line){var t=self.base,e=i.prototype;t.Line=i,t.newLine=n,t.newOrderedLine=function(t,e,i){return t.key<e.key?n(t,e,i):n(e,t,i)},e.length=function(){return Math.sqrt(this.length2())},e.length2=function(){return this.p1.distToSq2D(this.p2)},e.slope=function(){return t.newSlope(this.p1.slopeTo(this.p2))},e.reverse=function(){var t=this.p1;return this.p1=this.p2,this.p2=t,this},e.midpoint=function(){return this.p1.midPointTo(this.p2)},e.isCollinear=function(t){var e=this.p1,i=this.p2,n=t.p1,s=t.p2,r=i.x-e.x,h=i.y-e.y,o=s.x-n.x,p=s.y-n.y;return Math.abs(p*r-o*h)<1e-6}}function i(t,e,i){i||(i=[t.key,e.key].join("-")),this.p1=t,this.p2=e,this.key=i,this.coplanar=!1,this.edge=!1,this.del=!1}function n(t,e,n){return new i(t,e,n)}}();"use strict";var gs_base_bounds=exports;!function(){if(self.base||(self.base={}),!self.base.Bounds){var i=self.base,t=i.util,n=i.config,s=Math.abs,h=Math.min,e=Math.max,x=m.prototype;i.Bounds=m,i.newBounds=function(){return new m},x.clone=function(){var i=new m;return i.minx=this.minx,i.miny=this.miny,i.maxx=this.maxx,i.maxy=this.maxy,i},x.equals=function(n,s){return s||(s=i.config.precision_offset),t.isCloseTo(this.minx,n.minx,s)&&t.isCloseTo(this.miny,n.miny,s)&&t.isCloseTo(this.maxx,n.maxx,s)&&t.isCloseTo(this.maxy,n.maxy,s)},x.merge=function(i){this.minx=h(this.minx,i.minx),this.maxx=e(this.maxx,i.maxx),this.miny=h(this.miny,i.miny),this.maxy=e(this.maxy,i.maxy)},x.update=function(i){this.minx=h(this.minx,i.x),this.maxx=e(this.maxx,i.x),this.miny=h(this.miny,i.y),this.maxy=e(this.maxy,i.y),this.minx===i.x&&(this.leftMost=i)},x.contains=function(i){return i.isNested(this)},x.containsXY=function(i,t){return i>=this.minx&&i<=this.maxx&&t>=this.miny&&t<=this.maxy},x.containsOffsetXY=function(i,t,n){return i>=this.minx-n&&i<=this.maxx+n&&t>=this.miny-n&&t<=this.maxy+n},x.isNested=function(i){return this.minx>=i.minx-n.precision_bounds&&this.maxx<=i.maxx+n.precision_bounds&&this.miny>=i.miny-n.precision_bounds&&this.maxy<=i.maxy+n.precision_bounds},x.overlaps=function(i,t){return 2*s(this.centerx()-i.centerx())-t<this.width()+i.width()&&2*s(this.centery()-i.centery())-t<this.height()+i.height()},x.width=function(){return this.maxx-this.minx},x.height=function(){return this.maxy-this.miny},x.centerx=function(){return this.minx+this.width()/2},x.centery=function(){return this.miny+this.height()/2}}function m(){this.minx=1e8,this.miny=1e8,this.maxx=-1e8,this.maxy=-1e8,this.leftMost=null}}();"use strict";var gs_base_polygon=exports;!function(){if(self.base||(self.base={}),!self.base.Polygon){var n=self.base,t=n.config,i=n.util,e=n.debug,r=n.key,s=Math.sqrt,o=function(){return n.polygons},h=Math.abs,u=Math.min,l=Math.max,a=Math.PI,f=a/180,c=n.Bounds,d=n.newPoint,g=v.prototype,y=(n.newSlope(d(0,0,0,r.NONE),d(1,0,0,r.NONE)),1);n.Polygon=v,n.newPolygon=x,v.filterTooSmall=function(n){return n.length<3?null:n},v.filterTooSkinny=function(n){return n.circularityDeep()*n.areaDeep()<.25?null:n},v.filterArea=function(n){return function(t){return t.area()>=n?t:null}},v.filterDeleted=function(n){return n.delete?null:n},v.filterInside=function(n){return function(t){return n.contains(t)}},v.filterCollect=function(n){return function(t){return n.push(t),t}},v.filterEvolve=function(n){return n.evolve()},v.filterChain=function(n){return t=n,function(n){for(var i=t.length,e=0;e<i&&(n=t[e++](n)););return n};var t},g.createConvexHull=function(n){n.sort(function(n,t){return n.x!=t.x?n.x-t.x:n.y-t.y});for(var t,i,e,r,s,o=n.length,h=[],u=0;u<2*o;u++){for(var l=u<o?u:2*o-1-u;h.length>=2&&(t=h[h.length-2],i=h[h.length-1],e=n[l],void 0,void 0,r=(t.x-i.x)*(e.y-i.y)-(t.y-i.y)*(e.x-i.x),s=(t.x-i.x)*(e.x-i.x)+(t.y-i.y)*(e.y-i.y),r<0||0==r&&s<=0);)h.pop();h.push(n[l])}return h.pop(),this.addPoints(h),this},g.stepsFromRoot=function(){for(var n=this.parent,t=0;n;)n.inner&&n.inner.length>1&&t++,n=n.parent;return t},g.first=function(){return this.points[0]},g.last=function(){return this.points[this.length-1]},g.swap=function(n,t){var i=this.points,e=i.length;this.bounds=new c;for(var r=0;r<e;r++)p=i[r],n?p.swapXZ():t&&p.swapYZ(),this.bounds.update(p);return this.inner&&this.inner.forEach(function(i){i.swap(n,t)}),this},g.center=function(n){var t=d(0,0,0,null),i=x(),e=this.points;return e.forEach(function(n){t.x+=n.x,t.y+=n.y,t.z+=n.z}),t.x/=e.length,t.y/=e.length,t.z/=e.length,n?t:(e.forEach(function(n){i.push(d(n.x-t.x,n.y-t.y,n.z-t.z))}),i)},g.circleCenter=function(){var n=this.points,t=n.length,i=Math.floor(t/3),e=n[0],r=n[i],s=n[2*i],o=(r.y-e.y)/(r.x-e.x),h=(s.y-r.y)/(s.x-r.x),u=d(0,0,0,null);return u.x=(o*h*(e.y-s.y)+h*(e.x+r.x)-o*(r.x+s.x))/(2*(h-o)),u.y=-1*(u.x-(e.x+r.x)/2)/o+(e.y+r.y)/2,u.z=e.z,u},g.centerRectangle=function(n,t,i){return t/=2,i/=2,this.push(d(n.x-t,n.y-i,n.z)),this.push(d(n.x+t,n.y-i,n.z)),this.push(d(n.x+t,n.y+i,n.z)),this.push(d(n.x-t,n.y+i,n.z)),this},g.centerCircle=function(n,t,e,r){var s=0,o=360/e;for(r&&(o=-o);e-- >0;)this.push(d(i.round(Math.cos(s*f)*t,7)+n.x,i.round(Math.sin(s*f)*t,7)+n.y,n.z)),s+=o;return this},g.move=function(n){var t=this.bounds=new c;return this.points.forEach(function(i){i.move(n),t.update(i)}),this.inner&&this.inner.forEach(function(t){t.move(n)}),this},g.scale=function(n,t){var e=this.bounds=new c;this.points.forEach(function(r){r.x*=n,r.y*=n,r.z*=n,t&&(r.x=i.round(r.x,t),r.y=i.round(r.y,t),r.z=i.round(r.z,t)),e.update(r)}),this.inner&&this.inner.forEach(function(i){i.scale(n,t)})},g.hintFillAngle=function(){for(var n,i,e,r,s=0,o=this.points,h=o.length,u=t.hint_min_circ,l=t.hint_len_min,a=t.hint_len_max||1/0;s<h;)n=o[s],i=o[++s%h],(e=n.distToSq2D(i))>=l&&e<=a&&(!r||e>r.len)&&(r={p1:n,p2:i,len:e});return r&&this.circularity()>=u&&(this.fillang=r.p1.slopeTo(r.p2).normal()),this.fillang},g.clone=function(n){for(var t=x(),i=this.length,e=0;e<i;)t.push(this.points[e++]);return t.fillang=this.fillang,t.depth=this.depth,t.open=this.open,n&&this.inner&&(t.inner=this.inner.clone()),t},g.setZ=function(n){for(var t=this.points,i=t.length,e=0;e<i;)t[e++].z=n;return this.inner&&this.inner.forEach(function(t){t.setZ(n)}),this},g.getZ=function(){return this.points[0].z},g.render=function(n,t,i,e){n.poly(this,t,i,e)},g.add=function(n,t,i){return this.push(d(n,t,i)),this},g.addPoints=function(n){for(var t=n.length,i=0;i<t;)this.push(n[i++]);return this},g.push=function(n){return n.poly&&(n=n.clone()),n.poly=this,this.length++,this.points.push(n),this.bounds.update(n),n},g.append=function(n){return this.push(n),this},g.setClosed=function(){return this.open=!1,this},g.setOpen=function(){return this.open=!0,this},g.isOpen=function(){return this.open},g.isClosed=function(){return!this.open},g.setClockwise=function(){return this.isClockwise()||this.reverse(),this},g.setCounterClockwise=function(){return this.isClockwise()&&this.reverse(),this},g.isClockwise=function(){return this.area(!0)>0},g.showKey=function(){return[this.first().key,this.last().key,this.length].join("~~")},g.alignWinding=function(n,t){t&&this.length>n.length?n.alignWinding(this,!1):this.isClockwise()!==n.isClockwise()&&this.reverse()},g.opposeWinding=function(n,t){t&&this.length>n.length?n.opposeWinding(this,!1):this.isClockwise()===n.isClockwise()&&this.reverse()},g.reverse=function(){return this.area2=-this.area2,this.points=this.points.reverse(),this},g.isNested=function(n){return!!n.bounds.contains(this.bounds)&&this.isInside(n,t.precision_nested_sq)},g.forEachPointEaseDown=function(n,t){for(var i,e,r,s=this.findClosestPointTo(t).index,o=t.z,h=0,u=this.points,l=u.length,a=-1,p=u[0].z;;){if(r=u[s%l],e&&r.z<o){var f=o-r.z;(i=e.distTo2D(r))>2*f?n(e.followTo(r,f).setZ(r.z),h++):i>=f||(r=r.clone().setZ(o-i/2)),o=r.z}else 0===h&&r.z<o&&(r=r.clone().setZ(o));if(e=r,n(r,h++),s%l===a)break;a<0&&r.z<=p&&(a=s%l),s++}return e},g.forEachPoint=function(n,t,i){for(var e,r=i||0,s=this.points,o=s.length,h=t?o+1:o,u=0;h-- >0;){if(n(s[e=r%o],e,s,u++))return;r++}},g.forEachSegment=function(n,t,i){for(var e,r,s=i||0,o=this.points,h=o.length,u=t?h-1:h;u-- >0;){if(r=(s+1)%h,n(o[e=s%h],o[r],e,r))return;s++}},g.intersections=function(t,e){var r=[];return this.forEachSegment(function(s,o,h,u){var l=i.intersect(t,e,s,o,n.key.SEGINT,!1);l&&(r.push(l),s.pos=h,o.pos=u)}),r.sort(function(n,e){return i.distSq(t,n)-i.distSq(t,e)}),r},g.bisect=function(n,t){if(this.isOpen())return null;var i=this.clone().setClockwise(),e=i.intersections(n,t);return e&&2===e.length?[i.emitSegment(e[0],e[1]),i.emitSegment(e[1],e[0]).reverse()]:null},g.emitSegment=function(n,t){var i=x(),e=n.p2.pos;t.p1.pos;return i.setOpen(),i.push(n),this.forEachPoint(function(n,e){if(i.push(n),n===t.p1)return!0},!0,e),i.push(t),i},g.hasPointsInside=function(n,i){if(!n.overlaps(this))return!1;var e,r=!1;return this.forEachSegment(function(s,o){return s.distTo2D(o)>t.precision_midpoint_check_dist&&((e=s.midPointTo(o)).inPolygon(n)||e.nearPolygon(n,i||t.precision_close_to_poly_sq))?r=!0:o.inPolygon(n)||o.nearPolygon(n,i||t.precision_close_to_poly_sq)?r=!0:void 0}),r},g.isInside=function(n,i){if(!this.bounds.isNested(n.bounds))return!1;var e,r=!0;return this.forEachSegment(function(s,o){return s.distTo2D(o)>t.precision_midpoint_check_dist&&!(e=s.midPointTo(o)).inPolygon(n)&&!e.nearPolygon(n,i||t.precision_close_to_poly_sq)?(r=!1,!0):o.inPolygon(n)||o.nearPolygon(n,i||t.precision_close_to_poly_sq)?void 0:(r=!1,!0)}),r},g.contains=function(n,t){return n&&n.isInside(this,t)&&n.isOutsideAll(this.inner,t)},g.containedBySet=function(n){if(!n)return!1;for(var t=0;t<n.length;t++)if(n[t].contains(this))return!0;return!1},g.addInner=function(n){return n.parent=this,this.inner?this.inner.push(n):this.inner=[n],this},g.innerCount=function(){return this.inner?this.inner.length:0},g.hasInner=function(){return this.inner&&this.inner.length>0},g.clearInner=function(){return this.inner=null,this},g.newUndeleted=function(){var n=x();return this.forEachPoint(function(t){t.del||n.push(t)}),n},g.circularity=function(){return 4*a*this.area()/i.sqr(this.perimeter())},g.circularityDeep=function(){return 4*a*this.areaDeep()/i.sqr(this.perimeter())},g.perimeter=function(){var n=0;return this.forEachSegment(function(t,i){n+=s(t.distToSq2D(i))},this.open),n},g.perimeterDeep=function(){var n=this.perimeter();return this.inner&&this.inner.forEach(function(t){n+=t.perimeter()}),n},g.area=function(n){if(this.length<3)return 0;if(0===this.area2)for(var t,i,e=this.points,r=e.length,s=0;s<r;s++)t=e[s],i=e[(s+1)%r],this.area2+=(i.x-t.x)*(i.y+t.y);return n?this.area2:h(this.area2/2)},g.areaDeep=function(){if(!this.inner)return this.area();var n,t=this.inner,i=this.area();for(n=0;n<t.length;n++)i-=t[n].area();return i},g.overlaps=function(n){return this.bounds.overlaps(n.bounds,t.precision_merge)},g.fromXYArray=function(n,t){for(var i=0;i<n.length;)this.add(n[i++],n[i++],t||0);return this},g.clean=function(){return function(n,t){for(var i=x(),e=0,r=n.length;e<r;)i.push(d(null,null,t,null,n[e++]));return i}(self.ClipperLib.Clipper.CleanPolygon(this.toClipper()[0],t.clipperClean),this.getZ())},g.toClipper=function(n,t){var i=n||[];if(t){for(var e,r=[],s=this.points,o=s.length,h=0;h<o;)e=s[h++],r.push({X:e.x,Y:e.y});i.push(r)}else i.push(this.points);return this.inner&&this.inner.forEach(function(n){n.toClipper(i,t)}),i},g.dump=function(n,t){for(var r,s=[JSON.stringify({len:this.length,area:this.areaDeep(),perim:this.perimeterDeep(),circ:this.circularityDeep(),inner:this.inner?this.inner.length:0,cw:this.isClockwise(),open:this.isOpen(),id:this.id})],o=[],h=0;h<this.points.length;)r=this.points[h++],o.appendAll([i.round(r.x,t||5),i.round(r.y,t||5)]);s.push("["+o.join(",")+"]"),e.log((n||"")+s.join("\n")),this.inner&&this.inner.forEach(function(n){n.dump("-- ",t)})},g.offset=function(n,t){return o().expand([this],-n,this.getZ(),t)},g.isEquivalent=function(n,e,r){if(i.isCloseTo(this.area(),n.area(),r||t.precision_poly_area)&&this.bounds.equals(n.bounds,r||t.precision_poly_bounds)){var s=this.circularity(),o=n.circularity();if(h(s-o)<t.precision_circularity&&1-s<t.precision_circularity)return!0;if(e){var u,l=this.inner,a=n.inner;if(l!==a){if(null===l||null===a||l.length!=a.length)return!1;for(u=0;u<l.length;u++)if(!l[u].isEquivalent(a[u]))return!1}}var p,f,c,d=!0;return this.forEachPoint(function(i){if(p=!1,n.forEachSegment(function(n,e){if((f=i.distToLine(n,e))<t.precision_poly_merge)return p=!0;c=Math.min(c,f)}),!p)return d=!1,!0}),d}return!1},g.findClosestPointTo=function(n){var t,i,e,r=1/0;return this.forEachPoint(function(o,h){(t=s(o.distToSq2D(n)))<r&&(i=h,r=t,e=o)}),{point:e,distance:r,index:i}},g.flattenTo=function(n){return n.push(this),this.inner&&n.appendAll(this.inner),n},g.shortestSegmentLength=function(){var n=1/0;return this.forEachSegment(function(t,i){n=Math.min(n,t.distTo2D(i))}),n},g.diff=function(n){var t=this.fillang&&this.area()>n.area()?this.fillang:n.fillang,i=self.ClipperLib,e=i.ClipType,r=i.PolyType,s=i.PolyFillType,h=new i.Clipper,u=new i.PolyTree,l=this.toClipper(),a=n.toClipper();return h.AddPaths(l,r.ptSubject,!0),h.AddPaths(a,r.ptClip,!0),h.Execute(e.ctDifference,u,s.pftEvenOdd,s.pftEvenOdd)?((n=o().fromClipperTree(u,n.getZ())).forEach(function(n){n.fillang=t}),n):null},g.mask=function(n){var t=this.fillang&&this.area()>n.area()?this.fillang:n.fillang,i=self.ClipperLib,e=i.ClipType,r=i.PolyType,s=i.PolyFillType,h=new i.Clipper,u=new i.PolyTree,l=this.toClipper(),a=n.toClipper();return h.AddPaths(l,r.ptSubject,!0),h.AddPaths(a,r.ptClip,!0),h.Execute(e.ctIntersection,u,s.pftEvenOdd,s.pftEvenOdd)?((n=o().fromClipperTree(u,n.getZ())).forEach(function(n){n.fillang=t}),n):null},g.union=function(n){if(!this.overlaps(n))return null;var t=this.fillang&&this.area()>n.area()?this.fillang:n.fillang,i=self.ClipperLib,e=i.ClipType,r=i.PolyType,s=i.PolyFillType,h=new i.Clipper,u=new i.PolyTree,l=this.toClipper(),a=n.toClipper();return h.AddPaths(l,r.ptSubject,!0),h.AddPaths(a,r.ptClip,!0),h.Execute(e.ctUnion,u,s.pftEvenOdd,s.pftEvenOdd)&&1===(n=o().fromClipperTree(u,n.getZ())).length?((n=n[0]).fillang=t,n):null},g.spread=function(){var n,t,i,e,r,s,o,a,p,f=this.points,c=f.length;for(o={d:0},p=0,n=0;n<c;n++)t=f[n%c],i=f[(n+1)%c],e=h(t.x-i.x)+h(t.y-i.y),r=h(e-o.d),s=e>p,p=l(p,e),(s||r<.001&&o.p1&&u(t.z,i.z)<u(o.p1.z,o.p2.z))&&(o={p1:t,p2:i,i:(n+1)%c,d:e});return o.i>0?((a=f.slice(o.i)).appendAll(f.slice(0,o.i)),x(a)):this}}function v(n){this.id=y++,this.open=!1,this.length=0,this.points=[],this.area2=0,this.bounds=new c,this.inner=null,this.parent=null,this.depth=0,this.delete=!1,this.fillang=null,this.fills=null,n&&this.addPoints(n)}function x(n){return new v(n)}}();"use strict";var gs_base_polygons=exports;!function(){if(self.base||(self.base={}),!self.base.polygons){var e=self.base,n=e.util,r=e.config,l=Math.PI/180,i=Math.abs,t=Math.sqrt,o=n.sqr,p=e.key.NONE,f=e.newPoint;e.polygons={trace2count:function e(n,r,l,i,t,o,p){if(0===i)return void(o&&o.append(n));var f,a=0===t&&o?l/2:l,u=n.offset(a,[]),s=[];if(0===u.length)return void(o&&o.append(n));n.inner&&n.inner.forEach(function(e){e.offset(-a,s)});var c=[];g(u,s,c,[],n.getZ());if(c.length>0){if(r.appendAll(c),0===t&&p&&p.appendAll(c),i>0)for(f=0;f<c.length;f++)e(c[f],r,l,i-1,t+1,o)}else o&&o.append(n)},rayIntersect:function(r,l,t,o){var p=0,f=[],a=[],u=e.config,s=o?u.precision_fill_merge:u.precision_merge;t.forEach(function(e){e.flattenTo(f)}),t=f;for(;p<t.length;)for(var c=t[p++],d=c.points,h=d.length,g=e.debug,y=!1,C=0;C<h;C++){var v=(C+1)%h,P=n.intersectRayLine(r,l,d[C],d[v]);P&&(P.group=c,a.push(P),P.isNear(d[C],s)?(P.pos=C,P.mod=h,y&&g.points([P],255,.5,1)):P.isNear(d[v],s)?(P.pos=v,P.mod=h,y&&g.points([P],65535,.5,.85)):y&&g.points([P],16711935,.5,.5))}if(a.length>0){var m,E,T=!1;if(a.sort(function(e,i){if(!e.del&&!i.del&&e.isNear(i,s)){var t=[];e.isNear(e.p1,s)||t.push(e.p1),e.isNear(e.p2,s)||t.push(e.p2),i.isNear(i.p1,s)||t.push(i.p1),i.isNear(i.p2,s)||t.push(i.p2),t.length<2?g.log("sliceInt: line common ep fail: "+t.length):t.length>2?(e.del=!0,i.del=!0):n.intersectRayLine(r,l,t[0],t[1])?(T=!0,e.del=!0,y&&g.points([e],16776960,.2,.85)):(T=!0,e.del=!0,i.del=!0,y&&g.points([e,i],16777215,.2,1))}return e.dist-i.dist}),o)for(p=0,h=a.length;p<h;){for(m=a[p++];m&&m.del&&p<h;)m=a[p++];for(E=a[p++];E&&E.del&&p<h;)E=a[p++];if(m&&E&&m.group&&m.group){var x=m.group,b=E.group,A=(x.depth,x===b);if(x.depth===b.depth&&A&&m.mod&&E.mod){var w=i(m.pos-E.pos);1!==w&&w!==m.mod-1||(m.del=!0,E.del=!0,T=!0,y&&g.points([m,E],16777215,.2,1.85))}}}if(T){var _=[];for(p=0;p<a.length;p++){var N=a[p];N.del||_.push(N)}a=_}}return a},alignWindings:h,setWinding:d,fillArea:function(n,r,u,s,c,d){if(0===n.length)return;var h,g=1,y=n[0],C=y.getZ(),v=y.bounds.clone();r%=180;for(;r>90;)r-=180;h=e.newSlope(0,0,Math.cos(r*l)*u,Math.sin(r*l)*u);for(;g<n.length;)v.merge(n[g++].bounds);var P=s||[],m=-h.dy,E=h.dx,T=i(i(m)>0?v.width()/m:0),x=i(i(E)>0?v.height()/E:0),b=t(o(T*m)+o(x*E)),A=t(o(m)+o(E)),w=b/A,_=r<0?{x:v.minx,y:v.miny,z:C}:{x:v.maxx,y:v.miny,z:C},N=self.ClipperLib,O=N.ClipType,S=N.PolyType,M=N.PolyFillType,L=new N.Clipper,k=new N.PolyTree,j=e.config.clipper*(c||0),I=e.config.clipper*(d||0),Z=[];for(P.origin=f(_.x,_.y,_.z),g=0;g<w;g++){var F=f(_.x-1e3*h.dx,_.y-1e3*h.dy,C,p),D=f(_.x+1e3*h.dx,_.y+1e3*h.dy,C,p);Z.push([F,D]),_.x+=m,_.y+=E}L.AddPaths(Z,S.ptSubject,!1),L.AddPaths(a(n),S.ptClip,!0),Z=[],L.Execute(O.ctIntersection,k,M.pftNonZero,M.pftEvenOdd)&&k.m_AllPolys.forEach(function(e){if(j||I){var n=N.JS.PerimeterOfPath(e.m_polygon,!1,1);if(j&&n<j)return;if(I&&n>I)return}var r=f(null,null,C,null,e.m_polygon[0]),l=f(null,null,C,null,e.m_polygon[1]),i=P.origin.distToLineNew(r,l)/u;Z.push([r,l,i])});return Z.sort(function(e,n){return e[2]-n[2]}),Z.forEach(function(e){var n=Math.round(e[2]);e[0].index=n,e[1].index=n,P.push(e[0]),P.push(e[1])}),P},subtract:g,flatten:function(e,n,r){n||(n=[]);return e.forEach(function(e){e.flattenTo(n),r&&(e.inner=null)}),n},trimTo:function(e,r){if(e===r||null===e||null===r)return null;var l,i=[];return n.doCombinations(e,r,{},function(e,n){(l=e.mask(n))&&i.appendAll(l)}),i},expand2:function e(n,l,i,t,o,p,f,a){h(n);n.forEach(function(e){e.inner&&d(e.inner,!e.isClockwise())});var u=r.clipper,c=self.ClipperLib,g=c.Clipper,C=c.PolyFillType,v=c.JoinType,P=c.EndType,m=new c.ClipperOffset,E=new c.PolyTree,T=n,x=.45*l;n.forEach(function(e){var n=g.CleanPolygons(e.toClipper(),r.clipperClean),l=g.SimplifyPolygons(n,C.pftNonZero);m.AddPaths(l,v.jtMiter,P.etClosedPolygon)});m.Execute(E,(l+x)*u);n=s(E,a);m=new c.ClipperOffset;E=new c.PolyTree;n.forEach(function(e){var n=g.CleanPolygons(e.toClipper(),r.clipperClean),l=g.SimplifyPolygons(n,C.pftNonZero);m.AddPaths(l,v.jtMiter,P.etClosedPolygon)});m.Execute(E,-x*u);n=s(E,a);if(f){var b=y(T),A=y(n),w=Math.abs(1-b/A);w>.2&&f(T,t.length?n:null,w,-x)}t&&t.appendAll(n);p&&p(n,o);(0===o||o>1)&&n.length>0&&e(n,i||l,i,t,o>0?o-1:0,p,f,a);return n},expand:function e(n,l,i,t,o,p,f){h(n);n.forEach(function(e){e.inner&&d(e.inner,!e.isClockwise())});var a=r.clipper,u=self.ClipperLib,c=u.Clipper,g=u.PolyFillType,C=u.JoinType,v=u.EndType,P=new u.ClipperOffset,m=new u.PolyTree;y(n);n.forEach(function(e){var n=c.CleanPolygons(e.toClipper(),r.clipperClean),l=c.SimplifyPolygons(n,g.pftNonZero);P.AddPaths(l,C.jtMiter,v.etClosedPolygon)});P.Execute(m,l*a);n=s(m,i);t&&t.appendAll(n);f&&f(n,o);(0===o||o>1)&&n.length>0&&e(n,p||l,i,t,o>0?o-1:0,p,f);return n},union:function(e){if(e.length<2)return e;var n,r,l,i=e.slice(),t=[];e:for(n=0;n<i.length;n++)if(i[n])for(r=n+1;r<i.length;r++)if(i[r]&&(l=i[n].union(i[r]))){i[n]=null,i[r]=null,i.push(l);continue e}for(n=0;n<i.length;n++)i[n]&&t.push(i[n]);return t},nest:function(e,n,r){if(!e)return e;var l,i;for(e.sort(function(e,n){return e.area()-n.area()}),l=0;l<e.length;l++)(i=e[l]).parent=null,i.inner=null;for(l=0;l<e.length-1;l++){i=e[l];for(var t=l+1;t<e.length;t++){var o=e[t];if((!r||!o.isOpen())&&i.isNested(o)){o.addInner(i);break}}}var p,f=[];for(l=0;l<e.length;l++){for(p=e[l],(i=p).depth=0;p.parent;)i.depth++,p=p.parent;n?0===i.depth&&f.push(i):i.depth%2==0?f.push(i):i.inner=null}return f},dump:function e(n){Array.isArray(n)?n.forEach(function(n){e(n)}):(console.group({id:n.id,area:n.area(),depth:n.depth,inner:n.inner?n.inner.length:null}),n.inner&&e(n.inner),console.groupEnd())},diff:function(e,n,r){var l=self.ClipperLib,i=l.ClipType,t=l.PolyType,o=l.PolyFillType,p=new l.Clipper,f=new l.PolyTree,u=a(e),c=a(n);return p.AddPaths(u,t.ptSubject,!0),p.AddPaths(c,t.ptClip,!0),p.Execute(i.ctDifference,f,o.pftEvenOdd,o.pftEvenOdd)?s(f,r):null},filter:function(e,n,r){return e.forEach(function(e){(e=r(e))&&(Array.isArray(e)?n.appendAll(e):n.push(e))}),n},toClipper:a,fromClipperNode:u,fromClipperTree:s,cleanClipperTree:c}}function a(e,n){var r=[];return e.forEach(function(e){e.toClipper(r,n)}),r}function u(n,r){var l=e.newPolygon();return n.m_polygon.forEach(function(e){l.push(f(null,null,r,null,e))}),l.open=n.IsOpen,l}function s(e,n,r,l){var i,t=r||[];return e.m_Childs.forEach(function(e){(i=u(e,n)).area()<.1||(l?l.addInner(i):t.push(i),e.m_Childs&&s(e,n,t,l?null:i))}),t}function c(e){var n=self.ClipperLib.Clipper;return e.m_Childs&&e.m_Childs.forEach(function(e){e.m_polygon=n.CleanPolygon(e.m_polygon,r.clipperClean),c(e.m_Childs)}),e}function d(e,n,r){if(e)for(var l,i=0;i<e.length;)(l=e[i++]).isClockwise()!==n&&l.reverse(),r&&l.inner&&d(l.inner,!n,!1)}function h(e){for(var n,r,l=e.length,i=0,t=0,o=0;o<l;)t+=(r=e[o++]).length,r.isClockwise()&&(i+=r.length);for(o=0,n=i>t/2;o<l;)(r=e[o++]).isClockwise()!=n&&r.reverse();return n}function g(e,n,r,l,i,t){var o=self.ClipperLib,p=o.ClipType,f=o.PolyType,u=o.PolyFillType,d=new o.Clipper,h=new o.PolyTree,g=a(e),y=a(n),C=t||.1,v=[];function P(e,n){e.forEach(function(e){e.area()>=C&&(n.push(e),v.push(e))})}return d.StrictlySimple=!0,r&&(d.AddPaths(g,f.ptSubject,!0),d.AddPaths(y,f.ptClip,!0),d.Execute(p.ctDifference,h,u.pftEvenOdd,u.pftEvenOdd)&&(c(h),P(s(h,i),r))),l&&(r&&(h.Clear(),d.Clear()),d.AddPaths(y,f.ptSubject,!0),d.AddPaths(g,f.ptClip,!0),d.Execute(p.ctDifference,h,u.pftEvenOdd,u.pftEvenOdd)&&(c(h),P(s(h,i),l))),v}function y(e){var n=0;return e.forEach(function(e){n+=e.circularityDeep()}),n}}();"use strict";var gs_moto_kv=exports;!function(){if(self.moto||(self.moto={}),!self.moto.KV){try{self.moto.KV=self.localStorage,self.moto.KV.setItem("__test",1),self.moto.KV.getItem("__test")}catch(t){console.log("in private browsing mode or 3rd party storage blocked. some settings will be lost."),self.moto.KV=new e}var t=e.prototype;t.getItem=function(t){return this[t]},t.setItem=function(t,e){this.__data__[t]=e,this[t]=e},t.removeItem=function(t){delete this.__data__[t]},t.clear=function(){var t,e=this.__data__;for(t in e)e.hasOwnProperty(t)&&(delete e[t],delete this[t])}}function e(){this.__data__={},this.__mem__=!0}}();"use strict";var gs_moto_ajax=exports;!function(){if(self.moto||(self.moto={}),!self.moto.Ajax){self.moto.Ajax=i,self.moto.callAjax=function(t,e){new i(e).request(t)};var t=["request not initialized","server connection established","request recieved","processing request","request complete"],e=i.prototype,a=moto.KV,s=a.getItem("moto-ajax")||(new Date).getTime().toString(36)+o()+o();a.setItem("moto-ajax",s),e.onStateChange=function(){if(this.state=t[this.ajax.readyState],4===this.ajax.readyState&&this.callback){var e=this.ajax.status;e>=200&&e<300?this.callback(this.ajax.responseType?this.ajax.response:this.ajax.responseText,this.ajax):this.callback(null,this.ajax)}},e.request=function(t,e,a){for(var i in this.ajax.open(e?"POST":"GET",t,!0),this.responseType&&(this.ajax.responseType=this.responseType),(a=a||{})["X-Moto-Ajax"]=s,a)this.ajax.setRequestHeader(i,a[i]);e?this.ajax.send(e):this.ajax.send()}}function i(e,a){this.ajax=new XMLHttpRequest,this.ajax.onreadystatechange=this.onStateChange.bind(this),this.ajax.withCredentials=!0,this.state=t[0],this.callback=e,this.responseType=a}function o(){return Math.round(4294967295*Math.random()).toString(36)}}();"use strict";var gs_moto_ctrl=exports;THREE.CubeControls=function(t,e,n,o){this.object=t,this.domElement=void 0!==e?e:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.reverseZoom=!1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT};var a,i,s=this,r=s.domElement,c=new THREE.Vector2,h=new THREE.Vector2,u=new THREE.Vector2,l=new THREE.Vector2,p=new THREE.Vector2,d=new THREE.Vector2,E=new THREE.Vector3,m=new THREE.Vector3,f=new THREE.Vector2,g=new THREE.Vector2,T=new THREE.Vector2,b=0,y=null,v=0,O=null,H=1,P=1,R=new THREE.Vector3,M=new THREE.Vector3,L=new THREE.Quaternion,A=(new THREE.Quaternion).setFromUnitVectors(t.up,new THREE.Vector3(0,1,0)),w=A.clone().inverse(),N={type:"change"},k={type:"start"},x={type:"end"},Y={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},D=Y.NONE,U=1,V=2,j=3,S=X(t.fov)?U:X(t.top)?V:j;function X(t){return null!==t&&void 0!==t}function I(t){for(var e=0;e<t.length;e++){var n=t[e];if(X(n))return n}return null}function Z(){return Math.pow(.95,s.zoomSpeed)}function z(t){if(!1!==s.enabled){t.preventDefault();var e=s.domElement===document?s.domElement.body:s.domElement;if(D===Y.ROTATE){if(!0===s.noRotate)return;h.set(t.clientX,t.clientY),u.subVectors(h,c),s.rotateLeft(2*Math.PI*u.x/e.clientWidth*s.rotateSpeed),s.rotateUp(2*Math.PI*u.y/e.clientHeight*s.rotateSpeed),c.copy(h)}else if(D===Y.DOLLY){if(!0===s.noZoom)return;g.set(t.clientX,t.clientY),T.subVectors(g,f),T.y>0?s.dollyIn():s.dollyOut(),f.copy(g)}else if(D===Y.PAN){if(!0===s.noPan)return;p.set(t.clientX,t.clientY),d.subVectors(p,l),s.pan(d.x,d.y),l.copy(p)}s.update()}}function C(){!1!==s.enabled&&(document.removeEventListener("mousemove",z,!1),document.removeEventListener("mouseup",C,!1),s.dispatchEvent(x),D=Y.NONE)}function _(t){if(!1!==s.enabled&&!0!==s.noZoom)if(t.preventDefault(),t.stopPropagation(),t.shiftKey&&o)o(t.deltaX||t.wheelDelta||t.detail);else{var e=-(t.deltaY||t.wheelDelta||t.detail||0);0!==e&&(s.reverseZoom&&(e=-e),e>0?s.dollyOut():e<0&&s.dollyIn(),s.update(),s.dispatchEvent(k),s.dispatchEvent(x))}}this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.rotateLeft=function(t){b-=t},this.rotateUp=function(t){v-=t},this.panLeft=function(t){var e=this.object.matrix.elements;E.set(e[0],e[1],e[2]),E.multiplyScalar(-t),R.add(E)},this.panUp=function(t){var e=this.object.matrix.elements;E.set(e[4],e[5],e[6]),E.multiplyScalar(t),R.add(E)},this.pan=function(t,e){var n=s.domElement===document?s.domElement.body:s.domElement;switch(S){case U:var o=s.object.position.clone().sub(s.target).length();o*=Math.tan(s.object.fov/2*Math.PI/180),s.panLeft(2*t*o/n.clientHeight),s.panUp(2*e*o/n.clientHeight);break;case V:s.panLeft(t*(s.object.right-s.object.left)/n.clientWidth),s.panUp(e*(s.object.top-s.object.bottom)/n.clientHeight)}},this.setZoom=function(t,e){s.reverseZoom=t,s.zoomSpeed=e||1},this.setPosition=function(t){y=I([t.left,t.theta,y]),O=I([t.up,t.phi,O]),t.panX&&(this.target.x=t.panX),t.panY&&(this.target.y=t.panY),t.panZ&&(this.target.z=t.panZ),t.scale&&(H=t.scale)},this.getPosition=function(t){var e=this.target;return{left:a,up:i,panX:e.x,panY:e.y,panZ:e.z,scale:t?P:1}},this.dollyIn=function(t){void 0===t&&(t=Z()),H*=t},this.dollyOut=function(t){void 0===t&&(t=Z()),H/=t},this.update=function(){var t=this.object.position;m.copy(t).sub(this.target),m.applyQuaternion(A),a=X(y)?y:Math.atan2(m.x,m.z),i=X(O)?O:Math.atan2(Math.sqrt(m.x*m.x+m.z*m.z),m.y),a+=b,i+=v,a=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,a)),i=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,i)),i=Math.max(1e-6,Math.min(Math.PI-1e-6,i));var e=m.length()*(S===U?H:1);e=Math.max(this.minDistance,Math.min(this.maxDistance,e)),this.target.add(R),m.x=e*Math.sin(i)*Math.sin(a),m.y=e*Math.cos(i),m.z=e*Math.sin(i)*Math.cos(a),m.applyQuaternion(w),t.copy(this.target).add(m),this.object.lookAt(this.target),b=0,y=null,v=0,O=null,R.set(0,0,0),P*=H,S===V?(s.object.zoom=1/H,s.object.updateProjectionMatrix()):H=1,M.distanceToSquared(this.object.position)>1e-6||8*(1-L.dot(this.object.quaternion))>1e-6?(this.dispatchEvent(N),M.copy(this.object.position),L.copy(this.object.quaternion),n&&n(t,!0)):n&&n(t,!1)},this.reset=function(){D=Y.NONE,H=1,P=1,this.target.copy(this.target0),this.object.position.copy(this.position0)},this.getPolarAngle=function(){return i},this.getAzimuthalAngle=function(){return a},this.onMouseUp=C,r.addEventListener("contextmenu",function(t){t.preventDefault()},!1),r.addEventListener("mousedown",function(t){if(!1!==s.enabled){switch(t.preventDefault(),t.button){case s.mouseButtons.ORBIT:D=t.metaKey?Y.PAN:Y.ROTATE;break;case s.mouseButtons.ZOOM:D=Y.DOLLY;break;case s.mouseButtons.PAN:D=Y.PAN}switch(D){case Y.ROTATE:if(!0===s.noRotate)return D=Y.NONE;c.set(t.clientX,t.clientY);break;case Y.DOLLY:if(!0===s.noZoom)return D=Y.NONE;f.set(t.clientX,t.clientY);break;case Y.PAN:if(!0===s.noPan)return D=Y.NONE;l.set(t.clientX,t.clientY)}document.addEventListener("mousemove",z,!1),document.addEventListener("mouseup",C,!1),s.dispatchEvent(k)}},!1),r.addEventListener("mousewheel",_,!1),r.addEventListener("DOMMouseScroll",_,!1),r.addEventListener("touchstart",function(t){if(!1!==s.enabled){switch(t.touches.length){case 1:if(!0===s.noRotate)return;D=Y.TOUCH_ROTATE,c.set(t.touches[0].pageX,t.touches[0].pageY);break;case 2:if(!0===s.noZoom)return;D=Y.TOUCH_DOLLY;var e=t.touches[0].pageX-t.touches[1].pageX,n=t.touches[0].pageY-t.touches[1].pageY,o=Math.sqrt(e*e+n*n);f.set(0,o);break;case 3:if(!0===s.noPan)return;D=Y.TOUCH_PAN,l.set(t.touches[0].pageX,t.touches[0].pageY);break;default:D=Y.NONE}s.dispatchEvent(k)}},!1),r.addEventListener("touchend",function(){!1!==s.enabled&&(s.dispatchEvent(x),D=Y.NONE)},!1),r.addEventListener("touchmove",function(t){if(!1!==s.enabled){t.preventDefault(),t.stopPropagation();var e=s.domElement===document?s.domElement.body:s.domElement;switch(t.touches.length){case 1:if(!0===s.noRotate)return;if(D!==Y.TOUCH_ROTATE)return;h.set(t.touches[0].pageX,t.touches[0].pageY),u.subVectors(h,c),s.rotateLeft(2*Math.PI*u.x/e.clientWidth*s.rotateSpeed),s.rotateUp(2*Math.PI*u.y/e.clientHeight*s.rotateSpeed),c.copy(h),s.update();break;case 2:if(!0===s.noZoom)return;if(D!==Y.TOUCH_DOLLY)return;var n=t.touches[0].pageX-t.touches[1].pageX,o=t.touches[0].pageY-t.touches[1].pageY,a=Math.sqrt(n*n+o*o);reverseZoom&&(a=-a),g.set(0,a),T.subVectors(g,f),T.y>0?s.dollyOut():s.dollyIn(),f.copy(g),s.update();break;case 3:if(!0===s.noPan)return;if(D!==Y.TOUCH_PAN)return;p.set(t.touches[0].pageX,t.touches[0].pageY),d.subVectors(p,l),s.pan(d.x,d.y),l.copy(p),s.update();break;default:D=Y.NONE}}},!1),window.addEventListener("keydown",function(t){if(!1!==s.enabled&&!0!==s.noKeys&&!0!==s.noPan)switch(t.keyCode){case s.keys.UP:s.pan(0,s.keyPanSpeed),s.update();break;case s.keys.BOTTOM:s.pan(0,-s.keyPanSpeed),s.update();break;case s.keys.LEFT:s.pan(s.keyPanSpeed,0),s.update();break;case s.keys.RIGHT:s.pan(-s.keyPanSpeed,0),s.update()}},!1)},THREE.CubeControls.prototype=Object.create(THREE.EventDispatcher.prototype);"use strict";var gs_moto_space=exports;!function(){var e,n,t,i,o,a,r,s,u,c,l,p,f,d,E,v,y,h,w,m,x,T,b=window,H=document,g=new THREE.Scene,R=new THREE.Group,z=R.children,M=Math.PI,S=M/2,D=M/4,G=Math.round,C=0,Z=0,k=0,P=!1,B=!1,L=!0,X=!1,Y=!1,j=12303291,U=13421772,V=!0,W=!0,A=!0,K=ie(0,0,0,.3/3),N={x:0,y:0,z:0},O={x:0,y:0},_=!1,I=null,q=null,F=0;function J(e){new TWEEN.Tween(s.getPosition()).to(e,500).onUpdate(function(){s.setPosition(this),se()}).start()}function Q(){return b.innerWidth}function $(){return b.innerHeight}function ee(){return Q()/$()}function ne(e,n,t){e.addEventListener(n,t)}function te(e,n){for(var t=0;t<n.length;t+=2)ne(e,n[t],n[t+1])}function ie(e,n,t,i){var o=new THREE.PointLight(16777215,i,0);return o.position.set(e,n,t),g.add(o),o}function oe(){c.position.y=-c.scale.z/2-k,ue()}function ae(e,n,t){c.scale.set(e||300,n||175,t||5),s.maxDistance=4*Math.max(e,n),oe();var i=1*Math.max(e,t);v.position.set(e,i,n),y.position.set(-e,i,-n),h.position.set(e,h.position.y,-n),w.position.set(-e,w.position.y,n),F=n}function re(e,n,t,i){if(r&&he.scene.remove(r),e){r=new THREE.Group,a=e,o=n;var s,u=c.scale.x,l=c.scale.y,p=c.scale.z,f=G(u/e)*e,d=G(l/e)*e,E=Math.ceil(f/2),v=Math.ceil(d/2),y=u/2,h=l/2,w=-(p/2)-k+Z,m=[],x=[],T=n?[]:null;for(m.append({x:4.5,y:-F/2-3.5,z:0}).append({x:-4.5,y:-F/2-3.5,z:0}),m.append({x:-4.5,y:-F/2-3.5,z:0}).append({x:0,y:-F/2-8.5,z:0}).append({x:0,y:-F/2-8.5,z:0}).append({x:4.5,y:-F/2-3.5,z:0}),s=-E;s<=E;s++)s>=-y&&s<=y&&(s%e==0?x.append({x:s,y:-h,z:w}).append({x:s,y:h,z:w}):T&&s%n==0&&T.append({x:s,y:-h,z:w}).append({x:s,y:h,z:w}));for(s=-v;s<=v;s++)s>=-h&&s<=h&&(s%e==0?x.append({x:-y,y:s,z:w}).append({x:y,y:s,z:w}):T&&s%n==0&&T.append({x:-y,y:s,z:w}).append({x:y,y:s,z:w}));r.add(fe(m,10066329,1)),r.add(fe(x,t||10066329,1)),T&&r.add(fe(T,i||13421772,1)),he.scene.add(r)}}function se(){P=!1,s.update()}function ue(e){!1===P&&(P=!0,setTimeout(se,e||10))}function ce(){m.aspect=ee(),m.updateProjectionMatrix(),x.setSize(Q(),$()),T.style.width=Q(),T.style.height=$(),ue()}function le(e){return e.charCodeAt(0)}function pe(e){if(!L||H.activeElement&&H.activeElement!=H.body)return!1;if(e.metaKey)return!1;var n=!0;switch(e.charCode){case le("f"):he.view.front();break;case le("t"):he.view.top();break;default:n=!1}return n&&e.preventDefault(),!1}function fe(e,n,t){if(e.length%2!=0)throw"invalid line : "+e.length;for(var i,o,a=new THREE.Geometry,r=0;r<e.length;)i=e[r++],o=e[r++],a.vertices.push(new THREE.Vector3(i.x,i.y,i.z)),a.vertices.push(new THREE.Vector3(o.x,o.y,o.z));return a.verticesNeedUpdate=!0,new THREE.LineSegments(a,new THREE.LineBasicMaterial({color:n,linewidth:t||1}))}function de(e,n){var t=new THREE.Vector3(O.x,O.y,0).unproject(m);return new THREE.Raycaster(m.position,t.sub(m.position).normalize()).intersectObjects(e,n)}function Ee(n){if(n.target===x.domElement){H.activeElement.blur(),n.preventDefault();var t=null,i=Y?u:c;if(e&&(t=e()),t&&t.length>0){i.visible=!0;var o=de(t.slice().append(i),!1);if(i.visible=!1,o.length>0){for(var a,r,l=0;l<o.length;l++)a||o[l].object!==i?!r&&t.contains(o[l].object)&&(r=o[l]):a=o[l];a&&r&&(I=a.point.clone(),q=I,s.enabled=!1,e(r,n))}}if(p){var d=c.visible;c.visible=!0,o=de([c],!1),c.visible=d,f=o&&o.length>0?o[0].point:null}}else s.enabled=!1;_=!1}function ve(e){if(s.enabled||(s.enabled=!0,s.onMouseUp(e)),_)i&&q&&i(null,null,!0);else if(e.preventDefault(),!_){var t=!1,o=null;if(n&&(o=n()),o&&o.length>0){var a=de(o,B);a.length>0?(n(a[0],e),t=!0):n(null,e)}!t&&f&&p(f),t&&ue()}I=null,q=null}function ye(e){var n,o;if(s.enabled){e.preventDefault();var a=t?t():null;a&&a.length>0&&(n=de(a,B)).length>0&&t(n[0],e),n&&0!=n.length||!l||(o=c.visible,c.visible=!0,n=de([c],!1),c.visible=o,n&&n.length>0&&l(n[0].point))}else if(I&&i&&i()){e.preventDefault();var r=Y?u:c;if(r.visible=!0,n=de([r],!1),r.visible=!1,n.length>0&&n[0].object===r){var p=I.clone().sub(n[0].point),f=q.clone().sub(n[0].point);I=n[0].point,i({x:-p.x,y:p.z},f.multiplyVectors(f,N)),ue()}}_=!0,O={x:e.clientX/Q()*2-1,y:-e.clientY/$()*2+1}}!function e(){TWEEN.update(),setTimeout(e,20)}();var he={alignTracking:function(e,n,t){e&&n?(Y=!0,u.position.set(e.x,e.y,e.z),u.rotation.set(n.x,n.y,n.z),N=t):(Y=!1,u.position.set(0,0,0),u.rotation.set(S,0,0))},addEventListener:ne,addEventHandlers:te,onEnterKey:function e(n,t){if(Array.isArray(n))for(var i=0;i<n.length;i+=2)e(n[i],n[i+1]);else ne(n,"keyup",function(e){13===e.keyCode&&t(e)})},onResize:ce,update:ue,showSkyGrid:function(e){V=e},setSkyColor:function(e){j=e},setSkyGridColor:function(e){U=e},scene:{add:function(e){return e.rotation.x=R.rotation.x,g.add(e)},remove:function(e){return g.remove(e)}},platform:{tweenTo:function(e,n,t){var i={x:c.scale.x,y:c.scale.y,z:c.scale.z},r={x:e,y:n,z:t},s=a,u=o;new TWEEN.Tween(i).to(r,500).onStart(function(){re(0)}).onUpdate(function(){ae(this.x,this.y,this.z),se()}).onComplete(function(){re(s,u)}).start()},setSize:function(e,n,t){ae(e,n,t),re(a,o)},setColor:function(e){c.material.color.set(e),ue()},setGrid:re,add:function(e){R.add(e)},remove:function(e){R.remove(e)},setMaxZ:function(e){C=e/2},isHidden:function(){return!W},setHidden:function(e){W=!e,c.visible=!e},setHiding:function(e){A=e},setZOff:function(e){k=e,oe()},setGZOff:function(e){Z=e,oe()},opacity:function(e){c.material.opacity=e},onMove:function(e){d=e},onHover:function(e){l=e},onClick:function(e){p=e},size:function(){return c.scale},isVisible:function(){return c.visible},showGrid:function(e){r.visible=e}},view:{top:function(){J({left:0,up:0,panX:0,panY:C,panZ:0})},back:function(){J({left:M,up:S,panX:0,panY:C,panZ:0})},home:function(){J({left:0,up:D,panX:0,panY:C,panZ:0})},front:function(){J({left:0,up:S,panX:0,panY:C,panZ:0})},right:function(){J({left:S,up:S,panX:0,panY:C,panZ:0})},left:function(){J({left:-S,up:S,panX:0,panY:C,panZ:0})},panTo:function(e,n,t){!function(e,n,t){var i=s.getPosition();i.panX=e,i.panY=n,i.panZ=t,J(i)}(e,n,t)},setZoom:function(e,n){s.setZoom(e,n)},reset:function(){s.reset(),ue()},load:function(e){s.setPosition(e)},save:function(){return s.getPosition(!0)}},mouse:{downSelect:function(n){e=n},upSelect:function(e){n=e},onDrag:function(e){i=e},onHover:function(e){t=e}},useDefaultKeys:function(e){L=e},selectRecurse:function(e){B=e},objects:function(){return z},screenshot:function(e){return x.domElement.toDataURL(e||"image/png")},init:function(e,n){T=e,R.rotation.x=-S,g.add(R),e.style.width=Q(),e.style.height=$(),x=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0}),(m=new THREE.PerspectiveCamera(35,ee(),1,1e5)).position.set(0,200,340),x.setSize(Q(),$()),e.appendChild(x.domElement),(s=new THREE.CubeControls(m,e,function(e,n){c&&(c.visible=A?X&&e.y>=0&&W:W),K&&K.position.copy(m.position),x.render(g,m),n&&d&&(E&&clearTimeout(E),E=setTimeout(d,500))},n)).noKeys=!0,s.maxDistance=1e3,g.add(new THREE.AmbientLight(7368816)),v=ie(200,250,200,.345),y=ie(-200,250,-200,.285),ie(0,-200,0,.15),h=ie(200,5,-200,.105),w=ie(-200,5,200,.12),(c=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshPhongMaterial({color:13421772,specular:13421772,shininess:5,transparent:!0,opacity:.6,side:THREE.DoubleSide}))).position.y=k,c.rotation.x=-S,c.visible=W,(u=new THREE.Mesh(new THREE.PlaneBufferGeometry(2e3,2e3,1,1),new THREE.MeshBasicMaterial({color:7829367,opacity:.3,transparent:!1,side:THREE.DoubleSide}))).visible=!1,u.rotation.x=S;var t=new THREE.Mesh(new THREE.BoxGeometry(5e4,5e4,5e4,1,1,1),new THREE.MeshBasicMaterial({color:j,side:THREE.DoubleSide})),i=new THREE.Mesh(new THREE.BoxGeometry(5e3,5e3,5e3,10,10,10),new THREE.MeshBasicMaterial({color:U,side:THREE.DoubleSide}));g.add(c),g.add(u),g.add(t),V&&(i.material.wireframe=!0,g.add(i)),te(b,["resize",ce,"mousemove",ye,"mousedown",Ee,"mouseup",ve,"keypress",pe]),X=!0}};window.moto||(window.moto={}),window.moto.Space=he}();"use strict";!function(){function t(){this.vertices=null,this.normals=null,this.colors=null}var e=t.prototype;self.moto||(self.moto={}),self.moto.STL=t,e.load=function(t,e){var r=this,n=new XMLHttpRequest;n.addEventListener("load",function(t){200===t.target.status||0===t.target.status?(r.parse(t.target.response||t.target.responseText),e&&e(r.vertices)):e&&e(null,t.target.statusText)},!1),n.addEventListener("progress",function(t){},!1),n.addEventListener("error",function(){},!1),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=x-user-defined"),n.open("GET",t,!0),n.responseType="arraybuffer",n.send(null)},e.encode=function(t,e){if(!t||t.length%3!=0)throw"invalid vertices";var r,n=t.length/3,a=new ArrayBuffer(16*n+n*(2/3)+84),o=new DataView(a),s=0,i=0,l=80;function u(t){o.setUint16(l,t,!0),l+=2}function f(t){o.setFloat32(l,t,!0),l+=4}function g(){f(t[s++]),f(t[s++]),f(t[s++])}for(r=n/3,o.setUint32(l,r,!0),l+=4;s<t.length;)f(e?e[i++]:0),f(e?e[i++]:0),f(e?e[i++]:0),g(),g(),g(),u(0);return a},e.parse=function(t){var e,r=this.convertToBinary(t);return 84+50*(e=new DataView(r)).getUint32(80,!0)===e.byteLength?this.parseBinary(r):this.parseASCII(this.convertToString(t))},e.parseBinary=function(t){for(var e,r,n,a,o,s,i=new DataView(t),l=i.getUint32(80,!0),u=!1,f=0;f<70;f++)1129270351==i.getUint32(f,!1)&&82==i.getUint8(f+4)&&61==i.getUint8(f+5)&&(u=!0,p=new Float32Array(3*l*3),a=i.getUint8(f+6)/255,o=i.getUint8(f+7)/255,s=i.getUint8(f+8)/255,i.getUint8(f+9)/255);for(var g=0,c=new Float32Array(3*l*3),h=new Float32Array(3*l*3),p=u?new Uint16Array(3*l*3):null,v=0;v<l;v++){var y=84+50*v,d=i.getFloat32(y,!0),F=i.getFloat32(y+4,!0),w=i.getFloat32(y+8,!0);if(u){var U=i.getUint16(y+48,!0);0==(32768&U)?(e=(31&U)/31,r=(U>>5&31)/31,n=(U>>10&31)/31):(e=a,r=o,n=s)}for(var A,T=1;T<=3;)A=y+12*T++,c[g]=i.getFloat32(A,!0),c[g+1]=i.getFloat32(A+4,!0),c[g+2]=i.getFloat32(A+8,!0),h[g]=d,h[g+1]=F,h[g+2]=w,u&&(p[g]=e,p[g+1]=r,p[g+2]=n),g+=3}return this.vertices=c,this.normals=h,this.colors=p,c},e.parseASCII=function(t){for(var e,r,n,a,o=[],s=[],i=/facet([\s\S]*?)endfacet/g;null!==(e=i.exec(t));){for(r=e[0],n=/normal[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/g,a=/vertex[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/g;null!==(e=n.exec(r));)s.push(parseFloat(e[1])),s.push(parseFloat(e[3])),s.push(parseFloat(e[5]));for(;null!==(e=a.exec(r));)o.push(parseFloat(e[1])),o.push(parseFloat(e[3])),o.push(parseFloat(e[5]))}var l,u=new Float32Array(o.length),f=new Float32Array(s.length);for(l=0;l<o.length;l++)u[l]=o[l];for(l=0;l<s.length;l++)f[l]=s[l];return this.vertices=u,this.normals=f,u},e.convertToString=function(t){if("string"!=typeof t){for(var e=new Uint8Array(t),r="",n=0;n<t.byteLength;n++)r+=String.fromCharCode(e[n]);return r}return t},e.convertToBinary=function(t){if("string"==typeof t){for(var e=new Uint8Array(t.length),r=0;r<t.length;r++)e[r]=255&t.charCodeAt(r);return e.buffer||e}return t}}();"use strict";var gs_moto_db=exports;!function(){if(self.moto||(self.moto={}),!self.moto.Storage){self.moto.Storage=r;var e=self.indexedDB||self.mozIndexedDB||self.webkitIndexedDB||self.msIndexedDB,t=self.IDBKeyRange,i=null;r.delete=function(t){e.deleteDatabase(t)};var n=r.prototype;n.keys=function(e,t,i){var n=[];this.iterate(function(e,t){e&&n.push(e)},t,i,!0),e(n)},n.iterate=function(e,i,n,r){if(!this.db)return this.init(),this.queue.push(["iterate",e,i,n]);var o=i&&n?t.bound(i,n):i?t.lowerBound(i):n?t.upperBound(n):void 0;this.db.transaction(this.name).objectStore(this.name).openCursor(o).onsuccess=function(t){var i=t.target.result;i?(e(i.key,i.value),i.continue()):r&&e(null)}},n.deleteStore=function(){if(this.initCalled)throw"cannot delete ObjectStore after init() called";return this.version=Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,this.init(!0)},n.init=function(t){if(!this.initCalled){var n=this,r=this.name,o=null;try{(o=e.open(r,this.version)).onupgradeneeded=function(e){t?n.db.deleteObjectStore(r):(n.db=o.result,n.store=n.db.createObjectStore(r),setTimeout(function(){n.runQueue()}))},o.onsuccess=function(e){n.db=o.result,n.runQueue()},o.onerror=function(e){console.log({error:e}),s()}}catch(e){return void s()}return this.initCalled=!0,this}function s(){console.log("in private browsing mode or browser lacks support for IndexedDB. unable to setup storage for '"+r+"'."),i={},n.runQueue()}},n.runQueue=function(){if(this.queue.length>0){for(var e,t=0,i=this.queue;t<i.length;)switch((e=i[t++])[0]){case"iterate":this.iterate(e[1],e[2],e[3]);break;case"put":this.put(e[1],e[2],e[3]);break;case"get":this.get(e[1],e[2]);break;case"remove":this.remove(e[1],e[2]);break;case"clear":this.clear()}this.queue=[]}},n.put=function(e,t,n){if(i)return i[e]=t,void(n&&n(!0));if(!this.db)return this.init(),this.queue.push(["put",e,t,n]);try{var r=this.db.transaction(this.name,"readwrite").objectStore(this.name).put(t,e);n&&(r.onsuccess=function(e){n(!0)},r.onerror=function(e){n(!1)})}catch(e){console.log(e),n&&n(!1)}},n.get=function(e,t){if(i)t&&t(i[e]);else{if(!this.db)return this.init(),this.queue.push(["get",e,t]);try{var n=this.db.transaction(this.name).objectStore(this.name).get(e);t&&(n.onsuccess=function(e){t(n.result)},n.onerror=function(e){t(null)})}catch(e){console.log(e),t&&t(null)}}},n.remove=function(e,t){if(i)return delete i[e],void(t&&t(!0));if(!this.db)return this.init(),this.queue.push(["remove",e,t]);try{var n=this.db.transaction(this.name,"readwrite").objectStore(this.name).delete(e);t&&(n.onsuccess=function(e){t(!0)},n.onerror=function(e){t(!1)})}catch(e){console.log(e),t&&t(!1)}},n.clear=function(e){if(!this.db)return this.init(),this.queue.push(["clear"]);this.db.transaction(this.name,"readwrite").objectStore(this.name).clear()}}function r(e,t){this.db=null,this.name=e,this.version=t||1,this.queue=[],this.initCalled=!1}}();"use strict";var gs_moto_ui=exports;!function(){var e=self.moto=self.moto||{};if(!e.ui){var t=self,i=null,n=null,l=null,r=[],o=(e.KV,t.document);t.$=t.$||function(e){return o.getElementById(e)},e.ui={prefix:function(t){return t,e.ui},hideAction:function(t){return t,e.ui},inputAction:function(t){return l=t,e.ui},setMode:function(e){r.forEach(function(t){t.setMode(e)})},bound:function(e,t){return function(i){return isNaN(i)?e:i<e?e:i>t?t:i}},toInt:function(){var e=""!==this.value?parseInt(this.value):null;isNaN(e)&&(e=0);null!==e&&this.bound&&(e=this.bound(e));return this.value=e,e},toFloat:function(){var e=""!==this.value?parseFloat(this.value):null;null!==e&&this.bound&&(e=this.bound(e));return this.value=e,e},hidePop:b,isPopped:function(){return null!==s},newText:function(e,t){var l=t||{},r=p(t),u=o.createElement("button"),h=o.createElement("div"),f=o.createElement("div"),v=o.createElement("label"),A=o.createElement("textarea");f.setAttribute("class","poptext flow-col"),h.setAttribute("style","position: relative"),h.appendChild(f),f.appendChild(v),f.appendChild(A),v.appendChild(o.createTextNode(e)),A.setAttribute("cols",30),A.setAttribute("rows",20),A.setAttribute("wrap","off"),u.appendChild(o.createTextNode("edit")),u.onclick=function(e){if(u.parentNode.appendChild(h),u.parentNode.onclick=u.onclick,e.stopPropagation(),e.target===A)e.target.focus();else{var t=f===s;b(),t||(f.style.display="flex",s=f,A.focus())}},c(u,l),d(u,l),n.appendChild(r),r.appendChild(a(e)),r.appendChild(u),r.setAttribute("class",["flow-row",i].join(" ")),l.title&&r.setAttribute("title",t.title);return u.setVisible=r.setVisible,A},newLabel:a,newRange:function(e,t){var l=p(t),r=o.createElement("input"),s=t&&t.hide,u=document.querySelector("#"+i);u?u.appendChild(l):n.appendChild(l);e&&l.appendChild(a(e));l.appendChild(r),l.setAttribute("class",["flow-row",i].join(" ")),r.setAttribute("type","range"),r.setAttribute("min",t&&t.min?t.min:0),r.setAttribute("max",t&&t.max?t.max:100),r.setAttribute("value",0),l.style.display=s?"none":"",t&&(t.title&&(r.setAttribute("title",t.title),l.setAttribute("title",t.title)),t.action&&t.action);return r.setVisible=l.setVisible,r},newInput:function(e,t){var r=p(t),s=t&&t.hide,u=t&&t.size||5,d=t?t.height:0,c=d>1?o.createElement("textarea"):o.createElement("input"),h=l,f=document.querySelector("#"+i);f?f.appendChild(r):n.appendChild(r);r.appendChild(a(e)),r.appendChild(c),r.setAttribute("class",["flow-row",i].join(" ")),d>1?(c.setAttribute("cols",u),c.setAttribute("rows",d),c.setAttribute("wrap","off")):c.setAttribute("size",u);c.setAttribute("type","text"),r.style.display=s?"none":"",t&&(t.disabled&&c.setAttribute("disabled","true"),t.title&&r.setAttribute("title",t.title),t.convert&&(c.convert=t.convert.bind(c)),t.bound&&(c.bound=t.bound),t.action&&(h=t.action));c.addEventListener("focus",function(e){b()}),h&&(c.addEventListener("keyup",function(e){13===e.keyCode&&h(e)}),c.addEventListener("blur",function(e){h(e)}));c.convert||(c.convert=function(){return""!==this.value?this.value:null}.bind(c));return c.setVisible=r.setVisible,c},newButton:function(e,t,i){var n=o.createElement("button"),l=o.createTextNode(e);return n.appendChild(l),n.setAttribute("id","button_"+e.split(" ").join("")),n.onclick=function(){t()},c(n,i),d(n,i),n},newBoolean:function(e,t,l){var r=p(l),s=o.createElement("input"),u=l&&l.hide,d=document.querySelector("#"+i);d?d.appendChild(r):n.appendChild(r);e&&r.appendChild(a(e));r.appendChild(s),r.setAttribute("class",["flow-row",i].join(" ")),r.style.display=u?"none":"",s.setAttribute("type","checkbox"),s.checked=!1,l&&(l.disabled&&s.setAttribute("disabled","true"),l.title&&(s.setAttribute("title",l.title),r.setAttribute("title",l.title)));t&&(s.onclick=function(){t()});return s.setVisible=r.setVisible,s},newSelectField:function(e,t){var r=p(t),s=o.createElement("select"),u=t&&t.hide,d=l,c=document.querySelector("#"+i);c?c.appendChild(r):n.appendChild(r);r.appendChild(a(e)),r.appendChild(s),r.setAttribute("class",["flow-row",i].join(" ")),r.style.display=u?"none":"",t&&(t.convert&&(s.convert=t.convert.bind(s)),t.disabled&&s.setAttribute("disabled","true"),t.title&&r.setAttribute("title",t.title),t.action&&(d=t.action));return s.onchange=function(){d()},s.setVisible=r.setVisible,s},newTable:h,newTableRow:function(e,t){return v(h(e),t)},newRow:v,newBlank:function(e){var t=p(e),l=e&&e.hide,r=document.querySelector("#"+i);r?r.appendChild(t):n.appendChild(t);return t.setAttribute("class",["flow-row",i].join(" ")),t.style.display=l?"none":"",ip.setVisible=t.setVisible,ip},newGroup:function(e,t,l,r,s,a){return function(e,t,n,l,r,s){var a=o.createElement("div"),d=o.createElement("a");if(i="ck_"+e.split(" ").join(""),t.appendChild(a),a.setAttribute("class","grouphead noselect groupLabel"),a.setAttribute("id",i),a.appendChild(d),l){var p=o.createElement("input");a.appendChild(p),p.setAttribute("type","checkbox"),p.setAttribute("class","enable-checkbox"),p.onclick=function(e){r(),u(e)},n.title&&p.setAttribute("title",n.title)}return d.appendChild(o.createTextNode(e)),d.setAttribute("ck",i),d.setAttribute("id",i+"_label"),c(a,n),p}(e,n=t||n,l,r,s)},newLayer:function(e,t,l,r,s,a){return function(e,t,n,l,r,s){var a=o.createElement("div"),d=o.createElement("a");if(i="ck_"+e.split(" ").join(""),t.appendChild(a),a.setAttribute("class","grouphead noselect groupLabel"),a.setAttribute("id",i),a.appendChild(d),l){var p=o.createElement("input");a.appendChild(p),p.setAttribute("type","checkbox"),p.setAttribute("class","enable-checkbox"),p.onclick=function(e){r(),u(e)},n.title&&p.setAttribute("title",n.title)}return d.appendChild(o.createTextNode(e)),d.setAttribute("ck",i),d.setAttribute("id",i+"_label"),c(a,n),a}(e,n=t||n,l,r,s)},setGroup:function(e){return n=e,e}};var s=null}function u(e){e.target.parentNode.childNodes.forEach(function(t){"A"!==t.nodeName&&(t.classList.contains("enable-checkbox")||(e.target.checked?(t.style.height="100%",t.style.visibility="visible"):(t.style.height="0",t.style.visibility="hidden")))})}function a(e){var t=o.createElement("label"),i=e.split(" ").join("");return t.appendChild(o.createTextNode(e)),t.setAttribute("id",i),t.setAttribute("class","noselect"),t}function d(e,t){t&&t.id&&e.setAttribute("id",t.id)}function c(e,t){e.__show=!0,e.__modeSave=null,e.showMe=function(){e.__show||(e.style.display=e.__modeSave,e.__show=!0,e.__modeSave=null)},e.hideMe=function(){e.__show&&(e.__show=!1,e.__modeSave=e.style.display,e.style.display="none")},e.setVisible=function(t){t?e.showMe():e.hideMe()},e.setMode=function(t){e.setVisible(e.modes.contains(t))},e.hasMode=function(t){return e.modes.contains(t)},t&&t.modes&&(e.modes=t.modes,r.push(e))}function p(e){var t=o.createElement("div");return c(t,e),t}function b(){s&&(s.style.display="none"),s=null}function h(e){for(var t=[],i=0;i<e.length;i++)t.push(f(e[i]));return t}function f(e){var t=o.createElement("div");return t.setAttribute("class","tablerow"),e.forEach(function(e){t.appendChild(e)}),t}function v(e,t){var l=function(e){var t=o.createElement("div");e&&e.appendChild(t);i&&t.setAttribute("class",i);return t}(t&&t.noadd?null:n);return e&&e.forEach(function(e){l.appendChild(e)}),c(l,t),l}}();"use strict";var gs_kiri_db=exports;!function(){function e(e,i){this.db=e,this.files={},this.listeners=[],this.autodec=i,this.deferredHandler=null,this.refresh()}self.kiri||(self.kiri={});var i=self.kiri,t=e.prototype;function n(e){e.db.put("files",e.files),r(e)}function r(e){for(var i=0;i<e.listeners.length;i++)e.listeners[i](e.files)}i.openCatalog=function(i,t){return new e(i,t)},t.refresh=function(){var e=this;e.db.get("files",function(i){i&&(e.files=i,r(e))})},t.wipe=function(){var e,i=this.files;for(e in i)i.hasOwnProperty(e)&&this.deleteFile(e)},t.fileList=function(){return this.files},t.addFileListener=function(e){this.listeners.contains(e)||(this.listeners.push(e),e(this.files))},t.removeFileListener=function(e){this.listeners.remove(e)},t.decimate=function(e,t){if(e.length<5e5)return t(e);i.work.decimate(e,function(e){t(e)})},t.setDeferredHandler=function(e){this.deferredHandler=e},t.putDeferred=function(e,i){this.files[e]={deferred:i},n(this)},t.putFile=function(e,i,t){var r=this;r.db.put("file-"+e,i,function(f){f?(r.files[e]={vertices:i.length/3,updated:(new Date).getTime()},n(r),r.autodec?r.decimate(i,function(i){r.db.put("fdec-"+e,i),t&&t(i)}):t&&t(f)):t&&t(f)})},t.getFile=function(e,i){var t=this,n=t.files[e];if(n&&n.deferred)return t.deferredHandler?t.deferredHandler(n.deferred,e,i):i();this.autodec?this.db.get("fdec-"+e,function(n){n?i(n):t.db.get("file-"+e,function(n){if(!n)return i();t.decimate(n,function(r){t.db.put("fdec-"+e,r),i(n)})})}):t.db.get("file-"+e,i)},t.deleteFile=function(e,i){var t=this;if(t.files[e])return delete t.files[e],t.db.remove("fdec-"+e),void t.db.remove("file-"+e,function(e){n(t),i&&i(e)});i&&i(!1)}}();"use strict";var gs_kiri_slice=exports;!function(){if(self.kiri||(self.kiri={}),!self.kiri.Slice){var n=self.kiri,i=self.base,t=i.util,e=i.polygons,l=c.prototype,r=e.fillArea,o=i.newPoint,s=t.round,a=(Math.min,Math.max,Math.PI/180),f=(i.key.NONE,[16776960,65535,16711935,16711680,65280,255,16777215,0]);n.Top=h,n.newTop=function(n){return new h(n)},n.Slice=c,n.newSlice=g,h.prototype.innerTraces=function(){var n=this.traces,i=[];return n&&n.forEach(function(n){n.inner&&i.appendAll(n.inner)}),i},h.prototype.clone=function(n){return new h(this.poly.clone(n))},h.prototype.gatherOuter=function(n){return this.traces.forEach(function(i){0===i.depth&&n.append(i)}),n},l.clone=function(n){var i=g(this.z,this.view);return this.tops.forEach(function(t){i.addTop(t.poly.clone(n))}),i},l.addLayers=function(i){function t(){return n.newLayer(i)}this.layers||(this.layers={outline:t(),trace:t(),bridge:t(),flat:t(),solid:t(),fill:t(),sparse:t(),support:t()})},l.mergeTop=function(n){var i,t,e=this.tops;for(t=0;t<e.length;t++)if(i=n.union(e[t].poly))return e[t].poly=i,e[t];return this.addTop(n)},l.addTop=function(n){var i=new h(n);return this.tops.push(i),i},l.gatherTopPolys=function(n){return this.tops.forEach(function(i){n.push(i.poly)}),n},l.gatherTopPolyInners=function(n){return this.tops.forEach(function(i){i.poly.inner&&n.appendAll(i.poly.inner)}),n},l.gatherTraces=function(n){return this.tops.forEach(function(i){n.appendAll(i.traces)}),n},l.gatherInner=function(n){return this.tops.forEach(function(i){n.appendAll(i.inner)}),n},l.gatherSolids=function(n){return this.tops.forEach(function(i){n.appendAll(i.solids)}),n},l.gatherFillLines=function(n){return this.tops.forEach(function(i){i.fill_lines&&n.appendAll(i.fill_lines)}),n},l.invalidateSolids=function(){var n=this.solids;n.poly=[],n.trimmed=null},l.invalidateSupports=function(){this.supports=null},l.renderOutline=function(i){if(this.view){var t=n.driver.CAM.process,e=this.layers.outline,l=f,r=this.groups?this.groups.sort(function(n,i){return i.area()-n.area()}):null,o=this.tops,s=0,a=this.camMode===t.FINISH_X||this.camMode===t.FINISH_Y;switch(e.clear(),i%5){case 0:if(!this.lines)return;this.lines.forEach(function(n){var i=[n.p1,n.p2];e.lines(i,l[s++%l.length]),e.points(i,0,.1)});break;case 1:if(!r)return;r.forEach(function(n){d(e,n,l,s++,!1,!0)});break;case 2:if(!r)return;r.forEach(function(n){d(e,n,l,s++,!1,!1)});break;case 3:o.forEach(function(n){d(e,n.poly,l,0,!0,!1)});break;case 4:o.forEach(function(n){e.poly(n.poly,l[0],!0,a),n.inner&&e.poly(n.inner,10066329,!0,null)})}e.render()}},l.doShells=function(n,i,t,l,o){var s=o||{};this.tops.forEach(function(o){s.vase&&(o.poly=o.poly.clone(!1)),o.traces=[],o.inner=[];var a=[],f=o.poly.getZ();if(s.thin&&(o.thin_fill=[]),n)if(0===i)a=[o.poly].clone(!0),o.traces=a;else if(s.thin){var c=2*i,h=2*t;e.expand2([o.poly],-i,-t,o.traces,n,function(i,t){a=i,i.forEach(function(i){i.depth=n-t,i.inner&&i.inner.forEach(function(i){i.depth=-(n-t)})})},function(n,i,l,s){if(i){var a=e.nest(e.flatten([].appendAll(n).appendAll(i)).clone()),p=e.expand(a,-s,f,null,1),d=r(p,45,t,[],s/2,h),g=r(p,135,t,[],s/2,h);o.thin_fill.appendAll(u(d,g))}else a=e.nest(e.flatten([].appendAll(n).appendAll(i)).clone()),p=e.expand(a,-s,f,null,1),d=r(p,45,t,[],0,c),g=r(p,135,t,[],0,c),o.thin_fill.appendAll(u(d,g))},f)}else e.expand([o.poly],-i,f,o.traces,n,-t,function(i,t){a=i,i.forEach(function(i){i.depth=n-t,i.inner&&i.inner.forEach(function(i){i.depth=-(n-t)})})});l&&a.length>0&&a.forEach(function(n){e.trace2count(n,o.inner,l,1,0)})})},l.renderShells=function(i){var t=this,e=t.layers,l=e.trace,r=n.driver.CAM.process;l.clear(),t.camMode&&(e.solid.clear(),e.bridge.clear(),e.flat.clear(),e.fill.clear(),e.sparse.clear()),t.tops.forEach(function(n){switch(t.camMode){case r.FINISH:l=e.solid;break;case r.FINISH_X:l=e.bridge;break;case r.FINISH_Y:l=e.flat;break;case r.FLIP:l=e.sparse;break;default:l=e.trace}n.traces&&l.poly(n.traces,0,!0,null)}),l.render(),t.camMode&&(e.solid.render(),e.bridge.render(),e.flat.render())},l.invalidateFill=function(){this.tops.forEach(function(n){n.fill_lines=null,n.fill_sparse=null})},l.doThinWallDetection=function(n){this.tops.forEach(function(n){n.inner&&n.inner.length})},l.doSolidLayerFill=function(n,i){this.isSolidFill=!1,0!==this.tops.length&&"number"==typeof i&&(this.tops.forEach(function(t){t.inner&&t.inner.length>0?t.fill_lines=r(t.inner,i,n,null):t.fill_lines=null}),this.isSolidFill=!0)},l.renderSolidFill=function(){var n=this.layers.fill;n.clear(),this.tops.forEach(function(i){i.fill_lines&&n.lines(i.fill_lines,3355443)}),n.render()},l.doSparseLayerFill=function(n){let i=n.spacing,t=n.density,l=n.bounds,r=n.height;n.type;if(this.isSparseFill=!1,0!==this.tops.length&&0!==t&&!this.isSolidFill){var f,c=this,h=c.tops,u=self.ClipperLib,p=u.ClipType,d=u.PolyType,g=u.PolyFillType,y=new u.Clipper,E=new u.PolyTree,v=[],m=[],_=[],S={bounds:function(){return l},zIndex:function(){return c.index},zValue:function(){return c.z},zHeight:function(){return r},offset:function(){return i},density:function(){return t},emit:function(n,i){_.push(o(n,i,c.z))},newline:function(){_.length>0&&(m.push(_),_=[])}};c.isSparseFill=!0,function(n,i){var t,e,l=n.offset()/2,r=4*(1-n.density())+l,o=s(Math.cos(30*a)*r,7),f=s(Math.sin(30*a)*r,7),c=n.bounds(),h=!0,u=n.zIndex()%2==0,p=c.max.y+(r+2*f);if(i||u)for(t=c.min.x;!(h&&t>c.max.x)&&(h||!(t>c.max.x+o+l));){for(e=c.min.y,n.newline();e<=p;)n.emit(t,e),e+=r,n.emit(t,e),h?t+=o:t-=o,e+=f,n.emit(t,e),e+=r,n.emit(t,e),h?t-=o:t+=o,e+=f;t+=l,h&&(t+=2*o),h=!h,n.newline()}else for(e=c.min.y+r;!(h&&e>c.max.y)&&(h||!(e>c.max.y+f));){for(t=c.min.x,n.newline();t<c.max.x;)n.emit(t,e),h?e+=f:e-=f,t+=o,n.emit(t,e),t+=l,n.emit(t,e),h?e-=f:e+=f,t+=o,n.emit(t,e),t+=l;e+=r,h&&(e+=2*f),h=!h,n.newline()}}(S,!0),S.newline(),h.forEach(function(n){n.fill_sparse=[],v.appendAll(n.inner),v.appendAll(n.solids)}),y.AddPaths(m,d.ptSubject,!1),y.AddPaths(e.toClipper(v),d.ptClip,!0),y.Execute(p.ctIntersection,E,g.pftNonZero,g.pftEvenOdd)&&E.m_AllPolys.forEach(function(n){f=e.fromClipperNode(n,c.z),h.forEach(function(n){f.isInside(n.poly)&&n.fill_sparse.push(f)})})}},l.renderSparseFill=function(){var n=this.layers.sparse;n.clear(),this.tops.forEach(function(i){i.fill_sparse&&i.fill_sparse.forEach(function(i){i.length>1&&i.render(n,3355494,!1,!0)})}),n.render()},l.doDiff=function(n){if(this.down){var i=this.down;this.bridges=null,i.flats=null;var t=this.gatherInner([]),l=i.gatherInner([]),r=[],o=[];e.subtract(t,l,r,o,this.z,n),this.bridges=r,i.flats=o}},l.renderDiff=function(){var n=this,i=n.layers,t=i.bridge,e=i.flat,l=n.bridges,r=n.flats;t.clear(),e.clear(),l&&l.forEach(function(i){i.setZ(n.z),i.render(t,43775,!0)}),r&&r.forEach(function(i){i.setZ(n.z),i.render(e,16711850,!0)}),t.render(),e.render()},l.addSolidFills=function(n){this.solids.poly.appendAll(n)},l.projectFlats=function(n){!this.isSolidFill&&this.down&&this.flats&&p(this,this.flats,n,!1,!0)},l.projectBridges=function(n){!this.isSolidFill&&this.up&&this.bridges&&p(this,this.bridges,n,!0,!0)},l.doSolidsFill=function(n,i,t){var l=t||1,o=this,s=o.tops,a=o.solids,f=e.union(a.poly);if(0===a.length)return!1;if(0===f.length)return!1;var c,h=[],u=o.gatherInner([]);return f.forEach(function(n){n.setZ(o.z),u.forEach(function(i){n.del||(c=n.mask(i))&&c.length>0&&(n.del=!0,h.appendAll(c))})}),a.unioned=f,a.trimmed=h,s.forEach(function(n){n.solids=[]}),h.forEach(function(n){s.forEach(function(i){if(i.poly.overlaps(n)&&(!n.parent||n.parent.area()>i.poly.area())){if(n.areaDeep()<l)return;n.parent=i.poly,i.solids.push(n)}})}),s.forEach(function(t){t.fill_lines=t.thin_fill||[];var e=[],l=[];h.forEach(function(n){n.parent===t.poly&&(n.fillang?l.push(n):e.push(n))}),e.length>0&&(r(e,i,n,t.fill_lines),t.fill_lines_norm={angle:i,spacing:n}),l.length>0&&(t.fill_lines_ang={spacing:n,list:[],poly:[]},l.forEach(function(i){r([i],i.fillang.angle+45,n,t.fill_lines),t.fill_lines_ang.list.push(i.fillang.angle+45),t.fill_lines_ang.poly.push(i.clone())}))}),!0},l.doThinFill=function(n,i){return this.tops.forEach(function(n){n.thin_fill&&n.thin_fill.length>0&&(n.fill_lines?n.fill_lines.appendAll(n.thin_fill):n.fill_lines=n.thin_fill)}),!0},l.renderSolidOutlines=function(){var n=this.layers.solid,i=this.solids.trimmed;n.clear(),i&&i.forEach(function(i){i.render(n,56576,!0)}),n.render()},l.doSupport=function(n,t,l,r,o,s,a){var f=r||.1,c=o||2,h=this.gatherTopPolys([]),u=h;if(l&&e.expand(h,l,this.z,u=[]),e.expand(h,s,this.z,this.offsets=[]),this.down){var p=e.flatten(this.gatherTraces([])),d=this.gatherFillLines([]),g=[],y=this.down,E=y.gatherTopPolys([]),v=e.flatten(y.gatherTraces([]));p.forEach(function(n){n.forEachSegment(function(n,i){T(n,i,!0)})});var m=[];if(d.forEachPair(function(n,i){T(n,i,!1)}),g.length||m.length){var _=[];g.forEach(function(n){_.push(i.newPolygon().centerRectangle(n,c/2,c/2))}),_=e.union(_).forEach(function(n){m.push(i.newPolygon().createConvexHull(n.points))}),m=e.union(m),m=e.trimTo(m,u);for(var S=0;y&&m.length>0;){y.supports=y.supports||[];var w=[],b=[];if(e.subtract(m,y.gatherTopPolys([]),w,null,this.z,f),w.forEach(function(n){n.area()<.1||b.push(n.setZ(y.z))}),0===b.length)break;S>=a&&y.supports.appendAll(b),m=b,y=y.down,S++}}}function F(i){for(var t=0;t<g.length;t++)if(i.distTo2D(g[t])<c/4)return;var e=i.isInPolygonOnly(E);e||v.forEach(function(t){return t.forEachSegment(function(t,l){if(i.distToLine(t,l)<=n)return e=!0}),e}),e||g.push(i)}function T(n,i,e){var l,r=1;if((l=n.distTo2D(i))>=t)for(var o=n.slopeTo(i).factor(1/l),s=Math.floor(l/t)+1,a=l/s;r<s;)F(n.projectOnSlope(o,r++*a));e&&F(i)}},l.doSupportFill=function(n,i,t){var l=this.supports,o=[],s=[],a=t||.1;l&&(l=e.union(l),e.subtract(l,this.offsets,o,null,this.z,a),l=o,this.down&&(e.subtract(o,this.down.offsets,s,null,this.z,a),l=s),l&&l.forEach(function(t){var l=t.bounds.width()/t.bounds.height()>1?90:0,o=n*(1/i),s=[];return e.trace2count(t,s,n/4,1,0),s.length>0&&r(s,l,o,t.fills=[]),!0}),this.supports=l)},l.renderSupport=function(){var n=this.layers.support,i=this.supports;n.clear(),i&&i.forEach(function(i){n.poly(i,16711680,!0),n.lines(i.fills,16711680)}),n.render()},l.findClosestPointTo=function(n){var i,t;return this.tops.forEach(function(e){t=e.poly.findClosestPointTo(n),(!i||t.distance<i.distance)&&(i=t)}),i}}function c(n,i){this.z=n,this.index=0,this.lines=null,this.groups=null,this.up=null,this.down=null,this.tops=[],this.view=i,this.bridges=null,this.flats=null,this.solids={poly:null,trimmed:null},this.offsets=null,this.supports=null,this.isSolidFill=!1,this.isSparseFill=!1,this.camMode=null,this.layers=null,i&&this.addLayers(i)}function h(n){this.poly=n,this.traces=null,this.inner=null,this.fill_lines=null,this.fill_sparse=null,this.solids=null}function u(n,e){if(n&&e&&n.length&&e.length){var l=e.slice();n:for(var r=0;r<n.length;r+=2){for(var o=0;o<e.length;o+=2)if(t.intersect(n[r],n[r+1],e[o],e[o+1],i.key.SEGINT))continue n;l.push(n[r]),l.push(n[r+1])}for(var s=0;s<l.length;s++)l[s].index=1/0;return l.length>2?l:[]}}function p(n,i,t,e,l){if(!(!n||n.isSolidFill||t<=0)){var r=i.clone(!0);l&&r.forEach(function(n){n.hintFillAngle()}),n.addSolidFills(r),t>0&&(e?p(n.up,i,t-1,!0,!1):p(n.down,i,t-1,!1,!1))}}function d(n,i,t,e,l,r){n.poly(i,t[e%t.length],l,r),l&&i.inner&&i.inner.forEach(function(i){d(n,i,t,e+1,!1,r)})}function g(n,i){return new c(n,i)}}();"use strict";var gs_kiri_slicer=exports;!function(){if(self.kiri||(self.kiri={}),!self.kiri.slicer){self.kiri.slicer={slice:l,sliceWidget:function(e,n,r,o){l(e.getPoints(),e.getBoundingBox(),n,r,o)}};var e=self.kiri,n=self.base,r=n.config,o=n.util,t=n.polygons,i=o.time,s=e.newSlice,a=n.newOrderedLine}function l(l,p,h,u,f){var g=h.topo,c=0,d=0;if(h.swapX||h.swapY){l=l.slice();var v,w=new THREE.Box3,y={};w.setFromPoints(l),h.swapX&&(c=-w.max.x),h.swapY&&(d=-w.max.y);for(var m=0;m<l.length;m++)(v=y[(z=l[m]).key])?l[m]=v:(v=z.clone(),h.swapX?v.swapXZ():h.swapY&&v.swapYZ(),v.rekey(),y[z.key]=v,l[m]=v);w.setFromPoints(l);var z;for(m=0;m<l.length;m++)1!==(z=l[m]).mod&&(z.mod=1,z.z-=w.min.z);w.setFromPoints(l),p=w}var k,M,P,x,b=h.zmin||Math.floor(p.min.z),E=h.zmax||Math.ceil(p.max.z),X=h.height,F=h.minHeight,Y=h.firstHeight||X,H=X/2,S=[],Z=[],_=[],O={},T={},D=i(),I=[],q=0,B=[],L=0,A=e.driver.CAM.process;function C(e){e=o.round(e,5),O[e]=(O[e]||0)+1}for(ie=0;ie<l.length;)if(M=l[ie++],P=l[ie++],x=l[ie++],q+=Math.abs(M.z-P.z)+Math.abs(P.z-x.z)+Math.abs(x.z-M.z),(0===X||F)&&(C(M.z),C(P.z),C(x.z)),M.z===P.z&&P.z===x.z&&M.z>p.min.z){var G=M.z.toFixed(5),N=Math.abs(o.area2(M,P,x))/2;T[G]?T[G]+=N:T[G]=N}var R=Math.max(1,Math.ceil(E/(q/l.length))-1);if(k=1/(E/R),R>1){for(ie=0;ie<R+1;ie++)B.push([]);for(ie=0;ie<l.length;){M=l[ie++],P=l[ie++],x=l[ie++];var W=Math.min(M.z,P.z,x.z),j=Math.max(M.z,P.z,x.z),J=Math.floor(W*k),K=Math.ceil(j*k);for(L=J;L<K;L++)B[L].push(M),B[L].push(P),B[L].push(x)}}if(0===X||F){for(var Q in O)O.hasOwnProperty(Q)&&_.push(parseFloat(Q));_.sort(function(e,n){return e-n})}if(0===X){var U=_;for(ie=0;ie<U.length-1;ie++)Z.push((U[ie]+U[ie+1])/2)}else if(h.cam){for(X=(E-b)/(Math.floor(E/X)+1),ie=b;ie<E;ie+=X)Z.push(ie);for(Q in T)!T.hasOwnProperty(Q)||T[Q]<10||!Z.contains(Q)&&Q>=b&&Z.push(parseFloat(Q));Z.sort(function(e,n){return n-e})}else if(F){var V,$,ee,ne,re,oe=b+Y,te=0;for(S.push(Y),Z.push(Y/2);oe<E&&te<_.length;)if(!(oe>=(re=_[te++])||(V=re-oe)<F))for($=Math.floor(V/F),(ee=Math.floor(V/X))&&ee<$?(V%X>.01&&ee++,ne=V/ee):ne=V;oe<re;)S.push(ne),Z.push(oe+ne/2),oe+=ne}else for(h.firstHeight&&(Z.push(h.firstHeight/2),S.push(h.firstHeight),b=h.firstHeight),ie=b+H;ie<E;ie+=X)Z.push(ie),S.push(X);for(var ie=0;ie<Z.length;ie++)he(Z[ie],S[ie]),f(ie/Z.length);for(h.cam&&I.length>0&&(I[0].hasFlats=!0,I[I.length-1].hasFlats=!0),ie=1;ie<I.length;ie++)I[ie-1].up=I[ie],I[ie].down=I[ie-1];function se(e,n,o){var t=e.z-n;Math.abs(t)<r.precision_slice_z?o.on.push(e):t<0?o.under.push(e):o.over.push(e)}function ae(e,n,r){for(var o=[],t=0;t<e.length;t++)for(var i=0;i<n.length;i++)o.push(e[t].intersectZ(n[i],r));return o}function le(e,n){var r=e[n.key];return r||(e[n.key]=n,n)}function pe(e,n,r,o,t){n=le(e,n),r=le(e,r);var i=a(n,r);return i.coplanar=o||!1,i.edge=t||!1,i}function he(e,r){var o={},i=[],a=T[e.toFixed(5)]>0,p=s(e,h.view?h.view.newGroup():null),u=1==R?l:B[Math.floor(e*k)];if(u){a&&(h.cam&&(p.hasFlats=!0),e+=.001);for(var f=0;f<u.length;){M=u[f++],P=u[f++],x=u[f++];var v={under:[],over:[],on:[]};if(se(M,e,v),se(P,e,v),se(x,e,v),3===v.under.length||3===v.over.length);else if(2===v.on.length)i.push(pe(o,v.on[0],v.on[1],!1,!0));else if(3===v.on.length);else if(0===v.under.length||0===v.over.length);else{(m=ae(v.over,v.under,e)).length<2&&1===v.on.length&&m.push(v.on[0]),2===m.length?i.push(pe(o,m[0],m[1])):console.log({msg:"invalid ips",line:m,where:v})}}if(0!=i.length||h.swapX||h.swapY){if(p.height=r,p.index=I.length,p.lines=function(e){var n=[],r=[],o=[],t={};function i(e,n){var r;t[(r=e).key]||(o.push(r),t[r.key]=r),e.group?e.group.push(n):e.group=[n]}return e.sort(function(e,n){return e.key===n.key?(e.del=!e.edge,n.del=!n.edge,0):e.key<n.key?-1:1}),e.forEach(function(e){e.del||(r.push(e),i(e.p1,e),i(e.p2,e))}),o.forEach(function(e){if(2==e.group.length){var n=e.group[0],o=e.group[1];if(n.isCollinear(o)){n.del=!0,o.del=!0;var t=n.p1!=e?n.p1:n.p2,i=o.p1!=e?o.p1:o.p2,s=base.newOrderedLine(t,i);t.group.remove(n),t.group.remove(o),i.group.remove(n),i.group.remove(o),t.group.push(s),i.group.push(s),s.edge=n.edge||o.edge,r.push(s)}}}),r.sort(function(e,n){return e.key===n.key?(e.del=!0,n.del=!n.edge,0):e.key<n.key?-1:1}),r.forEach(function(e){e.del||(n.push(e),e.p1.group=null,e.p2.group=null)}),n}(i),g||(p.groups=function(e,r){var o,t,i=n.debug,s={},a=[],l=[],p=[],h=1,u=1,f=n.config.bridgeLineGapDistance;function g(e){var n=s[e.key];return n||(a.push(e),s[e.key]=e,e.mod=u++,e.toString=function(){return this.mod},e)}function c(e,n){e.group?e.group.push(n):e.group=[n]}function d(e,n){var r,o=e.length;for(r=0;r<o-1;r++)if(e[r]===n)return e.slice(r);return e}function v(n,r,o,t){var s=[];if(o.length>1e4)i.log("excessive path options @ "+o.length+" #"+e.length);else{for(;;){s.push(n);var a=n,l=n.group;if(r.push(n),n.del=!0,n.pos=h++,1!==r.length){if(l.length>2){l.forEach(function(e){e!==t&&(e.del?o.push(d(r,e)):v(e,r.slice(),o,n))});break}if(n=l[0]===t?l[1]:l[0],t=a,!n){r.open=!0,o.push(r);break}if(n.del){o.push(d(r,n));break}}else t=n,n=l[0]}for(var p=0;p<s.length;p++)s[p].del=!1}}function w(e){(e=e.clean()).length>2&&l.push(e.clean())}function y(e){var r=null,o=0,t=0;e.forEach(function(e,n){(!r||e.length>r.length)&&(r=e),e.open?t++:o++}),o>1&&0===t?(e.forEach(function(e){e.poly=n.newPolygon().addPoints(e)}),e.sort(function(e,n){return n.poly.length-e.poly.length}),e.forEach(function(e){if(!(e.length<3)){var n,r=e.length;for(n=0;n<r;n++)if(e[n].del)return;for(n=0;n<r;n++)e[n].del=!0;w(e.poly),0}})):r.open?p.push(r):w(n.newPolygon().addPoints(r))}function m(e,n){return e.distToSq2D(n)<=.01}e.forEach(function(e){o=g(e.p1.round(7)),t=g(e.p2.round(7)),c(o,t),c(t,o)}),a.forEach(function(e){if(0===e.pos&&1===e.group.length){var n=[];v(e,[],n),n.length>0&&y(n)}}),a.forEach(function(e){if(0===e.pos&&2===e.group.length){var n=[];v(e,[],n),n.length>0&&y(n)}});for(var z=0;z<p.length;z++){var k,M,P,x=p[z],b=x[x.length-1];if(f){if(!x.delete)e:for(;;){var E={dist:1/0};for(P=z+1;P<p.length;P++)(k=p[P]).delete||((M=b.distToSq2D(k[0]))<E.dist&&M<=f&&(E={dist:M,array:k}),(M=b.distToSq2D(k[k.length-1]))<E.dist&&M<=f&&(E={dist:M,array:k,reverse:!0}));if(!(k=E.array)){w(n.newPolygon().addPoints(x));break e}if(E.reverse&&k.reverse(),k.delete=!0,x.appendAll(k),b=x[x.length-1],0,m(x[0],b)){w(n.newPolygon().addPoints(x));break e}}}else w(n.newPolygon().addPoints(x).setOpen())}return l}(p.lines,I.length),t.nest(p.groups).forEach(function(e){p.addTop(e)})),h.swapX||h.swapY){var w={x:c,y:d,z:0};if(p.camMode=h.swapX?A.FINISH_X:A.FINISH_Y,g){var y,m,z=(i=p.lines).length;for(y=0;y<z;y++)(m=i[y]).p1=m.p1.clone(),m.p2=m.p2.clone();for(y=0;y<z;y++)m=i[y],h.swapX?(m.p1.swapXZ(),m.p2.swapXZ()):(m.p1.swapYZ(),m.p2.swapYZ()),m.p1.move(w),m.p2.move(w)}else p.tops.forEach(function(e){e.poly.swap(h.swapX,h.swapY),e.poly.move(w),e.poly.inner=null}),drape(p,h.swapX,h.swapY)}I.push(p)}}}I.slice_time=i()-D,u(I)}}();"use strict";var gs_kiri_fdm=exports;!function(){if(self.kiri||(self.kiri={}),self.kiri.driver||(self.kiri.driver={}),!self.kiri.driver.FDM){var e=self.kiri,t=self.base,i=t.debug,n=t.util,o=t.config,l=e.driver.FDM={},r=t.polygons,s=e.slicer,a=t.newPoint,p=n.time;self.kiri_fdm_xyz_mini_w=function(e,t){return btoa("; filename = kirimoto.gcode\n; machine = dv1MW0A000\n"+e)},l.slice=function(e,t,l,r){var a=e.process,u=e.machine,c=(p(),a.sliceSolidMinArea),f=a.sliceSolidLayers,d=f&&!a.sliceVase,h=u.nozzleSize/2,g=u.nozzleSize*a.sliceShellSpacing,m=g*e.synth.fillOffsetMult,S=u.nozzleSize*a.sliceFillSpacing,x=a.sliceFillAngle,y=t.mesh&&t.mesh.newGroup?t.mesh.newGroup():null;if(a.sliceHeight<.01)return r("invalid slice height");a.firstSliceHeight<a.sliceHeight&&(i.log("invalid first layer height < slice height"),i.log("reverting to slice height"),a.firstSliceHeight=a.sliceHeight),s.sliceWidget(t,{height:a.sliceHeight,minHeight:a.sliceMinHeight,firstHeight:a.firstSliceHeight,view:y},function(e){if(t.slices=e,!e)return;function i(t,i,n,o){e.forEach(function(r){n(r),function(t,i,n,o){l(.5+.5*(i+t/e.length*(n-i)),o)}(r.index,t,i,o)})}o.hint_len_max=n.sqr(a.sliceBridgeMax),e.forEach(function(e){e.invalidateFill(),e.invalidateSolids(),e.invalidateSupports()});var s=a.sliceSupportEnable&&a.sliceSupportDensity>0,p=a.sliceSupportArea;i(0,.2,function(t){var i=(t.index<a.sliceBottomLayers||t.index>e.length-a.sliceTopLayers-1||a.sliceFillSparse>.95)&&!a.sliceVase;t.doShells(a.sliceShells,h,g,m,{vase:a.sliceVase,thin:!1}),i&&t.doSolidLayerFill(S,x),x+=90},"offsets"),d&&(i(.2,.34,function(e){e.doDiff(c)},"diff"),i(.34,.35,function(e){e.projectFlats(f),e.projectBridges(f)},"solids"),i(.35,.5,function(e){e.doSolidsFill(S,x,c),e.doThinFill(S,x),x+=90},"solids"));s&&(i(.5,.7,function(e){e.doSupport(a.sliceSupportOffset,a.sliceSupportSpan,a.sliceSupportExtra,p,a.sliceSupportSize,a.sliceSupportOffset,a.sliceSupportGap)},"support"),i(.7,.8,function(e){e.doSupportFill(u.nozzleSize,a.sliceSupportDensity,p)},"support"));!a.sliceVase&&a.sliceFillSparse>0&&i(.8,1,function(e){e.doSparseLayerFill(S,a.sliceFillSparse,t.getBoundingBox())},"infill");r()},function(e){return l(0+.5*e)})},l.printSetup=function(e,t){var i,n,o,l,s,p,u,c,f,d=e.widgets,h=e.settings,g=h.machine.nozzleSize,m=h.process,S=(h.mode,e.output),x=a(0,0,0),y=(m.firstSliceHeight,0),z=0,v=0,F=[],b=[];if(m.outputBrimCount||m.outputRaft){var E=[],P=m.outputBrimOffset||(m.outputRaft?4:0);if(d.forEach(function(e){var t=[];e.slices[0].tops.forEach(function(e){t.push(e.poly.clone())}),r.nest(t).forEach(function(t){t.offset(g/2-P).forEach(function(t){t.move(e.mesh.position),E.push(t)})})}),E=r.union(E),P&&E.length){var D=m.sliceSupportExtra+2;E=r.expand(E,D,0,null,1),E=r.expand(E,-D,0,null,1)}if(m.outputRaft){P=a(0,0,0);x=null;var M=function(t,i,n,o,l){var s=kiri.newSlice(v+t/2);E.forEach(function(e){null===x&&(x=e.first());var t=s.addTop(e);t.traces=[e],t.inner=r.expand(t.traces,.5*-g,0,null,1),t.inner[0].bounds.minx-=g/2,t.inner[0].bounds.maxx+=g/2,t.fill_lines=r.fillArea(t.inner,i,n,[])}),P.z=s.z,x=e.slicePrintPath(s,x,P,F,{speed:o,mult:l}),F.height=t,S.append(F),F=[],v+=t};M(g/1,m.sliceFillAngle+0,6*g,m.firstLayerRate/3,4),M(g/1,m.sliceFillAngle+0,6*g,m.firstLayerRate/2,4),M(g/2,m.sliceFillAngle+90,3*g,m.outputFeedrate,2.5),M(g/2,m.sliceFillAngle+0,1*g,m.outputFeedrate,1.5),M(g/2,m.sliceFillAngle+0,1*g,m.outputFeedrate,1),m.outputRaftSpacing||0,S.last().last().retract=!0}else if(m.outputBrimCount){var k=[],H=[];E.forEach(function(e){r.trace2count(e,k,-g,m.outputBrimCount,0)}),x=e.poly2polyEmit(k,x,function(t,i,n,o){return e.polyPrintPath(t,o,H,{rate:m.firstLayerRate,onfirst:function(e){H.length&&e.distTo2D(o)>2&&(H.last().retract=!0)}})}),e.addPrintPoints(H,F,null),H.length&&(H.last().retract=!0)}}for(d.forEach(function(e){y=Math.max(y,e.slices.length)});;){for(n=0;n<d.length;n++)(i=d[n].mesh).widget&&(c=i.widget.slices)&&c[z]&&b.push({slice:c[z],offset:i.position});if(0===b.length)break;for(;;){for(0,l=null,s=1/0,n=0;n<b.length;n++)(f=b[n])&&((u=f.slice.findClosestPointTo(x.sub(f.offset)))&&(!l||u.distance<s)&&(l=f,s=u.distance,p=n),0);if(!l)break;F.length&&p!==o&&(F.last().retract=!0),F.height=F.height||l.slice.height,b[p]=null,l.offset.z=v,x=e.slicePrintPath(l.slice,x.sub(l.offset),l.offset,F,{first:0===l.slice.index}),o=p}F.layer=z,F.length&&S.append(F),t(++z/y),z===y&&F.length&&(F.last().retract=!0),b=[],F=[]}},l.printExport=function(e,t){var i,o,l,r,s,a,p,u,c,f=e.output,d=e.settings,h=d.machine,g=d.process,m=h.gcodeFan,S=h.gcodeLayer,x=h.gcodeTrack,y=0,z=0,v=[],F=h.gcodePause,b=[],E=0,P=0,D=3,M=0,k=0,H=0,w=0,A={x:0,y:0,z:0,f:0},_=null,B=0,R=g.zHopDistance||0,T=g.outputOriginCenter?null:{x:h.bedWidth/2,y:h.bedDepth/2},L={temp:g.outputTemp,temp_bed:g.outputBedTemp,bed_temp:g.outputBedTemp,fan_speed:g.outputFanMax,speed:g.outputFanMax,top:T?h.bedDepth:h.bedDepth/2,left:T?0:-h.bedWidth/2,right:T?h.bedWidth:h.bedWidth/2,bottom:T?0:-h.bedDepth/2,kfactor:g.gcodeKFactor||0,z_max:h.maxHeight,layers:f.length},O=60*g.outputSeekrate,G=g.outputRetractDist,C=60*g.outputRetractSpeed,W=g.outputRetractDwell||0,j=W/1e3,I=e.constReplace,V=0,K=0;for(var X in(g.gcodePauseLayers||"").split(",").forEach(function(e){var t=parseInt(e);t>=0&&v.push(t)}),(c=t?function(e){e&&(V++,K+=e.length,b.append(e)),(!e||b.length>1e3)&&(t(b.join("\n")),b=[])}:function(e){e&&(b.append(e),V++,K+=e.length)})("; Generated by KIRI:MOTO"),c("; "+(new Date).toString()),c(I("; Bed left:{left} right:{right} top:{top} bottom:{bottom}",L)),c("; --- process ---"),g)c("; "+X+" = "+g[X]);c("; --- startup ---");for(var Y=0;Y<h.gcodePre.length;Y++){var Z=h.gcodePre[Y];h.extrudeAbs&&Z.indexOf("E")>0&&Z.split(";")[0].split(" ").forEach(function(e){"E"==e[0]&&(E=Math.max(E,parseFloat(e.substring(1))||0))}),c(I(Z,L))}function q(e){c("G4 P"+e),y+=j}function J(){N({e:-(w=G)},C,"retract "+G),R&&N({z:B+R},O,"zhop up"),y+=G/C*60*2}function N(e,t,i){i&&c(" ; "+i);var o=[t||e.e?"G1":"G0"];"number"==typeof e.x&&(A.x=n.round(e.x,D),o.append(" X").append(A.x.toFixed(D))),"number"==typeof e.y&&(A.y=n.round(e.y,D),o.append(" Y").append(A.y.toFixed(D))),"number"==typeof e.z&&(A.z=n.round(e.z,D),o.append(" Z").append(A.z.toFixed(D))),"number"==typeof e.e&&(E+=e.e,h.extrudeAbs?o.append(" E").append(n.round(E,D)):o.append(" E").append(n.round(e.e,D))),t&&t!=A.f&&(o.append(" F").append(Math.round(t)),A.f=t);var l=o.join("");_!=l&&(_=l,c(l))}var Q=[],U=0;for(f.forEach(function(e){Q.appendAll(e)}),Q.forEachPair(function(e,t){U+=e.point.distTo2D(t.point)},1),J();z<f.length;){if(o=f[z],a=e.extrudePerMM(h.nozzleSize,h.filamentSize,0===o.layer?g.firstSliceHeight:o.height),L.z=B.toFixed(2),L.Z=L.z,L.layer=z,L.height=o.height.toFixed(3),F&&v.indexOf(z)>=0)for(Y=0;Y<F.length;Y++)c(I(F[Y],L));for(S&&S.length?S.forEach(function(e){c(I(e,L))}):c("; --- layer "+z+" ("+L.height+" @ "+L.z+") ---"),1===z&&m&&g.outputCooling&&c(I(m,L)),N({z:B+=o.height},O),i=0;i<o.length;i++)if(r=60*((l=o[i]).speed||g.outputFeedrate),l.point){var $=l.point.x,ee=l.point.y;g.outputInvertX&&($=-$),g.outputInvertY&&(ee=-ee),T&&($+=T.x,ee+=T.y),u=p?p.distTo2D(l.point):0,l.emit&&w&&(R&&N({z:B},O,"zhop down"),N({e:w},C,"engage "+w),w=0,W&&q(W),y+=G/C*60*2),p&&l.emit?(N({x:$,y:ee,e:s=a*l.emit*u},r),H+=s):N({x:$,y:ee},O),!w&&l.retract&&J(),y+=u/r*60*1.5,k+=u,L.progress=M=Math.round(k/U*100),x&&M!=P&&(c(I(x,L)),P=M),p=l.point,l.emit}else q(l.speed);z++}L.material=n.round(H,2),L.time=n.round(y,2),c("; --- shutdown ---");for(Y=0;Y<h.gcodePost.length;Y++)c(I(h.gcodePost[Y],L));return c("; --- filament used: "+L.material+"mm ---"),c("; --- print time: "+L.time+"s ---"),c(),e.distance=H,e.lines=V,e.bytes=K+V-1,e.time=y,t?null:b.join("\n")}}}();"use strict";var gs_kiri_cam=exports;!function(){if(self.kiri||(self.kiri={}),self.kiri.driver||(self.kiri.driver={}),!self.kiri.driver.CAM)var n=self.kiri,e=self.base,o=e.util,t=e.polygons,i=(n.driver.CAM={slice:function(n,e,o,a){var c,s,x=n,M=x.process,T=x.process,b=e.slices=[],w=m(x,M.allTool),k=m(x,M.allTool),O=m(x,M.allTool),D=M.roughingOn&&M.roughingDown&&w,I=M.waterlineOn&&M.finishingDown&&k,P=M.roughingOn&&M.camZTopOffset,Z=M.drillingOn&&M.drillDown&&M.drillDownSpeed,C=M.flipJigOn&&M.flipJigDown&&w,F=l(.1,r(M.roughingDown,M.finishingDown,M.flipJigDown)/3),G=T.camPocketOnly,H=M.camTabsOn&&!G,A=M.camTabsWidth,_=M.camTabsHeight,N=e.mesh,L=e.getBoundingBox(),X=l(L.min.z,T.camZBottom);if(F<=.05)return a("invalid slice depth");if(M.reliefYOff&&M.reliefXOff&&M.reliefOn&&!(D||I||P||Z||C))return a("no processes selected");if(!(D||I||P||Z||M.reliefOn||C))return a("no processes selected");const B=function(n,e){if(n.z>X+_)return;if(0===n.tops.length)return;var o,t,i,a=0;n.tops[0].traces.forEach(function(n,e){(i=n.area())>a&&(a=i,t=e,o=n)}),o.setClockwise();const r=(A+e)/2,l={x:-1e4,y:A/2},c={x:-l.x,y:l.y},s={x:l.x,y:-l.y},f={x:-l.x,y:-l.y},u={x:-r,y:1e4},p={x:u.x,y:-u.y},h={x:-u.x,y:u.y},d={x:-u.x,y:-u.y};var g=o.intersections(l,c),m=o.intersections(s,f),x=o.intersections(u,p),y=o.intersections(h,d),v=o.emitSegment(g[0],x[0]),z=o.emitSegment(y[0],g[g.length-1]),M=o.emitSegment(m[m.length-1],y[y.length-1]),S=o.emitSegment(x[x.length-1],m[0]);n.tops[0].traces.splice(t,1,v,z,M,S)};z(e,{height:F,cam:!0,zmin:T.camZBottom},function(n){const e=function(n,e){var o,i,a;return n.forEach(function(r,l){i=r.gatherTopPolys([]).clone(!0),o?(i.appendAll(o),o=t.union(i),r.tops=[],o.forEach(function(n){r.addTop(n),n.setZ(r.z)})):o=i,a=r,e&&e(l/n.length)}),a.clone(!1)}(n,function(n){o(.25+.15*n,"shelling")}),a=c=e.gatherTopPolys([]);D&&!G&&(c=t.expand(c,w/2+M.roughingStock,0));I&&G&&(s=t.expand(a,-k/2,0));if(P)for(var l=L.max.z,f=l+T.camZTopOffset,p=M.roughingDown;f>=l;){f-=r(p,f-l);const n=u(f,N.newGroup?N.newGroup():null);if(n.camMode=i.FACING,b.append(n),c.clone().forEach(function(e){n.addTop(e)}),Math.abs(f-l)<.001)break}if(D){var d=[];S(n,M.roughingDown,i.ROUGH,d),b.appendAll(d)}if(I){var d=[];S(n,M.finishingDown,i.FINISH,d),b.appendAll(d)}if(C)for(var l=L.max.z+T.camZTopOffset,p=M.flipJigDown;l>=0;){l-=r(p,l);const n=u(l,N.newGroup?N.newGroup():null);if(n.camMode=i.FLIP,b.append(n),c.clone().forEach(function(e){n.addTop(e)}),Math.abs(l)<.001)break}if(Z){var g=[],m=.1*O,x=O/2*(O/2)*Math.PI,y=.05*x;n.forEach(function(n){var e=n.gatherTopPolyInners([]);e.forEach(function(n){if(n.circularity()>=.99&&Math.abs(n.area()-x)<=y){var e,o=n.circleCenter(),t=!1,i=1/0;g.forEach(function(n){t||((e=n.last().distTo2D(o))<=m&&(t=!0,n.push(o)),i=Math.min(i,e))}),t||g.push(h().append(o))}})}),g.forEach(function(n){var e=n.center(!0),o=u(0,null);n.points.forEach(function(n){n.x=e.x,n.y=e.y}),o.camMode=i.DRILL,o.addTop(null).traces=[n],b.append(o)})}},function(n){o(0+.25*n,"slicing")}),b.forEach(function(n,e){switch(n.index=e,n.camMode){case i.FACING:!function(n,e,o,i,a){var r=[],l=[];e.clone(!0).forEach(function(e){e.setZ(n.z).flattenTo(l)}),l=t.nest(l),t.expand(l,-o/2,n.z,r,0,-o*i),a||(l=t.flatten(r.slice(),[]),e.clone(!0).forEach(function(e){e.setZ(n.z).flattenTo(l)}),r=t.nest(l));n.tops.length||(console.log({no_top:n.z}),n.addTop());n.tops[0].traces=r}(n,c,w,M.roughingOver,G);break;case i.ROUGH:!function(n,e,o,i,a,r){var l=n.gatherTopPolys([]).clone(!0),c=[],s=[];e.clone(!0).forEach(function(e){e.setZ(n.z).flattenTo(s)}),t.flatten(l,s,!0),s.forEach(function(n){n.setClosed()}),s=t.nest(s),t.expand(s,-(o/2+i),n.z,c,0,-o*a),r||(s=t.flatten(c.slice(),[],!0),e.clone(!0).forEach(function(e){e.setZ(n.z).flattenTo(s),e.setClosed()}),c=s);n.tops[0].traces=c}(n,c,w,M.roughingStock,M.roughingOver,G),H&&B(n,w);break;case i.FINISH:!function(n,e,o,i){if(0===n.tops.length)return e;var a=n.gatherTopPolys([]).clone(!0),r=t.expand(a,o/2,n.z);i&&(r=t.filter(t.diff(e,r,n.z),[],function(n){if(n.area()<1)return null;for(var o=0;o<e.length;o++)if(n.isEquivalent(e[o]))return n.inner?n.inner:null;return n}));const l=t.flatten(r,[],!0);n.tops[0].inner=l,n.tops[0].traces=l}(n,s,k,G),H&&B(n,k);break;case i.FLIP:var a=[];c.clone(!0).forEach(function(e){e.setZ(n.z).flattenTo(a)}),n.tops[0].traces=a}o(.4+e/b.length*.1,"finishing")},"cam post"),function(n,e,o,t){var a,r,c,s,x,M=n.mesh,S=e.process,T=e.process,b=T.camTolerance,w=m(e,S.allTool),k=(g(e,S.allTool),w*S.reliefOver),O=n.getBoundingBox().clone(),D=O.max.x-O.min.x,I=O.max.y-O.min.y,P=S.finishingAngle,Z=S.finishCurvesOnly,C=180/Math.PI,F=Math.ceil(D/b),G=Math.ceil(I/b),H=new Float32Array(F*G),A=n.topo={data:H,stepsx:F,stepsy:G,bounds:O,diameter:w,resolution:b},_=y(e,S.allTool,A),N=[];d();function L(n,e){return v(A,_,n,e)}z(n,{height:b,swapX:!0,topo:!0},function(n){for(var e,g,m,y,v,z,A,_=0,X=O.min.y,B=O.max.y,R=O.max.x,Y=l(O.min.z,T.camZBottom)+1e-4,W=0;W<n.length;W++){var J=n[W],U=H,j=J.lines;for(e=0,y=J.z-R,v=X;v<=B;v+=b){m=U[g=_*G+e]||0;for(var q=0;q<j.length;q++){var K=j[q],Q=K.p1,V=K.p2;if((Q.z>Y||V.z>Y)&&(Q.z>m||V.z>m)&&(Q.y<=v&&V.y>=v||V.y<=v&&Q.y>=v)){var $=Q.y-V.y,nn=Q.z-V.z,en=(Q.y-v)/$,on=Q.z-nn*en;on>m&&(m=U[g]=Math.max(on,Y))}}e++}t(.2+ ++_/F*.5,"topo tracing")}if(S.reliefOn&&!S.reliefYOff)for(d(),_=0,y=O.min.x;y<=O.max.x;y+=k){for(s=e=0,(J=u(_,M.newGroup?M.newGroup():null)).camMode=i.FINISH_X,J.lines=a=[],J.addTop(h().setOpen()).poly,r=h().setOpen(),J.tops[0].traces=[r],v=O.min.y;v<O.max.y;v+=b){if(m=H[_*G+e],z=L(_,e),s){M&&a.push(f(p(y,s,x),p(y,v,m)));var tn=Math.abs(Math.atan2(A-z,b)*C%90);tn>P&&(A>z?r.push(p(y,v,A)):r.push(p(y,s,z)))}r.push(p(y,v,z)),s=v,x=m,A=z,e++}E(J,w,Z)&&N.push(J),_=Math.round((y-O.min.x+k)/D*F),t(.7+_/F*.15,"linear x")}if(S.reliefOn&&!S.reliefXOff)for(d(),e=0,v=O.min.y;v<O.max.y;v+=k){for(c=_=0,(J=u(e,M.newGroup?M.newGroup():null)).camMode=i.FINISH_Y,J.lines=a=[],J.addTop(h().setOpen()).poly,r=h().setOpen(),J.tops[0].traces=[r],y=O.min.x;y<=O.max.x;y+=b){if(m=H[_*G+e],z=L(_,e),c){M&&a.push(f(p(c,v,x),p(y,v,m)));var tn=Math.abs(Math.atan2(A-z,b)*C%90);tn>P&&(A>z?r.push(p(y,v,A)):r.push(p(c,v,z)))}r.push(p(y,v,z)),c=y,x=m,A=z,_++}E(J,w,Z)&&N.push(J),e=Math.round((v-O.min.y+k)/I*G),t(.85+e/G*.15,"linear y")}o(N)},function(n){t(0+.2*n,"topo slicing")})}(e,n,function(n){b.appendAll(n)},function(n,e){o(.5+.5*n,e||"create topo")}),a()},printSetup:function n(e,o,a,c){var s=e.settings,f=s.machine,u=s.process,h=a||0,d=e.widgets,x=d.length,z=d[h];if(h>=x||!z)return;var M,S,E,T,b,w,k,O,D,I,P,Z=z.slices,C=z.getCamBounds(s),F=u.camStockZ&&u.camStockX&&u.camStockY,G=u.outputOriginCenter,H=u.camZClearance||1,A=F?u.camStockZ-C.max.z:0,_=F?u.camStockZ+H:C.max.z+H,N=G?0:F?-u.camStockX/2:C.min.x,L=G?0:F?-u.camStockY/2:C.min.y,X=p(N,L,F?u.camStockZ:C.max.z+H),B=(e.output,i),R=u.camDepthFirst,Y=!1,W=u.camTolerance,J=u.drillDown,U=u.drillLift,j=u.drillDwell,q=0===h?[]:e.output,K=[],Q=!0,V=0,$=f.spindleMax,nn=e.addOutput,en=e.tip2tipEmit,on=e.poly2polyEmit,tn=e.poly2polyDepthFirstEmit;function an(){K.length<2||(q.push(K),K=[])}function rn(n,e,o,t){K.mode=I,nn(K,n,e,o,t)}function ln(n,e,o){n!==D&&(E=g(s,n),T=m(s,n),b=T,w=y(s,n,z.topo),D=n),k=e,O=o}function cn(n,e,o,t){for(var i=n.first().z-n.last().z,a=[],r=n.first();;){if(!(i>2*e)){if(i<e){a.push(r.clone()),r.z-=i,a.push(r.clone());break}a.push(r.clone()),r.z-=i/2,a.push(r.clone()),r.z-=i/2,a.push(r.clone());break}a.push(r.clone()),r.z-=e,i-=e}a.forEach(function(n,e){sn(n,1),e<a.length-1&&(t&&rn(null,0,t,E.number),o&&sn(n.clone().setZ(n.z+o),0))}),sn(r.clone().setZ(_)),an()}function sn(n,e){(n=n.clone()).x+=z.mesh.position.x,n.y+=z.mesh.position.y,n.z+=A,Q&&(e=0,Q=!1);var o=k;if(P){var t=P.distTo2D(n),i=n.z-P.z,a=Math.abs(i),c=!e;if(t<.001&&n.z===P.z)return;if(c&&t<=b&&(a<=W?(e=1,c=!1):i<=-W&&(rn(n.clone().setZ(P.z),0,0,E.number),t=0)),(t>T||i>T&&t>W)&&(c||a>=W)){var s=l(function(n,e,o,t,i,a){var r=n.topo,l=r.resolution,c=n.getBoundingBox(),s=i-o,f=a-t,u=Math.max(Math.abs(s),Math.abs(f))/l,p=s/u,h=f/u,d=0;for(;u-- >0;){var g=Math.round((o-c.min.x)/l),m=Math.round((t-c.min.y)/l);d=Math.max(d,v(r,e,g,m,!0)),o+=p,t+=h}return d}(z,w,P.x,P.y,n.x,n.y)+A,n.z,P.z),f=l(s-n.z,s-P.z)>=W,u=s;f&&(u=s+H,rn(P.clone().setZ(u),0,0,E.number)),(f||n.z<s)&&(rn(n.clone().setZ(u),0,0,E.number),t=0)}if(i<=-W){var p=r(t/2,a),h=p/a;o=p&&h&&t>W?Math.round(O+(k-O)*h):O}}else rn(n.clone().setZ(_),0,0,E.number);rn(n,e?1:0,o,E.number),P=n,K.spindle=V}M=c||X;var fn={rough:[],finish:[],roughDiam:0,finishDiam:0,linearx:[],lineary:[],layer:0,drill:[]};Z.forEach(function(n,e){switch(fn.layer++,S=n.camMode!=I,I=n.camMode,Q=!0,S&&(fn.layer=0),n.camMode){case B.FACING:ln(u.allTool,u.roughingSpeed,0),V=Math.min($,u.roughingSpindle),n.tops.forEach(function(n){if(n.traces){var e=[];n.traces.forEach(function(n){e.push(n),n.inner&&n.inner.forEach(function(n){e.push(n)})}),t.setWinding(e,u.outputClockwise,!0),M=on(e,M,function(n,e,o){n.forEachPoint(function(n,e,o,t){sn(n.clone(),0!==t)},!0,e)}),an()}});break;case B.ROUGH:case B.FINISH:n.camMode===B.ROUGH?(ln(u.allTool,u.roughingSpeed,u.roughingPlunge),V=Math.min($,u.roughingSpindle),fn.roughDiam=T):(ln(u.allTool,u.waterlineSpeed,u.waterlinePlunge),V=Math.min($,u.finishingSpindle),fn.finishDiam=T),n.tops.forEach(function(e){if(e.poly&&e.traces){var o=[];t.flatten(e.traces,[]).forEach(function(n){R&&(n=n.clone(!0)),n.layer=fn.layer,o.push(n)}),t.setWinding(o,u.outputClockwise,!0),R?(n.camMode===B.ROUGH?fn.rough:fn.finish).append(o):(M=on(o,M,function(n,e,o){n.forEachPoint(function(n,e,o,t){sn(n.clone(),0!==t)},n.isClosed(),e)}),an())}});break;case B.FINISH_X:case B.FINISH_Y:ln(u.allTool,u.reliefSpeed,u.reliefPlunge),V=Math.min($,u.finishingSpindle),fn.finishDiam=T,n.tops.forEach(function(e){if(e.traces){var o,t=[];e.traces.forEach(function(n){R&&(n=n.clone(!0)),t.push({first:n.first(),last:n.last(),poly:n})}),R?(n.camMode===B.FINISH_X?fn.linearx:fn.lineary).appendAll(t):(M=en(t,M,function(n,e,t){(o=n.poly).last()===e&&o.reverse(),o.forEachPoint(function(n,e){sn(n.clone(),e>0)},!1)}),an())}});break;case B.DRILL:ln(u.allTool,u.drillDownSpeed,u.drillDownSpeed),n.tops.forEach(function(n){n.traces&&fn.drill.appendAll(n.traces)});break;case B.FLIP:ln(u.allTool,u.flipJigSpeed,u.flipJigPlunge),n.tops.forEach(function(n){if(n.traces){var e=[];n.traces.forEach(function(n){e.push(n),n.inner&&n.inner.forEach(function(n){e.push(n)})}),t.setWinding(e,u.outputClockwise,!0),M=on(e,M,function(n,e,o){n.forEachPoint(function(n,e,o,t){sn(n.clone(),0!==t)},!0,e)}),an()}})}o(e/Z.length)});if(R)if(fn.rough.length>0&&(ln(u.allTool,u.roughingSpeed,u.roughingPlunge),V=Math.min($,u.roughingSpindle),M=tn(fn.rough,M,function(n,e,o,t){var i=null;return Y&&n.isClosed()?i=n.forEachPointEaseDown(function(n,e){sn(n.clone(),e>0)},t):n.forEachPoint(function(n,e,o,t){sn(n.clone(),0!==t)},n.isClosed(),e),an(),i},fn.roughDiam*u.roughingOver*1.01)),fn.finish.length>0&&(ln(u.allTool,u.waterlineSpeed,u.waterlinePlunge),V=Math.min($,u.finishingSpindle),M=tn(fn.finish,M,function(n,e,o,t){var i=null;return Y&&n.isClosed()?i=n.forEachPointEaseDown(function(n,e){sn(n.clone(),e>0)},t):n.forEachPoint(function(n,e,o,t){sn(n.clone(),0!==t)},n.isClosed(),e),an(),i},.01*fn.finishDiam)),u.finishCurvesOnly){ln(u.allTool,u.reliefSpeed,u.reliefPlunge),V=Math.min($,u.finishingSpindle);var un=[].appendAll(fn.linearx).appendAll(fn.lineary);M=en(un,M,function(n,e,o){var t=n.poly;t.last()===e&&t.reverse(),t.forEachPoint(function(n,e){sn(n.clone(),e>0)},!1),an()})}else ln(u.allTool,u.reliefSpeed,u.reliefPlunge),V=Math.min($,u.finishingSpindle),fn.linearx.length>0&&(M=en(fn.linearx,M,function(n,e,o){var t=n.poly;t.last()===e&&t.reverse(),t.forEachPoint(function(n,e){sn(n.clone(),e>0)},!1),an()})),fn.lineary.length>0&&(M=en(fn.lineary,M,function(n,e,o){var t=n.poly;t.last()===e&&t.reverse(),t.forEachPoint(function(n,e){sn(n.clone(),e>0)},!1),an()}));fn.drill.length>0&&(ln(u.allTool,u.drillDownSpeed,u.drillDownSpeed),function(n){for(n=n.slice();;){for(var e,o,t=1/0,i=null,a=0;a<n.length;a++)n[a]&&(o=n[a].first().distTo2D(M))<t&&(t=o,i=n[a],e=a);if(!i)return;n[e]=null,M=i.first(),cn(i,J,U,j)}}(fn.drill));sn(M.clone().setZ(C.max.z+H),!1);q.push(K);e.output=q;h+1<x&&n(e,o,h+1,M)},printExport:function(n,e){var t,i,r,l,c,s=0,f=0,u=0,p=[],h=0,d=n.settings,g=(d.machine,d.machine||{}),m=g.gcodeSpace,x=g.gcodeStrip||!1,y=g.gcodeChange||["M6 T{tool}"],v=g.gcodeSpindle||["M3 S{speed}"],z=g.gcodeDwell||["G4 P{time}"],M=n.widgets[0].getCamBounds(d),S=d.machine,E=d.process,T=d.process,b=4,w={x:null,y:null,z:null,f:null,t:null},k=0,O=E.camStockZ&&E.camStockX&&E.camStockY?E.camStockZ:M.max.z,D={max:{x:-1/0,y:-1/0,z:-1/0},min:{x:1/0,y:1/0,z:1/0}},I=T.outputOriginCenter?null:{x:M.max.x,y:M.max.y},P={tool:0,tool_name:"unknown",top:I?S.bedDepth:S.bedDepth/2,left:I?0:-S.bedWidth/2,right:I?S.bedWidth:S.bedWidth/2,bottom:I?0:-S.bedDepth/2,time:0};c=e?function(n){n&&(f++,u+=n.length,p.append(n)),(!n||p.length>1e3)&&(e(p.join("\n")),p=[])}:function(n){n&&(p.append(n),f++,u+=n.length)};function Z(e,o){if(e)for(t=0;t<e.length;t++)i=n.constReplace(e[t],o),x&&(r=i.indexOf(";"))>=0&&0===(i=i.substring(0,r).trim()).length||c(i)}function C(n){var e=n.toString(),o=e.indexOf(".");return o<0?e+".0":e}Z(g.gcodePre,P),n.output.forEach(function(n){n.forEach(function(n){(l=n.point)&&!l.mod&&(l.mod=1,I&&(l.x+=I.x,l.y+=I.y),T.outputInvertX&&(l.x=-l.x),T.outputInvertY&&(l.y=-l.y),T.camOriginTop&&(l.z=l.z-O))})}),n.output.forEach(function(n){k!==n.mode&&(k&&!x&&c("; ending "+a[k]+" after "+Math.round(s/60)+" seconds"),k=n.mode,x||c("; starting "+a[k])),n.spindle&&n.spindle!==h&&((h=n.spindle)>0?Z(v,{speed:Math.abs(h)}):c("M4")),n.forEach(function(n){!function(n){var e=n.point;if(!e)return s+=n.speed,P.time=n.speed,void Z(z,P);e.x=o.round(e.x,b),e.y=o.round(e.y,b),e.z=o.round(e.z,b),n.tool!=w.t&&(w.t=n.tool,P.tool=w.t,P.tool_name=function(n,e){for(var o=0;o<e.length;o++)if(e[o].number===n)return e[o].name;return"unknown"}(n.tool,d.tools),Z(y,P));var t=n.speed,i=[t?"G1":"G0"],a=e.x-w.x,r=e.y-w.y,l=e.z-w.z,f=Math.sqrt(a*a+r*r+l*l);(a||r||l)&&(e.x!==w.x&&(w.x=e.x,D.min.x=Math.min(D.min.x,w.x),D.max.x=Math.max(D.max.x,w.x),i.append(m).append("X").append(C(w.x))),e.y!==w.y&&(w.y=e.y,D.min.y=Math.min(D.min.y,w.y),D.max.y=Math.max(D.max.y,w.y),i.append(m).append("Y").append(C(w.y))),e.z!==w.z&&(w.z=e.z,D.min.z=Math.min(D.min.z,w.z),D.max.z=Math.max(D.max.z,w.z),i.append(m).append("Z").append(C(w.z))),t&&t!==w.f&&(w.f=t,i.append(m).append("F").append(t)),s+=w.f/60*f,c(i.join("")),0)}(n)})}),k&&!x&&c("; ending "+a[k]+" after "+Math.round(s/60)+" seconds");return Z(g.gcodePost,P),c(),n.time=s,n.lines=f,n.bytes=u+f-1,n.bounds=D,e?null:p.join("\n")},getToolDiameter:m,getToolShaftDiameter:x,getToolLength:function(n,e){var o=g(n,e);return o?(o.metric?1:25.4)*o.flute_len:0},getToolShaftLength:function(n,e){var o=g(n,e);return o?(o.metric?1:25.4)*o.shaft_len:0},getToolType:function(n,e){var o=g(n,e);return o?o.type:0}}).process={ROUGH:1,FINISH:2,FINISH_X:3,FINISH_Y:4,FACING:5,DRILL:6,FLIP:7},a=["unset","roughing","finishing","linear-x","linear-y","facing","drilling","flip-jig"],r=Math.min,l=Math.max,c=Math.PI/2,s=n.slicer,f=e.newLine,u=n.newSlice,p=e.newPoint,h=e.newPolygon,d=o.time;function g(n,e){for(var o=0,t=n.tools;o<t.length;o++)if(t[o].id===e)return t[o];return null}function m(n,e){var o=g(n,e);return o?(o.metric?1:25.4)*o.flute_diam:0}function x(n,e){var o=g(n,e);return o?(o.metric?1:25.4)*o.shaft_diam:0}function y(n,e,o){for(var t="ballmill"===g(n,e).type,i=x(n,e),a=i/o.resolution,r=Math.round(a),l=a/2,s=function(n,e){var o=g(n,e);return o?(o.metric?1:25.4)*o.flute_len:0}(n,e),f=m(n,e),u=f/2,p=f/o.resolution,h=(Math.round(p),p/2),d=r+(1-r%2),y=(r-r%2)/2,v=[],z=i-f>.001,M=0;M<d;M++)for(var S=0;S<d;S++){var E=M-y,T=S-y,b=Math.sqrt(E*E+T*T);if(b<=h){var w=t?(1-Math.cos(b/h*c))*-u:0;v.push([E,T,w])}else z&&b<=l&&v.push([E,T,-s])}return v}function v(n,e,o,t,i){for(var a,r,l,c,s,f=0,u=-1,p=n.stepsx,h=n.stepsy,d=n.data;f<e.length;)if(r=(a=e[f++])[0]+o,l=a[1]+t,!(r<0||r>=p||l<0||l>=h)&&void 0!==(s=d[r*h+l])){if(i&&0===s)return n.bounds.max.z;c=a[2]+s,u=Math.max(c,u)}return u>=0?u:n.bounds.max.z}function z(n,e,o,t){s.sliceWidget(n,e,o,t)}function M(n,e){var o,t=null,i=1/0;return n.forEach(function(n){(o=Math.abs(n.z-e))<i&&(t=n,i=o)}),t}function S(n,e,o,t){var i,a=[];var r=[];n.forEach(function(n){n.hasFlats&&r.push(n)});var l=[];r.forEachPair(function(o,t){if(!(t.z>o.z)){var i=Math.abs(t.z-o.z),a=i/e,r=e,c=a-Math.floor(a),s=.02*e;if(!(Math.abs(i-e)<s)){c>s&&(r=i/Math.ceil(a));for(var f=o.z-r;f>=t.z+r/2;f-=r)l.push(M(n,f))}}},1),r.appendAll(l),r.sort(function(n,e){return e.z-n.z}),r.forEach(function(n){!function(n){if(i!==n){if(i=n,n.camMode){var e=u(n.z);n.tops.forEach(function(n){e.addTop(n.poly.clone(!0))}),n=e}n.camMode=o,n.z,a.push(n)}}(n)}),a.forEach(function(n){t.push(n)})}function E(n,e,o){var t,i,a,r,l=n.tops[0].traces[0],c=h().setOpen(),s=l.points,f=0,u=s.length-1;for(r=f;r<s.length;r++)if(s[r].z>0){f=r;break}for(r=u;r>0;r--)if(s[r].z>0){u=r;break}for(r=f;r<=u;r++){if(i=s[r],a){if(a.z===i.z&&(a.x===i.x||a.y===i.y)){t=i;continue}t&&(c.push(t),t=null)}c.push(i),a=i}if(t&&c.push(t),c.length<2)return!1;var p=[],d=h().setOpen();for(n.tops[0].traces=p,a=(s=c.points)[0],t=null,r=1;r<s.length;r++){i=s[r],(o?a.z!=i.z&&(a.x!==i.x||a.y!==i.y):a.z&&i.z)?(0===d.length&&p.length>0&&i.distTo3D(p.peek().last())<=e&&(d=p.peek()),t!==a&&d.push(a),d.push(i),t=i):d.length>1?(0!==p.length&&p.peek()===d||p.push(d),d=h().setOpen(),t=null):1===d.length&&(d=h().setOpen()),a=i}return d.length>1&&p.push(d),p.length>0}}();"use strict";var gs_kiri_laser=exports;!function(){if(self.kiri||(self.kiri={}),self.kiri.driver||(self.kiri.driver={}),!self.kiri.driver.LASER){var n=self.kiri,t=self.base,i=t.util,o=(t.debug,n.driver.LASER={}),e=n.slicer,r=t.newPoint;o.slice=function(n,t,i,o){var r=n.process;if(r.laserSliceHeight<0)return o("invalid slice height");e.sliceWidget(t,{height:r.laserSliceHeight},function(n){t.slices=n,n.forEach(function(t,o){t.doShells(1,-r.laserOffset),i(.8+o/n.length*.2)}),o()},function(n){i(0+.8*n)})},o.printSetup=function(n,t){var i=n.widgets,o=n.settings,e=o.machine,u=o.process,c=(o.mode,n.output),f=0,h=0;i.forEach(function(n){f+=n.slices.length}),i.forEach(function(i){i.slices.forEach(function(i){!function(n,t,i){var o=r(0,0,0);function e(t,i){t&&(Array.isArray(t)?t.forEach(function(n){e(n,i)}):n.polyPrintPath(t,o,i,{extrude:1}))}t.tops.forEach(function(n){var t=[];e(n.traces,t),e(n.innerTraces(),t),i.push(t)})}(n,i,c),t(h++/f)})}),c.forEach(function(n){var t,i={w:1/0,h:1/0},o={w:-1/0,h:-1/0};n.forEach(function(n){t=n.point,n.point=t.clone(),i.w=Math.min(i.w,t.x),o.w=Math.max(o.w,t.x),i.h=Math.min(i.h,t.y),o.h=Math.max(o.h,t.y)}),n.w=o.w-i.w,n.h=o.h-i.h,n.forEach(function(n){(t=n.point).x-=i.w,t.y-=i.h})});for(var a,s,p,l=self.moto,x=(e=o.machine,u=o.process,[e.bedWidth,e.bedDepth]),y=[x[0]/2,x[1]/2],E=x[0]>x[1]?[x[0]/x[1]*10,10]:[10,x[1]/x[1]*10],d=c.sort(function(n,t){return t.w*t.h-n.w*n.h}),g=new l.Pack(y[0],y[1],u.outputTileSpacing).fit(d);!g.packed;)y[0]+=E[0],y[1]+=E[1],g=new l.Pack(y[0],y[1],u.outputTileSpacing).fit(d);for(a=0;a<d.length;a++)(s=d[a]).fit.x+=s.w+g.pad,s.fit.y+=s.h+g.pad,s.forEach(function(n,t){(p=n.point).x+=g.max.w/2-s.fit.x,p.y+=g.max.h/2-s.fit.y,p.z=0})},o.exportGCode=function(n){var t,o,e=[],r=0,c=0;return u(n,function(n,e,u,f){e.x,n.x,e.y,n.y;r=n.x,c=n.y,t=" F"+f,o="M106 S"+i.round(u/100*256,3)},function(n){n.forEach(function(n,i){0===i?e.push("G0 "+n):1===i?(e.push(o),e.push("G1 "+n+t)):e.push("G1 "+n)}),e.push("M107")},function(){},function(n){return"X"+i.round(n.x-r,3)+" Y"+i.round(n.y-c,3)}),e.join("\n")},o.exportSVG=function(n,t){var o,e=[],r=0,c=0,f=t||"blue";return u(n,function(n,t){var i=t.x-n.x,u=t.y-n.y;r=n.x,c=n.y,o=t.y,e.push('<?xml version="1.0" standalone="no"?>'),e.push('<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'),e.push('<svg width="'+i+'mm" height="'+u+'mm" viewBox="0 0 '+i+" "+u+'" xmlns="http://www.w3.org/2000/svg" version="1.1">')},function(n){e.push('<polyline points="'+n.join(" ")+'" fill="none" stroke="'+f+'" stroke-width="0.01mm" />')},function(){e.push("</svg>")},function(n){return i.round(n.x-r,3)+","+i.round(o-n.y-c,3)}),e.join("\n")},o.exportDXF=function(n){var t=[];return u(n,function(n,i){t.appendAll(["  0","SECTION","  2","HEADER","  9","$ACADVER","1","AC1014","  0","ENDSEC","  0","SECTION","  2","ENTITIES"])},function(n){t.appendAll(["  0","LWPOLYLINE","100","AcDbPolyline"," 90",n.length," 70","0"," 43","0.0"]),n.forEach(function(n){t.appendAll([" 10",n.x," 20",n.y])}),t.appendAll(["  0","SEQEND"])},function(){t.appendAll(["  0","ENDSEC","  0","EOF"])},function(n){return{x:n.x,y:n.y}}),t.join("\n")}}function u(n,t,i,o,e){var r,u,c=n.settings.process,f=n.output,h=[],a={x:0,y:0},s={x:0,y:0};f.forEach(function(n){n.forEach(function(n){u=n.point,c.outputInvertX&&(u.x=-u.x),c.outputInvertY&&(u.y=-u.y),u.x*=c.outputTileScaling,u.y*=c.outputTileScaling,a.x=Math.min(a.x,u.x),s.x=Math.max(s.x,u.x),a.y=Math.min(a.y,u.y),s.y=Math.max(s.y,u.y)})}),c.outputOriginCenter||(f.forEach(function(n){n.forEach(function(n){(u=n.point).x-=a.x,u.y-=a.y})}),s.x=s.x-a.x,s.y=s.y-a.y,a.x=0,a.y=0),t(a,s,c.outputLaserPower,c.outputLaserSpeed),f.forEach(function(n){n.forEach(function(n){u=n.point,n.emit?(r&&0===h.length&&h.push(e(r)),h.push(e(u))):h.length>0&&(i(h),h=[]),r=u}),h.length>0&&(i(h),h=[])}),o()}}();"use strict";var gs_kiri_pack=exports;!function(){function t(t,i,s){this.root={x:0,y:0,w:t,h:i},this.max={w:0,h:0},this.packed=!1,this.spacing="number"==typeof s?s:1,this.pad=this.spacing/2}t.prototype={fit:function(t){for(var i,s,h,o,n=0;n<t.length;){if(h=(s=t[n++]).w+this.spacing,o=s.h+this.spacing,!(i=this.findNode(this.root,h,o)))return this;s.fit=this.splitNode(i,h,o)}return this.packed=!0,this},findNode:function(t,i,s){return t.used?this.findNode(t.right,i,s)||this.findNode(t.down,i,s):i<=t.w&&s<=t.h?t:null},splitNode:function(t,i,s){return t.used=!0,t.down={x:t.x,y:t.y+s,w:t.w,h:t.h-s},t.right={x:t.x+i,y:t.y,w:t.w-i,h:s},this.max.w=Math.max(this.max.w,t.x+i),this.max.h=Math.max(this.max.h,t.y+s),t}},self.moto||(self.moto={}),self.moto.Pack=t}();"use strict";var gs_kiri_layer=exports;!function(){if(self.kiri||(self.kiri={}),!self.kiri.Layer){var i=self.kiri,n=r.prototype,y={};i.Layer=r,i.newLayer=function(i){return new r(i)},n.setVisible=function(i){this.group&&(this.group.visible=i)},n.clear=function(){this.changed=!0,this.bycolor={}},n.add=function(i,n){var y=this.bycolor[i];y||(y=this.bycolor[i]=[]),y.push(n)},n.poly=function(i,n,y,e){var o=this;Array.isArray(i)?i.forEach(function(i){o.poly(i,n,y,e)}):(this.add(n,{poly:i,deep:y,open:e}),this.changed=!0)},n.points=function(i,n,y,o){var r=this,t=y/2;i.forEach(function(i){r.lines([e({x:i.x+t,y:i.y+t,z:i.z-t}),e({x:i.x+t,y:i.y+t,z:i.z+t}),e({x:i.x-t,y:i.y+t,z:i.z-t}),e({x:i.x-t,y:i.y+t,z:i.z+t}),e({x:i.x+t,y:i.y-t,z:i.z-t}),e({x:i.x+t,y:i.y-t,z:i.z+t}),e({x:i.x-t,y:i.y-t,z:i.z-t}),e({x:i.x-t,y:i.y-t,z:i.z+t}),e({x:i.x+t,y:i.y+t,z:i.z+t}),e({x:i.x-t,y:i.y+t,z:i.z+t}),e({x:i.x+t,y:i.y+t,z:i.z-t}),e({x:i.x-t,y:i.y+t,z:i.z-t}),e({x:i.x+t,y:i.y-t,z:i.z+t}),e({x:i.x-t,y:i.y-t,z:i.z+t}),e({x:i.x+t,y:i.y-t,z:i.z-t}),e({x:i.x-t,y:i.y-t,z:i.z-t}),e({x:i.x+t,y:i.y+t,z:i.z+t}),e({x:i.x+t,y:i.y-t,z:i.z+t}),e({x:i.x+t,y:i.y+t,z:i.z-t}),e({x:i.x+t,y:i.y-t,z:i.z-t}),e({x:i.x-t,y:i.y+t,z:i.z+t}),e({x:i.x-t,y:i.y-t,z:i.z+t}),e({x:i.x-t,y:i.y+t,z:i.z-t}),e({x:i.x-t,y:i.y-t,z:i.z-t})],n)})},n.lines=function(i,n){this.add(n,{lines:i}),this.changed=!0},n.render=function(){if(this.view&&this.changed){this.group&&this.view.remove(this.group),this.group=this.view.newGroup();var i,n,r,t=this.bycolor;for(i in t)if(t.hasOwnProperty(i)){var s=new THREE.Geometry,x=s.vertices,z=(n=parseInt(i),r=void 0,(r=y[n])||(r=y[n]=new THREE.LineBasicMaterial({fog:!1,color:n,linewidth:1})),r);t[i].forEach(function(i){i.poly?o(x,i.poly,i.deep,i.open):i.lines&&i.lines.forEach(function(i){x.push(e(i))})}),x.length>0&&this.group.add(new THREE.LineSegments(s,z))}this.changed=!1}}}function e(i){return new THREE.Vector3(i.x,i.y,i.z)}function o(i,n,y,r){var t=n.points,s=t.length;if(!(s<2)){for(var x=(void 0===r||null===r?n.isOpen():r)?s-1:s,z=e(t[0]),h=0;h<x;)i.push(z),i.push(z=e(t[++h%s]));y&&n.inner&&n.inner.forEach(function(n){o(i,n,!1,r)})}}function r(i){this.changed=!1,this.group=null,this.view=i,this.bycolor={}}}();"use strict";var gs_kiri_widget=exports;!function(){if(self.kiri||(self.kiri={}),!self.kiri.Widget){var e=self.kiri,t=e.driver,i=t.CAM,s=t.FDM,o=t.LASER,r=(i.process,self.base),n=(r.config,r.debug),a=r.util,c=(r.polygons,Math),l=(c.abs,c.min,c.max,c.sqrt),h=(c.ceil,c.floor,c.round,e.slicer,r.newLine,r.newPoint),u=(e.newSlice,r.newPolygon,r.newOrderedLine,a.time),d=p.prototype,m=0;e.Widget=p,e.newWidget=f,p.loadFromCatalog=function(t,i){e.catalog.getFile(t,function(e){i(f().loadVertices(e))})},p.loadFromState=function(t,i,s){var o=f();o.id=t,o.saved=u(),e.odb.get("ws-save-"+t,function(e){if(e){var t=e.geo||e,r=e.orient||null;i(o.loadVertices(t)),s&&r&&r.pos&&(o.orient=r,o.move(r.pos.x,r.pos.y,r.pos.z,!0))}else i(null)})},p.deleteFromState=function(t,i){e.odb.remove("ws-save-"+t,i)},p.verticesToPoints=function(e,t){for(var i,s,o=new Array(e.length/3),a=0,c=0,d=u(),m={},f=0,p=0,g=o.length;a<e.length;){var v=h(e[a++],e[a++],e[a++]),y=v.key,w=m[y];w||(w=v,m[y]=v,f++),o[c++]=w}for(;o.length>r.config.decimate_threshold&&t&&r.config.precision_decimate>0;){var x,E=[],S=0;for(a=0;a<g;){var b=o[a++],T=o[a++],z=o[a++];E.push({p1:b,p2:T,d:l(b.distToSq3D(T))}),E.push({p1:b,p2:z,d:l(b.distToSq3D(z))}),E.push({p1:T,p2:z,d:l(T.distToSq3D(z))})}for(E.sort(function(e,t){return e.d-t.d}),a=0;a<E.length&&!((x=E[a]).d>=r.config.precision_decimate);a++)x.p1.op||x.p2.op||(x.p1.op=x.p2.op=x.p1.midPointTo3D(x.p2),S++);if(0===S)break;for(p++,i=new Array(g),s=0,a=0;a<g;){b=o[a++],T=o[a++],z=o[a++];b.op&&b.op===T.op||(b.op&&b.op===z.op||T.op&&T.op===z.op||(i[s++]=b.op||b,i[s++]=T.op||T,i[s++]=z.op||z))}o=i.slice(0,s),g=s}return p&&n.log({before:e.length/3,after:o.length,unique:f,decimations:p,time:u()-d}),o},p.pointsToVertices=function(e){for(var t=new Float32Array(3*e.length),i=0,s=0;i<e.length;)t[s++]=e[i].x,t[s++]=e[i].y,t[s++]=e[i++].z;return t},d.saveToCatalog=function(t){var i=this,s=a.time();return e.catalog.putFile(t,this.getGeoVertices(),function(e){e&&e.length&&(console.log("saving decimated mesh ["+e.length+"] time ["+(a.time()-s)+"]"),i.loadVertices(e))}),this},d.saveState=function(t){var i=this;e.odb.put("ws-save-"+this.id,{geo:i.getGeoVertices(),orient:i.orient},function(e){i.saved=u(),t&&t()})},d.encodeSlices=function(){var e=[];return this.slices&&this.slices.forEach(function(t){e.push(t.encode())}),e},d.decodeSlices=function(t){this.slices=e.codec.decode(t,{mesh:this.mesh})},d.loadVertices=function(e){if(this.mesh)return this.mesh.geometry.addAttribute("position",new THREE.BufferAttribute(e,3)),this.mesh.geometry.computeFaceNormals(),this.mesh.geometry.computeVertexNormals(),this.points=null,this;var t=new THREE.BufferGeometry;return t.addAttribute("position",new THREE.BufferAttribute(e,3)),this.loadGeometry(t)},d.loadGeometry=function(e){var t=new THREE.Mesh(e,new THREE.MeshPhongMaterial({color:16776960,specular:1579032,shininess:100,transparent:!0,opacity:1}));return e.computeFaceNormals(),e.computeVertexNormals(),t.material.side=THREE.DoubleSide,t.castShadow=!0,t.receiveShadow=!0,t.widget=this,this.mesh=t,this.center(),this},d.setPoints=function(e){return this.points=e||null,this},d.clearSlices=function(){var e=this.slices,t=this.mesh;e&&(e.forEach(function(e){t.remove(e.view)}),this.slices=null)},d.setColor=function(e){this.mesh.material.color.set(e)},d.setOpacity=function(e){var t=this.mesh;e<=0?(t.material.transparent=!1,t.material.opacity=1,t.material.visible=!1):a.inRange(e,0,1)&&(t.material.transparent=e<1,t.material.opacity=e,t.material.visible=!0)},d.center=function(){for(var e=0,t=this.mesh,i=t.geometry,s=t.getBoundingBox(!0),o=s.min.clone(),r=s.max.clone().sub(o).multiplyScalar(.5),n=i.attributes.position,a=n.array;e<a.length;e+=3)a[e]-=o.x+r.x,a[e+1]-=o.y+r.y,a[e+2]-=o.z;n.needsUpdate=!0,s=t.getBoundingBox(!0),t.w=s.max.x-s.min.x,t.h=s.max.y-s.min.y,t.d=s.max.z-s.min.z,this.points=null,this.modified=!0},d.setTopZ=function(e){var t=this.mesh,i=this.orient.pos;e?(i.z=t.getBoundingBox().max.z-e,t.position.z=-i.z-.01):(i.z=0,t.position.z=0),this.modified=!0},d.move=function(e,t,i,s){var o=this.mesh,r=this.orient.pos;o.material.visible&&(s?(o.position.set(e,t,i),r.x=e||0,r.y=t||0,r.z=i||0):(o.position.x+=e||0,o.position.y+=t||0,o.position.z+=-i||0,r.x+=e||0,r.y+=t||0,r.z+=i||0),(e||t||i)&&(this.modified=!0))},d.scale=function(e,t,i){var s=this.mesh,o=this.orient.scale;this.setWireframe(!1),this.clearSlices(),s.geometry.applyMatrix((new THREE.Matrix4).makeScale(e,t,i)),this.center(),o.x*=e||1,o.y*=t||1,o.z*=i||1},d.rotate=function(e,t,i){this.setWireframe(!1),this.clearSlices(),this.mesh.geometry.applyMatrix((new THREE.Matrix4).makeRotationFromEuler(new THREE.Euler(e||0,t||0,i||0))),this.center();var s=this.orient.rot;s.x+=e||0,s.y+=t||0,s.z+=i||0},d.mirror=function(){this.setWireframe(!1),this.clearSlices();var e,t=this.orient,i=this.mesh.geometry,s=i.attributes,o=s.position.array,r=s.normal.array;for(e=0;e<o.length;e+=3)o[e]=-o[e],r[e]=-r[e];i.computeFaceNormals(),i.computeVertexNormals(),this.center(),t.mirror=!t.mirror},d.getGeoVertices=function(){return this.mesh.geometry.getAttribute("position").array},d.getPoints=function(){return this.points||(this.points=p.verticesToPoints(this.getGeoVertices())),this.points},d.getBoundingBox=function(e){return this.bounds&&!e||(this.bounds=new THREE.Box3,this.bounds.setFromPoints(this.getPoints())),this.bounds},d.isModified=function(){return this.modified},d.slice=function(t,r,c,l){var h=this,u=a.time();if(h.settings=t,c(1e-4,"slicing"),l)e.work.slice(t,this,function(t){t.update&&c(t.update,t.updateStatus),t.send_start&&(h.xfer={start:t.send_start}),t.topo&&(h.topo=t.topo),t.stats&&(h.stats=t.stats),t.send_end&&(h.stats.load_time=h.xfer.start-t.send_end),t.slices&&(h.clearSlices(),h.slices=[]),t.slice&&h.slices.push(e.codec.decode(t.slice,{mesh:h.mesh})),t.error&&r(!1,t.error),t.done&&(h.modified=!1,r(!0))});else{h.clearSlices();var d=null;switch(t.mode){case"LASER":d=o;break;case"FDM":d=s;break;case"CAM":d=i}d?d.slice(t,h,function(e,t){c(e,t)},function(e){if(e)return r(e);c(1,"transferring"),h.stats.slice_time=a.time()-u,h.modified=!1,r()}):(n.log("invalid mode: "+t.mode),r("invalid mode: "+t.mode))}},d.getCamBounds=function(e){var t=this.getBoundingBox().clone();return t.max.z+=e.process.camZTopOffset,t},d.render=function(e,t){var i=this.slices;i&&(i.forEach(function(t){t.renderOutline(e)}),i.forEach(function(t){t.renderShells(e)}),t||i.forEach(function(e){e.renderDiff()}),i.forEach(function(e){e.renderSolidFill()}),t||i.forEach(function(e){e.renderSolidOutlines()}),t||i.forEach(function(e){e.renderSparseFill()}),t||i.forEach(function(e){e.renderSupport()}))},d.hideSlices=function(){var e=!1;return this.slices&&this.slices.forEach(function(t){e=e||t.view.visible,t.view.visible=!1}),e},d.toggleWireframe=function(e,t){this.setWireframe(!this.wire,e,t)},d.setWireframe=function(e,t,i){var s=this.mesh;this.wire&&(s.remove(this.wire),this.wire=null,this.setOpacity(1),this.hideSlices()),e&&(this.wire=base.render.wireframe(s,this.getPoints(),t),this.setOpacity(i))}}function f(e){return new p(e)}function p(e){this.id=e||(new Date).getTime().toString(36)+m++,this.mesh=null,this.points=null,this.bounds=null,this.wire=null,this.topo=null,this.slices=null,this.settings=null,this.modified=!0,this.orient={scale:{x:1,y:1,z:1},rot:{x:0,y:0,z:0},pos:{x:0,y:0,z:0},mirror:!1},this.stats={slice_time:0,load_time:0,progress:0},this.saved=!1}}();"use strict";var gs_kiri_print=exports;!function(){self.kiri||(self.kiri={});var t=self.kiri,e=t.driver,n=(e.CAM,e.FDM,e.LASER,self.base),i=n.util,r=n.debug,o=n.polygons,s=(Math.sqrt,i.sqr),u=Math.PI,a=c.prototype,l=n.Polygon,f=(n.newPoint,null),p=null;function c(t,e,n){this.id=n||(new Date).getTime().toString(36),this.settings=t,this.widgets=e,this.group=new THREE.Group,this.layerView=[],this.time=0,this.lines=0,this.bytes=0,this.output=[],this.distance=0,this.bounds=null}function h(t){var e=Math.floor(6*t.h),n=t.h-e*(1/6),i={},r=t.v*(1-t.s),o=t.v*(1-t.s*n),s=t.v*(1-t.s*(1-n));switch(e){case 0:i.r=t.v,i.g=s,i.b=r;break;case 1:i.r=o,i.g=t.v,i.b=r;break;case 2:i.r=r,i.g=t.v,i.b=s;break;case 3:i.r=r,i.g=o,i.b=t.v;break;case 4:i.r=s,i.g=r,i.b=t.v;break;case 5:i.r=t.v,i.g=r,i.b=o}return i}function d(t,e,n,i,r){f&&e.x==f.x&&e.y==f.y&&e.z==f.z&&p==n||(f=e,p=n,t.push(new function(t,e,n,i){this.point=t,this.emit=e,this.speed=n,this.tool=i}(e,n,i,r)))}function v(t,e,n){n&&t.length>0&&d(e,n,0),e.appendAll(t)}function g(t,e,n){for(var i,r,o,s=0;o=null,i=1/0,t.forEach(function(t){t.delete||((r=e.distTo3D(t.first))<i&&(o={el:t,first:t.first,last:t.last},i=r),(r=e.distTo3D(t.last))<i&&(o={el:t,first:t.last,last:t.first},i=r))}),o;)o.el.delete=!0,e=o.last,n(o.el,o.first,++s);return e}function y(t,e,n){for(var i,r,o,s=0;o=null,i=1/0,t.forEach(function(t){if(!t.delete)if(t.isOpen()){const n=e.distTo2D(t.first()),r=e.distTo2D(t.first());if(n>i&&r>i)return;r<i&&r<n?(t.reverse(),o={poly:t,index:0,point:t.first()}):n<i&&(o={poly:t,index:0,point:t.first()})}else t.forEachPoint(function(n,s){(r=e.distTo3D(n))<i&&(o={poly:t,index:s,point:n},i=r)})}),o;)o.poly.delete=!0,e=n(o.poly,o.index,++s,e)||o.point;return t.forEach(function(t){t.delete=!1}),e}function m(t,e,n,i){var r;return(r=t.indexOf(n))>0?i(e[t.substring(0,r)]||0,parseInt(t.substring(r+1))||0):null}t.newPrint=function(t,e,n){return new c(t,e,n)},a.addOutput=d,a.tip2tipEmit=g,a.extrudePerMM=function(t,e,n){return u*s(t/2)/(u*s(e/2))*(n/t)},a.constReplace=function t(e,n,i){var r,o,s,u=e.indexOf("{",i||0),a=e.indexOf("}",u);return u>=0&&a>u?(r=e.substring(u+1,a),o=m(r,n,"-",function(t,e){return t-e})||m(r,n,"+",function(t,e){return t+e})||m(r,n,"/",function(t,e){return t/e})||m(r,n,"*",function(t,e){return t*e})||n[r]||0,s=e.replace("{"+r+"}",o),t(s,n,a+1+(s.length-e.length))):e},a.poly2polyEmit=y,a.addPrintPoints=v,a.poly2polyDepthFirstEmit=function(t,e,n,i){var r,s=[];t.forEach(function(t,e){r=[],s.push(r),function t(e,n){if(!e)return;n||(n=[]);Array.isArray(e)?e.forEach(function(e){t(e,n)}):(n.push(e),t(e.inner,n));return n}(o.nest(t,!0,!0)).sort(function(t,e){return e.area()-t.area()}).forEach(function(t){if(t.isOpen()||!t.parent||t.parent.innerCount()>1||!function(t,e,n){return function(t,e,n){var i=1/0;return t.forEachPoint(function(t){const r=t.distToPolySegments(e,n);if((i=Math.min(i,r))<=n)return!0}),i}(t,e,n)<=n}(t,t.parent,i))r.push(t),t.pool=[],t.poolsDown=[];else{for(var e=t.parent;e&&!e.pool;)e=e.parent;if(!e)return void console.log({orphan:t});e.pool.push(t)}}),r.sort(function(t,e){return t.area()-e.area()});const n=s[e-1];e>0&&r.forEach(function(t){for(var e=0;e<n.length;e++){const o=n[e];if((!o.isOpen()||!t.isClosed())&&(i=o,r=.1,t.isInside(i,r)))return void o.poolsDown.push(t)}var i,r})});const u=function(t){if(t.mark)return;t.mark=!0;const i=t.pool.slice().append(t);e=y(i,e,n),t.poolsDown.forEach(function(t){u(t)})};return s.forEach(function(t){t.forEach(function(t){u(t)})}),e},a.parseGCode=function(t,e){var n=t.toUpperCase().replace("X"," X").replace("Y"," Y").replace("Z"," Z").replace("E"," E").replace("F"," F").replace("  "," ").split("\n"),i=this.output=[],r=this.bounds={max:{x:-1/0,y:-1/0,z:-1/0},min:{x:1/0,y:1/0,z:1/0}},o=[],s=!1,u=!1,a=function(){s=!0,o.length>0&&(i.push(o),o=[])},l=0,f={X:0,Y:0,Z:0,F:0,E:0},p=e&&e.x||0,c=e&&e.y||0,h=e&&e.z||0;n.forEach(function(t){if(!((t=t.split(";")[0].split(" ")).length<2)){switch(t.shift()){case"G90":!0;break;case"G91":!1;break;case"G0":a();case"G1":t.forEach(function(t){f[t.charAt(0)]=parseFloat(t.substring(1))}),f.X&&(r.min.x=Math.min(r.min.x,f.X)),f.X&&(r.max.x=Math.max(r.max.x,f.X)),f.Y&&(r.min.y=Math.min(r.min.y,f.Y)),f.Y&&(r.max.y=Math.max(r.max.y,f.Y)),f.Z&&(r.min.z=Math.min(r.min.z,f.Z)),f.Z&&(r.max.z=Math.max(r.max.z,f.Z)),f.E&&(u=!0),u&&0===f.E&&(l!=f.Z?a():s=!0),d(o,{x:f.X+p,y:f.Y+c,z:f.Z+h},!s,f.F)}s=!1,f.E=0,l=f.Z}}),a(),this.lines=n.length,this.bytes=t.length},a.setup=function(e,n,i){var r=this,o=r.settings,s=o.mode;if(f=null,p=null,e)t.work.printSetup(o,function(t){t.done?(r.output=t.output,i()):n(t.update,t.updateStatus)});else{var u=t.driver[s];u?u.printSetup(r,n):console.log({missing_print_driver:s}),i()}},a.exportGCode=function(e,n,i){var r=this,o=r.settings.mode;if(e)t.work.printGCode(function(t){r.lines=t.lines,r.bytes=t.bytes,r.bounds=t.bounds,r.distance=t.distance,r.time=t.time,n(t.gcode)});else{var s=t.driver[o];s&&s.printExport?n(s.printExport(r,i)):(console.log({missing_export_driver:o}),n(null))}},a.exportLaserGCode=function(){return t.driver.LASER.exportGCode(this)},a.exportSVG=function(e){return t.driver.LASER.exportSVG(this,e)},a.exportDXF=function(){return t.driver.LASER.exportDXF(this)},a.encodeOutput=function(){var t,e=[];return this.output.forEach(function(n){t=[],e.push(t),n.forEach(function(e){e.point&&t.push({emit:e.emit,speed:60*e.speed,retract:e.retract,point:{x:e.point.x,y:e.point.y,z:e.point.z}})})}),e},a.render=function(){switch(this.settings.mode){case"CAM":this.renderMoves(!0,34986);break;case"FDM":this.renderMoves(!0,7829367);break;case"LASER":this.renderMoves(!1,34986)}},a.renderMoves=function(e,n){var o,s,u=this;u.lines=0,u.output.forEach(function(a){var l=[],f={};for(var p in a.forEach(function(t,e){if(o){if(i.distSq(o,t.point)<.001&&t.point.z===o.z)return;if(t.emit>0){var n=t.speed||4e3,s=f[n]||[];f[n]=s,s.push(o),s.push(t.point)}else l.push(o),l.push(t.point)}else t.emit&&r.log("first point is emit"),t.point.z;o=t.point}),s=t.newLayer(u.group),u.layerView.push(s),e&&s.lines(l,n),f)h({h:Math.min(6e3,parseInt(p))/6e3,s:1,v:.6});s.render(),u.lines+=f.length})},a.getLayerCount=function(){return this.output.length},a.hide=function(){this.layerView.forEach(function(t){t.setVisible(!1)})},a.showLayer=function(t,e){this.layerView[t]&&this.layerView[t].setVisible(e)},a.polyPrintPath=function(t,e,n,i){t.setClockwise();i=i||{};var r=this.settings.process,o=r.outputShortDistance,s=r.outputShortFactor,u=i.extrude||r.outputShellMult,a=i.rate||r.outputFeedrate,l=a*s,f=r.outputSeekrate,p=t.findClosestPointTo(e),c=t.perimeter(),h=c<r.outputShortPoly,v=!0,g=e;return h&&(l+=(a-l)*(c/r.outputShortPoly)),t.forEachPoint(function(t,e,r,s){if(v)i.onfirst&&i.onfirst(t),d(n,t,0,f),v=!1;else{var p=g.distTo2D(t);if(i.shorten&&p>i.shorten&&s===r.length&&(t=g.offsetPointFrom(t,i.shorten)),o&&p<o)d(n,t,u,l+p/o*(a-l));else d(n,t,u,h?l:a)}g=t},!0,p.index),n.last().point},a.slicePrintPath=function(t,e,r,s,u){var a,f=u||{},p=[],c=this,h=this.settings,y=h.process,m=h.machine.nozzleSize,x=f.first||!1,E=(f.minSeek,m*(f.thinWall||1.75)),b=f.retractOver||2,S=f.mult||y.outputFillMult,M=f.mult||y.outputShellMult||(y.laserSliceHeight>=0?1:0),P=y.outputSparseMult,k=y.outputFinishFactor||0,w=f.speed||y.outputFinishrate,D=y.firstLayerRate,z=y.firstLayerFillRate,T=y.firstLayerPrintMult,F=f.speed||(x?D:y.outputFeedrate),A=f.speed||f.fillSpeed||(x?z||D:y.outputFeedrate),C=y.outputSeekrate,G=e.add(r),L=y.zHopDistance||0,Z=y.antiBacklash,O=t.z;function X(){p.length&&(p.last().retract=!0)}function R(e,r){var s=!1;return o.flatten(t.gatherTopPolys([])).forEach(function(t){s||t.forEachSegment(function(t,o){if(i.intersect(e,r,t,o,n.key.SEGINT))return s=!0})}),s}function V(t,n){if(t)if(Array.isArray(t))_(t,function(t){V(t,n)},null);else{var i=0===t.depth&&!x;e=c.polyPrintPath(t,e,p,{rate:i?w:F,accel:i,shorten:i&&!x?m*k:0,extrude:M,onfirst:function(t){e.distTo2D(t)>b&&X()}})}}function Y(t,n,i){for(var r,o,s,u,l,f,c,h,v,g,y=0,m=0,x=!1,M=-1;t&&y<t.length;){for(f=!1,c=null,h=1/0,a=m;a<t.length;a+=2)if(!(r=t[a]).del&&(null===c&&r.index>M&&(c=r.index),null!==c)){if(r.index!==c)break;r.index%2==0?(v=t[a],g=t[a+1]):(g=t[a],v=t[a+1]),(u=Math.min(v.distTo2D(e),g.distTo2D(e)))<h&&(o=v,s=g,h=u),m=a,f=!0}f?(u=e.distTo2D(o),l=o.distTo2D(s),!i&&!x&&u>b?(x=!0,m=0,M=-1):(x=!1,o.del=!0,s.del=!0,y+=2,M=o.index,u<=E&&l<=E?(s=o.midPointTo(s),d(p,s,S*(u/E),A)):(u>b&&(L||R(e,o))&&X(),Z&&u>b&&d(p,o.add({x:Z,y:-Z,z:0}),0,C),u<E?d(p,o,S,A):d(p,o,0,C),d(p,s,S,A)),e=s)):(m=0,M=-1)}t&&t.forEach(function(t){t.del=!1})}function _(t,n,i,r){if(1===t.length)return n(t[0]);t=t.slice();for(var o,s,u,l;;){for(u=[],null,a=0;a<t.length;a++)(s=t[a])&&(o=(l=i?i(s):s).findClosestPointTo(e),u.push({i:a,n:s,d:o.distance-l.depth*E}));if(!1,0===u.length)return;u.sort(function(t,e){return t.d-e.d}),t[u[0].i]=null,n(u[0].n)}}x&&(S*=T,M*=T,P*=T);for(_([].appendAll(t.supports||[]).appendAll(t.tops||[])||[],function(t){if(t instanceof l)t.setZ(O),V([t].appendAll(t.inner||[])),t.fills&&(t.fills.forEach(function(t){t.z=O}),Y(t.fills,t.inner,!0));else{var n=o.flatten(t.gatherOuter([]));V([].appendAll(t.traces).appendAll(t.innerTraces()||[]),n),Y(t.fill_lines),function(t,n){if(t){var i=t.map(function(t){return{poly:t,first:t.first(),last:t.last()}}),r=e;e=g(i,e,function(t,e,n){var i=t.poly;i.last()===e&&i.reverse(),i.forEachPoint(function(t,e){0===e&&r&&r.distTo2D(t)>b&&R(r,t)&&X(),d(p,t,0===e?0:P,F),r=t})})}}(t.fill_sparse),t}},function(t){return t instanceof l?t:t.poly}),a=0;a<p.length;a++)p[a].point=p[a].point.add(r);return v(p,s,G),e.add(r)}}();"use strict";var gs_kiri_codec=exports;!function(){if(self.kiri||(self.kiri={}),!self.kiri.codec){var r=self.base,e=self.kiri,n={};e.codec={encode:t,decode:i,registerDecoder:s},e.Slice.prototype.encode=function(r){return{type:"slice",z:this.z,index:this.index,camMode:this.camMode,tops:t(this.tops,r),bridges:t(this.bridges,r),flats:t(this.flats,r),solids:t(this.solids,r),supports:t(this.supports,r)}},s("slice",function(r,n){var t=e.newSlice(r.z,n.mesh?n.mesh.newGroup():null);return t.index=r.index,t.camMode=r.camMode,t.tops=i(r.tops,n),t.bridges=i(r.bridges,n),t.flats=i(r.flats,n),t.solids=i(r.solids,n),t.supports=i(r.supports,n),t}),e.Top.prototype.encode=function(r){return{type:"top",poly:t(this.poly,r),traces:t(this.traces,r),inner:t(this.inner,r),solids:t(this.solids,r),fill_lines:o(this.fill_lines),fill_sparse:t(this.fill_sparse,r)}},s("top",function(r,n){var t=e.newTop(i(r.poly,n));return t.traces=i(r.traces,n),t.inner=i(r.inner,n),t.solids=i(r.solids,n),t.fill_lines=l(r.fill_lines),t.fill_sparse=i(r.fill_sparse,n),t}),r.Polygon.prototype.encode=function(r){return r.poly||(r.poly={}),r.poly[this.id]?{type:"poly",ref:this.id}:(r.poly[this.id]=this,{type:"poly",id:this.id,array:o(this.points),open:this.isOpen(),inner:t(this.inner,r),parent:t(this.parent,r),fills:o(this.fills),depth:this.depth})},s("poly",function(e,n){if(n.poly||(n.poly={}),e.ref)return n.poly[e.ref];for(var t=r.newPolygon(),s=0;s<e.array.length;)t.push(r.newPoint(e.array[s++],e.array[s++],e.array[s++]));return t.id=e.id,t.open=e.open,n.poly[e.id]=t,t.inner=i(e.inner,n),t.parent=i(e.parent,n),t.fills=l(e.fills),t.depth=e.depth,t})}function t(r,e){if(e=e||{},null===r)return null;if(void 0!==r){if(Array.isArray(r)){for(var n=new Array(r.length),i=0;i<r.length;)n[i]=t(r[i++],e);return n}switch(typeof r){case"string":case"number":return r;case"object":return r.encode?r.encode(e):function(r,e){if(r instanceof Float32Array)return r;var n={};for(var i in r)r.hasOwnProperty(i)&&(n[i]=t(r[i],e));return n}(r,e)}return null}}function i(r,e){if(e=e||{},null===r)return null;if(void 0!==r){if(Array.isArray(r)){for(var t=0;t<r.length;t++)r[t]=i(r[t],e);return r}switch(typeof r){case"string":case"number":return r;case"object":return r.type&&n[r.type]?n[r.type](r,e):function(r,e){if(r instanceof Float32Array)return r;var n={};for(var t in r)r.hasOwnProperty(t)&&(n[t]=i(r[t],e));return n}(r,e)}return null}}function s(r,e){n[r]=e}function o(r){if(!r)return null;var e=new Float32Array(3*r.length),n=0;return r.forEach(function(r){e[n++]=r.x,e[n++]=r.y,e[n++]=r.z}),e}function l(e){if(!e)return null;for(var n=0,t=0,i=new Array(e.length/3);n<e.length;)i[t++]=r.newPoint(e[n++],e[n++],e[n++]);return i}}();if(self.window){self.kiri||(self.kiri={});var host=(loc=self.location).hostname,port=loc.port,proto=loc.protocol,pre=host.indexOf(".space")>0||"localhost"===host?proto+"//"+host+":"+port:"",time=function(){return(new Date).getTime()},KIRI=self.kiri,BASE=self.base,seqid=1,running={},slicing={},worker=null;function send(e,i,t,n,o){var s=seqid++;running[s]={fn:t,async:n||!1},worker.postMessage({seq:s,task:e,time:time(),data:i},o)}KIRI.work={isSlicing:function(){var e=0;for(var i in slicing)e++;return e>0},restart:function(){for(var e in worker&&worker.terminate(),slicing)slicing[e]({error:"cancelled slicing"});slicing={},running={},(worker=new Worker(pre+"/code/worker.js/"+exports.VERSION)).onmessage=function(e){var i=time(),t=e.data,n=running[t.seq].fn;t.done&&delete running[t.seq],t.time_recv=i-t.time_recv,n(t.data,t)}},decimate:function(e,i){send("decimate",e=e.buffer.slice(0),function(e){i(e)})},clear:function(e){send("clear",e?{id:e.id}:{},function(e){})},slice:function(e,i,t){var n=i.getGeoVertices().buffer.slice(0);slicing[i.id]=t,send("slice",{id:i.id,settings:e,vertices:n,position:i.mesh.position},function(e){(e.done||e.error)&&delete slicing[i.id],t(e)},null,[n])},printSetup:function(e,i){send("printSetup",{settings:e},function(e){i(e)})},printGCode:function(e){var i=[];BASE.util.time();send("printGCode",{},function(t){t.line?i.push(t.line):(t.gcode||(t.gcode=i.join("\n")),e(t))})},sliceToGCode:function(e,i,t){(new Date).toString(36),i=widget.getGeoVertices().buffer.slice(0);send("slice",{settings:e,id:wiwd,vertices:i,position:{x:0,y:0,z:0}},function(n){send("printSetup",{settings:e},function(e){send("printGCode",{},function(e){t(e)})},null,[i]),t(n)})}},KIRI.work.restart()}else{module={exports:{}};host=(loc=self.location).hostname;var loc,ver=exports.VERSION;time=function(){return(new Date).getTime()};if(console.log("camlab | init work | "+ver),"grid.space"!==host&&"debug"!==host)try{["license","ext-n3d","ext-clip","add-array","add-three","geo","geo-point","geo-debug","geo-bounds","geo-line","geo-slope","geo-polygon","geo-polygons","kiri-slice","kiri-slicer","kiri-driver-fdm","kiri-driver-cam","kiri-driver-laser","kiri-widget","kiri-pack","kiri-print","kiri-codec"].forEach(function(e){importScripts(["/js/",e,".js","/v"+ver].join(""))})}catch(e){console.log("unable to load worker scripts. kiri is likely in debug mode.")}else importScripts("/code/work.js/"+ver),base.debug.disable();var currentPrint,base=self.base,moto=self.moto,dbug=base.debug,util=base.util,kiri=self.kiri,Widget=kiri.Widget,cache={},dispatch={decimate:function(e,i){e=new Float32Array(e),e=Widget.pointsToVertices(Widget.verticesToPoints(e,!0)),i.done(e)},slice:function(e,i){var t=e.settings,n=new Float32Array(e.vertices),o=e.position,s=Widget.verticesToPoints(n);i.data({update:.05,updateStatus:"slicing"});var r,c=kiri.newWidget(e.id).setPoints(s),a=util.time();cache[e.id]=c,c.mesh={widget:c,position:o},c.slice(t,function(n){if(n)delete cache[e.id],i.data({error:n});else{var o=c.slices||[];i.data({send_start:time()}),i.data({topo:t.synth.sendTopo?c.topo:null,stats:c.stats,slices:o.length}),o.forEach(function(e,t){i.data({index:t,slice:e.encode()})}),i.data({send_end:time()})}i.done({done:!0})},function(e,t){(r=util.time())-a<10&&e<.99||(i.data({update:.05+.95*e,updateStatus:t}),a=r)})},printSetup:function(e,i){var t,n=[];for(t in cache)cache.hasOwnProperty(t)&&n.push(cache[t]);i.data({update:.05,updateStatus:"preview"}),(currentPrint=kiri.newPrint(e.settings,n,e.id)).setup(!1,function(e,t){i.data({update:e,updateStatus:t})},function(){i.done({done:!0,output:currentPrint.encodeOutput()})})},printGCode:function(e,i){currentPrint.exportGCode(!1,function(e){i.done({gcode:e,lines:currentPrint.lines,bytes:currentPrint.bytes,bounds:currentPrint.bounds,distance:currentPrint.distance,time:currentPrint.time})},function(e){i.data({line:e})})},clear:function(e,i){if(!e.id)return cache={},currentPrint=null,void i.done({clear:!0});var t=void 0!==cache[e.id];delete cache[e.id],i.done({id:e.id,had:t,has:void 0!==cache[e.id]})}};self.onmessage=function(e){var i=util.time(),t=e.data,n=dispatch[t.task],o={data:function(e,i){self.postMessage({seq:t.seq,task:t.task,done:!1,data:e},i)},done:function(e,i){self.postMessage({seq:t.seq,task:t.task,done:!0,data:e},i)}};if(n){var s=i-t.time,r=n(t.data,o),c=util.time()-i;r&&self.postMessage({seq:t.seq,task:t.task,time_send:s,time_proc:c,time_recv:util.time(),data:r})}else console.log({kiri_msg:e})},self.alert=function(e){console.log(e)}}"use strict";self.kiri=self.kiri||{},self.kiri.version=exports.VERSION,self.kiri.copyright=exports.COPYRIGHT,self.kiri.license=exports.LICENSE,function(){if(!kiri.init){/(iPad|iPhone|iPod)/g.test(navigator.userAgent);var e,t,n,i={FDM:1,LASER:2,CAM:3},o={ARRANGE:1,SLICE:2,PREVIEW:3},l={fdm:{d:{bedWidth:1,bedDepth:1,bedHeight:1,maxHeight:1,extrudeAbs:1,filamentSize:1,nozzleSize:1,gcodePre:1,gcodePost:1,gcodeProc:1,gcodePause:1,gcodeFExt:1,gcodeFan:1,gcodeTrack:1,gcodeLayer:1},p:{processName:1,sliceHeight:1,sliceShells:1,sliceShellSpacing:1,sliceFillAngle:1,sliceFillOverlap:1,sliceFillSpacing:1,sliceFillSparse:1,sliceSupportEnable:1,sliceSupportDensity:1,sliceSupportOffset:1,sliceSupportGap:1,sliceSupportSize:1,sliceSupportArea:1,sliceSupportExtra:1,sliceSupportSpan:1,sliceSolidMinArea:1,sliceSolidLayers:1,sliceBottomLayers:1,sliceTopLayers:1,sliceVase:1,firstSliceHeight:1,firstLayerRate:1,firstLayerFillRate:1,firstLayerPrintMult:1,outputRaft:1,outputRaftSpacing:1,outputTemp:1,outputFanMax:1,outputBedTemp:1,outputFeedrate:1,outputFinishrate:1,outputSeekrate:1,outputShellMult:1,outputFillMult:1,outputSparseMult:1,outputRetractDist:1,outputRetractSpeed:1,outputRetractDwell:1,outputBrimCount:1,outputBrimOffset:1,outputShortPoly:1,outputShortDistance:1,outputShortFactor:1,outputFinishFactor:1,sliceMinHeight:1,outputCooling:1,antiBacklash:1,zHopDistance:1,gcodeKFactor:1,gcodePauseLayers:1,outputClockwise:1,outputOriginCenter:1,outputInvertX:1,outputInvertY:1}},cam:{d:{bedWidth:1,bedDepth:1,bedHeight:1,spindleMax:1,gcodePre:1,gcodePost:1,gcodeDwell:1,gcodeChange:1,gcodeSpindle:1,gcodeFExt:1,gcodeSpace:1,gcodeStrip:1},p:{processName:1,allTool:1,roughingSpindle:1,roughingDown:1,roughingOver:1,roughingSpeed:1,roughingPlunge:1,roughingStock:1,roughingOn:1,finishingSpindle:1,finishingDown:1,waterlineSpeed:1,waterlinePlunge:1,reliefOver:1,reliefSpeed:1,reliefPlunge:1,finishingAngle:1,finishingOn:1,waterlineOn:1,reliefOn:1,reliefXOff:1,reliefYOff:1,finishCurvesOnly:1,drillSpindle:1,drillDownSpeed:1,drillDown:1,drillDwell:1,drillLift:1,drillingOn:1,camTabsWidth:1,camTabsHeight:1,camTabsOn:1,flipJigOn:1,flipJigDown:1,flipJigSpeed:1,flipJigPlunge:1,flipJigPadding:1,camPocketOnly:1,camDepthFirst:0,camEaseDown:1,camOriginTop:1,camTolerance:1,camZTopOffset:1,camZBottom:1,camZClearance:1,camStockX:1,camStockY:1,camStockZ:1,camPartSnapUp:1,outputClockwise:1,outputOriginCenter:1,outputInvertX:1,outputInvertY:1,machineMetric:1}},laser:{d:{bedWidth:1,bedDepth:1},p:{processName:1,laserOffset:1,laserSliceHeight:1,outputTileSpacing:1,outputTileScaling:1,outputLaserPower:1,outputLaserSpeed:1,outputOriginCenter:1,outputInvertX:1,outputInvertY:1}}},a={tools:[{id:1e3,number:1,type:"endmill",name:"end 1/4",metric:!1,flute_diam:.25,flute_len:1.25,shaft_diam:.25,shaft_len:1.5},{id:1001,number:2,type:"endmill",name:"end 1/8",metric:!1,flute_diam:.125,flute_len:.6,shaft_diam:.125,shaft_len:.9},{id:1002,number:3,type:"endmill",name:"end 1/16",metric:!1,flute_diam:.0625,flute_len:.6,shaft_diam:.125,shaft_len:.9},{id:1003,number:4,type:"endmill",name:"end 2mm",metric:!0,flute_diam:2,flute_len:18,shaft_diam:3.175,shaft_len:20},{id:1004,number:5,type:"endmill",name:"end 3mm",metric:!0,flute_diam:3,flute_len:18,shaft_diam:3.175,shaft_len:20},{id:1005,number:6,type:"ballmill",name:"ball 1/4",metric:!1,flute_diam:.25,flute_len:1.25,shaft_diam:.25,shaft_len:1.5},{id:1006,number:7,type:"ballmill",name:"ball 1/8",metric:!1,flute_diam:.125,flute_len:.6,shaft_diam:.125,shaft_len:.9},{id:1007,number:8,type:"ballmill",name:"ball 1/16",metric:!1,flute_diam:.0625,flute_len:.6,shaft_diam:.125,shaft_len:.9}],machine:{bedWidth:258,bedDepth:185,bedHeight:2.5,maxHeight:150,filamentSize:1.75,nozzleSize:.4,spindleMax:0,gcodePre:[],gcodePost:[],gcodeProc:"",gcodePause:[],gcodeFan:"",gcodeTrack:"",gcodeLayer:"",gcodeDwell:["G4 P{time}"],gcodeChange:[""],gcodeSpindle:["M3 S{speed}"],gcodeFExt:"",gcodeSpace:"",gcodeStrip:!0,machineMetric:!0},process:{processName:"default",sliceHeight:.25,sliceShells:3,sliceShellSpacing:1,sliceFillAngle:45,sliceFillOverlap:.3,sliceFillSpacing:1,sliceFillSparse:.5,sliceSupportEnable:!1,sliceSupportDensity:.25,sliceSupportOffset:1,sliceSupportGap:1,sliceSupportSize:10,sliceSupportArea:1,sliceSupportExtra:0,sliceSupportSpan:6,sliceSolidMinArea:1,sliceSolidLayers:3,sliceBottomLayers:3,sliceTopLayers:3,sliceVase:!1,firstSliceHeight:.25,firstLayerRate:30,firstLayerFillRate:40,firstLayerPrintMult:1,outputRaft:!1,outputRaftSpacing:.2,outputTemp:200,outputFanMax:255,outputBedTemp:0,outputFeedrate:80,outputFinishrate:60,outputSeekrate:100,outputShellMult:1.2,outputFillMult:1.2,outputSparseMult:1.2,outputRetractDist:1,outputRetractSpeed:40,outputRetractDwell:30,outputBrimCount:2,outputBrimOffset:2,outputShortPoly:30,outputShortDistance:0,outputShortFactor:.2,outputFinishFactor:0,sliceMinHeight:0,detectThinWalls:!1,antiBacklash:1,zHopDistance:.2,gcodeKFactor:0,gcodePauseLayers:"",outputCooling:!0,laserOffset:.25,laserSliceHeight:1,outputTileSpacing:1,outputTileScaling:1,outputLaserPower:100,outputLaserSpeed:1e3,allTool:1e3,roughingSpindle:1e3,roughingDown:2,roughingOver:.5,roughingSpeed:1e3,roughingPlunge:250,roughingStock:0,roughingOn:!1,finishingSpindle:1e3,finishingDown:3,reliefOver:.5,waterlineSpeed:800,waterlinePlunge:250,reliefSpeed:1e3,reliefPlunge:800,finishingAngle:85,finishingOn:!0,waterlineOn:!0,reliefOn:!1,reliefXOff:!1,reliefYOff:!1,finishCurvesOnly:!1,drillSpindle:1e3,drillDownSpeed:250,drillDown:5,drillDwell:250,drillLift:2,drillingOn:!1,camTabsWidth:5,camTabsHeight:5,camTabsOn:!1,flipJigOn:!1,flipJigDown:2,flipJigSpeed:600,flipJigPlunge:250,flipJigPadding:5,camPocketOnly:!1,camDepthFirst:!1,camEaseDown:!1,camOriginTop:!0,camPartSnapUp:!1,camTolerance:.15,camZTopOffset:0,camZBottom:0,camZClearance:2,camStockX:0,camStockY:0,camStockZ:0,outputClockwise:!0,outputOriginCenter:!0,outputInvertX:!1,outputInvertY:!1},sproc:{FDM:{},CAM:{},LASER:{}},cproc:{FDM:null,CAM:null,LASER:null},cdev:{FDM:null,CAM:null},filter:{FDM:"Any.Generic.Marlin",CAM:"Sienci.Mill.One.V3"},machines:{},feeds:{},devproc:{},layers:{layerOutline:!0,layerTrace:!0,layerFacing:!0,layerRough:!0,layerFinish:!0,layerFinishX:!0,layerFinishY:!0,layerDelta:!1,layerSolid:!1,layerSparse:!0,layerFill:!0,layerSupport:!0,layerPrint:!1,layerJig:!0},synth:{fillOffsetMult:0,diffOffsetMult:0},controller:{view:null,zoomSpeed:1,reverseZoom:!0},mode:"CAM",id:function(){for(;;){var e=Math.round(9999999999*Math.random()).toString(36);if(e.length>=4&&e.length<=8)return e}}(),ver:3},r=a,s=self,c=moto,d=s.kiri,u=s.base,p=u.util,m=u.debug,f=s.window,h=s.document,g=s.location,v=(e=g.search.substring(1),n={},e.split(",").forEach(function(e){2===(t=e.split(":")).length&&(n[t[0]]=n[t[0]]||[]).push(decodeURIComponent(t[1]))}),n),y=0===g.host.indexOf("localhost"),w=(de(g.protocol),c.KV),b=d.odb=new c.Storage(v.d?v.d[0]:"camlab"),S=d.space=c.Space,D=d.widgets=[],k=d.catalog=d.openCatalog(b,!0),x=new ce(w),M="kiri-seed",A=kiri.Widget,T=kiri.newWidget,E={},C=c.ui.prefix("camlab").inputAction(tt).hideAction(gt),F=(v.dm&&1===v.dm.length&&v.dm[2],v.sm&&1===v.sm.length?v.sm[2]:null),O=i.CAM,I={},L=null,P=null,z=[],R="kiri-gcode-filters",B=me(w.getItem(R))||[],_=4473924,H=.25,N=12320512,G=16776960,j=16776960,V=1,Z=.5,W=0,X=.25,J=parseInt(w["print-seq"]||"0")+1,Y=0,K=0,U=0,q=4,Q=o.ARRANGE,ee=!0,te=!1,ne=(v.local,!1),ie=null,oe=null,le=0;v.rm&&(q=parseInt(v.rm[0])),d.api={ui:E,on:function(e,t){e&&"string"==typeof e&&"function"==typeof t&&(I[e]=I[e]||[],I[e].push(t))},sdb:w,o2js:pe,js2o:me,ajax:ue,help:yt,powered:wt,load:function(e,t){e.toLowerCase().indexOf(".stl")>0?function(e,t){(new c.STL).load(e,function(e){Ge(T().loadVertices(e)),t&&t(e)})}(e,t):ue(e,function(e){e=me(e).toFloat32(),Ge(T().loadVertices(e)),t&&t(e)})},focus:bt,stats:x,import:function(){$("load-file").onchange=function(e){m.log(e),ot(e.target.files)},$("load-file").click()},catalog:k,getMode:Dt,setMode:kt,showModal:ct,hideModal:vt,showDialog:ut,hideDialog:dt,showCatalog:function(){ut("catalog")},addWidget:Ge,selectAll:Ve,selectNone:We,showProgress:ve,clearWorker:d.work.clear,getSettings:function(){return a},putSettings:lt,ghostDetect:function(){return!1},hideImport:function(){E.import.style.display="none"},hideDevices:function(){E.showDevices.style.display="none"},mouse:{moved:function(){return ne},movedSet:function(e){ne=e}}},ce.prototype.save=function(){return this.db.stats=pe(this.obj),this},ce.prototype.get=function(e){return this.obj[e]},ce.prototype.set=function(e,t){return this.obj[e]=t,this.save(),this},ce.prototype.add=function(e,t){return this.obj[e]=(this.obj[e]||0)+(t||1),this.save(),this},ce.prototype.del=function(e){return delete this.obj[e],this.save(),this},x.set("upgrade",kiri.version!==x.get("camlab")&&x.get("init")>0),x.set("camlab",kiri.version),S.addEventListener(h,"DOMContentLoaded",function(){xt()},!1),S.addEventListener(f,"mousemove",function(){ne=!0}),h.onkeydown=function(e){27==e.keyCode&&e.preventDefault()},Array.isArray(self.kirimod)&&kirimod.forEach(function(e){e(kiri.api)})}function ae(e,t){e&&I[e]&&I[e].forEach(function(e){e(t)})}function re(){ae("settings",a)}function se(e,t,n){try{var i=e[t];delete e[t],e[n+t.split("-")[1].toLowerCase()]=i}catch(e){console.log(e)}}function ce(e){this.db=e,this.obj=me(e.stats||"{}");var t,n=this.obj;for(t in n)n.hasOwnProperty(t)&&(0===t.indexOf("slice-")&&se(n,t,"s-"),0===t.indexOf("prep-")&&se(n,t,"p-"),0===t.indexOf("export-")&&se(n,t,"e-"),0===t.indexOf("show-")&&se(n,t,"d-"))}function de(e){return 0===e.toLowerCase().indexOf("https")}function ue(e,t,n,i,o){return new c.Ajax(t,n).request(e,i,o)}function pe(e,t){return e?JSON.stringify(e):t||null}function me(e,t){try{return e?JSON.parse(e):t||null}catch(n){return console.log({malformed_json:e}),t||null}}function fe(e,t){return me(w.getItem(e),t)}function he(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}function ge(e,t){for(var n in e)e.hasOwnProperty(n)&&(t.hasOwnProperty(n)||delete e[n])}function ve(e,t){e?(e=p.round(100*e,4),E.loading.display="block",E.progress.width=e+"%",t&&(E.prostatus.innerHTML=t)):E.loading.display="none"}function ye(e,t,n){return Math.max(t,Math.min(n,e))}function we(e){Ae(K=ye(e,0,U))}function be(){var e=[];return Se(function(t){e.push(t.mesh)}),e}function Se(e){D.slice().forEach(function(t){e(t)})}function De(e){var t=z;0===t.length&&1===D.length&&(t=[D[0].mesh]),t.slice().forEach(function(t){e(t.widget)})}function ke(e){var t=0;Q===o.PREVIEW&&P?t=P.getLayerCount():Se(function(e){e.slices&&(t=Math.max(t,e.slices.length))}),t=Math.max(0,t-1),U=t,(E.layerID.convert()>t||K>t)&&(K=t,E.layerID.value=t,E.layerSlider.value=U),E.layerSlider.max=t,e&&(K=U,E.layerSlider.value=U)}function xe(){var e=!1;return Be(V),Se(function(t){t.setWireframe(!1),e=t.hideSlices()||e}),Ie(),e}function Me(e,t,n){return t?e<=n&&e>n-t:e<=n}function Ae(e){e=ye(e="string"==typeof e||"number"==typeof e?parseInt(e):K,0,U),E.layerID.value=e,E.layerSlider.value=e;var t,n,o,l,a=E.layerRange.checked?E.layerSpan.convert()||1:0,r=E.layerPrint.checked;if(O===i.CAM&&Y!==a&&a&&e===U&&(e=0),Y=a,K=e,Se(function(r){if(o=r.slices)for(t=0;t<o.length;t++)(n=o[t]).view.visible=Me(t,a,e),(l=n.layers).outline.setVisible(O===i.CAM?E.layerOutline.checked&&y:E.layerOutline.checked),l.trace.setVisible(O===i.CAM?E.layerRough.checked:E.layerTrace.checked),l.bridge.setVisible(O===i.CAM?E.layerFinishX.checked:E.layerDelta.checked),l.flat.setVisible(O===i.CAM?E.layerFinishY.checked:E.layerDelta.checked),l.solid.setVisible(O===i.CAM?E.layerFinish.checked:E.layerSolid.checked),l.fill.setVisible(O===i.CAM?E.layerFacing.checked:E.layerFill.checked),l.sparse.setVisible(O===i.CAM?E.layerJig.checked:E.layerSparse.checked),l.support.setVisible(E.layerSupport.checked)}),P)for(t=0;t<P.layerView.length;t++)P.showLayer(t,r&&Me(t,a,e));h.activeElement.blur(),S.update()}function Te(){if(P)switch(x.add("e-"+Dt().toLowerCase()),a.mode){case"LASER":return Ce();case"FDM":case"CAM":return Ee()}else preparePrint(Te)}function Ee(){Pe(),P.exportGCode(!0,function(e){Fe(e)})}function Ce(){if(P){var e="laser-"+(new Date).getTime().toString(36);ue("/camlab/output-laser.html",function(o){E.print.innerHTML=o,$("print-filename").value=e,$("print-lines").value=P.lines,$("print-close").onclick=vt,$("print-svg").onclick=t,$("print-dxf").onclick=n,$("print-lg").onclick=i,ct("print")})}else preparePrint(Ce);function t(){saveAs(new Blob([P.exportSVG($("print-color").value)],{type:"application/octet-stream"}),$("print-filename").value+".svg")}function n(){saveAs(new Blob([P.exportDXF()],{type:"application/octet-stream"}),$("print-filename").value+".dxf")}function i(){saveAs(new Blob([P.exportLaserGCode()],{type:"application/octet-stream"}),$("print-filename").value+".gcode")}}function Fe(e){w["print-seq"]=J++;var t=(O===i.CAM?"cnc-":"print-")+J.toString().padStart(3,"0"),n=a.machine.gcodeFExt||"gcode",o=a.machine.gcodeProc;function l(){return new Blob([e],{type:"application/octet-stream"})}function r(){t=$("print-filename").value,saveAs(l(),t+"."+n)}o&&self[o]&&(e=self[o](e)),ue("/camlab/output-gcode.html",function(e){E.print.innerHTML=e,$("print-close").onclick=vt,$("print-download").onclick=r,$("print-filename").value=t,ct("print")})}function Oe(){xe(),Le(),Ie()}function Ie(){P&&(S.platform.remove(P.group),P=null),E.layerPrint.checked=!1}function Le(){Se(function(e){e.slices=null})}function Pe(e){Q==o.ARRANGE&&(L=(L=S.screenshot()).substring(L.indexOf(",")+1)),St(o.SLICE);var t=z.slice();Ie(),nt(),We();var n,l=D.length,r=U,s=K,c={};a.synth.sendTopo=!1,Be(Z),Se(function(d){var u,f,h={},g=0,v=!1;if(O===i.CAM&&t.length>0&&t.indexOf(d.mesh)<0)return--l;d.stats.progress=0,d.setColor(j),d.slice(a,function(t,n){var c=p.time();d.render(q,O===i.CAM),d.setWireframe(!1,_,H),d.setOpacity("CAM"===a.mode?X:W),d.setColor(G),t&&(f&&(h[g+"_"+f]=c-u),m.log(h),x.add("s-"+Dt().toLowerCase()),ke(!0),r!=U&&(s=U),!1),(0==--l||n||v)&&(ve(0),Ae(s),Be("CAM"===a.mode?X:W),e&&"function"==typeof e&&e()),gt(),n&&!v&&(v=!0,St(o.ARRANGE),E.layers.style.display="none",Be(V),We(),alert2(n))},function(e,t){if(t!==f){var i=p.time();f&&(h[g+"_"+f]=i-u),f=t,u=i,g++}c[d.id]=e,n=0,Se(function(e){n+=c[e.id]||0}),ve(n/D.length,t)},!0)}),(P=kiri.newPrint(a,D)).setup(!0,function(e,t){ve(e,t)},function(){ve(0),P.render(),x.add("p-"+Dt().toLowerCase()),S.platform.add(P.group),S.update(),E.layerPrint.checked=!0,ke(!0),Ae(),"function"==typeof e&&e()})}function ze(){return 1-ye(a.process.sliceFillOverlap,0,.8)}function Re(e){E.selection.style.display=Q===o.ARRANGE&&z.length?"block":"none",e?(E.selWidth.innerHTML=p.round(e.w,2),E.selDepth.innerHTML=p.round(e.h,2),E.selHeight.innerHTML=p.round(e.d,2),E.scaleX.value=1,E.scaleY.value=1,E.scaleZ.value=1):0===z.length&&(E.selWidth.innerHTML="0",E.selDepth.innerHTML="0",E.selHeight.innerHTML="0",E.scaleX.value="",E.scaleY.value="",E.scaleZ.value="")}function Be(e){Se(function(t){t.setOpacity(e)}),S.update()}function $e(e,t,n,i){De(function(o){o.move(e,t,n,i)}),S.update()}function _e(e){var t=parseFloat(e.target.value||1);E.scaleUniform.checked&&(E.scaleX.value=t,E.scaleY.value=t,E.scaleZ.value=t);var n=parseFloat(E.scaleX.value||t),i=parseFloat(E.scaleY.value||t),o=parseFloat(E.scaleZ.value||t);De(function(e){e.scale(n,i,o),Re(e.mesh)}),E.scaleX.value=1,E.scaleY.value=1,E.scaleZ.value=1,Ne(),S.update()}function He(e,t,n){De(function(i){i.rotate(e,t,n)}),Ne(),S.update()}function Ne(){var e=0;Se(function(t){e=Math.max(e,t.mesh.getBoundingBox().max.z)}),S.platform.setMaxZ(e)}function Ge(e,t,n){D.push(e),S.platform.add(e.mesh),Ze(e,t),Ne(),n||ee&&Xe()}function je(e){if(Array.isArray(e)){var t,n=e.slice();for(t=0;t<n.length;t++)je(n[t].widget)}else d.work.clear(e),D.remove(e),S.platform.remove(e.mesh),z.remove(e.mesh),ke(),Ne(),O!==i.FDM&&Xe(),S.update()}function Ve(){Se(function(e){Ze(e,!0)})}function Ze(e,t){if(Q===o.ARRANGE){var n=e.mesh;if(z.indexOf(n)>=0)t?We(e):z.length>1&&(We(),Ze(e,!1));else{if(!n.material.visible)return;t||We(),z.push(n),e.setColor(N),Re(n)}S.update()}}function We(e){if(Q===o.ARRANGE)if(e){var t=e.mesh,n=z.indexOf(t);n>=0&&z.splice(n,1),e.setColor(G),S.update(),Re()}else Se(function(e){We(e)})}function Xe(e,t){var n=Q===o.ARRANGE,l=a.process,r=O===i.CAM?le:0;switch(O){case i.CAM:}if(St(o.ARRANGE),xe(),E.layers.style.display="none",!t&&!n)return S.update();Se(function(e){e.isModified()});var s=t;if(O===i.CAM&&D.length>1){var u=t||1,p=d.driver.CAM;(l.roughingOn||l.waterlineOn||l.reliefOn)&&(u=Math.max(u,p.getToolDiameter(a,l.allTool))),s=1.5*u}for(var m,f,h=S.platform.size(),g=[h.x,h.y],v=[g[0]/2,g[1]/2],y=g[0]>g[1]?[g[0]/g[1]*10,10]:[10,g[1]/g[1]*10],w=be().sort(function(e,t){return t.w*t.h-e.w*e.h}),b=new c.Pack(v[0],v[1],s).fit(w);!b.packed;)v[0]+=y[0],v[1]+=y[1],b=new c.Pack(v[0],v[1],s).fit(w);for(m=0;m<w.length;m++)(f=w[m]).fit.x+=f.w/2+b.pad,f.fit.y+=f.h/2+b.pad,f.widget.move(b.max.w/2-f.fit.x,b.max.h/2-f.fit.y,0,!0),f.widget.setTopZ(r),f.material.visible=!0;S.update()}function Je(e,t){var n,i;for(n in e)e.hasOwnProperty(n)&&(void 0===(i=t[n])||null===i||""===i?t[n]=e[n]:"object"==typeof e[n]&&Je(e[n],t[n]))}function Ye(e){if(!e)return console.trace("missing scope");var t,n;for(t in Je(r,a),e)if(e.hasOwnProperty(t)&&(n=e[t],E.hasOwnProperty(t))){var i=E[t],o=i?i.type:null;if("text"===o)i.value=n;else if("checkbox"===o)i.checked=n,i.classList.contains("enable-checkbox")&&Ke(i);else if("select-one"===o){i.innerHTML="<option></option>";var l=null;a.tools.forEach(function(e,t){n===e.id&&(l=t+1);var o=h.createElement("option");o.appendChild(h.createTextNode(e.name)),o.setAttribute("value",e.id),i.appendChild(o)}),l&&(i.selectedIndex=l)}}return a}function Ke(e){e.parentNode.childNodes.forEach(function(t){"A"!==t.nodeName&&(t.classList.contains("enable-checkbox")||(e.checked?(t.style.height="100%",t.style.visibility="visible"):(t.style.height="0",t.style.visibility="hidden")))})}function Ue(e){if(!e)return console.trace("missing scope");var t;for(t in e)if(e.hasOwnProperty(t)&&E.hasOwnProperty(t)){var n=null,i=E[t];if(!i||""===i)continue;"text"===i.type?n=E[t].convert():"checkbox"===i.type?n=E[t].checked:"select-one"===i.type&&i.selectedIndex>0&&(n=parseInt(i.options[i.selectedIndex].value)),e[t]!=n&&(e[t]=n)}return a.synth.fillOffsetMult=ze(),a.synth.diffOffsetMult=a.machine.nozzleSize/2*ze(),a}function qe(){var e=O===i.CAM?le:0;Se(function(t){t.setTopZ(e)})}function Qe(){var e=a.process;l.cam.p,i.CAM;if(e.camStockX&&e.camStockY&&e.camStockZ){if(!ie){var t=new THREE.BoxGeometry(1,1,1),n=new THREE.MeshBasicMaterial({color:4473924,wireframe:!0,opacity:.2,transparent:!0,side:THREE.DoubleSide}),r=new THREE.Mesh(t,n);S.platform.add(r),ie=r}ie.scale.x=e.camStockX,ie.scale.y=e.camStockY,ie.scale.z=e.camStockZ,ie.position.z=e.camStockZ/2,ie.material.visible="CAM"===a.mode,Se(function(t){e.camStockZ-t.mesh.getBoundingBox().max.z}),e.camPartSnapUp?le=e.camStockZ-e.camZTopOffset:(le=0,Se(function(t){e.camZTopOffset=e.camStockZ-t.mesh.getBoundingBox().max.z})),qe(),S.update()}else ie?(S.platform.remove(ie),S.update(),ie=null,le=0,qe()):e.camZTopOffset;St(o.ARRANGE),Xe(),Le(),S.update()}function et(){Ye(a.machine),Ye(a.process),Ye(a.layers)}function tt(){Ue(a.machine),Ue(a.process),Ue(a.layers),nt(),Qe(),it()}function nt(e){switch(ge(a,r),a.mode){case"FDM":ge(a.machine,l.fdm.d),ge(a.process,l.fdm.p);break;case"CAM":ge(a.machine,l.cam.d),ge(a.process,l.cam.p);break;case"LASER":ge(a.machine,l.laser.d),ge(a.process,l.laser.p),a.cdev.LASER=a.machine}ge(a.cdev.FDM,l.fdm.d),ge(a.cdev.CAM,l.cam.d);var t=S.view.save();(t.left||t.up)&&(a.controller.view=t),w.setItem("ws-settings",JSON.stringify(a))}function it(){var e=a.process;S.platform.remove(oe),oe=null;var t=d.driver.CAM,n=O===i.CAM?.99*t.getToolDiameter(a,e.allTool):4,o=O===i.CAM?t.getToolShaftDiameter(a,e.allTool):4,l=O===i.CAM?t.getToolLength(a,e.allTool):50,r=O===i.CAM?t.getToolShaftLength(a,e.allTool):50,s=O===i.CAM?t.getToolType(a,e.allTool):ballmill,c=.8*Math.PI,u=n/2;void 0!=l&&0!=l||(l=50),void 0!=r&&0!=r||(r=50);var p=.056*Math.PI*l,m=[];m.push(new THREE.Vector2(n/2,0));for(var f=0;f>-c;f-=c/8)m.push(new THREE.Vector2(u*Math.cos(f),-u*Math.sin(f))),u-=.5*n/8;m.push(new THREE.Vector2(.1*-n,0)),m.push(new THREE.Vector2(-n/2,0)),u=n/2;for(f=-Math.PI;f>-c-Math.PI;f-=c/8)m.push(new THREE.Vector2(u*Math.cos(f),-u*Math.sin(f))),u-=.5*n/8;m.push(new THREE.Vector2(.1*n,0));var h,g=new THREE.Shape(m);h="ballmill"===s?{steps:l,depth:l-n/2,bevelEnabled:!1}:{steps:l,depth:l,bevelEnabled:!1};var v=new THREE.ExtrudeGeometry(g,h);"ballmill"===s&&v.translate(0,0,n/2);var y=new THREE.MeshStandardMaterial({color:13421772,metalness:.5,roughness:.7}),w=new THREE.Mesh(v,y);w=function(e,t){for(var n=w.geometry.vertices,i=0;i<n.length;i++){var o=t*n[i].z/l,a=n[i].x*Math.cos(o)-n[i].y*Math.sin(o),r=n[i].y*Math.cos(o)+n[i].x*Math.sin(o);n[i].x=a,n[i].y=r}return w.geometry.computeVertexNormals(),w}(0,p);var b=new THREE.CylinderGeometry(o/2,o/2,1.1*r,20);if(b.rotateX(Math.PI/2),b.translate(0,0,r/2+l),w.add(new THREE.Mesh(b,y)),"ballmill"===s){var D=[];for(f=0;f<Math.PI;f+=.1)D.push(new THREE.Vector2(Math.cos(f)*n/2,Math.sin(f)*n/2));D.push(new THREE.Vector2(n/2,0));var k=new THREE.LatheGeometry(D,12);k.rotateX(-Math.PI/2),k.translate(0,0,n/2),w.add(new THREE.Mesh(k,y))}oe=w,e.camOriginTop?Se(function(e){oe.position.z=e.mesh.getBoundingBox().max.z+0}):Se(function(e){oe.position.z=0}),e.outputOriginCenter?Se(function(e){oe.position.x=0,oe.position.y=0}):Se(function(e){oe.position.x=-e.mesh.getBoundingBox().max.x,oe.position.y=-e.mesh.getBoundingBox().max.y}),S.platform.add(w),Xe(),S.update()}function ot(e){for(var t=0;t<e.length;t++){var n=e[t].name.toLowerCase(),i=new FileReader,l=n.indexOf(".stl")>0,r=n.indexOf(".gcode")>0||n.indexOf(".nc")>0;i.file=e[t],i.onloadend=function(e){var t;l&&Ge(T().loadVertices((new c.STL).parse(e.target.result)).saveToCatalog(e.target.file.name)),r&&(t=e.target.result,St(o.PREVIEW),Ie(),Be(0),(P=kiri.newPrint(a,[])).parseGCode(t,a.process.outputOriginCenter?null:{x:-a.machine.bedWidth/2,y:-a.machine.bedDepth/2}),P.render(),S.platform.add(P.group),S.update(),E.layerPrint.checked=!0,ke(!0),Ae(),Fe(t))},i.readAsBinaryString(i.file)}it()}function lt(e){a=e,nt(),rt(null,!0)}function at(){var e,t,n=a.machine,i=Math.round(Math.max(n.bedHeight,n.bedWidth/100,n.bedDepth/100));S.platform.setGZOff(i/2-.1),S.platform.setSize(e=parseInt(n.bedWidth),t=parseInt(n.bedDepth),i),S.platform.setHidden(e>500||t>500)}function rt(e,t){var n=0,i=fe("ws-widgets",[]),o=fe("ws-settings"),l=fe("ws-camera"),s="FDM"===(o||a).mode;if(o&&(Je(r,o),(a=o).controller.view&&(l=a.controller.view,w.removeItem("ws-camera")),["FDM","CAM","LASER"].forEach(function(e){var t="ws-settings-"+e,n=fe(t,a);w.removeItem(t),w.removeItem("ws-camera-"+e),a.cproc[e]||(he(n.machine,n.bed),he(n.process,n.output),a.cproc[e]="default",a.sproc[e].default=n.process),a.cdev[e]||(a.cdev[e]=n.machine),"CAM"===e&&n.tools&&(a.tools=n.tools),a.filter[e]=n.filter[e]}),B.forEach(function(e){var t="gcode-filter-"+e,n=fe(t);n&&(a.machines[e]=n),w.removeItem(t)}),w.removeItem(R),nt()),et(),at(),Qe(),it(),S.view.reset(),l?S.view.load(l):setTimeout(S.view.home,100),!t)return Se(function(e){je(e)}),i.forEach(function(t){A.loadFromState(t,function(t){t&&Ge(t,0,s),++n===i.length&&(We(),e&&e())},s)}),i.length>0}function st(){var e=!1;return["modal","catalog","machines","tools","feeds","projects"].forEach(function(t){var n=E[t].style.display;e=e||"none"!==n}),e||C.isPopped()}function ct(e){E.modal.style.display="block",["print","help","powered"].forEach(function(t){E[t].style.display=t===e?"block":"none"})}function dt(){ut(null)}function ut(e,t){C.isPopped()?C.hidePop():["catalog","machines","tools","settings","feeds","projects"].forEach(function(n){var i=E[n].style;i.display=n!==e||!t&&"flex"===i.display?"none":"flex"})}function pt(e,t){var n=e?e.target.getAttribute("load"):t||a.cproc[Dt()],i=a.sproc[Dt()][n],o=Dt(),l=h.querySelector("#ck_settings_label");if(i){for(var r in i)i.hasOwnProperty(r)&&(a.process[r]=i[r]);a.process.processName=n,a.cproc[o]=n,a.devproc[a.filter[Dt()]]=n,et(),t||dt(),tt(),e&&re(),l.textContent=n}}function mt(e){var t=e.target.getAttribute("del");delete a.sproc[Dt()][t],ft(),nt(),re()}function ft(){var e=[],t=a.sproc[Dt()]||{},n=E.settingsList;for(var i in n.innerHTML="",t)t.hasOwnProperty(i)&&e.push(i);e.sort().forEach(function(e){var t=h.createElement("div"),i=h.createElement("button"),o=h.createElement("button");i.setAttribute("load",e),i.onclick=pt,i.appendChild(h.createTextNode(e)),e==a.process.processName&&i.setAttribute("class","selected"),o.setAttribute("del",e),o.setAttribute("title","remove '"+e+"'"),o.onclick=mt,o.appendChild(h.createTextNode("x")),t.setAttribute("class","flow-row"),t.appendChild(i),t.appendChild(o),n.appendChild(t)}),gt()}function ht(){gt()}function gt(){var e=E.ctrlLeft.getBoundingClientRect(),t=E.ctrlRight.getBoundingClientRect();E.catalog.style.left=e.width-5+"px",E.catalog.style.top="56px",E.machines.style.left=e.width-5+"px",E.machines.style.top="12px",E.tools.style.left=e.width-5+"px",E.tools.style.top="100px",E.feeds.style.right=t.width-5+"px",E.feeds.style.top="35px",E.settings.style.right=t.width-5+"px",E.settings.style.top="35px"}function vt(){E.modal.style.display="none"}function yt(e){if(dt(),!e)return f.open("//sienci.com/camlab-help","_help"),void x.add("d-help");ue(e,function(e){E.help.innerHTML=e,$("help-close").onclick=vt,$("kiri-version").innerHTML="<i>version "+kiri.version+"</i>",ct("help"),x.add("d-help")})}function wt(e){if(dt(),!e)return f.open("//wiki.grid.space/wiki/Kiri:Moto"),void x.add("d-help");ue(e,function(e){E.powered.innerHTML=e,$("powered-close").onclick=vt,ct("powered"),x.add("d-help")})}function bt(e){h.activeElement.blur(),e=[e||h.body,E.ctrlLeft,E.container,E.assets,E.control,E.modeFDM,E.reverseZoom,E.viewModelOpacity,h.body];for(var t,n=0;n<e.length&&((t=e[n]).focus(),h.activeElement!==t);n++);E.ctrlLeft.focus(),E.container.focus()}function St(e){switch(Q=e,We(),Re(),[E.modeArrange,E.modeSlice].forEach(function(e){e.removeAttribute("class")}),e){case o.ARRANGE:ke(),E.layerView.style.display="none",E.layers.style.display="none",E.modeArrange.setAttribute("class","buton");break;case o.SLICE:E.layerView.style.display="block",E.modeSlice.setAttribute("class","buton"),ke();break;case o.PREVIEW:E.layerView.style.display="block",E.modePreview.setAttribute("class","buton");break;default:return void m.log("invalid view mode: "+e)}h.activeElement.blur()}function Dt(){return a.mode}function kt(e,t,n){vt(),dt(),i[e]||(m.log("invalid mode: "+e),e="CAM"),a.mode=e,a.cdev[e]&&(a.machine=a.cdev[e]),x.set("dn",a.filter[e]||".laser."),O=i[e],C.setMode(O),pt(),nt(),Oe(),S.update(),ie&&(ie.material.visible="CAM"===a.mode),rt(null,!0),O!==i.FDM&&Xe(),n&&n(),re()}function xt(){if(!kiri.init){kiri.init=xt;var e=$("assets"),t=$("control"),n=$("container"),r=($("welcome"),null),c=null,u=Math.PI/2,b=u/9,D=[i.FDM,i.LASER,i.CAM],I=[i.CAM],L=[i.FDM],P=[i.CAM,i.FDM],R=[i.LASER,i.FDM],B=[i.LASER,i.CAM],N=[i.LASER];f.addEventListener("resize",ht),S.showSkyGrid(!1),S.setSkyColor(16316664),S.init(n,function(e){0!==U&&(a.controller.reverseZoom&&(e=-e),e>0?K--:e<0&&K++,Ae())}),S.platform.onMove(nt),he(E,{container:n,ctrlLeft:$("control-left"),ctrlRight:$("control-right"),layerView:$("layer-view"),layerSlider:$("layer-slider"),assets:e,control:t,modal:$("modal"),print:$("print"),help:$("help"),powered:$("powered"),alert:{dialog:$("alert-area"),text:$("alert-text")},projects:$("projects"),projectsClose:$("projects-close"),machines:$("machines"),deviceAdd:$("machine-add"),deviceDelete:$("machine-del"),deviceSave:$("machine-save"),deviceClose:$("machine-close"),deviceSelect:$("machine-select"),machine:C.newGroup("Machine",$("machine")),deviceName:C.newInput("name",{size:12}),setDeviceFilament:C.newInput("filament",{title:"diameter [mm]",convert:C.toFloat,modes:L}),setDeviceNozzle:C.newInput("nozzle",{title:"diameter [mm]",convert:C.toFloat,modes:L}),setDeviceWidth:C.newInput("bed width",{title:"[mm]",convert:C.toInt}),setDeviceDepth:C.newInput("bed depth",{title:"[mm]",convert:C.toInt}),setDeviceMetric:C.newBoolean("metric",G,{title:"in mm",modes:I}),setDeviceHeight:C.newInput("max height",{title:"max build height [mm]",convert:C.toInt,modes:L}),setDevice:C.newGroup("gcode",$("machine")),setDeviceMaxSpindle:C.newInput("max spindle rpm",{title:"max spindle speed\n0 to disable",convert:C.toInt,modes:I}),setDeviceExtrusion:C.newBoolean("extrusion absolute",G,{title:"extrusion moves absolute"}),setDeviceOrigin:C.newBoolean("origin center",G,{title:"bed origin center"}),setDeviceOriginTop:C.newBoolean("origin top",G,{title:"part z origin top",modes:I}),setDeviceFan:C.newInput("fan power",{title:"set cooling fan power",modes:L,size:15}),setDeviceTrack:C.newInput("progress",{title:"output on each % progress",modes:L,size:15}),setDeviceLayer:C.newText("layer",{title:"output at each layer change",modes:L,size:14,height:2}),setDeviceToken:C.newBoolean("token spacing",null,{title:"gcode token spacing",modes:I}),setDeviceStrip:C.newBoolean("strip comments",null,{title:"strip gcode comments",modes:I}),setDeviceFExt:C.newInput("file ext",{title:"file name exension",modes:I,size:5}),setDeviceDwell:C.newText("dwell",{title:"gcode dwell script",modes:I,size:14,height:2}),setDeviceChange:C.newText("tool change",{title:"tool change script",modes:I,size:14,height:2}),setDeviceSpindle:C.newText("spindle speed",{title:"set spindle speed",modes:I,size:14,height:2}),setDevicePause:C.newText("pause",{title:"gcode pause script",modes:L,size:14,height:3}),setDevicePre:C.newText("header",{title:"gcode header script",modes:P,size:14,height:3}),setDevicePost:C.newText("footer",{title:"gcode footer script",modes:P,size:14,height:3}),tools:$("tools"),toolsSave:$("tools-save"),toolsClose:$("tools-close"),toolSelect:$("tool-select"),toolAdd:$("tool-add"),toolDelete:$("tool-del"),toolType:$("tool-type"),toolName:$("tool-name"),toolNum:$("tool-num"),toolFluteDiam:$("tool-fdiam"),toolFluteLen:$("tool-flen"),toolShaftDiam:$("tool-sdiam"),toolShaftLen:$("tool-slen"),toolMetric:$("tool-metric"),catalog:$("catalog"),catalogBody:$("catalogBody"),catalogList:$("catalogList"),settings:$("settings"),settingsBody:$("settingsBody"),settingsList:$("settingsList"),feeds:$("feeds"),layerID:$("layer-id"),layerSpan:$("layer-span"),layerRange:$("layer-range"),loading:$("loading").style,progress:$("progress").style,prostatus:$("prostatus"),selection:$("selection"),selWidth:$("sel_width"),selHeight:$("sel_height"),selDepth:$("sel_depth"),scaleX:$("scale_x"),scaleY:$("scale_y"),scaleZ:$("scale_z"),scaleUniform:$("scale_uni"),layers:C.newLayer("layers",e),layerOutline:C.newBoolean("outline",j,{modes:y?D:R}),layerTrace:C.newBoolean("trace",j,{modes:R}),layerFacing:C.newBoolean("facing",j,{modes:I}),layerRough:C.newBoolean("roughing",j,{modes:I}),layerFinish:C.newBoolean("finishing",j,{modes:I}),layerFinishX:C.newBoolean("finish x",j,{modes:I}),layerFinishY:C.newBoolean("finish y",j,{modes:I}),layerDelta:C.newBoolean("delta",j,{modes:L}),layerSolid:C.newBoolean("solids",j,{modes:L}),layerFill:C.newBoolean("solid fill",j,{modes:L}),layerSparse:C.newBoolean("sparse fill",j,{modes:L}),layerSupport:C.newBoolean("support",j,{modes:L}),layerPrint:C.newBoolean("move",j,{modes:I}),layerJig:C.newBoolean("flip jig",j,{modes:I}),sysTable:C.newTableRow([[E.setupMachines=C.newButton("Machine",de,{modes:P})]]),importButton:C.newTableRow([[C.newButton("Import",function(){d.api.import()}),E.import=C.newButton("+")]]),camStock:C.newGroup("material size",null,{title:"use when cutting an object or\npattern out of a larger piece of material",modes:I}),camStockX:C.newInput("width",{title:"width in millimeters\n0 defaults to part size",convert:C.toFloat,bound:C.bound(0,9999),modes:I,size:1}),camStockY:C.newInput("depth",{title:"depth in millimeters\n0 defaults to part size",convert:C.toFloat,bound:C.bound(0,9999),modes:I,size:1}),camStockZ:C.newInput("height",{title:"height in millimeters\n0 defaults to part size",convert:C.toFloat,bound:C.bound(0,9999),modes:I,size:1}),output:C.newGroup("positioning"),outputOriginCenter:C.newBoolean("origin center",G,{title:"cutting tool either starts at\ncenter or at front, left",modes:B}),camOriginTop:C.newBoolean("origin top",G,{title:"cutting tool either starts at\nthe top or the bottom",modes:I}),camPartSnapUp:C.newBoolean("snap to top",G,{title:"float the object to\nthe top of the material",modes:I}),camZTopOffset:C.newInput("z top offset",{title:"offset from stock surface\nto top face of part [mm]",convert:C.toFloat,modes:I,size:1}),camZBottom:C.newInput("z segment",{title:"offset from part bottom\nto limit cutting depth [mm]",convert:C.toFloat,modes:I,size:1}),mills:C.newTableRow([[E.setupTools=C.newButton("Mills",function(){if(O!==i.CAM)return;"inline-block"==E.layers.style.display&&(E.layers.style.display="none");c=a.tools.slice(),E.toolsClose.onclick=function(){c.changed&&!confirm("abandon changes?")||dt()},E.toolAdd.onclick=function(){c.push({id:p.time(),number:c.length,name:"new",type:"endmill",flute_diam:.25,flute_len:1,shaft_diam:.25,shaft_len:3,metric:!1}),c.changed=!0,le(),E.toolSelect.selectedIndex=c.length-1,se(c[c.length-1])},E.toolDelete.onclick=function(){c.remove(r),c.changed=!0,le()},E.toolsSave.onclick=function(){c.changed=!1,r&&ce(),a.tools=c,nt(),et(),dt(),re()},le(),c.length>0?(se(c[0]),E.toolSelect.selectedIndex=0):E.toolAdd.onclick();ut("tools"),E.toolSelect.focus()},{modes:I})],[]]),system:C.newGroup("millselect"),allTool:C.newSelectField("tool",{modes:I}),wsFuncTable:C.newTableRow([[E.modeArrange=C.newButton("Arrange",Xe)],[E.modeSlice=C.newButton("Generate",Pe)],[E.modeExport=C.newButton("Send",Te)],[E.poweredButton=C.newButton("Powered",wt)],[E.modeCAM=C.newButton("Cam",null)],[E.setupFeeds=C.newButton("Feeds",function(){if(O!==i.CAM)return;"inline-block"==E.layers.style.display&&(E.layers.style.display="none");ut("feeds"),E.toolSelect.focus()},{modes:I})],[E.helpButton=C.newButton("Help",yt)]]),settingsGroup:C.newGroup("settings",sets),settingsTable:C.newTableRow([[E.settingsLoad=C.newButton("load",function(){ft(),ut("settings")}),E.settingsSave=C.newButton("save",function(){dt();var e=Dt(),t=a,n=t.process,i=t.sproc[e],o=l[e.toLowerCase()].p,r=f.prompt("Save Settings As",n&&n.processName||"default"),s=h.querySelector("#ck_settings_label");if(!r)return;var c=i[r]={};for(var d in n.processName=r,n)n.hasOwnProperty(d)&&o.hasOwnProperty(d)&&(c[d]=n[d]);t.cproc[Dt()]=r,nt(),re(),s.textContent=r})]]),pathAlteration:C.newGroup("path alterations",null,{modes:I}),camPocketOnly:C.newBoolean("pocket only",G,{title:"stops from cutting\nthe object's perimeter",modes:I}),camDepthFirst:C.newBoolean("depth first",G,{title:"optimize pocket cuts\nwith depth priority",modes:I}),outputClockwise:C.newBoolean("clockwise",G,{title:"waterline milling direction",modes:I}),bedWidth:C.newInput("width",{title:"in mm",convert:C.toInt,modes:N}),bedDepth:C.newInput("depth",{title:"in mm",convert:C.toInt,modes:N}),roughingOn:C.newGroup("roughing",null,{title:"cuts away a\nlot of material",modes:I},!0,G,!1),roughingOver:C.newInput("step over",{title:"0.1 - 1.0\npercentage of\ntool diameter",convert:C.toFloat,bound:C.bound(.1,1),modes:I,size:4}),roughingDown:C.newInput("step down",{title:"step down depth for\neach roughing pass [mm]\n0 to disable",convert:C.toFloat,modes:I,size:4}),roughingSpeed:C.newInput("feed rate",{title:"max speed while\ncutting [mm/min]",convert:C.toInt,modes:I,size:4}),roughingPlunge:C.newInput("plunge rate",{title:"max speed on\nz axis [mm/min]",convert:C.toInt,modes:I,size:4}),roughingStock:C.newInput("leave stock",{title:"horizontal offset from vertical faces\nstock to leave for finishing pass [mm]",convert:C.toFloat,modes:I,size:4}),waterlineOn:C.newGroup("finishing",null,{title:"small material removal\nfor a nice surface\nfinish",modes:I},!0,G,!0),finishingDown:C.newInput("step down",{title:"step down depth for\neach finishing pass [mm]\n0 to disable",convert:C.toFloat,modes:I,size:4}),waterlineSpeed:C.newInput("feed rate",{title:"max speed while\ncutting [mm/min]",convert:C.toInt,modes:I,size:4}),waterlinePlunge:C.newInput("plunge rate",{title:"max speed on\nz axis [mm/min]",convert:C.toInt,modes:I,size:4}),reliefOn:C.newGroup("relief",null,{title:"linear finishing in\nx-asis and y-axis",modes:I},!0,G,!0),reliefOver:C.newInput("step over",{title:"0.05 - 1.0\npercentage of\ntool diameter",convert:C.toFloat,bound:C.bound(.05,1),modes:I,size:4}),reliefSpeed:C.newInput("feed rate",{title:"max speed while\ncutting [mm/min]",convert:C.toInt,modes:I,size:4}),reliefPlunge:C.newInput("plunge rate",{title:"max speed on\nz axis [mm/min]",convert:C.toInt,modes:I,size:4}),finishingAngle:C.newInput("max angle",{title:"angles greater than this\nare considered vertical",convert:C.toFloat,bound:C.bound(45,90),modes:I,size:4}),reliefXOff:C.newBoolean("no linear x",G,{title:"linear x-axis finishing",modes:I}),reliefYOff:C.newBoolean("no linear y",G,{title:"linear y-axis finishing",modes:I}),finishCurvesOnly:C.newBoolean("curves only",G,{title:"limit linear cleanup\nto curved surfaces\nto reduce time",modes:I}),drillingOn:C.newGroup("drilling",null,{title:"for drilling holes",modes:I},!0,G),drillDown:C.newInput("plunge per",{title:"max plunge between\ndwell periods [mm]\n0 to disable",convert:C.toFloat,modes:I,size:4}),drillDownSpeed:C.newInput("plunge rate",{title:"plunge rate [mm/min]\n0 to disable",convert:C.toFloat,modes:I,size:4}),drillDwell:C.newInput("dwell time",{title:"dwell time between\nplunges [milliseconds]",convert:C.toFloat,modes:I,size:4}),drillLift:C.newInput("drill lift",{title:"lift between plunges\nafter dwell period [mm]\n0 to disable",convert:C.toFloat,modes:I,size:4}),camTabsOn:C.newGroup("cutout tabs",null,{title:"keeps the object\npartially attached to\nthe original material",modes:I},!0,G),camTabsWidth:C.newInput("width",{title:"width perpendicular\nto part [mm]",convert:C.toFloat,bound:C.bound(1,100),modes:I,size:4}),camTabsHeight:C.newInput("height",{title:"height from part\nbottom [mm]",convert:C.toFloat,bound:C.bound(1,100),modes:I,size:4}),flipJigOn:C.newGroup("flip jig",null,{title:"generates a jig which\nallows both sides of the\nobject to be cut",modes:I},!0,G),flipJigDown:C.newInput("step down",{title:"step down depth for\neach pass [mm]\n0 to disable",convert:C.toFloat,modes:I,size:4}),flipJigSpeed:C.newInput("feed rate",{title:"max speed while\ncutting [mm/min]",convert:C.toInt,modes:I,size:4}),flipJigPlunge:C.newInput("plunge rate",{title:"max speed on\nz axis [mm/min]",convert:C.toInt,modes:I,size:4}),flipJigPadding:C.newInput("padding",{title:"minimum space between\npart border and start\nof jig [mm]",convert:C.toFloat,bound:C.bound(1,1e3),modes:I,size:4})}),S.addEventHandlers(s,["keyup",function(e){switch(e.keyCode){case 27:h.activeElement.blur(),vt(),We(),dt(),d.work.isSlicing()&&d.work.restart()}return!1},"keydown",Z,"keypress",function(e){var t,n,o,l,a,r,s=!0,c=e.charCode-48;if(st())return!1;if(V()&&(parseInt(h.activeElement.size)>10||c>=0&&c<=9))return!1;switch(e.charCode){case W("h"):yt("/camlab/help-kiri.html");break;case W("g"):Pe();break;case W("s"):Ve();break;case W("e"):Te();break;case W("p"):O===i.CAM&&("inline-block"==E.layers.style.display&&(E.layers.style.display="none"),E.projectsClose.onclick=dt,ut("projects"));break;case W("d"):for(t=z.slice(),We(),n=0;n<t.length;n++){(o=t[n].clone()).geometry=o.geometry.clone(),o.material=o.material.clone(),l=o.getBoundingBox();var d=T().loadGeometry(o.geometry);d.move(l.max.x-l.min.x+1,0,0),Ge(d,!0)}break;case W("m"):De(function(e){e.mirror()}),S.update();break;case W("a"):Xe();break;case W("w"):a=_,r=H,Se(function(e){e.toggleWireframe(a,r)}),S.update();break;default:ae("keypress",e),s=!1}return s&&e.preventDefault(),!1},"dragover",function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy",S.platform.setColor(65280)},"dragleave",function(){S.platform.setColor(5592405)},"drop",function(e){e.stopPropagation(),e.preventDefault(),S.platform.setColor(5592405);var t=e.dataTransfer.files;(t.length<5||confirm("add objects to table?"))&&ot(t)}]),S.onEnterKey([E.layerSpan,function(){Ae()},E.layerID,function(){we(E.layerID.value)},E.scaleX,_e,E.scaleY,_e,E.scaleZ,_e,E.toolName,ce,E.toolNum,ce,E.toolFluteDiam,ce,E.toolFluteLen,ce,E.toolShaftDiam,ce,E.toolShaftLen,ce,E.bedWidth,at,E.bedDepth,at]),E.modeArrange.innerHTML="Arrange",E.modeExport.innerHTML="Export",E.modeCAM.innerHTML='<a>CAMLab</a><img src="/public/baa.png" width="30%" align="right">',E.helpButton.innerHTML="?",E.poweredButton.innerHTML='<img src="/public/KiriMoto.png" width="100%">',button_Machine.innerHTML='<a>Machine</a><img src="/public/SmallMachine.png" width="35%" align="right">',button_Mills.innerHTML='<a>Tools</a><img src="/public/endmill.png" width="40%" align="right" margin-top="3px">',E.toolDelete.innerHTML='<img src="/public/trash.png" width="90%" align="bottom" style="margin-bottom:-2px">',E.deviceDelete.innerHTML='<img src="/public/trash.png" width="90%" align="bottom" style="margin-bottom:-2px">',E.layerID.convert=C.toFloat.bind(E.layerID),E.layerSpan.convert=C.toFloat.bind(E.layerSpan),E.layerRange.onchange=function(){Ae()},$("layer-toggle").onclick=function(e){var t=E.layers.style;t.display="inline-block"!==t.display?"inline-block":"none",t.position="fixed"!==t.position?"fixed":"flex"},$("x-").onclick=function(e){He(e.shiftKey?-b:-u,0,0)},$("x+").onclick=function(e){He(e.shiftKey?b:u,0,0)},$("y-").onclick=function(e){He(0,e.shiftKey?-b:-u,0)},$("y+").onclick=function(e){He(0,e.shiftKey?b:u,0)},$("z-").onclick=function(e){He(0,0,e.shiftKey?b:u)},$("z+").onclick=function(e){He(0,0,e.shiftKey?-b:-u)},$("delmodel").onclick=function(e){e.keyCode=46,Z(e)},E.layerSlider.onclick=function(){we(E.layerSlider.value)},E.layerSlider.onmousemove=E.layerSlider.onchange=function(){we(E.layerSlider.value)},E.layerSlider.onmouseup=function(){bt()},E.import.setAttribute("import","1"),E.import.onclick=function(){ut("catalog")},E.toolMetric.onclick=ce,E.toolType.onchange=ce,S.platform.setSize(a.machine.bedWidth,a.machine.bedDepth,a.machine.bedHeight),S.platform.setGrid(25,5),S.platform.opacity(.2),S.mouse.downSelect(function(){return Q!==o.ARRANGE?null:z}),S.mouse.upSelect(function(e,t){if(!t||"CANVAS"!==t.target.nodeName)return be();e?Ze(e.object.widget,t.shiftKey):We()}),S.mouse.onDrag(function(e){if(!e||O!==i.FDM)return z.length>0;De(function(t){t.move(e.x,e.y,0)})}),rt(ye)||ye()}function G(){tt(),Ae()}function j(){Ue(a.machine),Ue(a.process),Ue(a.layers),nt(),Ae()}function V(){var e=h.activeElement;return e&&("INPUT"===e.nodeName||"TEXTAREA"===e.nodeName)}function Z(e){if(st())return!1;var t,n=e.altKey?5:0,i=n?0:-Math.PI/(e.shiftKey?36:2);switch(e.keyCode){case 8:case 46:if(V())return!1;z.length>0&&je(z),it(),e.preventDefault();break;case 37:if(V())return!1;i&&He(0,0,-i),n>0&&$e(-n,0,0),e.preventDefault();break;case 39:if(V())return!1;i&&He(0,0,i),n>0&&$e(n,0,0),e.preventDefault();break;case 38:if(V())return!1;if(e.metaKey)return we(K+1);i&&He(i,0,0),n>0&&$e(0,n,0),it(),e.preventDefault();break;case 40:if(V())return!1;if(e.metaKey)return we(K-1);i&&He(-i,0,0),n>0&&$e(0,-n,0),it(),e.preventDefault();break;case 65:if(e.metaKey){if(V())return!1;e.preventDefault(),We(),Ve(),(t=f.getSelection())&&t.rangeCount&&t.collapseToStart()}break;case 83:e.ctrlKey?(e.preventDefault(),nt(),log("settings saved")):e.metaKey&&(e.preventDefault(),function(){nt();var e=[],t=me(w.getItem("ws-widgets"),[]);Se(function(n){e.push(n.id),t.remove(n.id),n.saveState()}),w.setItem("ws-widgets",pe(e)),t.forEach(function(e){A.deleteFromState(e)})}());break;case 76:e.metaKey&&(e.preventDefault(),rt()),it()}}function W(e){return e.charCodeAt(0)}function X(e){delete a.machines[e],nt()}function J(e){return!!a.machines[e]}function Y(){return E.deviceSelect.options[E.deviceSelect.selectedIndex].text}function q(e,t){var n;(te=t,t&&(E.setupDevices.style.display="none"),n="LASER",a.mode!==n)&&(J(e)?oe(a.machines[e],e):ue("/camlab/filter/"+Dt()+"/"+e,function(t){oe(t,e)}))}function ee(e,t){return void 0!==e?e:t}function ne(){return a.filter[Dt()]}function ie(e){var t=Y(),n=e||E.deviceName.value,i={mode:Dt(),settings:{bed_width:parseInt(E.setDeviceWidth.value)||300,bed_depth:parseInt(E.setDeviceDepth.value)||175,machine_metric:E.setDeviceMetric.checked,build_height:parseInt(E.setDeviceHeight.value)||150,nozzle_size:parseFloat(E.setDeviceNozzle.value)||.4,filament_diameter:parseFloat(E.setDeviceFilament.value)||1.75,origin_center:E.setDeviceOrigin.checked,origin_top:E.setDeviceOriginTop.checked,extrude_abs:E.setDeviceExtrusion.checked,spindle_max:parseInt(E.setDeviceMaxSpindle.value)||0},cmd:{fan_power:E.setDeviceFan.value,progress:E.setDeviceTrack.value,spindle:E.setDeviceSpindle.value.split("\n"),layer:E.setDeviceLayer.value.split("\n")},pre:E.setDevicePre.value.split("\n"),post:E.setDevicePost.value.split("\n"),pause:E.setDevicePause.value.split("\n"),dwell:E.setDeviceDwell.value.split("\n"),"tool-change":E.setDeviceChange.value.split("\n"),"file-ext":E.setDeviceFExt.value,"token-space":E.setDeviceToken.checked?" ":"","strip-comments":E.setDeviceStrip.checked};t!==n&&J(t)&&X(t),function(e,t){a.machines[e]=t,nt()}(n,i),oe(i,n)}function oe(e,t){try{x.set("dn",t),"string"==typeof e&&(e=me(e)||{});var n=e.cmd||{},i=e.settings||{},o=J(t),l=a.devproc[t];a.machine={bedHeight:2.5,bedWidth:ee(i.bed_width,258),bedDepth:ee(i.bed_depth,185),maxHeight:ee(i.build_height,150),nozzleSize:ee(i.nozzle_size,.4),filamentSize:ee(i.filament_diameter,1.75),extrudeAbs:ee(i.extrude_abs,!1),spindleMax:ee(i.spindle_max,0),gcodeFan:ee(n.fan_power,""),gcodeTrack:ee(n.progress,""),gcodeLayer:ee(n.layer,[]),gcodePre:ee(e.pre,[]),gcodePost:ee(e.post,[]),gcodeProc:ee(e.proc,""),gcodePause:ee(e.pause,[]),gcodeDwell:ee(e.dwell,[]),gcodeSpindle:ee(n.spindle,[]),gcodeChange:ee(e["tool-change"],[]),gcodeFExt:ee(e["file-ext"],"gcode"),gcodeSpace:ee(e["token-space"],""),gcodeStrip:ee(e["strip-comments"],!1)};var r=a.machine,s=a.process;s.outputOriginCenter=ee(i.origin_center,!0),s.camOriginTop=ee(i.origin_top,!0),E.deviceName.value=t,E.setDevicePre.value=r.gcodePre.join("\n"),E.setDevicePost.value=r.gcodePost.join("\n"),E.setDevicePause.value=r.gcodePause.join("\n"),E.setDeviceWidth.value=r.bedWidth,E.setDeviceDepth.value=r.bedDepth,E.setDeviceHeight.value=r.maxHeight,E.setDeviceExtrusion.checked=r.extrudeAbs,E.setDeviceOrigin.checked=s.outputOriginCenter,E.setDeviceFan.value=r.gcodeFan,E.setDeviceTrack.value=r.gcodeTrack,E.setDeviceLayer.value=r.gcodeLayer.join("\n"),E.setDeviceFilament.value=r.filamentSize,E.setDeviceNozzle.value=r.nozzleSize,E.setDeviceMaxSpindle.value=r.spindleMax,E.setDeviceSpindle.value=r.gcodeSpindle.join("\n"),E.setDeviceDwell.value=r.gcodeDwell.join("\n"),E.setDeviceChange.value=r.gcodeChange.join("\n"),E.setDeviceFExt.value=r.gcodeFExt,E.setDeviceToken.checked=!!r.gcodeSpace,E.setDeviceStrip.checked=r.gcodeStrip,[E.deviceName,E.setDevicePre,E.setDevicePost,E.setDevicePause,E.setDeviceDepth,E.setDeviceWidth,E.setDeviceMetric,E.setDeviceHeight,E.setDeviceExtrusion,E.setDeviceOrigin,E.setDeviceOriginTop,E.setDeviceFan,E.setDeviceTrack,E.setDeviceLayer,E.setDeviceFilament,E.setDeviceNozzle,E.setDeviceMaxSpindle,E.setDeviceSpindle,E.setDeviceDwell,E.setDeviceChange,E.setDeviceFExt,E.setDeviceToken,E.setDeviceStrip].forEach(function(e){e.disabled=!o}),E.deviceSave.disabled=E.deviceDelete.disabled=!o,et(),at(),a.filter[Dt()]=t,a.cdev[Dt()]=r,l&&pt(null,l),"Sienci.Mill.One.V2"==ne()||"Sienci.Mill.One.V3"==ne()||"LongMill.12"==ne()||"LongMill.30"==ne()?E.setupFeeds.style.display="inline-block":E.setupFeeds.style.display="none",nt()}catch(t){console.log({error:t,machine:e})}Oe(),re()}function le(){E.toolSelect.innerHTML="",c.forEach(function(e,t){e.order=t;var n=h.createElement("option");n.appendChild(h.createTextNode(e.name)),n.onclick=function(){se(e)},E.toolSelect.appendChild(n)}),console.log("rendertool"),it()}function se(e){r=e,E.toolName.value=e.name,E.toolNum.value=e.number,E.toolFluteDiam.value=e.flute_diam,E.toolFluteLen.value=e.flute_len,E.toolShaftDiam.value=e.shaft_diam,E.toolShaftLen.value=e.shaft_len,E.toolMetric.checked=e.metric,E.toolType.selectedIndex="endmill"===e.type?0:"ballmill"===e.type?1:-1}function ce(){r.name=E.toolName.value,r.number=parseInt(E.toolNum.value),r.flute_diam=parseFloat(E.toolFluteDiam.value),r.flute_len=parseFloat(E.toolFluteLen.value),r.shaft_diam=parseFloat(E.toolShaftDiam.value),r.shaft_len=parseFloat(E.toolShaftLen.value),r.metric=E.toolMetric.checked,r.type=["endmill","ballmill"][E.toolType.selectedIndex],le(),E.toolSelect.selectedIndex=r.order,c.changed=!0,console.log("updatetool")}function de(){O===i.LASER||te||(St(o.ARRANGE),E.layers.style.display="none",ue("/api/filters-"+Dt().toLowerCase(),function(e){e&&(!function(e){E.machines.onclick=C.hidePop,C.hidePop();var t=-1,n=ne(),i=a.machines;for(var o in i)if(i.hasOwnProperty(o)&&i[o]){var l=i[o],r=l.cmd,s="FDM"===Dt();(l.mode?l.mode===Dt():r?s:!s)&&e.push(o)}e=e.sort(),E.deviceClose.onclick=dt,E.deviceSave.onclick=function(){Oe(),ie(),nt(),de()},E.deviceAdd.onclick=function(){Oe(),ie(Y()+".copy"),de()},E.deviceDelete.onclick=function(){Oe(),X(Y()),de()},E.deviceSelect.innerHTML="",e.forEach(function(e,i){var o=h.createElement("option");o.appendChild(h.createTextNode(e)),o.onclick=function(){q(e)},J(e)&&o.setAttribute("local",1),E.deviceSelect.appendChild(o),e===n&&(t=i)}),t>=0?(E.deviceSelect.selectedIndex=t,q(n)):(E.deviceSelect.selectedIndex=0,q(e[0])),ut("machines",!0),ht(),E.deviceSelect.focus()}(me(e)),x.add("d-gcode"))}))}function fe(e){A.loadFromCatalog(e.target.getAttribute("load"),function(e){Ge(e),dt()}),it()}function ge(e){k.deleteFile(e.target.getAttribute("del"))}function ve(e){var t=E.catalogList,n=[];for(var i in t.innerHTML="",e)n.push({n:i,ln:i.toLowerCase(),v:e[i].vertices,t:e[i].updated});n.sort(function(e,t){return e.ln<t.ln?-1:1});for(var o=0;o<n.length;o++){var l=h.createElement("div"),a=h.createElement("button"),r=h.createElement("button"),s=n[o];i=s.n;a.setAttribute("load",i),a.setAttribute("title","file: "+i+"\nvertices: "+s.v),a.onclick=fe,a.appendChild(h.createTextNode(i.split(".")[0])),r.setAttribute("del",i),r.setAttribute("title","remove '"+i+"'"),r.onclick=ge,r.appendChild(h.createTextNode("x")),l.setAttribute("class","flow-row"),l.appendChild(a),l.appendChild(r),t.appendChild(l)}n.length,gt()}function ye(){We(),k.addFileListener(ve),S.view.setZoom(a.controller.reverseZoom,a.controller.zoomSpeed),S.platform.setZOff(.2),v.s&&v.s.forEach(function(e){var t=h.createElement("script");t.setAttribute("async",!0),t.setAttribute("src","/code/"+e+".js"),h.body.appendChild(t),x.add("l-"+e)}),v.ss&&v.ss.forEach(function(e){var t=h.createElement("link");t.setAttribute("type","text/css"),t.setAttribute("rel","stylesheet"),t.setAttribute("href","/camlab/style-"+e+".css"),h.body.appendChild(t)}),v.v&&v.v.forEach(function(e){e=e.split("="),w.setItem(e[0],e[1])});var e,t,n,i=v.mode?v.mode[0]:null,o=v.dev?v.dev[0]:null;kt(i||F||a.mode),e=!0,E.ctrlLeft.style.display=e?"block":"none",E.ctrlRight.style.display=e?"block":"none",at(),bt(),x.get("upgrade")&&m.log("kiri | version upgrade"),x.del("upgrade"),v.s||console.log("camlab | init main | "+kiri.version),x.set("seed",w[M]),x.add("init"),E.helpButton.title="Find tutorials on how to use CAMLab",q(o||ne(),o),tt(),gt(),ae("init-done",x),2===(n=(t||g.hash.substring(1)).split("/")).length&&new moto.Ajax(function(e){if(e){var t=JSON.parse(e);if(t&&t.ver&&t.rec){var n=JSON.parse(atob(t.rec));n.id=t.space,n.ver=t.ver,lt(n),re(),g.hash=""}}}).request("/data/"+n[0]+"/"+n[1])}}}();